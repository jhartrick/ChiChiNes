var trup,init,lfgs,sycl,cfgo,uris,clip,dast,perm,blak,scbr,exts,down,D=!1;
Registry.require("promise convert xmlhttprequest downloads cache storage uri compat parser helper syncinfo notify asker i18n native engineapi news".split(" "),function(){var ua=function(a){D|=60<=a;K.debug(!1);n.debug(D,!1);P.debug(D)},l=rea.FEATURES,oa=function(){var a=[],d=!0,b=function(a,b,f){var c={title:a.join("\n\n")};console.warn(a.join("\n"));rea.browserAction.setIcon(b);rea.browserAction.setTitle(c);b=function(c,b,f){c={name:"1",sub_menu_item:!0,pos:"left",items:[]};c.items.push({name:a[0],
image:"info"});1<a.length&&c.items.push({name:a[1]});f({items:[c],options:{enabled:!1}})};f||rea.extension.onMessage.addListener(b)};return{run:function(){try{if(Registry.verify("58").length){var a={path:rea.extension.getURL("images/icon_paused.png")};d=!1;b(["Ace Script detected that browser is caching some outdated code parts.","In order to avoid unexpected behavior TM will be kept paused until your browser was restarted."],a)}}catch(e){d=!1,console.error(e.message)}"chromeStorage"!=l.DB.USE||l.DB.NO_WARNING||
window.setTimeout(function(){n.isWorking().fail(function(){confirm("Ace Script detected that the extension storage is unreliable!\n\nUnfortunately this means that all your settings and userscripts are inaccessible at the moment.\n\nDo you want to visit the FAQ entry that explains how to recover from that?")&&rea.tabs.create({url:"http://awe.acestream.me/faq#Q206"},function(){});var a={path:rea.extension.getURL("images/icon_paused.png")};b(["Ace Script detected that the extension storage is unreliable!"],
a,!0)})},1E3);return d},pause:b,setWarning:function(b,d,f){a.push({text:b,description:d,url:f})},getWarnings:function(){return a}}}();if(oa.run()){var pa=function(a,d){var b;if("remote-control-url"===a)b="http://127.0.0.1:6878/remote-control";else if("_a"===a)b=null;else if("mode"===a)b=0;else throw"unknown param name: "+a;if("function"===typeof d)d(b);else return b},L=l.WEBREQUEST,k=Registry.get("promise"),v=Registry.get("helper"),U=Registry.get("cache"),n=Registry.get("storage"),P=Registry.get("notify"),
ia=Registry.get("asker"),N=Registry.get("native"),Q=Registry.get("permission"),X=Registry.get("engineapi"),da=Registry.get("news");perm=Q;dast=n;X.init(pa("_a"));da.init();var va=v.createUUID(),O={},Y={};D&&console.debug("Starting background fred @"+va);U.create("rundata").setOptions({timeout:180,check_interval:120,retimeout_on_get:!0}).init();U.create("resources").setOptions({timeout:1800,check_interval:300}).init();var R={},Fa=function(a,d){chrome.tabs.sendMessage(d.id,{method:"awe-watch-online",
url:a.linkUrl})},Ga=function(a){chrome.contextMenus.create({id:"awe-watch-online",title:"Watch online",contexts:["link"],onclick:Fa},function(){chrome.runtime.lastError;"function"===typeof a&&a.call(null)})},Ha=function(a){var d=Registry.get("storage"),b={};d.listValues().forEach(function(a){if(a.match("^"+rea.FEATURES.CONSTANTS.PREFIX.META)){a=d.getValue(a);var e="";a.namespace&&(e=a.namespace+"/");e+=a.name;b[e]=!0}});a(b)},Ja=function(){var a=k(),d,b,h=rea.extension.manifest.version,e=n.getSchemaVersion(),
f=e;n.getVersion("0.0.0.0").then(function(a){b=a;d=x.versionCmp(h,b)==x.versionCmp.eNEWER;return n.isWiped()}).then(function(a){!d&&a&&(a=["Ace Script detected inconsistencies that indicate that your browser wiped the extension database!","You can continue to use Ace Script normally, but your settings and scripts might be lost. Click here to get more information.","http://awe.acestream.me/faq.php#Q207"],console.warn(a.join("\n")),ea.setWarning.apply(this,a))}).always(function(){var c=[],m=0,r=function(){if(m<
c.length){var b=c[m].schema;c[m].cond(b)?c[m].fn().done(function(){b&&(console.log("Converted database from",f,"to",b),f=b);m++;r()}).fail(function(){a.reject()}):(m++,r())}},u=function(){console.warn("Incognito mode detected. Database conversion can only be done in non-incognito mode! Stopping now...");var a={path:rea.extension.getURL("images/icon_paused.png")};oa.pause(["Ace Script needs to convert its database but this can't be done in incogonito mode!","Please open a non-incognito mode window and/or restart your browser."],
a)},c=[{cond:function(){return d&&!l.RUNTIME.FIREFOX&&"chromeStorage"==l.DB.USE&&!n.getValue(l.CONSTANTS.STORAGE.LEGACY_VERSION)&&x.versionCmp("3.5.3603",b)==x.versionCmp.eNEWER},fn:function(){var a=k();rea.extension.inIncognitoContext?(u(),a.reject()):(console.log("Update database..."),f="3.5.3603",n.migrate("sql","chromeStorage").done(function(){console.log("Copied config for default usage of chrome storage");a.resolve()}));return a.promise()}},{cond:function(){return d&&x.versionCmp("3.6.3650",
f)==x.versionCmp.eNEWER&&x.versionCmp("3.5.3650",b)==x.versionCmp.eNEWER},fn:function(){var a=k();if(rea.extension.inIncognitoContext)u(),a.reject();else{f="3.6.3650";var c=[];[{o:"AWE_config",n:l.CONSTANTS.STORAGE.CONFIG},{o:"AWE_update_check",n:l.CONSTANTS.STORAGE.UPDATE},{o:"AWE_version"},{o:"AWE_unload_ts"}].forEach(function(a){if(a.n){var b=n.getValue(a.o);void 0!==b&&c.push(n.setValue(a.n,b))}c.push(n.deleteValue(a.o))});var d=/@re$/,m=[];n.listValues().forEach(function(a){-1!=a.search(d)&&
(a=a.replace(d,""),m.push(a))});m.forEach(function(a){var b=n.getValue(a+"@st"),f=n.getValue(a),d=n.getValue(a+"@re"),m=n.getValue(a+"@source"),r=y.getUidByName(a)||v.createUUID();c.push(n.deleteValue(a+"@st"));c.push(n.deleteValue(a));c.push(n.deleteValue(a+"@re"));c.push(n.deleteValue(a+"@source"));f&&d&&m?(c.push(n.setValue(l.CONSTANTS.PREFIX.SCRIPT_UID+r,a)),c.push(n.setValue(l.CONSTANTS.PREFIX.COND+r,d)),c.push(n.setValue(l.CONSTANTS.PREFIX.STORE+r,b)),c.push(n.setValue(l.CONSTANTS.PREFIX.SCRIPT+
r,m)),c.push(n.setValue(l.CONSTANTS.PREFIX.META+r,f))):console.warn("invalid script entry",{source:m,meta:f,cond:d})});d=/@st$/;n.listValues().forEach(function(a){-1!=a.search(d)&&c.push(n.deleteValue(a))});k.when(c).done(function(){console.log("Converted database from",b,"to",f);a.resolve()})}return a.promise()}},{schema:"3.7.0",cond:function(a){return x.versionCmp(a,f)==x.versionCmp.eNEWER},fn:function(){var a=k();if(rea.extension.inIncognitoContext)u(),a.reject();else{var c=[],b=RegExp("^"+l.CONSTANTS.PREFIX.META);
n.listValues().forEach(function(a){if(-1!=a.search(b)){var f=n.getValue(a);f.options&&f.options.override&&!f.options.override.orig_run_at&&(f.options.override.orig_run_at=f.options.run_at||"document-idle",f.options.run_at=null,c.push(n.setValue(a,f)))}});k.when(c).done(function(){a.resolve()})}return a.promise()}},{schema:"4258",cond:function(a){return x.versionCmp(a,f)==x.versionCmp.eNEWER},fn:function(){var a=k();if(rea.extension.inIncognitoContext)u(),a.reject();else{var c=n.getValue(l.CONSTANTS.STORAGE.CONFIG);
c&&c.sync_enabled&&2==c.sync_type&&(c.sync_version=1,n.setValue(l.CONSTANTS.STORAGE.CONFIG,c));a.resolve()}return a.promise()}},{schema:"4526",cond:function(a){return d&&l.RUNTIME.SAFARI&&"chromeStorage"==l.DB.USE&&x.versionCmp(a,f)==x.versionCmp.eNEWER},fn:function(){var a=k();rea.extension.inIncognitoContext?(u(),a.reject()):(console.log("Update database..."),n.migrate("localStorage","chromeStorage").done(function(){console.log("Copied config for default usage of setting storage");a.resolve()}).fail(a.reject));
return a.promise()}},{schema:"4871",cond:function(a){return d&&x.versionCmp(a,f)==x.versionCmp.eNEWER},fn:function(){var a=k(),c,b,f=n.getValue(l.CONSTANTS.STORAGE.CONFIG);f&&f.scriptTemplate&&(b=g.getDefaults())&&(c=b.script_templates)&&c[0]&&c[0].value&&(c[0].value=f.scriptTemplate,delete f.scriptTemplate,n.setValue(l.CONSTANTS.STORAGE.CONFIG,f));a.resolve();return a.promise()}},{cond:function(){return d||x.versionCmp(f,e)==x.versionCmp.eNEWER},fn:function(){var a=k();n.setVersion(h,f).done(function(){a.resolve()});
return a.promise()}},{cond:function(){return d},fn:function(){console.log("First run of version "+h+"!");Ia.scheduleNotification(b,"0.0.0.0"==b);return k.Pledge()}},{cond:function(){return!0},fn:function(){var c=k();a.resolve();window.setTimeout(c.resolve,l.MISC.TIMEOUT);return c.promise()}}];r()});return a.promise()},ea=function(){var a={get:function(a,b){var h=(0==a)+"#"+b,e=U.items.rundata.getj(h);if(e)e.oldret.user_agent[a]=e.oldret.user_agent[e.frameId],e=e.oldret;else{var e=[],f=0,c={},m={};
if(b)for(var r=w.determineScriptsToRun(b),u=0;u<r.length;u++){var q=r[u];q.enabled?q.evilness&&q.evilness>=g.values.script_blacklist_severity||0!=a&&(!0===q.options.noframes||null===q.options.noframes&&!0===q.options.override.orig_noframes)||w.isContexter(q)||(q.options.user_agent&&(m[a]=q.options.user_agent),c[q.name]=!0,e.push(q)):f++}e={runners:e,disabled:f,script_map:c,user_agent:m};b&&U.items.rundata.setj(h,{frameId:a,oldret:e})}return e},getUserAgent:function(d,b){return a.get(d,b).user_agent},
getContexters:function(a,b){for(var h=[],e=w.determineScriptsToRun(b),f=0;f<e.length;f++){var c=e[f];c.enabled&&(0==a||!0!==c.options.noframes&&(null!==c.options.noframes||!0!==c.options.override.orig_noframes))&&w.isContexter(c)&&h.push(c)}return h}};return a}(),A=function(){var a={},d=1,b=d++,h=d++,e=d++,f=d++,c=d++,m=d++,r=d++,u=d++,q=function(){var a={frames:{0:{state:b}},tabs:{reset_ts:(new Date).getTime()},scripts:{},urls:{},maps:{},contexts:{onUnload:{}},stats:{running:0,disabled:0},extra:{}};
Object.defineProperties(a.urls,{length:{value:0,enumerable:!1,writable:!0,configurable:!0}});return a},p={},E={},G={},C={listeners:{once:{whenReady:function(c,b){if(!a[c]||a[c].frames[0].state<f)C.listeners.once.onReady(c,b);else b()},onReady:function(a,c){var b=function(a){C.listeners.remove.onCommited(f);C.listeners.remove.onCompleted(d);a&&c()},f=C.listeners.add.onCommited(function(c){c===a&&b(!0)}),d=C.listeners.add.onCompleted(function(c){c===a&&b(!0)})}},add:{onReset:function(a){var c=v.createUUID();
p[c]=a;return c},onCommited:function(a){var c=v.createUUID();E[c]=a;return c},onCompleted:function(a){var c=v.createUUID();G[c]=a;return c}},remove:function(){return{onReset:function(a){delete p[a]},onCommited:function(a){delete E[a]},onCompleted:function(a){delete G[a]}}}()},events:{reset:function(c,f){a[c]=q();a[c].frames[0].state=b;v.each(p,function(a){a&&a(c,f)})},request:function(c,b,f){g.values.enabled&&(a[c]=a[c]||q(),a[c].frames[b]=a[c].frames[b]||{},a[c].frames[b].state=h,f=B.woHash(f),ja.isAllowed(f)&&
(f=ea.getUserAgent(b,f),f[b]&&C.set.extra(c,b,"user_agent",f[b])))},response:function(c,f,d){if(g.values.enabled){a[c]=a[c]||q();a[c].frames[f]=a[c].frames[f]||{};var m=a[c].frames[f].state||b;a[c].frames[f].state=e;0===f&&(a[c].tabs.response_ts=(new Date).getTime());d=B.woHash(d);m<e&&C.scripts.determine(c,f,d);return(c=a[c].scripts[d])?c.runners.length:0}},commited:function(c,d,m){if(g.values.enabled){var r=B.parse(m);if("http:"===r.protocol||"https:"===r.protocol||"file:"===r.protocol)a[c]=a[c]||
q(),a[c].frames[d]=a[c].frames[d]||{},r=a[c].frames[d].state||b,a[c].frames[d].state=f,r<e&&(m=B.woHash(m),C.scripts.determine(c,d,m)),v.each(E,function(a){a&&a(c)})}},loading:function(f,d,m){if(g.values.enabled){var r=B.parse(m);"http:"!==r.protocol&&"https:"!==r.protocol&&"file:"!==r.protocol||0!==d||"file:"!==r.protocol||(a[f]=a[f]||q(),a[f].frames[d]=a[f].frames[d]||{},r=a[f].frames[d].state||b,a[f].frames[d].state=c,r<e&&(m=B.woHash(m),C.scripts.determine(f,d,m)))}},run:function(c,b,f,d,r){if(g.values.enabled){var h=
0===b?b:f;a[c]=a[c]||q();a[c].frames[h]=a[c].frames[h]||{};a[c].frames[h].state=m;var e=B.woHash(d);(d=a[c].scripts[e])||(C.scripts.determine(c,b,e),d=a[c].scripts[e],d)?(C.scripts.updateMaps(c,f,d.script_map),C.scripts.updateUrls(c,f,e),C.scripts.updateStats(c,f,d.runners.length,d.disabled),C.scripts.run(c,b,f,e,d.runners,function(b){a[c]&&delete a[c].scripts[e];r(b)})):console.warn("tv: no script run info for tab "+c+" @ "+e,D?a[c].scripts:"")}},complete:function(c,f,d){d=B.parse(d);if(g.values.enabled&&
("http:"===d.protocol||"https:"===d.protocol||"file:"===d.protocol)){if(0===f){a[c]=a[c]||q();a[c].frames[f]=a[c].frames[f]||{};var h=a[c].frames[f].state||b;a[c].frames[f].state=r;if(!A.get.empty(c)&&A.get.stats(c).running){if(h<m){console.warn("tv: no script run info!");return}"file:"===d.protocol?window.setTimeout(function(){rea.tabs.sendMessage(c,{method:"onLoad",frameId:f},function(){})},500):(rea.tabs.sendMessage(c,{method:"onLoad",frameId:f},function(){}),H.runCheck&&rea.contentSettings.javascript.clear({}))}}v.each(G,
function(a){a&&a(c)})}},unload:function(c,f,b){f=0===f?f:b;a[c]=a[c]||q();a[c].frames[f]=a[c].frames[f]||{};a[c].frames[f].state=u;if(a[c]&&a[c].contexts.onUnload[b]){for(f=0;f<a[c].contexts.onUnload[b].length;f++)a[c].contexts.onUnload[b][f]();a[c].contexts.onUnload[b]=[]}},remove:function(c){delete a[c]}},scripts:{updateStats:function(c,f,b,d){a[c].stats.running+=b;a[c].stats.disabled+=d;a[c].contexts.onUnload[f]=a[c].contexts.onUnload[f]||[];a[c].contexts.onUnload[f].push(function(){a[c].stats.running-=
b;a[c].stats.disabled-=d});a[c].tabs.ts=(new Date).getTime()},updateMaps:function(c,f,b){var d=1,m=function(f,b){void 0===a[c].maps[b]&&1===d&&(a[c].maps[b]=0);a[c].maps[b]+=d};v.each(b,m);a[c].contexts.onUnload[f]=a[c].contexts.onUnload[f]||[];a[c].contexts.onUnload[f].push(function(){a[c]&&(d=-1,v.each(b,m))})},updateUrls:function(c,f,b){var d=1,m=function(){void 0===a[c].urls[b]&&1===d&&(a[c].urls[b]=0);a[c].urls[b]+=d;a[c].urls.length=-1};m();a[c].contexts.onUnload[f]=a[c].contexts.onUnload[f]||
[];a[c].contexts.onUnload[f].push(function(){a[c]&&(d=-1,m())})},determine:function(c,f,b){var d=null;ja.isAllowed(b)?d=b:(D&&console.log("This URL is filtered by the security settings:",b,"-> Do nothing!"),A.set.forbidden(c,f));f=ea.get(f,d);a[c].scripts[b]=f;return f.runners.length},run:function(a,c,f,b,d,m){a=[];c=l.RUNTIME.ALLOWS_FAST_DOCUMENT_START&&g.values.runtime_fastDocumentStart;for(f=0;f<d.length;f++){var r=d[f];a.push(wa.bundle({url:b},r,c&&("document-start"===r.options.run_at||!r.options.run_at&&
"document-start"===r.options.override.orig_run_at)))}k.when(a).always(m)}},set:{extra:function(c,f,b,d){a[c]=a[c]||q();null===f?a[c].extra[b]=d:(a[c].extra[b]=a[c].extra[b]||{},a[c].extra[b][f]=d)},blocker:function(a){C.set.extra(a,null,"blocker",!0)},forbidden:function(a,c){0===c&&C.set.extra(a,null,"forbidden",!0)}},get:{extra:function(c,f,b,d){void 0===d&&(d=null);var m=null,m=(a[c]?a[c].extra:{})[b];null!==f&&m&&(m=m[f]);return m||d},empty:function(c){var f=!0;if(a[c]&&0!=a[c].urls.length){if(-1==
a[c].urls.length)return a[c].urls.length=0,v.each(a[c].urls,function(f,b){"length"!==b&&0<f&&a[c].urls.length++}),C.get.empty(c);f=!1}return f},urls:function(c){return a[c]?a[c].urls:{}},stats:function(c,f){var b={};if(a[c]&&(b.running=a[c].stats.running,b.disabled=a[c].stats.disabled,f)){b.unique=0;for(var d in a[c].maps)a[c].maps.hasOwnProperty(d)&&0<a[c].maps[d]&&b.unique++}return b},tabs:function(){var c={};v.each(a,function(a,f){c[f]={ts:a.response_ts}});return c},blocker:function(a){return C.get.extra(a,
null,"blocker")},forbidden:function(a){return C.get.extra(a,null,"forbidden")},user_agent:function(a,c){return C.get.extra(a,c,"user_agent")}}};return C}(),qa=function(){return{isScriptUrl:function(a){if(!a||-1!=a.search(/\#bypass=true/)||-1!=a.search(l.REQUESTS.GET_INTERNAL_PAGE_REGEXP()))return!1;a=a.split(/[\?#$]/)[0];var d=-1!=a.search(/\.acestream\.(js\#|js\?|js$)/);!d&&g.values.handle_user_js&&(d=-1!=a.search(/\.user\.(js\#|js\?|js$)/));return d?!(-1!=a.search(/^htt[ps]{1,2}:\/\/code\.google\.com/)||
-1!=a.search(/^htt[ps]{1,2}:\/\/github\.com/)&&-1==a.search(/^htt[ps]{1,2}:\/\/github\.com\/[a-zA-Z0-9%-]\/[a-zA-Z0-9%-]\/raw\//)):d}}}(),xa=function(){var a=function(a){var b=k(),h=(new Date).getTime();a.url+=-1!=a.url.search("\\?")?"&":"?";a.url+="ts="+h;var h=function(c){if(4==c.readyState&&(200==c.status||0==c.status))if("arraybuffer"==e.responseType){if(c.response){b.resolve({decoded:!0,encoding:a.encoding,content:M.arrbuf2str(c.response,a.encoding)});return}}else if(null!==c.response&&void 0!==
c.response){b.resolve({decoded:!0,encoding:a.encoding,content:c.response});return}b.reject({content:""})},e={method:"GET",retries:0,responseType:"arraybuffer",url:a.url};if(a.sync){var f=Z(e,{});4==f.readyState&&403==f.status&&(delete e.responseType,f=Z(e,{}));h(f)}else Z(e,{ondone:h});return b.promise()};return{getSource:function(d){"string"===typeof d&&(d={url:d});return a(d)}}}();lfgs=xa;var ja=function(){return{isAllowed:function(a){var d=!1,b=!1,h=0!=g.values.forbiddenPages.length,e=0!=g.values.page_whitelist.length;
switch(g.values.page_filter_mode){case "black":b=h;break;case "off":break;case "white":d=e;break;default:d=e,b=h}h={inc:d?g.values.page_whitelist:void 0,exc:b?g.values.forbiddenPages:void 0};return!b&&!d||w.validUrl(a,h)}}}(),aa=function(){var a={init:function(){var d=k(),b=function(){"server"===g.values.script_blacklist_type&&window.setTimeout(a.checkUpdate,2E4)};b();g.addChangeListener("script_blacklist_type",b);d.resolve();return d.promise()},getEvilnessOf:function(a){if("off"===g.values.script_blacklist_type)return!1;
if(!a)return 0;var b=!1,h=0,e=function(f){var c=!1;if(f.length)return(c="/"==f.substr(0,1)?w.matchUrl(a,f):-1!=a.search(f))&&console.debug('black: entry "'+f+'" matched'),b|=c,1!=b};v.each(g.values.require_blacklist,e);b?h=11:"server"===g.values.script_blacklist_type&&v.each(g.values.script_blacklist_server,function(a){if(a&&(v.each(a.rules,function(a){e(a);return 1!=b}),b))return h=a.severity,!1});return Number(h)},checkUpdate:function(a){}};return a}();blak=aa;var Ka=function(){for(var a=[],d=[],
b=0;b<a.length;b++){var h=Registry.getRaw("system/"+a[b]+".acestream.js");h&&d.push(h)}return d},J=function(){var a=0,d=[],b={to:null,force:null,t:0},h={},t=function(a){D&&console.debug("sync: import",a.uuid,a.name,a.url);var c={imported:g.values.sync_type},f={},b;for(b in p.SYNCED)!0===p.SYNCED[b]&&(f[b]=a.options[b]);return w.installFromUrl(a.url,{uuid:a.uuid,ask:!1,internal:!0,sync:c,force_options:f},{silent_fail:!0})},f=function(a){D&&console.debug("sync: export",a.name,a.url);return K.add(a)},
c=function(a){var c=a.downloadURL?a.downloadURL.split("#")[0]:null,f=a.fileURL?a.fileURL.split("#")[0]:null,b=v.select([f,c],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0],c={uuid:a.uuid,name:a.name,options:{},durl:c,furl:f,url:b},d;for(d in p.SYNCED)!0===p.SYNCED[d]&&null!==a.options[d]&&(c.options[d]=a.options[d]);return c},m=function(){var a=[];y.getUidList().forEach(function(f){f=y.getByUid(f);f.script&&f.cond&&a.push(c(f.script))});return a},r=function(c){if(p.enabled)if(0<a)c&&
p.addSyncDoneCallback(function(a){a&&p.sync(50,c)});else{a++;var b=null,r=null,u=!0,q={},l=function(a){if(a){(a=a.split("#")[0])&&(a=a.toLowerCase());for(var c=0;c<b.length;c++){var f=b[c].furl?b[c].furl.toLowerCase():null,d=b[c].durl?b[c].durl.toLowerCase():null;if(f==a||d==a)return b[c]}}return null},n=function(a){if(a)for(var c=0;c<r.length;c++)if(r[c].uuid==a)return r[c];return null},v=function(a){if(a){a=a.split("#")[0];for(var c=0;c<r.length;c++)if(r[c].url==a)return r[c]}return null},x=function(a){if(!a)return null;
for(var c=0;c<b.length;c++)if(b[c].uuid==a)return b[c]};(function(){b=m();return K.list().done(function(a){r=a}).fail(function(){D&&console.error("sync: unable to get remotelist!")})})().then(function(){for(var a=k(),c=[],b=0;b<r.length;b++)c.push(function(){var a,c=r[b],f=!1,d=!1,m=2==g.values.sync_version?x(c.uuid):l(c.url);if(m)if(f=!0,q[c.url]=!0,c.uuid&&(q[c.uuid]=!0),c.content&&M.MD5(c.content)!=M.MD5(m.textContent))d=!0;else for(a in p.SYNCED)if(!0===p.SYNCED[a]&&m.options[a]!=c.options[a]){d=
!0;break}if(f)if(c.options.removed)D&&console.debug("sync: remove local script",c.uuid,c.name,c.url),w.doRemove(m.uuid,!1);else if(d)if(D&&console.debug("sync: update local script",c.uuid,c.name,c.url),d=y.getByUid(m.uuid),d.script&&d.cond){for(a in p.SYNCED)!0===p.SYNCED[a]&&(d.script.options[a]=c.options[a]);c.content&&(d.script.textContent=c.content);w.doModify(d.script.uuid,d.script,!1)}else console.log(e.getMessage("fatal_error")+"("+m.name+")!!!");if(!f&&!c.options.removed)if(a=k(),h[c.url]||
c.uuid&&h[c.uuid])D&&console.warn("sync: skip previously failed import",c);else return t(c).done(function(a){a||(D&&console.warn("sync: unable to import",c),h[c.url]=!0,c.uuid&&(h[c.uuid]=!0))}).fail(function(){D&&console.warn("sync: unable to load",c);h[c.url]=!0;c.uuid&&(h[c.uuid]=!0)}).always(a.resolve),a.promise();return k.Pledge()}());k.when(c).done(function(){a.resolve()});return a.promise()}).then(function(){b=m();return k.Pledge()}).then(function(){if(!K.isWritable())return k.Pledge();for(var a=
k(),c=[],d=0;d<b.length;d++)c.push(function(){var a=b[d],c=!1;if(!a.url||q[a.url]||q[a.uuid])return k.Pledge();if(2==g.values.sync_version?n(a.uuid):v(a.url))c=!0;return c?k.Pledge():f(a).done(function(a){})}());k.when(c).done(function(){a.resolve()});return a.promise()}).fail(function(){u=!1}).done(function(){u=!0}).always(function(){D&&console.debug("sync: finished");if(0==--a)for(var c=u;d.length;)d.shift()(c)})}},u=function(){p.enabled&&p.sync(500,!0)},q=null,p={enabled:!1,SYNCED:{comment:!0},
createTeslaData:function(){for(var a=k(),c=[],b=m(),f=0;f<b.length;f++)if(b[f].url){var d=JSON.stringify(b[f].options),d=b[f].name.replace(/\|/g,"!")+"|"+d+"|"+b[f].url.replace(/\|/g,"%7C");c.push(d)}a.resolve(c);return a.promise()},configChangeListener:function(){q||(q=window.setTimeout(function(){q=null;p.init().done(function(){p.enabled&&p.sync(3E3)})},3E3))},init:function(){var a=k();p.enabled=!1;(function(){return g.values.sync_enabled&&g.values.sync_type?K.init(g.values.sync_type,g.values.sync_version,
g.values.sync_id).done(function(a){p.enabled=a;p.enabled?K.addChangeListener(u):console.warn("sync: init failed!")}):k.Pledge()})().always(function(){a.resolve(p.enabled)});return a.promise()},finalize:function(){},reset:function(){return K.reset()},addSyncDoneCallback:function(a){d.push(a)},sync:function(a,c){var f=(new Date).getTime();a=a||500;c=b.force||c;b.to?(window.clearTimeout(b.to),b.ts<f+a&&(a=b.ts-f,1>a&&(a=1))):D&&console.debug("sync: schedule sync for run in "+a+" ms");b.force=c;b.ts=
f+a;b.to=window.setTimeout(function(){r(b.force);b.to=null;b.force=null},a)},scriptAddedCb:function(a,b){if(p.enabled&&K.isWritable()){var d=c(b);d.url&&B.parse(d.url).protocol.match(/https?:/)&&f(d)}},scriptChangedCb:function(a,b,d){if(p.enabled&&K.isWritable()&&(a=c(b),a.url))for(var m in p.SYNCED)if(!0===p.SYNCED[m]&&b.options[m]!=d.options[m]){f(a);break}},scriptRemovedCb:function(a,b){if(p.enabled&&K.isWritable()){var f=c(b);f.url&&(D&&console.debug("sync: remove",f.name,f.url),K.remove(f))}}};
return p}();sycl=J;var La=function(){g.addChangeListener("scriptblocker_overwrite",H.init);g.addChangeListener("sync_enabled",J.configChangeListener);g.addChangeListener("sync_type",J.configChangeListener);g.addChangeListener("sync_id",J.configChangeListener);g.addChangeListener("sync_version",J.configChangeListener);g.addChangeListener("logLevel",function(){ua(g.values.logLevel)});g.addChangeListener("i18n",function(){e.setLocale(g.values.i18n)});g.addChangeListener("native_import_path",function(){N.setPath(g.values.native_import_path)});
g.addChangeListener("incognito_mode",function(){ya()});g.addChangeListener("require_blacklist",w.blackCheckAll);g.addChangeListener("script_blacklist_server",w.blackCheckAll);g.addChangeListener("script_blacklist_type",w.blackCheckAll);g.addChangeListener("downloads_extension_whitelist",I.config_changed_listener);g.addChangeListener("downloads_mode",I.config_changed_listener)},g=function(){var a={},d={enabled:!0,configMode:0,safeUrls:!0,tryToFixUrl:!0,debug:!1,logLevel:0,showFixedSrc:!1,webrequest_modHeaders:"yes",
webrequest_fixCSP:"yes",scriptblocker_overwrite:"no",notification_showUpdate:"changelog",notification_silentScriptUpdate:!0,script_templates:[{name:"ECMAScript 5",value:"// ==UserScript==\n// @name         New Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  try to take over the world!\n// @author       You\n// @match        <$URL$>\n// @grant        none\n// ==/UserScript==\n/* jshint -W097 */\n'use strict';\n\n// Your code here..."},{name:"ECMAScript 6",
value:"// ==UserScript==\n// @name         New ES6-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use babel compiler\n// @author       You\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser-polyfill.min.js\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.min.js\n// @match        <$URL$>\n// ==/UserScript==\n\n/* jshint ignore:start */\nvar inline_src = (<><![CDATA[\n/* jshint ignore:end */\n/* jshint esnext:true */\n\n// Your code here...\n\n/* jshint ignore:start */\n]]\x3e</>).toString();\nvar c = babel.transform(inline_src);\neval(c.code);\n/* jshint ignore:end */"},
{name:"CoffeeScript",value:"// ==UserScript==\n// @name         New Coffee-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use coffeescript compiler\n// @author       You\n// @require      http://coffeescript.org/extras/coffee-script.js\n// @match        <$URL$>\n// ==/UserScript==\n/* jshint ignore:start */\nvar inline_src = (<><![CDATA[\n\n// Your code here\n\n]]\x3e</>).toString();\nvar compiled = this.CoffeeScript.compile(inline_src);\neval(compiled);\n/* jshint ignore:end */"}],
scriptUpdateCheckPeriod:864E5,scriptUpdateHideNotificationAfter:15E3,scriptUpdateCheckDisabled:!1,scriptUrlDetection:"auto",runtime_fastDocumentStart:!0,runtime_strict_mode:"byscript",runtime_strong_mode:"default",autoReload:!1,appearance_badges:"running",appearance_badge_color:"gcal"===rea.runtime.short_id?"#444":"#ee3131",editor_enabled:!0,editor_keyMap:"windows",editor_indentUnit:4,editor_indentWithTabs:!1,editor_tabMode:"indent",editor_electricChars:!0,editor_autoSave:!1,editor_easySave:!0,native_import:!0,
native_import_path:null,native_import_post_action:"disable",i18n:null,action_menu_columns:2<=l.ACTIONMENU.COLUMNS?2:1,action_menu_scripts_hide_disabled:!1,action_menu_scripts_sort:"position",incognito_mode:"temporary",layout:"default",sync_enabled:!1,sync_type:2,sync_version:2,sync_id:"",handle_user_js:!0,downloads_mode:"default",downloads_extension_whitelist:"/^[^\\.]*$/ /\\.mp[34]$/ .wav /\\.(avi|mkv|flv|divx|mpe?g|webm)$/ /\\.(ico|gif|png|jpe?g)/ /\\.(srt|sub|idx)$/ .txt .iso .zip /\\.r(ar|[0-9]{2,2})$/".split(" "),
external_update_interval:6048E5,require_timeout:2E4,require_blacklist:["/^https?:\\/\\/example.com(:[0-9]{1,5})?\\/.*/"],script_blacklist_server:[],script_blacklist_type:"server",script_blacklist_severity:4,page_filter_mode:"black",page_whitelist:["/https?:\\/\\/greasyfork\\.org\\/.*/","http://xkcd.com/970/"],forbiddenPages:"*.paypal.tld/* https://*deutsche-bank-24.tld/* https://*bankamerica.tld/* /^.*:\\/\\/apis\\.google\\.com\\/((?!render)([^\\/]+)\\/)+([^\\/]+)?$/ *://www.facebook.com/plugins/* *://platform.twitter.com/widgets/*".split(" ")},
b=function(b,f){var c=n.getValue(l.CONSTANTS.STORAGE.CONFIG,{}),m=void 0===c[b]?d[b]:c[b];c[b]=f;n.setValue(l.CONSTANTS.STORAGE.CONFIG,c);a[b]&&JSON.stringify(m)!=JSON.stringify(f)&&a[b].forEach(function(a){try{a(b,m,f)}catch(c){console.warn("config: changeListener error",c)}})},h={init:function(){var a=k();h.values={};for(var f in d)d.hasOwnProperty(f)&&function(){var a=f;h.values.__defineGetter__(a,function(){var c=n.getValue(l.CONSTANTS.STORAGE.CONFIG,{});return void 0===c[a]?d[a]:c[a]});h.values.__defineSetter__(a,
function(c){b(a,c)})}();h.images={};h.images.icon="images/icon.png";h.initialized=!0;var c=Ka(),m;for(m in c){var r=c[m];window.setTimeout(function(){w.doSave({url:null,src:r,ask:!1,replace:!0,internal:!0})},1)}a.resolve();return a.promise()},getDefaults:function(){return d},addChangeListener:function(b,f){a[b]||(a[b]=[]);a[b].push(f)}};return h}(),Z=function(a,d){return fa(a,d,{internal:!0})},S=function(){var a={key:function(a,b){return l.CONSTANTS.PREFIX.EXTERNAL+v.select([a,b?M.MD5(b):null],function(a){return a}).join(":")},
list:function(a){var b=RegExp("^"+a);return v.select(n.listValues(),function(a){return-1!=a.search(b)})},set:function(c,b,f){c=a.key(c,b);var d={};v.each(f,function(a,c){"content"==c&&(c="base",a=M.encodeS(a));d[c]=a});n.setValue(c,{ts:(new Date).getTime(),url:b,resource:d})},get:function(c,b){var f=a.key(c,b),f=n.getValue(f),d;if(f&&f.resource){var h={};v.each(f.resource,function(a,c){"base"==c&&(c="content",a=M.decodeS(a));h[c]=a});d={ts:f.ts,url:f.url,data:h}}return d},clean:function(c,b){var f=
a.key(c,b);n.deleteValue(f)},cleanAll:function(c,b){var f,d=a.list(a.key(c));if(b){var h={};v.each(b,function(b){b=a.key(c,b);h[b]=!0});f=[];v.each(d,function(a){h[a]||f.push(a)})}else f=d;f.forEach(function(a){n.deleteValue(a)})}},d=function(a,b){var f=k(),d={method:"GET",url:a,retries:l.XMLHTTPREQUEST.RETRIES,responseType:b.via_arraybuffer?"arraybuffer":void 0},h=function(d){var h={content:""};if(4!=d.readyState||200!=d.status&&0!=d.status)f.reject(h);else{var e,t=d.responseHeaders?d.responseHeaders.split("\n"):
null,g;for(g in t){var u=t[g].split(":"),q=u.shift()||"",u=u.join(":")||"";if("content-type"==q.trim().toLowerCase()&&-1!=u.search("image")){e=u.trim();break}}e||(-1!=a.search(".ico$")||-1!=a.search(".jpg$")?e="image/x-icon":-1!=a.search(".gif$")?e="image/gif":-1!=a.search(".png$")?e="image/png":v.isLocalImage(a)&&(e="image/x-icon"));h.meta=e;h.content=b.via_arraybuffer?M.arrbuf2str(d.response):d.responseText;f.resolve(h)}},e=function(){f.reject({})};b.sync?h(Z(d,{})):(d.timeout=g.values.require_timeout,
Z(d,{onload:h,onerror:e,ontimeout:e}));return f.promise()},b=v.getDebouncer(9E3),h=function(c,b,f){f.no_storage=!0;e(c,b,f).done(function(f){a.set(c,b,f.resource)}).fail(function(){}).always(function(){var f=a.get(c,b);f&&f.data?a.set(c,b,f.data):console.warn("externals: should never happen!")})},e=function(c,f,e){var t=k(),q=B.parse(f),p={sync:e.sync},E;if(f)if(aa.getEvilnessOf(f)>=g.values.script_blacklist_severity)p.resource={blacklisted:!0,content:""},t.reject(p);else if(!e.no_storage&&"file:"!==
q.protocol&&(E=a.get(c,f))){var G=a.key(c,f),C=(new Date).getTime();0<g.values.external_update_interval&&C-E.ts>g.values.external_update_interval&&!b.is(G)&&(1<g.values.external_update_interval&&b.add(G),D&&console.log("externals: resource needs update",f,(new Date(E.ts)).toISOString(),(new Date(C)).toISOString()),window.setTimeout(function(){h(c,f,e)},3E3));p.resource=E.data;t.resolve(p)}else p.sync=!1,"file:"==q.protocol&&-1==f.search(l.REQUESTS.GET_INTERNAL_PATH_REGEXP(!0))?(l.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||
console.warn("externals: Access to local files is forbidden! Loading the following @resource may fail:",f,"-> more info:","http://tampermonkey.net/faq.php#Q204"),E=xa.getSource({url:f,encoding:e.encoding})):E=d(f,{via_arraybuffer:e.via_arraybuffer}),E.done(function(b){!e.no_storage&&q.protocol&&"file:"!==q.protocol&&-1==f.search(l.REQUESTS.GET_INTERNAL_PATH_REGEXP(!0))&&a.set(c,f,b);p.resource=b;t.resolve(p)}).fail(function(a){D&&console.log("externals: get.failed",c,f,a);p.resource={failed:!0,content:""};
t.reject(p)});else p.resource={forbidden:!0,content:""},t.reject(p);return t.promise()},f={getElement:function(c,f){return a.get(c,f)},cleanElement:function(c,f){return a.clean(c,f)},dropAll:function(c){a.cleanAll(c);return k.Pledge()},dropAllBut:function(c,f){a.cleanAll(c,f);return k.Pledge()},loadResources:function(a,b){var d=k();f.getResources(a,b).always(function(){d.resolve()});return d.promise()},loadRequires:function(a,b){var d=k();f.getRequires(a,b).always(function(){d.resolve()});return d.promise()},
getResources:function(a,f){var b={elements:[]},d=k(),h=[],g={via_arraybuffer:!0,sync:!0};f.forEach(function(f){var d={name:f.name},m=e(a,f.url,g),u=k();m.done(function(a){a=a.resource;var c=[f.url,a.content.length].join(),b=U.items.resources.get(c)||{};try{d.resText=b.resText?b.resText:M.UTF8.decode(a.content)}catch(h){d.resText=""}try{d.resURL=b.resUrl?b.resURL:a.meta?"data:"+a.meta+";base64,"+M.Base64.encode(a.content):M.Base64.encode(a.content)}catch(h){d.resURL=f.url}U.items.resources.set(c,{resText:d.resText,
resURL:d.resURL})}).fail(function(a){a.resource&&a.resource.forbidden?console.warn("externals: can't load @resource",f.name,"from forbidden URL",f.unsafe_url):a.resource&&a.resource.blacklisted?console.warn("externals: can't load @resource",f.name,"from blacklisted URL",f.unsafe_url):console.warn("externals: can't load @resource",f.name,"from URL",f.unsafe_url);d.resText="";d.resURL=""}).always(function(a){g.sync&=a.sync;b.elements.push(d);u.resolve()});h.push(u)});k.when(h).always(function(){b.sync=
g.sync;d.resolve(b)});return d.promise()},getRequires:function(a,f){var b={elements:[]},d=k(),h=[],g={encoding:"UTF-8",sync:!0};v.each(f,function(f,d){var m={},u=e(a,f.url,g),l=k();u.done(function(a){m.textContent=a.resource.content||""}).fail(function(a){a.resource&&a.resource.forbidden?(m.textContent='// this @require ("'+encodeURIComponent(f.unsafe_url)+'") is not allowed!\n',console.warn("externals: can't load @require from forbidden URL",f.unsafe_url)):a.resource&&a.resource.blacklisted?(m.textContent=
'// this @require ("'+encodeURIComponent(f.unsafe_url)+'") is blacklisted!\n',console.warn("externals: can't load @require from blacklisted URL",f.unsafe_url)):(m.textContent='// this @require ("'+encodeURIComponent(f.unsafe_url)+'") could not be loaded!\n',console.warn("externals: can't load @require from URL",f.unsafe_url))}).always(function(a){g.sync&=a.sync;b.elements[d]=m;l.resolve()});h.push(l)});k.when(h).always(function(){b.sync=g.sync;b.elements=b.elements.filter(function(a){return a});d.resolve(b)});
return d.promise()}};return f}();exts=S;var wa=function(){var a=function(a,b,h){var e=k(),f=[];h.forEach(function(c){c=c.textContent||"";c=ka.mkCompat(c,a.options.compatopts_for_requires?a:null,"off"!=g.values.runtime_strict_mode);f.push(c)});h="\n"+f.join("\n")+"\n";var c=y.getStorageByUid(a.uuid);b=ka.mkCompat(b,a,"off"!=g.values.runtime_strict_mode);g.values.debug&&(b="debugger;\n"+b);e.resolve({header:a.header,code:b,requires:h,storage:c,script:a});return e.promise()};return{bundle:function(d,
b,h){var e={},f;for(f in b)"includes"!=f&&"matches"!=f&&"requires"!=f&&"resources"!=f&&"excludes"!=f&&"textContent"!=f&&("options"==f?(e[f]=JSON.parse(JSON.stringify(b[f])),e[f].run_at=e[f].run_at||b.options.override.orig_run_at||"document-idle"):e[f]=b[f]);return S.getResources(e.uuid,b.resources).then(function(a){h&&!a.sync&&(D&&console.warn("ri: uncached @external detected -> fast script start disabled"),h=a.sync);e.resources=a.elements;return S.getRequires(e.uuid,b.requires)}).then(function(c){h&&
!c.sync&&(D&&console.warn("ri: uncached @external detected -> fast script start disabled"),h=c.sync);c=c.elements;console.log("run script "+e.name+" @ "+d.url);return a(e,b.textContent,c)})}}}(),za=function(a){a&&(a+=(-1==a.search("\\?")?"?":"&")+"ts="+(new Date).getTime());return a},Aa=function(){var a=rea.extension.getViews({type:"popup"});a&&a.length&&rea.extension.sendMessage({method:"updateActions"},function(){})},ra=function(){return{getConfig:function(){var a={version:0,last:0},d={scripts:0},
b=n.getValue(l.CONSTANTS.STORAGE.UPDATE,d);"object"!==typeof b&&(b=d);b||(b=d);void 0==b.black&&(b.black=a);void 0==b.scripts&&(b.scripts=0);return b},setConfig:function(a){a&&n.setValue(l.CONSTANTS.STORAGE.UPDATE,a)}}}(),la=function(){var a=function(a,b){var h=0,t=0;if(a){var f=e.getMessage("Script_Update"),c=e.getMessage("Check_for_userscripts_updates")+"...";P.show(f,c,rea.extension.getURL("images/icon128.png"),1E4)}f=y.getUidList().map(function(a){var c,f,d,p,E;console.log("update: check for script updates @",
a);return function(){p=y.getByUid(a);if(!p.script||!p.cond)return console.warn("update: inconsistent script entry",a,p),k.Breach();var c=!g.values.scriptUpdateCheckDisabled&&!p.script.enabled&&!b;return b&&p.script.uuid!==b||c||!w.determineSourceURL(p.script)?k.Breach():k.Pledge()}().then(function(){var a=w.determineMetaURL(p,!0);if(!a)return k.Pledge();var c=k();fa({method:"GET",retries:l.XMLHTTPREQUEST.RETRIES,timeout:1E3*l.SCRIPT_DOWNLOAD.TIMEOUT,headers:{Accept:"text/x-userscript-meta"},url:a},
{ondone:function(f){4==f.readyState&&200==f.status?E=x.processMetaHeader(f.responseText):console.log("update: unable to find meta data @ "+a+" req.status = "+f.status);c.resolve()}});return c.promise()}).then(function(){var a=!!E,c=a&&!!E.version,f=c&&(!p.script.version||x.versionCmp(E.version,p.script.version)==x.versionCmp.eNEWER);return a&&c&&!f?k.Breach():k.Pledge()}).then(function(){var a=k(),c={method:"GET",retries:l.XMLHTTPREQUEST.RETRIES,timeout:1E3*l.SCRIPT_DOWNLOAD.TIMEOUT,url:w.determineSourceURL(p.script,
!0)};fa(c,{ondone:function(f){4==f.readyState&&200==f.status?a.resolve(f.responseText):(console.log("update: failed",p.script.name,c.url),a.reject())}});return a.promise()}).then(function(a){var b,e=p.script.uuid;b=x.createScriptFromSrc(a);b=b.name&&""!=b.name&&void 0!==b.version?(e=y.getMetaByUid(e))&&e.system?null:b.options.compat_uW_gmonkey?x.versionCmp.eERROR:-1!=b.name.search("@")?x.versionCmp.eERROR:e&&b.version==e.version?x.versionCmp.eEQUAL:e&&x.versionCmp(b.version,e.version)==x.versionCmp.eOLDER?
x.versionCmp.eOLDER:x.versionCmp.eNEWER:x.versionCmp.eERROR;return b==x.versionCmp.eNEWER?(h++,c=p.script.name,f=w.determineSourceURL(p.script),d=a,k.Pledge()):k.Breach()}).then(function(){if(g.values.notification_silentScriptUpdate)return k.Pledge();var a=e.getMessage("There_is_an_update_for_0name0_avaiable_",c)+"\n"+e.getMessage("Click_here_to_install_it_"),f=e.getMessage("Just_another_service_provided_by_your_friendly_script_updater_")+":",b=k();P.show(f,a,rea.extension.getURL("images/icon128.png"),
g.values.scriptUpdateHideNotificationAfter,b.resolve);return b.promise()}).then(function(c){var b=a||p.script.uuid;return void 0===c||c.clicked?w.doSave({url:f,uuid:b,replace:!b,src:d,ask:!g.values.notification_silentScriptUpdate}).done(function(a){a&&a.installed&&t++}):k.Breach()})});return k.sidebyside(f).then(function(){0==h&&a&&(D&&console.debug("No update found"),P.show("Narf!",e.getMessage("No_update_found__sry_"),rea.extension.getURL("images/icon128.png"),1E4));return{found:h,installed:t}})};
return{check:function(d,b,h){if(!d&&!g.values.scriptUpdateCheckPeriod)return k.Breach();var t=ra.getConfig();if(!d&&(new Date).getTime()-t.scripts<g.values.scriptUpdateCheckPeriod)return k.Breach();var f=k();d=function(){c&&(window.clearTimeout(c),c=null);m&&m.cancel();a(b,h).done(function(a){f.resolve(a.installed)}).fail(function(){f.resolve(null)});t=ra.getConfig();t.scripts=(new Date).getTime();ra.setConfig(t)};var c,m,r=function(){m=null;var a=e.getMessage("Script_Update"),c=e.getMessage("Waiting_for_sync_to_finish")+
"...";m=P.show(a,c,rea.extension.getURL("images/icon128.png"),6E4)};J.enabled?(J.addSyncDoneCallback(d),J.sync(50,!1),b&&(c=window.setTimeout(r,500))):d();return f.promise()}}}();trup=la;var w=function(){var a=function(a){a.sort(function(a,f){return a.position-f.position});return a},d=function(a){void 0===a.ask&&(a.ask=!0);if(void 0===a.url||null==a.url)a.url="";""===a.force_url&&(a.force_url=null);var c=x.createScriptFromSrc(a.src),b=null,d={heading:null,errors:[],info:[],warnings:[],flags:{}},h=
k(),q=(new Date).getTime(),p=a.save&&!a.ask&&g.values.editor_easySave,l=a.uuid,G;c.name&&void 0!=c.version?G=k.Pledge():(d.errors.push(e.getMessage("Invalid_UserScript__Sry_")+"\n\n"),a.name&&d.errors.push(e.getMessage("Script_name_0url0",a.name)+"\n\n"),a.url&&d.errors.push(e.getMessage("Downloaded_from_0url0",a.url)),console.warn("scriptman: invalid userscript",d,c),G=k.Breach());G.then(function(){a.replace&&!l&&(l=y.getUidsByName(c.name,c.namespace)[0]);if(l)b=y.getMetaByUid(l);else if(c.uuid)l=
c.uuid;else if(a.replace)l=v.createUUID();else return console.error("scriptman: neither UUID, @uuid nor replace option set"),k.Breach();if(""!==l.replace(/[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}/,""))return console.error("scriptman: invalid UUID",l),k.Breach();if(!a.clean&&!a.defaultscript&&b&&b.system)return k.Breach()}).then(function(){if(a.clean&&a.name&&a.name!=c.name||-1!=c.name.search("\n"))return d.errors.push(e.getMessage("Invalid_UserScript_name__Sry_")),k.Breach()}).then(function(){if(c.options.compat_uW_gmonkey)return d.errors.push(e.getMessage("This_script_uses_uW_gm_api_")),
k.Breach()}).then(function(){if(b){b.name!=c.name&&(d.flags.renamed=!0);if(b.lastModified&&void 0!==a.lastModified&&b.lastModified!==a.lastModified){var h=e.getMessage("some_secs");try{var g=Math.max(1,Math.floor((q-b.lastModified)/1E3));isNaN(g)||(h=g)}catch(t){}d.warnings.push(e.getMessage("CONFLICT__This_script_was_modified_0t0_seconds_ago_",h));d.flags.forceAsk=!0}c.version==b.version&&(a.save?d.flags.modification=!0:d.flags.reset=!0);a.clean&&(d.flags.factory=!0)}else d.flags.first_install=!0;
c.includes.length||c.matches.length||(h="/"+B.staticVars.urlAllHttp_+"/",p||a.internal||d.warnings.push(e.getMessage("This_script_does_not_provide_any__include_information_")+"\n"+e.getMessage("AWE_assumes_0urlAllHttp0_in_order_to_continue_",h)),c.includes.push(h));d.flags.sync=!!a.sync;d.flags.internal=a.internal;d.flags.ask=a.ask}).then(function(){c.uuid=l;c.lastUpdated=a.force_meta&&a.force_meta.lastModified||q;c.system=a.defaultscript;c.evilness=w.getEvilness(c);c.position=w.determineLastPosition()+
1;d.flags.factory||d.flags.reset||(a.force_url&&(c.updateURL=null,c.downloadURL=a.force_url),b&&(c.options.override=b.options.override,c.options.comment=b.options.comment));c.options.override.orig_includes=c.includes;c.options.override.orig_excludes=c.excludes;c.options.override.orig_matches=c.matches;c.options.override.orig_noframes=c.options.noframes;c.options.override.orig_run_at=c.options.run_at||"document-idle";c.options.noframes=null;c.options.run_at=null}).then(function(){if(b&&(c.fileURL=
b.fileURL,c.position=b.position,b.sync&&(c.sync=b.sync),!d.flags.factory&&!d.flags.reset)){c.enabled=b.enabled;c.options.noframes=b.options.noframes;c.options.run_at=b.options.run_at;c.options.awareOfChrome||(c.options.compat_forvarin=b.options.compat_forvarin);a.save&&!a.force_url&&(c.downloadURL=b.downloadURL||c.downloadURL);var h=t.determineMetaURL(b),g=t.determineMetaURL(c),h=h?B.woHash(h):h,g=g?B.woHash(g):g;h==g||p||a.internal||d.warnings.push(e.getMessage("The_update_url_has_changed_from_0oldurl0_to__0newurl0",
[h,g]))}}).then(function(){if(b&&!d.flags.factory&&c.version==b.version&&(a.defaultscript||a.noreinstall))return k.Breach()}).then(function(){b?(d.flags.factory||d.flags.reset?(d.flags.reset?(d.heading=e.getMessage("You_are_about_to_reinstall_a_UserScript_"),d.flags.reinstall=!0):(d.heading=e.getMessage("You_are_about_to_install_a_UserScript_"),d.flags.install=!0),a.internal||d.warnings.splice(0,0,e.getMessage("All_script_settings_will_be_reset_"))):d.flags.modification?d.heading=e.getMessage("You_are_about_to_modify_a_UserScript_"):
x.versionCmp(c.version,b.version)==x.versionCmp.eOLDER?(d.heading=e.getMessage("You_are_about_to_downgrade_a_UserScript"),d.flags.downgrade=!0,p||a.internal||d.warnings.splice(0,0,e.getMessage("The_downgraded_script_might_have_problems_to_read_its_stored_data_"))):(d.heading=e.getMessage("You_are_about_to_update_a_UserScript_"),d.flags.update=!0),d.info.push({label:e.getMessage("Installed_Version_"),value:"v"+b.version})):(d.heading=e.getMessage("You_are_about_to_install_a_UserScript_"),p||a.internal||
d.info.splice(0,0,e.getMessage("Malicious_scripts_can_violate_your_privacy_")),d.flags.install=!0);d.flags.install?d.action=e.getMessage("Install"):d.flags.reinstall?d.action=e.getMessage("Reinstall"):d.flags.modification?d.action=e.getMessage("Modify"):d.flags.downgrade?d.action=e.getMessage("Downgrade"):d.flags.update&&(d.action=e.getMessage("Update"))}).then(function(){a.url&&(c.fileURL=a.url);a.sync&&(c.sync=a.sync);a.force_options&&v.copy(a.force_options,c.options,(new x.Script).options,!0);
a.force_settings&&v.copy(a.force_settings,c,["enabled","position"]);c=w.mergeCludes(c)}).then(function(){var a=!1,b;for(b in c.options)if(-1!=b.search("compat_")&&!0===c.options[b]){a=!0;break}a&&d.info.push({label:e.getMessage("Note"),value:e.getMessage("A_recheck_of_the_GreaseMonkey_FF_compatibility_options_may_be_required_in_order_to_run_this_script_")})}).then(function(){["requires","resources"].forEach(function(a){c[a]=v.map(c[a],function(a){a.unsafe_url=a.url;a.url=B.sanitize(a.unsafe_url,c.fileURL?
c.fileURL.split("/").slice(0,-1).join("/"):null);return a})})}).done(function(){h.resolve({script:c,messages:d,short_info:[{label:e.getMessage("Author"),prop:"author"},{label:e.getMessage("Description"),prop:"description"},{label:e.getMessage("Source"),prop:"fileURL"}]})}).fail(function(){h.reject({messages:d})});return h.promise()},b=function(a){var c=k(),b=a.messages,d=a.script,h=!b.flags.internal,e=function(){var a=t.doModify(d.uuid,d,h)||{};(b.flags.first_install||b.flags.factory)&&y.setStorageByUid(d.uuid,
{ts:(new Date).getTime()});return a},g={lastModified:void 0,installed:!0,renamed:b.flags.renamed};b.warnings.length||b.flags.ask?ia.install(a).done(function(a){a.ok&&e();g.installed=a.ok;g.aborted=a.aborted;c.resolve(g)}).fail(function(a){c.reject(a)}):(e(),c.resolve(g));return c.promise()},h=v.getDebouncer(1E3),t={determineSourceURL:function(a,c){if(!a)return null;var b=v.select([a.downloadURL,a.fileURL],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0];return b&&c?za(b):b},determineMetaURL:function(a,
c){if(!a)return null;var b;a.fileURL&&(b=a.fileURL.replace(".user.js",".meta.js"),a.fileURL==b&&(b=a.fileURL.replace(".acestream.js",".meta.js")),a.fileURL==b&&(b=null));return(b=v.select([a.updateURL,a.downloadURL,b],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0])&&c?za(b):b},mergeCludes:function(a){var c,b,d=a.options.override;a.includes=d.merge_includes&&d.orig_includes?d.orig_includes.slice():[];a.excludes=d.merge_excludes&&d.orig_excludes?d.orig_excludes.slice():[];a.matches=
d.merge_matches&&d.orig_matches?d.orig_matches.slice():[];for(c=0;c<d.use_includes.length;c++)b=a.excludes.indexOf(d.use_includes[c]),0<=b&&a.excludes.splice(b,1),a.includes.push(d.use_includes[c]);if("undefined"!==typeof d.use_matches)for(c=0;c<d.use_matches.length;c++)b=a.excludes.indexOf(d.use_matches[c]),0<=b&&a.excludes.splice(b,1),a.matches.push(d.use_matches[c]);for(c=0;c<d.use_excludes.length;c++)a.excludes.push(d.use_excludes[c]);return a},doSave:function(a){return d(a).then(b)},doRemove:function(a,
c){y.removeByUid(a,c);y.setStorageByUid(a,null);S.dropAll(a);return k.Pledge()},doModify:function(a,c,b){void 0===b&&(b=!0);y.setByUid(a,c,b);return b?S.loadResources(a,c.resources).then(function(){return S.loadRequires(a,c.requires)}).then(function(){return S.dropAllBut(a,v.map([].concat(c.resources).concat(c.requires),function(a){return a.url}))}):k.Pledge()},exportToJson:function(a,c){var b=k(),d=w.determineScriptsToRun(null);a&&(d=v.select(d,function(c){return a[c.uuid]}));d=sa(d,!0);c&&!c.storage||
d.forEach(function(a){a.storage=y.getStorageByUid(a.uuid)});d={scripts:d};if(!c||c.global_settings)d.global_settings=n.getValue(l.CONSTANTS.STORAGE.CONFIG,{});b.resolve(d);return b.promise()},importFromJson:function(a){if(!a||!a.scripts||!a.scripts.length)return k.Breach();for(var c={},h=[],e={},g=0,t;t=a.scripts[g];g++)try{var p=k();"new-user-script"!=t.uuid&&(t.storage&&(e[t.uuid]=t.storage),d({uuid:t.uuid,name:t.name,src:t.source,force_settings:{enabled:t.enabled,position:t.position},force_options:t.options,
force_meta:{lastModified:t.lastModified},replace:!0,url:t.file_url||t.update_url,ask:!1}).done(function(a){c[v.createUUID()]=a;p.resolve()}).fail(function(a){console.warn("import: Error @ script",t.name,a);p.resolve()}),h.push(p.promise()))}catch(G){console.log("import: Error while importing script",t.name,G)}var E=function(){var a=k();k.when(h).always(function(){a.resolve()});return a.promise()}().then(function(){return ia.import(c,a.global_settings)}).then(function(a){var f=k(),d=[],h=[];if(a.ok)for(var m=
0,g;g=a.import_ids[m];m++)(function(){var a=g;if(c[a]){c[a].messages.warnings=[];var f=b(c[a]).done(function(){var b;(b=c[a].script.uuid)&&e[b]&&(b=y.setStorageByUid(b,{data:e[b].data||{},ts:(new Date).getTime()}),h.push(b))});d.push(f)}})();k.when(d).always(function(){w.reorderScripts();k.when(h).always(function(){f.resolve(a)})});return f.promise()}).then(function(c){return a.global_settings&&c.global_settings?(c=n.setValue(l.CONSTANTS.STORAGE.CONFIG,a.global_settings).then(function(){E.done(function(){window.setTimeout(V.reset,
1)});return k.Pledge({global_settings:!0})}),n.setTemporary(!0),c):k.Pledge({})});return E},installFromUrl:function(a,c,b){var d=k(),g=B.parse(a),q={messages:{errors:[e.getMessage("Unable_to_load_script_from_url_0url0",a)],warnings:[]}};c=c||{};b=b||{};var p=[a,JSON.stringify(c)].join("_");if(h.is(p))return D&&console.log("scriptman: de-bounced installFromUrl",a),k.Breach();h.add(p);if(!g.protocol.match(/(https?|file):/))return console.warn("scriptman: can't install from ",a),k.Breach(q);"file:"!=
g.protocol||l.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||console.warn("scriptman: Access to local files is forbidden! Loading the following script for installation may fail:",a,"-> more info:","http://tampermonkey.net/faq.php#Q204");var E=function(a,c){if(!a)if(c)a=q,"file:"!=g.protocol||l.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||a.messages.warnings.unshift(e.getMessage("AWE_has_no_file_access_permission_"));else{d.reject();return}a.heading=e.getMessage("You_are_about_to_install_a_UserScript_");b.silent_fail?d.reject(a):
ia.installError(a).always(function(a){d.reject(a)})},p=function(a){E(null,a)};Z({method:"GET",retries:l.XMLHTTPREQUEST.RETRIES,timeout:1E3*l.SCRIPT_DOWNLOAD.TIMEOUT,url:a},{onload:function(b){if(4==b.readyState)if(200==b.status||0==b.status){var h={url:a,src:b.responseText,ask:!0,replace:!0};c&&v.each(c,function(a,b){h[b]=c[b]});t.doSave(h).done(function(a){d.resolve(a.installed)}).fail(E)}else d.reject()},onerror:p,ontimeout:p});return d.promise()},determineLastPosition:function(){var a=0;y.getUidList().forEach(function(c){var b=
y.getByUid(c);b.script&&b.cond?b.script.position&&b.script.position>a&&(a=b.script.position):console.warn("scriptman: inconsistent script entry",c)});var c=new x.Script;c.position>a&&(a=c.position);return a},matchUrl:function(a,c,b){var d,h;try{!b&&1<c.length&&"/"==c.substr(0,1)?d=RegExp(".*"+c.replace(/^\//g,"").replace(/\/$/g,"")+".*","i"):b?(h=B.getRegExpFromMatch(c),d=RegExp(h)):(h=B.getRegExpFromInclude(c,{tryToFixUrl:g.values.tryToFixUrl,safeUrls:g.values.safeUrls}),d=RegExp(h,"i"))}catch(e){return console.warn("scriptman: invalid regexp ",
c),!1}return""===a.replace(d,"")},validUrl:function(a,c,b){var d,h=!1;if(c.inc||c.match){for(d in c.inc)if("string"!==typeof c.inc[d])console.warn("scriptman: include["+d+'] "'+c.inc[d]+'" '+(b?"@"+b+" ":"")+"can't be compared to \""+a+'"');else if(t.matchUrl(a,c.inc[d])){D&&console.log('scriptman: @include "'+c.inc[d]+'" matched'+(b?" ("+b+")":'"'));h=!0;break}if(c.match)for(d in c.match)if("string"!==typeof c.match[d])console.warn("scriptman: match["+d+'] "'+c.match[d]+'" '+(b?"@"+b+" ":"")+"can't be compared to \""+
a+'"');else if(t.matchUrl(a,c.match[d],!0)){D&&console.log('scriptman: @match "'+c.match[d]+'" matched'+(b?" ("+b+")":'"'));h=!0;break}if(!h)return h}else h=!0;for(d in c.exc)if(t.matchUrl(a,c.exc[d])){D&&console.log('scriptman: @exclude "'+c.exc[d]+'" matched'+(b?" ("+b+")":'"'));h=!1;break}return h},getEvilness:function(a){var c=0;return a.fileURL&&(c=aa.getEvilnessOf(a.fileURL))||a.downloadURL&&(c=aa.getEvilnessOf(a.downloadURL))||a.updateURL&&(c=aa.getEvilnessOf(a.updateURL))?(D&&console.log("scriptman: found blacklisted script",
a),c):0},blackCheckAll:function(){y.getUidList().forEach(function(a){var c=y.getByUid(a);if(c.script&&c.cond){var b=w.getEvilness(c.script);b!==c.script.evilness&&((b||void 0!==c.script.evilness)&&D&&console.log("scriptman: write blacklist state of ",c.script.name,b),c.script.evilness=b,t.doModify(a,c.script,!1))}})},reorderScripts:function(b,c){var d=t.determineScriptsToRun();if(b)for(var h=0;h<d.length;h++){var e=d[h];e.uuid==b&&(e.position=Number(c)+(e.position<c?.5:-.5))}d=a(d);h=1;for(e=0;e<
d.length;e++){var g=d[e];g.position=h++;t.doModify(g.uuid,g,!1)}},getUniqueScriptsForTab:function(a){var c=[];A.get.empty(a.id)?console.warn("bg: WARN: Tabs.get.urls["+a.id+"] is empty!"):v.each(A.get.urls(a.id),function(a,b){if(ja.isAllowed(b))for(var d=w.determineScriptsToRun(b),f=0;f<d.length;f++){for(var h=!1,e=0;e<c.length;e++)if(c[e].uuid==d[f].uuid){h=!0;break}h||c.push(d[f])}});return c},determineScriptsToRun:function(b){var c=[];D&&console.log("scriptman: determineScriptsToRun @"+b);y.getUidList().forEach(function(a){if(b){var d=
n.getValue(l.CONSTANTS.PREFIX.COND+a,null);if(!d||!t.validUrl(b,d,a))return}d=y.getByUid(a);d.script&&d.cond?c.push(d.script):console.warn("scriptman: inconsistent script entry",a,d)});return a(c)},isContexter:function(a){return a.options&&("context-menu"===a.options.run_at||null===a.options.run_at&&"context-menu"===a.options.override.orig_run_at)},determineOrigin:function(a){if(a=a.fileURL||a.downloadURL||a.updateURL){var b=a.match(/https?:\/\/userscripts\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/)||
a.match(/https?:\/\/userscripts-mirror\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/);if(b&&3==b.length)return{id:b[2],token:"uso",url:"http://userscripts-mirror.org/scripts/show/"+b[2],issue_url:"http://contactbyweb.com/userscripts-mirror"};if((b=a.match(/https?:\/\/greasyfork\.org\/scripts\/([^/]+)\/code\/.*\.user\.js/))&&2==b.length)return{id:b[1],token:"gf",url:"https://greasyfork.org/scripts/"+b[1],issue_url:"https://greasyfork.org/scripts/"+b[1]+"/feedback"};if((b=a.match(/https?:\/\/openuserjs\.org\/install\/([^/]+)+\/(.*)\.user\.js/))&&
3==b.length)return b.shift(),{id:b.join("/"),token:"ouj",url:"https://openuserjs.org/scripts/"+b[0]+"/"+b[1],issue_url:"https://openuserjs.org/scripts/"+b[0]+"/"+b[1]+"/issues"};if((b=a.match(/https?:\/\/monkeyguts\.com\/(codepages\/)?([0-9]{1,9})\.user\.js/))&&3==b.length)return{id:b[2],token:"mog",url:"https://monkeyguts.com/code.php?id="+b[2],issue_url:"https://monkeyguts.com/code.php?nav=rev&id="+b[2]};if((a=a.match(/https?:\/\/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/.*\.user\.js/)||a.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/raw\/.*\.user\.js/))&&
3==a.length)return a.shift(),{id:a.join("/"),token:"gh",url:"https://github.com/"+a.join("/"),issue_url:"https://github.com/"+a.join("/")+"/issues"}}}};return t}(),y=function(){var a=[],d={init:function(){n.addDifferentOriginChangeListener(l.CONSTANTS.PREFIX.STORE,function(a,h){if(h&&h.hasOwnProperty("value")&&h.origin){var e=a.replace(l.CONSTANTS.PREFIX.STORE,""),f;for(f in h.value.data)h.value.data.hasOwnProperty(f)&&function(){var a=f,b=h.value.data[f];d.notifyStorageListeners({uuid:e},null,function(d){var f=
{data:{},ts:0};f.data[a]=b;f.ts=h.value.data.ts;var e={storage:f};void 0===f.data[a]&&(e.removed=a);d(e)})}()}})},getUidList:function(){var a=RegExp("^"+l.CONSTANTS.PREFIX.SCRIPT_UID),d=[];n.listValues().forEach(function(e){-1!=e.search(a)&&d.push(e.replace(a,""))});return d},getUidsByName:function(a,h){var e=[];d.getUidList().forEach(function(f){var c=d.getMetaByUid(f);!c||c.name!=a||h&&h!=c.namespace||e.push(f)});return e},getUidByName:function(a){console.warn("sb: deprecated fn");return d.getUidsByName(a)[0]},
getStorageByUid:function(a){a=n.getValue(l.CONSTANTS.PREFIX.STORE+a,{ts:0,data:{}});"undefined"===typeof a.ts&&(a.ts=0);"undefined"===typeof a.data&&(a.data={});return a},setStorageByUid:function(a,d){return d?n.setValue(l.CONSTANTS.PREFIX.STORE+a,d):n.deleteValue(l.CONSTANTS.PREFIX.STORE+a)},getMetaByUid:function(a){return n.getValue(l.CONSTANTS.PREFIX.META+a,null)},getByUid:function(a){if(!a)return console.error("sb: no UUID set"),{};var d,e=n.getValue(l.CONSTANTS.PREFIX.META+a,null);if(e){var f=
function(a){if(a)for(var b=0,d=null;d=a[b];b++)delete d.loaded,delete d.textContent,delete d.resURL,delete d.resText};f(e.requires);f(e.resources);e.uuid=a;e.textContent=n.getValue(l.CONSTANTS.PREFIX.SCRIPT+a,e.textContent);e.textContent&&(d=e)}return{script:d,cond:n.getValue(l.CONSTANTS.PREFIX.COND+a,null)}},setByUid:function(a,d,e){var f={};if(!a)return console.error("sb: no UUID set",d),f;var c=n.getValue(l.CONSTANTS.PREFIX.META+a),g=!c;n.setValue(l.CONSTANTS.PREFIX.SCRIPT_UID+a,d.name);n.setValue(l.CONSTANTS.PREFIX.COND+
a,{inc:d.includes,match:d.matches,exc:d.excludes});n.setValue(l.CONSTANTS.PREFIX.SCRIPT+a,d.textContent);d.textContent=null;e&&(f.lastModified=(new Date).getTime(),d.lastModified=f.lastModified);n.setValue(l.CONSTANTS.PREFIX.META+a,d);e&&(ma.onScriptsChanged(),g?J.scriptAddedCb(d.name,d):J.scriptChangedCb(d.name,d,c));U.items.rundata.removeAll();return f},removeByUid:function(a,e){void 0===e&&(e=!0);var g=d.getByUid(a);n.deleteValue(l.CONSTANTS.PREFIX.SCRIPT_UID+a);n.deleteValue(l.CONSTANTS.PREFIX.COND+
a);n.deleteValue(l.CONSTANTS.PREFIX.SCRIPT+a);n.deleteValue(l.CONSTANTS.PREFIX.META+a);n.deleteValue(l.CONSTANTS.PREFIX.STORE+a);e&&(ma.onScriptsChanged(),g.script&&g.cond&&J.scriptRemovedCb(g.script.name,g.script));U.items.rundata.removeAll();return{}},addStorageListener:function(b,d,e,f,c){a.push({tabid:b,id:d,uuid:e,time:f,response:c})},removeStorageListeners:function(b,d){void 0===d&&(d=!0);var e=a;a=[];for(var f in e){var c=e[f];try{void 0!==b.tabid&&b.tabid!==c.tabid||void 0!==b.uuid&&b.uuid!==
c.uuid||void 0!==b.id&&b.id!==c.id?a.push(c):d&&c.response({})}catch(g){D&&console.debug("sb: listener clear for script",b,"failed! Page reload?!")}}},notifyStorageListeners:function(b,d,e){b=b||{};d=d||{};for(var f in a){var c=a[f];try{void 0!==d.uuid&&c.uuid===d.uuid||void 0!==d.tabid&&c.tabid===d.tabid||void 0!==d.id&&c.id===d.id||void 0!==b.tabid&&b.tabid!==c.tabid||void 0!==b.uuid&&b.uuid!==c.uuid||void 0!==b.id&&b.id!==c.id||e&&e(c.response)}catch(g){console.log("sb: listener notification for script",
b,"failed! Page reload?!")}}}};return d}();scbr=y;var Ba=function(){var a=function(a,b){var h=null,g=a.sender,f=this,c=function(b){try{a.postMessage(b)}catch(c){}};if("xhr"==b.method){var m=function(){a.disconnect()};b.details.convertBinary=!0;b.details.partialSize=b.details.partialSize||l.XMLHTTPREQUEST.PARTIAL_SIZE;var r={};Object.keys(b.callbacks).forEach(function(a){r[a]=function(b){b={data:b};b[a]=!0;c(b);"ondone"===a&&m()}});r.ondone||(r.ondone=m);fa(b.details,r)}else if("download"==b.method)I.start(b.details,
{onload:function(a){c({load:!0,data:a})},onprogress:function(a){c({progress:!0,data:a})},onerror:function(a){c({error:!0,data:a})},ontimeout:function(a){c({timeout:!0,data:a})},ondone:function(){a.disconnect()}});else if("addStorageListener"==b.method)g.tab?(y.addStorageListener(g.tab.id,b.id,b.uuid,(new Date).getTime(),c),h=function(){y.removeStorageListeners({uuid:b.uuid,id:b.id},!1)}):(console.log(e.getMessage("Unable_to_load_storage_due_to_empty_tabID_")),c({error:!0}));else if("removeStorageListener"==
b.method)g.tab?(y.removeStorageListeners({uuid:b.uuid,id:b.id}),c({error:!1})):(console.warn("Unable to remove storage listener due to empty tabID!"),c({error:!0}));else if("saveStorageKey"==b.method)g.tab?b.uuid&&(g=y.getStorageByUid(b.uuid),g.data[b.key]=b.value,g.ts=b.ts,y.setStorageByUid(b.uuid,g),y.notifyStorageListeners({uuid:b.uuid},{id:b.id},function(a){var c={data:{},ts:0};c.data[b.key]=b.value;c.ts=b.ts;var d={storage:c};void 0===c.data[b.key]&&(d.removed=b.key);a(d)})):console.log(e.getMessage("Unable_to_save_storage_due_to_empty_tabID_")),
c({});else if("openInTab"==b.method){var h=["active"],u={url:b.details.url};if(b.details.options){for(var k=0;k<h.length;k++)void 0!==b.details.options[h[k]]&&(u[h[k]]=b.details.options[h[k]]);b.details.options.insert&&(u.index=g.tab.index+1)}h=function(){f.disconnected=!0;f.tabId&&delete Y[f.tabId]};rea.tabs.create(u,function(a){f.tabId=a.id;Y[a.id]={onClose:function(){c({close:!0})}};c({success:!0,tabId:a.id})})}else if("nameTab"==b.method){if(f.tabId){var p=3,n=function(){A.listeners.once.whenReady(f.tabId,
function(){rea.tabs.sendMessage(f.tabId,{method:"setForeignAttr",attr:"name",value:b.name},function(a){a?c({name:b.name}):0<p--?n():D&&console.warn("foreignAttr: error setting attr")})})};n()}}else"closeTab"==b.method?(f.tabId&&Y[f.tabId]&&rea.tabs.remove(f.tabId),c({}),window.setTimeout(function(){try{f.disconnected||a.disconnect()}catch(b){}f.disconnected=!0},1E3)):"registerMenuCmd"==b.method&&(g.tab?(ba.add(g.tab.id,g.tab.url,b.name,b.accessKey,b.menuId,c),Aa(),h=function(){ba.clearById(b.menuId);
Aa()}):(console.log("Unable to register menu cmd due to empty tabID!"),c({run:!1})));h&&a.onDisconnect.addListener(h)};return function(d){if(F.late){var b={};d.onMessage.addListener(function(e){a.apply(b,[d,e])})}else F.registerLateCallback(function(){Ba(d)})}}(),ha={ping:{allow:{insecure:!0},exec:function(a,d,b){b({pong:!0,instanceID:va,config:{layout:g.values.layout}})}},newTab:{allow:{extpage:!0},exec:function(a,d,b){rea.tabs.create({url:a.url},function(a){b({tabId:a.id})})}},getTab:{allow:{script:!0},
exec:function(a,d,b){d.tab&&a.uid?(O[d.tab.id]||(O[d.tab.id]={}),O[d.tab.id][a.uid]||(O[d.tab.id][a.uid]={}),b({data:O[d.tab.id][a.uid]})):(console.log("bg: unable to process request",d,a),b({data:null}))}},getTabs:{allow:{script:!0},exec:function(a,d,b){if(a.uid){d={};for(var e in O)d[e]={},d[e]=O[e][a.uid];b({data:d})}else console.log("bg: unable to process request",d,a),b({data:null})}},setTab:{allow:{script:!0},exec:function(a,d,b){if(d.tab&&a.uid){O[d.tab.id]||(O[d.tab.id]={});var e={},g;for(g in a.tab)e[g]=
a.tab[g];O[d.tab.id][a.uid]=e}else console.log("bg: unable to process request",d,a);b({})}},focusTab:{allow:{script:!0},exec:function(a,d,b){(a=d&&d.tab?d.tab.id:null)?rea.tabs.update(a,{active:!0},function(){b({error:rea.runtime.lastError})}):b({error:"internal error"})}},closeTab:{allow:{script:!0},exec:function(a,d,b){var e=d&&d.tab?d.tab.id:null;e?rea.tabs.query({windowType:"normal"},function(a){1>=a.length?(console.warn("bg:","refused to close last tab!"),b({error:"refused to close last tab!"})):
rea.tabs.remove(e,function(){b({})})}):b({error:"internal error"})}},getEngineStatus:{allow:{script:!0},exec:function(a,d,b){X.getEngineStatus(function(a){b(a)})}},startJsPlayer:{allow:{script:!0},exec:function(a,d,b){X.startJsPlayer(function(a){b(a)})}},getAvailablePlayers:{allow:{script:!0},exec:function(a,d,b){X.getAvailablePlayers(a.params,function(a){b(a)})}},openInPlayer:{allow:{script:!0},exec:function(a,d,b){X.openInPlayer(a.params,a.playerId,function(a){b(a)})}},getDeviceId:{allow:{script:!0},
exec:function(a,d,b){X.getDeviceId(function(a){b(a)})}},getLocale:{allow:{script:!0},exec:function(a,d,b){a=chrome.i18n.getMessage("@@ui_locale");b(a)}},getConfig:{allow:{script:!0},exec:function(a,d,b){pa(a.name,b)}},getInstalledScripts:{allow:{script:!0},exec:function(a,d,b){Ha(b)}},registerContextMenuHandler:{allow:{script:!0},exec:function(a,d,b){Ga(function(){b()})}},checkNews:{allow:{script:!0},exec:function(a,d,b){if(a.url)for(a=da.getNewsForUrl(a.url),d=0;d<a.length;d++){var e,g=a[d].id;b=
[];var f="awe-notification-"+Math.ceil(1E6*Math.random());a[d].btnUrl&&(e=a[d].btnUrl,b.push({title:a[d].btnTitle||chrome.i18n.getMessage("show_more")}),b.push({title:chrome.i18n.getMessage("do_not_show_anymore")}));chrome.notifications.create(f,{type:"basic",title:a[d].title||"-",iconUrl:rea.extension.getURL("images/icon128.png"),message:a[d].text,buttons:b},function(a){R[a]={onClicked:function(){e&&chrome.tabs.create({url:e});da.markAsRead(g);chrome.notifications.clear(a,function(a){})},onButtonClicked:function(b){0===
b?(e&&chrome.tabs.create({url:e}),da.markAsRead(g)):1===b&&da.markAsRead(g);chrome.notifications.clear(a,function(a){})}}});window.setTimeout(function(){chrome.notifications.clear(f,function(a){})},15E3)}}},startEngine:{allow:{script:!0,extpage:!0},exec:function(a,d,b){console.log("start engine");chrome.runtime.sendNativeMessage("org.acestream.engine",{method:"start_engine"},function(a){console.log("start_engine response ",a);"function"===typeof b&&b(a)})}},copyToClipboard:{allow:{script:!0,extpage:!0},
exec:function(a,d,b){d.tab?ta.copy(a.data):console.log("bg: unable to process request",d,a);b({})}},setOption:{allow:{extpage:!0},exec:function(a,d,b){d="options"==d.extpage||"options"==a.origin;g.values[a.name]=a.value;d?W.create("options.settings").done(function(a){b({items:a,options:g.values})}).fail(function(a){b({error:a,options:g.values})}):b({})}},reportAnIssue:{allow:{extpage:!0},exec:function(a,d,b){var e,g;a.uuid&&(e=y.getByUid(a.uuid))&&e.script&&e.cond&&(d=w.determineOrigin(e.script),
"author"==a.to&&e.script.supportURL?(g={url:e.script.supportURL},d?[a.to,d.token,d.id].join(":"):[a.to,g.url].join(":")):d&&(g=d,[g.token,g.id].join(":")),g&&rea.tabs.create({url:g.issue_url||g.url,active:!0},function(){}));b({})}},begEvent:{allow:{extpage:!0},exec:function(a,d,b){if("dialog"==a.action)ca.dialog.shown(a.extra);else if("clicked"==a.action){var e,g;a.extra&&(e=a.extra.amount,g=a.extra.currency);ca.clicked(a.type,e,g)}else if(ca.button[a.action])ca.button[a.action](a.extra);else console.log("bg: Warning: unknown request ",
a);b({})}},buttonPress:{allow:{extpage:!0},exec:function(a,d,b){var e=function(){b({})};if("reset_simple"==a.name)V.reset(e);else if("reset_factory"==a.name)V.factoryReset(e);else if("create_tesla_data"==a.name)J.createTeslaData().done(function(a){ta.copy({content:M.UTF8.encode(a.join("<br>")),type:"html"});e()});else if("reset_chrome_sync"==a.name)J.reset().always(e);else if("install_tests"==a.name)(d=ga.framework.prepare(w.doSave,l.RUNTIME.BROWSER,e))&&console.error(d);else if("enabled"==a.name)g.values[a.name]=
!g.values[a.name],b({});else if("installFromUrl"==a.name)w.installFromUrl(a.data).always(function(){b({})});else if("externals_delete"==a.name)S.cleanElement(a.scriptuid,a.url),W.create("options.scripts").done(function(a){b({items:a,options:g.values})}).fail(function(a){b({error:a,options:g.values})});else if("run_script_updates"==a.name)if(a.scriptuid){var t;la.check(!0,!1,a.scriptuid).done(function(a){t=a}).always(function(){b({scriptuid:a.scriptuid,updatable:t})})}else la.check(!0,!0),b({});else console.log("bg: Warning: unknown button "+
a.name),b({})}},loadTree:{allow:{extpage:!0},exec:function(a,d,b){W.create(a.referrer,{complete:a.complete,uuid:a.uuid}).done(function(a){b({items:a,i18n:g.values.i18n,options:g.values,begging:ca.needed()})}).fail(function(a){b({error:a,options:g.values})})}},modifyScriptOptions:{allow:{extpage:!0},exec:function(a,d,b){if(a.uuid){var e="options"==d.extpage||"options"==a.origin,t=void 0==a.reload||1==a.reload,f=y.getByUid(a.uuid);if(f.script&&f.cond){var c=!1,m=new x.Script;Object.keys(m.options).forEach(function(b){"undefined"!==
typeof a[b]&&(f.script.options[b]=a[b])});Object.keys(m.options.override).forEach(function(b){-1!=b.search("merge_")&&"undefined"!==typeof a[b]&&(f.script.options.override[b]=a[b],c=!0)});"undefined"!==typeof a.enabled&&(f.script.enabled=a.enabled);"undefined"!==typeof a.includes&&(f.script.options.override.use_includes=a.includes,f.script.options.override.use_excludes=a.excludes,f.script.options.override.use_matches=a.matches,c=!0);c&&(f.script=w.mergeCludes(f.script));w.doModify(f.script.uuid,f.script).done(function(){t?
(void 0!==a.position&&w.reorderScripts(a.uuid,a.position),e?ha.loadTree.exec({referrer:"options.scripts"},d,b):rea.tabs.getSelected(null,function(c){W.create("actions").done(function(a){b({items:a,i18n:g.values.i18n,options:{enabled:g.values.enabled,layout:g.values.layout}})}).fail(function(){b({i18n:g.values.i18n,options:{enabled:g.values.enabled,layout:g.values.layout}})});a.uuid&&g.values.autoReload&&rea.tabs.sendMessage(c.id,{method:"reload",frameId:0},function(){})})):b({})}).fail(function(){b({})});
return!0}}b({})}},modifyNativeScript:{allow:{extpage:!0},exec:function(a,d,b){if(a.nid){var h=void 0==a.reload||1==a.reload;N.getUserscriptById(a.nid).then(function(b){if(b)if("installed"==a.actionid){if("false"==a.value)return N.uninstall(b)}else{if("enabled"==a.actionid)return N.setEnabled(b,a.value);if("imported"==a.actionid&&"true"==a.value){var f=N.getUserscriptSource(b);if(f)return w.doSave({src:f,ask:!0,replace:!0}).then(function(a){if(a.installed){if("disable"==g.values.native_import_post_action)return N.setEnabled(b,
!1);if("uninstall"==g.values.native_import_post_action)return N.uninstall(b)}});rea.tabs.sendMessage(d.tab.id,{method:"showMsg",msg:e.getMessage("Please_double_check_the_native_script_import_settings__")},function(){})}}else h=!1;return k.Pledge()}).always(function(){h?ha.loadTree.exec({referrer:"options.scripts"},d,b):b({})});return!0}b({})}},saveScript:{allow:{extpage:!0},exec:function(a,d,b){var h=void 0===a.reload||!!a.reload,t=function(a){h?W.create("options.scripts").done(function(c){a.items=
c;a.options=g.values;b(a)}).fail(function(a){b({error:a,options:g.values})}):b({})};if(a.clean){D&&console.debug("bg: clean userscript "+a.uuid);d=y.getByUid(a.uuid);var f=function(c){W.create("options.scripts").done(function(d){b({cleaned:c.installed,items:d,options:g.values});c.installed&&y.notifyStorageListeners({uuid:a.uuid},null,function(b){b({storage:y.getStorageByUid(a.uuid)})})}).fail(function(a){b({error:a,options:g.values})})};d.script&&d.cond?w.doSave({name:a.name,uuid:a.uuid,src:d.script.textContent,
clean:!0,ask:!0,save:!0}).always(function(a){f(a||{installed:!1})}):(console.error(e.getMessage("fatal_error")+" ("+a.uuid+")!!!"),f({installed:!1}))}else if(a.code){var c=b;h&&(c=function(a){w.reorderScripts();t(a)});a.new_script&&(a.uuid=v.createUUID());w.doSave({name:a.name,uuid:a.uuid,force_url:a.force_url,src:a.code,ask:!g.values.editor_easySave,lastModified:a.lastModified,save:!0}).always(function(a){c(a||{installed:!1})})}else w.doRemove(a.uuid),w.reorderScripts(),t({})}},exportToJson:{allow:{extpage:!0},
exec:function(a,d,b){w.exportToJson(a.ids,a.options).done(function(a){b({json:a})}).fail(function(){b({})})}},importFromJson:{allow:{extpage:!0},exec:function(a,d,b){var h=void 0===a.reload||!!a.reload;w.importFromJson(a.json).fail(function(a){b({error:a||e.getMessage("An_error_occured_during_import_")})}).done(function(a){var d={reload:a.global_settings};h&&!d.reload?W.create("options.scripts").done(function(a){d.items=a;d.options=g.values;b(d)}).fail(function(a){b({error:a,options:g.values})}):
b(d)})}},askCom:{allow:{extpage:!0},exec:function(a,d,b){ia.onMessage(a.data).always(function(a){a.i18n=g.values.i18n;a.options={statistics_enabled:!1};a.ext={version:rea.extension.manifest.version};b(a)})}},installScript:{allow:{insecure:!0},exec:function(a,d,b){if(d.tab){var h={};w.installFromUrl(a.url,{},{silent_fail:!0}).done(function(a){h={data:null,found:!0,installed:a}}).fail(function(a){h.err=a&&a.messages&&a.messages.errors?a.messages.errors[0]:e.getMessage("Unable_to_parse_this_")}).always(function(){b(h)})}else console.log(e.getMessage("Unable_to_install_script_due_to_empty_tabID_"))}},
execMenuCmd:{allow:{extpage:!0},exec:function(a,d,b){(a=ba.getById(a.id))?a.response({run:!0,menuId:a.id}):console.error("bg: Error: unable to find MC id "+a.id);b({})}},getWebRequestInfo:{allow:{script:!0},exec:function(a,d,b){d.tab?b({webRequest:L}):(console.log("Unable to run scripts due to empty tab id"),b({}))}},unLoad:{allow:{script:!0},exec:function(a,d){a.topframe||a.id&&A.events.unload(d.tab.id,d.tab.frameId,a.id)}},prepare:{allow:{script:!0},exec:function(a,d,b){if(d.tab){var e=a.topframe?
0:null,t=B.woHash(a.url);A.events.run(d.tab.id,e,a.id,t,function(f){f=v.select(f,function(a){return a});var c=[{m:"native",t:[I.staticVars.DEFAULT,I.staticVars.NATIVE]},{m:"disabled",t:[I.staticVars.OFF]},{m:"browser",t:[I.staticVars.CHROME]}].filter(function(a){if(-1!=a.t.indexOf(g.values.downloads_mode))return!0}).map(function(a){return a.m})[0]||"disabled",c={scripts:f,contexters:ma.getContexterCount(),raw:{},inIncognitoContext:rea.extension.inIncognitoContext,downloadMode:c,enforce_strict_mode:"on"==
g.values.runtime_strict_mode,use_strong_mode:"on"==g.values.runtime_strong_mode,logLevel:g.values.logLevel,version:rea.extension.manifest.version};if(a.raw&&f.length)for(f=0;f<a.raw.length;f++)c.raw[a.raw[f]]=Registry.getRaw(a.raw[f]);b(c);T.setIcon(d.tab.id);T.setBadge(d.tab.id)});return!0}b({});return!1}},scriptBlockerDetected:{allow:{script:!0},exec:function(a,d,b){a.xml_style_detected||-1!=a.url.search("\\.xml$")?console.warn("blocker: unable to get unsafeWindow..."):H.requestPermissionEx(function(a,
d){var f=a&&d?e.getMessage("Please_reload_this_page_in_order_to_run_your_userscripts_"):null;b({alert:f})});A.set.blocker(d.tab.id);T.setIcon(d.tab.id)}},notification:{allow:{script:!0,extpage:!0},exec:function(a,d,b){var e=a.image?a.image:rea.extension.getURL("images/icon128.png");(function(){var b=k();a.highlight&&d.tab?P.highlight(d.tab.id,b.resolve):b.resolve();return b.promise()})().then(function(){var b=k();a.text?P.show(a.title,a.text,e,a.timeout,b.resolve):b.resolve();return b.promise()}).always(function(a){b({clicked:a&&
a.clicked})})}},syntaxCheck:{allow:{script:!0,extpage:!0},exec:function(a,d,b){(function(){var a=k();Registry.require("hinter",function(){a.resolve(Registry.get("hinter"))});return a.promise()})().then(function(b){return b.hint(a.code,{maxerr:999},{})}).always(function(a){b({errors:a})})}},handler:function(a,d,b){if(!F.late)return F.registerLateCallback(function(){ha.handler(a,d,b)}),!0;var e=ha[a.method];if(e)if(e.allow&&e.exec){var g=rea.runtime.id,g=!l.REQUESTS.HAS_SENDER_ID&&d.tab||d.id===g,f=
null,c=l.REQUESTS.INTERNAL_PAGE_PROTOCOL+"//",m=l.REQUESTS.GET_INTERNAL_PAGE_REGEXP(),r=d.url?d.url:d.tab?d.tab.url:null,c=g&&(r?0==r.search(c):!0);g&&c&&(d.tab?(m=d.tab.url.match(m))&&2==m.length&&(f=m[1]):f="*",d.extpage=f);m="options"==f;if("background"==f||e.allow.insecure||e.allow.extpage&&c||e.allow.options&&m||e.allow.script&&g&&!c){if(e=e.exec(a,d,b),void 0!==e)return e}else return(!1!==a.topframe||!c&&!m)&&D&&console.warn("back: this context doesn't have the permission to call \""+a.method+
'"'),!1}else return console.log("b: invalid implementation of "+a.method),!1;else return console.log("back: unknown method "+a.method),!1;return!0}},Ma=function(){var a=[],d=["test"],b=!1;return{getLayouts:function(){b||(a.push({name:e.getMessage("Default"),value:"default"}),Registry.isDevVersion("helper")&&d.forEach(function(b){Registry.getRaw("layout/"+b+"/options.js")&&a.push({name:b.charAt(0).toUpperCase()+b.slice(1),value:b})}),b=!0);return a}}}(),ba=function(){var a=[];return{add:function(d,
b,e,g,f,c){a.push({tabId:d,url:b,name:e,accessKey:g,id:f,response:c})},list:function(){return a},listByTabId:function(d){var b={};return a.filter(function(a){return a.tabId==d&&!b[a.name]&&(b[a.name]=!0)})},clearByTabId:function(d){a=a.filter(function(a){return a.tabId!=d})},getByTabId:function(d){return a.filter(function(a){return a.tabId==d})[0]},clearById:function(d){a=a.filter(function(a){return a.id!=d})},getById:function(d){return a.filter(function(a){return a.id==d})[0]}}}(),Na=function(){return{create:function(){var a,
d,b,h,k,f,c,m,r,u,q,p,n,G;u=null;a={name:e.getMessage("General"),sub_menu_item:!0,items:[]};a.items.push({name:e.getMessage("Config_Mode"),id:"configMode",level:0,option:!0,select:[{name:e.getMessage("Novice"),value:0},{name:e.getMessage("Beginner"),value:50},{name:e.getMessage("Advanced"),value:100}],value:g.values.configMode,desc:e.getMessage("Changes_the_number_of_visible_config_options")});a.items.push({name:"Language",id:"i18n",level:0,option:!0,reload:!0,warning:{msg:e.getMessage("A_reload_is_required")},
select:[{name:"Browser Default",value:null},{name:"English",value:"en"},{name:"German - Deutsch",value:"de"},{name:"French - fran\u00e7ais",value:"fr"},{name:"Italian - italiano",value:"it"},{name:"Russian - \u0440\u0443\u0441\u0441\u043a\u0438\u0439",value:"ru"},{name:"Czech - \u010de\u0161tina",value:"cs"},{name:"Polish - polski",value:"pl"},{name:"Slovak - sloven\u010dina",value:"sk"},{name:"Spanish - espa\u00f1ol",value:"es"},{name:"Hungarian - magyar",value:"hu"},{name:"Portuguese (Brazil) - portugu\u00eas brasileiro",
value:"pt-br"},{name:"Chinese (Simplified) - \u4e2d\u6587\uff08\u7b80\u4f53\u4e2d\u6587\uff09",value:"zh_CN"},{name:"Chinese (Traditional) - \u4e2d\u6587\uff08\u7e41\u9ad4\uff09",value:"zh_TW"},{name:"Japanese - \u65e5\u672c\u8a9e",value:"ja"}],value:g.values.i18n,validation:{image:"info",opacity:.9,msg:e.getMessage("Your_language_is_not_supported__Click_here_to_get_intructions_how_to_translate_AWE_"),url:"http://awe.acestream.me/faq.php#Q500"}});a.items.push({name:e.getMessage("Make_includes_more_safe"),
id:"safeUrls",level:60,option:!0,checkbox:!0,enabled:g.values.safeUrls,desc:e.getMessage("Includes_more_safe_example")});a.items.push({name:e.getMessage("Fix_includes"),id:"tryToFixUrl",level:60,option:!0,checkbox:!0,enabled:g.values.tryToFixUrl,desc:e.getMessage("Fix_includes_example")});a.items.push({name:e.getMessage("Auto_reload_on_script_enabled"),level:20,id:"autoReload",option:!0,checkbox:!0,enabled:g.values.autoReload,desc:e.getMessage("Auto_reload_on_script_enabled_desc")});a.items.push({name:e.getMessage("Process .user.js scripts"),
level:0,id:"handle_user_js",option:!0,checkbox:!0,enabled:g.values.handle_user_js,desc:e.getMessage("Process both .acestream.js and .user.js files")});a.items.push({name:e.getMessage("Debug_scripts"),level:100,id:"debug",option:!0,checkbox:!0,enabled:g.values.debug,desc:""});a.items.push({name:e.getMessage("Show_fixed_source"),level:100,id:"showFixedSrc",option:!0,checkbox:!0,enabled:g.values.showFixedSrc,desc:""});a.items.push({name:e.getMessage("LogLevel"),id:"logLevel",level:0,option:!0,select:[{name:e.getMessage("Debug"),
value:60},{name:e.getMessage("Error"),value:0}],value:g.values.logLevel,desc:""});l.OPTIONS.NATIVE_SCRIPT_IMPORT&&(d={name:e.getMessage("Native_Script_Import"),sub_menu_item:!0,need_save:!0,items:[]},u={},g.values.native_import&&(u=!0===l.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS?{image:"button_ok",msg:e.getMessage("AWE_has_access_to_file_URIs")}:{image:"critical",msg:e.getMessage("AWE_needs_access_to_file_URIs__Visit_the_FAQ_"),url:"http://awe.acestream.me/faq.php#Q204"}),d.items.push({name:e.getMessage("Enable_Native_Script_Import"),
id:"native_import",level:0,option:!0,checkbox:!0,enabled:g.values.native_import,validation:u}),d.items.push({name:e.getMessage("Post_Import_Action"),id:"native_import_post_action",level:0,option:!0,select:[{name:e.getMessage("None"),value:"none"},{name:e.getMessage("Disable_Extension"),value:"disable"},{name:e.getMessage("Uninstall_Extension"),value:"uninstall"}],value:g.values.native_import_post_action,desc:e.getMessage("What_action_should_be_done_after_a_native_userscript_was_imported_sucessfully_")}),
u={},g.values.native_import&&(u=N.isPathValid()?{image:"button_ok",msg:e.getMessage("Everything_is_setup_correctly_")}:{image:"critical",msg:e.getMessage("AWE_needs_to_know_the_absolute_path_to_your_browser_profile_folder_Visit_the_FAQ_"),url:"http://awe.acestream.me/faq.php#Q205"}),d.items.push({name:e.getMessage("Browser_Profile_Path"),id:"native_import_path",level:0,option:!0,text:!0,width:2,value:g.values.native_import_path,validation:u}));l.OPTIONS.HAS_TESLA&&(p={name:e.getMessage("TESLA"),sub_menu_item:!0,
level:50,need_save:!0,items:[]},p.items.push({name:e.getMessage("Enable_TESLA"),id:"sync_enabled",level:50,option:!0,checkbox:!0,enabled:g.values.sync_enabled,desc:e.getMessage("AWE_External_Script_List_Access")}),b=[{name:"pastebin.com",value:K.types.ePASTEBIN,enable:{sync_id:!0,sync_version:!1,create_tesla_data:!0}},{name:"Chrome Sync",value:K.types.eCHROMESYNC,enable:{sync_id:!1,sync_version:!0,create_tesla_data:!1}}],l.SYNC.GOOGLE_DRIVE.SUPPORTED&&b.push({name:"Google Drive (Beta)",value:K.types.eGOOGLEDRIVE,
enable:{sync_id:!1,sync_version:!1,create_tesla_data:!1}}),p.items.push({name:e.getMessage("Sync_Type"),id:"sync_type",enabler:!0,level:50,option:!0,select:b,value:g.values.sync_type}),p.items.push({name:e.getMessage("Sync_Id"),id:"sync_id",enabledBy:"sync_type",level:50,text:!0,value:g.values.sync_id,option:!0}),p.items.push({name:e.getMessage("Sync_Version"),id:"sync_version",enabledBy:"sync_type",level:50,option:!0,select:[{name:"v1 - Legacy",value:1},{name:"v2 - Beta",value:2,warning:{msg:e.getMessage("This_sync_version_may_multiply_each_script_that_is_present_at_more_than_one_AWE_instance__Do_you_really_want_to_continue_")}}],
value:g.values.sync_version,desc:e.getMessage("Different_sync_versions_are_not_compatible_to_each_other_")}),p.items.push({name:e.getMessage("Create_Exportable_Data"),id:"create_tesla_data",enabledBy:"sync_type",button:!0,ignore:!0,level:60,warning:{msg:e.getMessage("Copy_exportable_data_to_clipboard_Ok_")}}));f={name:e.getMessage("Appearance"),sub_menu_item:!0,items:[]};f.items.push({name:e.getMessage("Layout"),id:"layout",level:0,option:!0,select:Ma.getLayouts(),value:g.values.layout,desc:""});
u={};"off"==g.values.notification_showUpdate&&(u={image:"critical",msg:e.getMessage("Are_you_sure_that_you_don_t_want_to_be_notified_of_updates_")});f.items.push({name:e.getMessage("Update_Notification"),id:"notification_showUpdate",level:50,option:!0,select:[{name:e.getMessage("Off"),value:"off"},{name:e.getMessage("Show_notification"),value:"notification"},{name:e.getMessage("Open_changelog"),value:"changelog"}],value:g.values.notification_showUpdate,validation:u});c={name:e.getMessage("Action_Menu"),
sub_menu_item:!0,items:[],level:50};c.items.push({name:e.getMessage("Hide_disabled_scripts"),id:"action_menu_scripts_hide_disabled",level:100,option:!0,checkbox:!0,enabled:g.values.action_menu_scripts_hide_disabled,desc:""});c.items.push({name:e.getMessage("Columns"),id:"action_menu_columns",level:50,option:!0,select:[{name:e.getMessage("1"),value:"1"},{name:e.getMessage("2"),value:"2"},{name:e.getMessage("3"),value:"3"}].filter(function(a){return a.value<=l.ACTIONMENU.COLUMNS}),value:g.values.action_menu_columns});
c.items.push({name:e.getMessage("Script_order"),id:"action_menu_scripts_sort",level:50,option:!0,select:[{name:e.getMessage("Position_"),value:"position"},{name:e.getMessage("Name"),value:"name"},{name:e.getMessage("Enabled"),value:"enabled"}],value:g.values.action_menu_scripts_sort});c.items.push({name:e.getMessage("Icon_badge_info"),id:"appearance_badges",level:50,option:!0,select:[{name:e.getMessage("Off"),value:"off"},{name:e.getMessage("Running_scripts"),value:"running"},{name:e.getMessage("Unique_running_scripts"),
value:"running_unique"},{name:e.getMessage("Disabled_scripts"),value:"disabled"}],value:g.values.appearance_badges});c.items.push({name:e.getMessage("Icon_badge_color"),id:"appearance_badge_color",level:100,color:!0,value:g.values.appearance_badge_color});b={name:e.getMessage("Editor"),sub_menu_item:!0,level:20,need_save:!0,items:[],warning:{msg:e.getMessage("A_reload_is_required")},reload:!0};b.items.push({name:e.getMessage("Enable_Editor"),id:"editor_enabled",level:100,option:!0,checkbox:!0,enabled:g.values.editor_enabled,
desc:""});b.items.push({name:e.getMessage("Key_Mapping"),id:"editor_keyMap",level:50,option:!0,select:[{name:e.getMessage("Windows"),value:"windows"},{name:e.getMessage("Emacs"),value:"emacs"},{name:e.getMessage("Vim"),value:"vim"}],value:g.values.editor_keyMap});b.items.push({name:e.getMessage("Indentation_Width"),id:"editor_indentUnit",level:50,option:!0,select:[{name:e.getMessage("1"),value:1},{name:e.getMessage("2"),value:2},{name:e.getMessage("3"),value:3},{name:e.getMessage("4"),value:4},{name:e.getMessage("5"),
value:5},{name:e.getMessage("6"),value:6},{name:e.getMessage("7"),value:7},{name:e.getMessage("8"),value:8},{name:e.getMessage("9"),value:9},{name:e.getMessage("10"),value:10},{name:e.getMessage("11"),value:11}],value:g.values.editor_indentUnit,desc:""});b.items.push({name:e.getMessage("Indent_with"),id:"editor_indentWithTabs",level:50,option:!0,select:[{name:e.getMessage("Tabs"),value:"tabs"},{name:e.getMessage("Spaces"),value:"spaces"}],value:g.values.editor_indentWithTabs,desc:""});b.items.push({name:e.getMessage("TabMode"),
id:"editor_tabMode",level:50,option:!0,select:[{name:e.getMessage("Classic"),value:"classic"},{name:e.getMessage("Smart"),value:"smart"},{name:e.getMessage("Indent"),value:"indent"}],value:g.values.editor_tabMode,desc:""});b.items.push({name:e.getMessage("Reindent_on_typing"),id:"editor_electricChars",level:50,option:!0,checkbox:!0,enabled:g.values.editor_electricChars,desc:""});b.items.push({name:e.getMessage("Enable_autoSave"),id:"editor_autoSave",level:20,option:!0,checkbox:!0,enabled:g.values.editor_autoSave,
desc:""});b.items.push({name:e.getMessage("Enable_easySave"),id:"editor_easySave",level:20,option:!0,checkbox:!0,enabled:g.values.editor_easySave,desc:""});k={name:e.getMessage("Script_Update"),sub_menu_item:!0,level:0,items:[]};k.items.push({name:e.getMessage("Check_disabled_scripts"),id:"scriptUpdateCheckDisabled",level:0,option:!0,checkbox:!0,enabled:g.values.scriptUpdateCheckDisabled,desc:""});k.items.push({name:e.getMessage("Dont_ask_me_for_simple_script_updates"),id:"notification_silentScriptUpdate",
level:80,option:!0,checkbox:!0,enabled:g.values.notification_silentScriptUpdate,desc:""});k.items.push({name:e.getMessage("Check_interval"),id:"scriptUpdateCheckPeriod",level:0,option:!0,select:[{name:e.getMessage("Never"),value:0},{name:e.getMessage("Every_Hour"),value:36E5},{name:e.getMessage("Every_6_Hours"),value:216E5},{name:e.getMessage("Every_12_Hour"),value:432E5},{name:e.getMessage("Every_Day"),value:864E5},{name:e.getMessage("Every_Week"),value:6048E5}],value:g.values.scriptUpdateCheckPeriod,
desc:""});k.items.push({name:e.getMessage("Hide_notification_after"),id:"scriptUpdateHideNotificationAfter",level:50,option:!0,select:[{name:e.getMessage("Never"),value:0},{name:e.getMessage("15_Seconds"),value:15E3},{name:e.getMessage("30_Seconds"),value:3E4},{name:e.getMessage("1_Minute"),value:6E4},{name:e.getMessage("5_Minutes"),value:3E5},{name:e.getMessage("1_Hour"),value:36E5}],value:g.values.scriptUpdateHideNotificationAfter,desc:""});h={name:e.getMessage("Externals"),sub_menu_item:!0,level:0,
items:[]};h.items.push({name:e.getMessage("Update_interval"),id:"external_update_interval",level:0,option:!0,select:[{name:e.getMessage("Always"),value:1},{name:e.getMessage("Every_Day"),value:864E5},{name:e.getMessage("Every_Week"),value:6048E5},{name:e.getMessage("Every_Month"),value:2592E6},{name:e.getMessage("Never"),value:0}],value:g.values.external_update_interval,desc:""});m={name:e.getMessage("Security"),sub_menu_item:!0,level:50,items:[]};l.OPTIONS.HAS_CSP&&(m.items.push({name:e.getMessage("Allow_overwrite_javascript_settings"),
id:"scriptblocker_overwrite",level:80,option:!0,select:[{name:e.getMessage("Yes"),value:"yes"},{name:e.getMessage("No"),value:"no"}],value:g.values.scriptblocker_overwrite,desc:e.getMessage("AWE_can_not_work_when_javascript_is_disabled")}),m.items.push({name:e.getMessage("Add_AWE_to_CSP"),id:"webrequest_fixCSP",level:80,option:!0,select:[{name:e.getMessage("Yes"),value:"yes"},{name:e.getMessage("No"),value:"no"}],value:g.values.webrequest_fixCSP,desc:e.getMessage("AWE_might_not_be_able_to_provide_access_to_the_unsafe_context_when_this_is_disabled")}),
m.items.push({name:e.getMessage("Allow_headers_to_be_modified_by_scripts"),id:"webrequest_modHeaders",level:80,option:!0,select:[{name:e.getMessage("Yes"),value:"yes"},{name:e.getMessage("Auto"),value:"auto"},{name:e.getMessage("No"),value:"no"}],value:g.values.webrequest_modHeaders,desc:""}));l.RUNTIME.INCOGNITO_MODE&&!rea.extension.inIncognitoContext&&(u="temporary"==g.values.incognito_mode?{}:{image:"critical",msg:"Permanent mode is still a BETA feature!"},m.items.push({name:e.getMessage("Store_data_in_incognito_mode"),
id:"incognito_mode",level:50,option:!0,select:[{name:e.getMessage("Temporary"),value:"temporary"},{name:e.getMessage("Permanent"),value:"permanent"}],value:g.values.incognito_mode,validation:u}));m.items.push({name:e.getMessage("Page_Filter_Mode"),id:"page_filter_mode",level:50,option:!0,select:[{name:e.getMessage("Off"),value:"off"},{name:e.getMessage("Blacklist"),value:"black"},{name:e.getMessage("Whitelist"),value:"white"},{name:e.getMessage("Both"),value:"black+white"}],value:g.values.page_filter_mode,
desc:""});m.items.push({name:e.getMessage("Whitelisted_Pages"),id:"page_whitelist",level:50,option:!0,input:!0,array:!0,value:g.values.page_whitelist,desc:""});m.items.push({name:e.getMessage("Blacklisted_Pages"),id:"forbiddenPages",level:50,option:!0,input:!0,array:!0,value:g.values.forbiddenPages,desc:""});r={name:e.getMessage("BlackCheck"),sub_menu_item:!0,level:50,items:[]};r.items.push({name:e.getMessage("Script_Blacklist_Source"),id:"script_blacklist_type",level:50,option:!0,select:[{name:e.getMessage("Off"),
value:"off"},{name:e.getMessage("Server_And_Manual"),value:"server"},{name:e.getMessage("Only_Manual"),value:"only_manual"}],value:g.values.script_blacklist_type});r.items.push({name:e.getMessage("Blacklist_Severity"),id:"script_blacklist_severity",level:50,option:!0,select:[{name:e.getMessage("severity_1"),value:1},{name:e.getMessage("severity_2"),value:2},{name:e.getMessage("severity_3"),value:3},{name:e.getMessage("severity_4"),value:4},{name:e.getMessage("severity_5"),value:5},{name:e.getMessage("severity_6"),
value:6},{name:e.getMessage("severity_7"),value:7},{name:e.getMessage("severity_8"),value:8},{name:e.getMessage("severity_9"),value:9},{name:e.getMessage("severity_10"),value:10}],value:g.values.script_blacklist_severity});r.items.push({name:e.getMessage("Manual_Script_Blacklist"),id:"require_blacklist",level:50,option:!0,input:!0,array:!0,value:g.values.require_blacklist,desc:""});if(l.OPTIONS.CAN_DOWNLOAD){var C=!1;u={};v.map("exe sh crx com bat scr".split(" "),function(a){return"name."+a}).forEach(function(a){C|=
I.is_whitelisted(a)});C&&(u={image:"critical",msg:e.getMessage("Your_whitelist_seems_to_include_executable_files_This_means_your_userscripts_may_download_malware_or_spyware_to_your_harddisk_")});G={name:e.getMessage("Downloads")+" BETA",sub_menu_item:!0,level:50,items:[]};G.items.push({name:e.getMessage("Download_Mode"),id:"downloads_mode",level:50,option:!0,select:v.select([{name:e.getMessage("Default"),value:I.staticVars.DEFAULT},{name:e.getMessage("Off"),value:I.staticVars.OFF},{name:e.getMessage("Native"),
value:I.staticVars.NATIVE},{name:e.getMessage("Browser_API"),value:l.DOWNLOAD.SUPPORTED?I.staticVars.CHROME:null}],function(a){return a.value}),value:g.values.downloads_mode,desc:e.getMessage("The_Browser_API_mode_requires_a_special_permission_")+'\n"Default" is "Native".'});G.items.push({name:e.getMessage("Whitelisted_File_Extensions"),id:"downloads_extension_whitelist",level:50,option:!0,input:!0,array:!0,value:g.values.downloads_extension_whitelist,desc:e.getMessage("Only_files_with_these_extensions_can_be_saved_to_the_harddisk_Be_careful_to_not_allow_file_extensions_that_represent_executables_at_your_operating_system_"),
validation:u})}q={name:e.getMessage("Experimental"),sub_menu_item:!0,level:80,items:[]};q.items.push({name:e.getMessage("strict_mode"),id:"runtime_strict_mode",level:80,option:!0,select:[{name:e.getMessage("Default"),value:"byscript"},{name:e.getMessage("Always"),value:"on"},{name:e.getMessage("Off"),value:"off"}],value:g.values.runtime_strict_mode});q.items.push({name:e.getMessage("strong_mode"),id:"runtime_strong_mode",level:80,option:!0,select:[{name:e.getMessage("Default"),value:"off"},{name:e.getMessage("Enabled"),
value:"on"}],value:g.values.runtime_strong_mode});u={name:e.getMessage("Userscripts"),sub_menu_item:!0,level:80,items:[]};u.items.push({name:e.getMessage("Script_URL_detection"),id:"scriptUrlDetection",level:80,option:!0,select:[{name:e.getMessage("Auto"),value:"auto"},{name:e.getMessage("Off"),value:"manual"}],value:g.values.scriptUrlDetection});u.items.push({name:e.getMessage("New_script_template_"),id:"script_templates",level:80,option:!0,input:!0,array:!0,named:!0,value:g.values.script_templates});
n={name:e.getMessage("Reset_Section"),sub_menu_item:!0,level:50,items:[]};n.items.push({name:e.getMessage("Restart_AWE"),id:"reset_simple",level:50,button:!0,reload:!0,value:0,warning:{msg:e.getMessage("This_will_Restart_AWE_Ok_")}});n.items.push({name:e.getMessage("Factory_Reset"),id:"reset_factory",level:80,button:!0,reload:!0,value:0,warning:{msg:e.getMessage("This_will_remove_all_scripts_and_reset_all_settings_Ok_")}});l.OPTIONS.HAS_TESLA&&n.items.push({name:e.getMessage("Chrome_Sync_Reset"),
id:"reset_chrome_sync",level:80,button:!0,reload:!0,value:0,warning:{msg:e.getMessage("This_will_remove_all_stored_data_from_google_sync_Ok_")}});ga&&n.items.push({name:"Install Tests",id:"install_tests",level:80,button:!0,reload:!1,ignore:!0,value:0,warning:{msg:"This will install a lot of test scripts!"}});return[a,f,c,k,h,void 0,p,d,void 0,b,m,r,G,u,q,n].filter(function(a){return!!a})}}}(),W=function(){return{create:function(a,d){a=a||"";d=d||{};var b=function(a){return k.onebyone(a).fail(function(){console.warn("tree: wait failed!")})},
h=function(a,b){for(var e=a.replace(/\.$/,"").split("."),g=t;e.length;){var h=e.shift();if(g[h]){if("function"===typeof g[h])return function(){return g[h](d,!b)};g=g[h];e.length||e.unshift("root")}else return console.warn("tree: unable to find",a,d),function(){return k.Pledge([])}}console.warn("tree: unable to find",a,d);return function(){return k.Pledge([])}},t={actions:{root:function(){var a=k();rea.tabs.getSelected(null,function(c){d.tab=c;b([h("actions.general"),h("actions.scripts"),h("actions.commands")]).done(function(b){a.resolve(b)}).fail(a.reject)});
return a.promise()},general:function(){var a=d.tab,b=a?a.url:null,h=b&&4<b.length&&""==b.substr(0,4).replace(/file|http/,"")?b:"",a=[],r={name:"enabled",sub_menu_item:!0,pos:"top",items:[]};r.items.push({name:e.getMessage("Enabled"),display:g.values.enabled?null:"greyed",id:"enabled",button:!0,reload:!0,enabler:!0});a.push(r);"manual"==g.values.scriptUrlDetection&&qa.isScriptUrl(b)&&r.items.push({name:e.getMessage("Install_this_script"),image:"script_download",id:"installFromUrl",data:b,button:!0,
reload:!0});b={name:"about",sub_menu_item:!0,pos:"bottom",items:[]};b.items.push({name:e.getMessage("Dashboard"),image:"utilities",url:rea.extension.getURL("options.html")+"?"+["url="+encodeURIComponent(h),"selected=dashboard"].join("&"),newtab:!0});a.push(b);return k.Pledge(a)},scripts:function(){var a=d.tab,b=a?a.url:null,h=[],r=b&&4<b.length&&""==b.substr(0,4).replace(/file|http/,"")?b:"",u,q={name:"scripts",sub_menu_item:!0,pos:"center",items:[]},a=w.getUniqueScriptsForTab(a),p=ea.getContexters(0,
null),a=sa([].concat(a).concat(p)),t;"position"!=g.values.action_menu_scripts_sort&&("name"==g.values.action_menu_scripts_sort?t=function(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:a.name.toLowerCase()>b.name.toLowerCase()?1:0}:"enabled"==g.values.action_menu_scripts_sort&&(t=function(a,b){return b.enabled-a.enabled}));g.values.action_menu_scripts_hide_disabled&&(a=a.filter(function(a){return a.enabled}));t&&a.sort(t);!g.values.action_menu_scripts_hide_disabled&&2<Math.min(g.values.action_menu_columns,
l.ACTIONMENU.COLUMNS)?(u={name:"scripts_right",sub_menu_item:!0,pos:"right",items:[]},a.forEach(function(a){(a.enabled?q:u).items.push(a)}),h.push(q),u.items.length&&h.push(u)):(u=q,q.items=q.items.concat(a),h.push(q));g.values.enabled&&!a.length&&b&&(ja.isAllowed(b)?q.items.push({name:e.getMessage("No_script_is_running"),image:"info"}):q.items.push({name:e.getMessage("This_page_is_blacklisted_at_the_security_settings"),image:"critical"}));b=e.getLocale();g.values.enabled&&("3"==g.values.action_menu_columns||
100>g.values.configMode||!a.length)&&(q.items.push({name:e.getMessage("Get_new_scripts___"),image:"script_download",url:"http://awe.acestream.me/",newtab:!0}),q.items.push({name:e.getMessage("Add_new_script___"),image:"script_add",url:rea.extension.getURL("options.html")+"?url="+encodeURIComponent(r)+"#open=new-user-script",newtab:!0}));return k.Pledge(h)},commands:function(){var a=d.tab,b=[];e.getLocale();var g={name:"commands",id:"commands",sub_menu_item:!0,pos:"left",items:[]},h=a.id,a=[],h=null==
h||void 0==h?ba.list():ba.listByTabId(h),u;for(u in h)if(h.hasOwnProperty(u)){var l=h[u];a.push({name:l.name,id:l.id,accessKey:l.accessKey,image:"menu_cmd",menucmd:!0})}a.length&&(g.items=a);g.items.push({name:e.getMessage("Check_for_userscripts_updates"),id:"run_script_updates",button:!0,image:"update"});b.push(g);return k.Pledge(b)}},options:{root:function(){return b([h("options.general"),h("options.verification"),h("options.scripts"),h("options.settings")])},general:function(){var a=[];a.push({name:"Version",
id:null,version:!0,value:rea.extension.manifest.version});rea.extension.inIncognitoContext&&"temporary"==g.values.incognito_mode&&a.push({globalhint:!0,image:"critical",value:e.getMessage("All_modifications_are_only_kept_until_this_incognito_session_is_closed_")});return k.Pledge(a)},verification:function(){var a=[];oa.getWarnings().forEach(function(b){a.push({globalhint:!0,image:"critical",value:b.text,description:b.description,info_url:b.url})});return k.Pledge(a)},scripts:{root:function(a,c){var d=
k(),g={name:e.getMessage("Installed_userscripts"),main_menu_item:!0,scriptTab:!0,id:"dashboard"};(function(){if(a.complete||!c)return b(v.map(["options.scripts.natives","options.scripts.userscripts","options.scripts.new"],function(a){return h(a)}));g.referrer="options.scripts";g.partial=!0;return b([h("options.scripts.new")])})().done(function(a){g.items=a;d.resolve([g])}).fail(d.reject);return d.promise()},"new":function(){var a=[];a.push({name:e.getMessage("New_userscript"),id:null,image:"script_add",
icon:rea.extension.getURL("images/txt.png"),nnew:!0,uuid:"new-user-script",position:-1,positionof:l.RUNTIME.MAX_SCRIPTS,enabled:!0,userscript:!0});return k.Pledge(a)},natives:function(){var a=[],b=k();N.getAllUserscripts().always(function(d){d=d||[];d.forEach(function(b){a.push({name:b.name,uuid:b.id,icon:b.icon,code:null,position:0,positionof:l.RUNTIME.MAX_SCRIPTS,enabled:b.enabled,version:b.version,description:b.description,nativeScript:!0})});b.resolve(a)});return b.promise()},userscripts:{root:function(a,
b){var d=a.complete||!b?null:"options.scripts.userscripts.source",d=sa(w.determineScriptsToRun(null),!0,d),g=d.length;e.getLocale();d.push({name:e.getMessage("No_script_is_installed"),image:"info",visible:!g});d.push({name:e.getMessage("Get_some_scripts___"),image:"edit_add",url:"http://awe.acestream.me/",newtab:!0,visible:!g});return k.Pledge(d)},source:function(a){if(!a.uuid)return k.Pledge([]);a=y.getByUid(a.uuid);if(a.script&&a.cond)return a=g.values.showFixedSrc?ka.mkCompat(a.script.textContent,
a.script,"off"!=g.values.runtime_strict_mode):a.script.textContent,k.Pledge([a]);console.warn("tree: unable to process ",a);return k.Breach()}}},settings:function(a,b){var d=k(),g={name:e.getMessage("Settings"),main_menu_item:!0,id:"settings",selected_default:!0},h;a.complete||!b?h=k.Pledge(Na.create()):(g.referrer="options.settings",h=k.Pledge());h.done(function(a){g.items=a;d.resolve([g])}).fail(d.reject);return d.promise()}}};D&&console.log("tree: loading",a,d);return h(a,!0)()}}}(),sa=function(a,
d,b){var e=[],k=new x.Script;["author","copyright"].forEach(function(a){k[a]=!1});for(var f in a){var c=a[f],m;if(d){m={};for(var l in k)k.hasOwnProperty(l)&&"textContent"!=l&&"requires"!=l&&"resources"!=l&&(v.toType(k[l]),m[l]=c[l]);b?(m.referrer=b,m.length=c.textContent.length):m.code=c.textContent;["requires","resources"].forEach(function(a){m[a]=v.map(c[a],function(a){var b=S.getElement(c.uuid,a.url);return{url:a.url,data:{length:b&&b.data&&b.data.content?b.data.content.length:0},ts:b?b.ts:null}})});
m.origin=w.determineOrigin(c);m.contexter=w.isContexter(c)}else m={name:c.name,uuid:c.uuid,system:c.system,support:!!c.supportURL,origin:!!w.determineOrigin(c),contexter:w.isContexter(c),enabled:c.enabled,position:c.position};m.blacklisted=c.evilness>=g.values.script_blacklist_severity;m.file_url=c.downloadURL||c.fileURL;m.positionof=a.length;m.userscript=!0;m.user_agent=c.options.user_agent;c.icon64||c.icon||(m.icon64=rea.extension.getURL(m.user_agent?"images/user_agent.png":"images/txt.png"));c.options&&
Object.keys(k.options).forEach(function(a){m[a]=c.options[a]});e.push(m)}return e},ta={copy:function(a){var d=document.createElement("iframe"),b=document.body||document.documentElement||document;b.appendChild(d);try{d.contentDocument.designMode="on","html"==a.type?(d.setAttribute("sandbox","allow-same-origin"),d.contentDocument.documentElement.innerHTML=a.content,d.contentDocument.execCommand("selectAll",!1,null)):d.contentDocument.oncopy=function(b){b.clipboardData.setData(a.mimetype||"text/plain",
a.content);b.preventDefault()},d.contentDocument.execCommand("copy",!1,null),d.contentDocument.designMode="off"}catch(e){console.error("bg: clipboard Error: "+e.message)}b.removeChild(d);d=null}};clip=ta;var H={asked:!1,runCheck:!1,hasPermission:!1,init:function(){Q.has(Q.permContentSettings).done(function(a){H.hasPermission=a;H.runCheck=H.hasPermission&&"yes"==g.values.scriptblocker_overwrite;D&&console.log("bg: contentSettings: runCheck = "+H.runCheck+" hasPerm = "+H.hasPermission)})},askForPermission:function(a){Q.ask(Q.permContentSettings,
e.getMessage("A_script_blocker_was_detected_"),e.getMessage("Click_here_to_allow_AWE_to_override_the_script_blocker")).done(a)},requestPermissionEx:function(a){"yes"!=g.values.scriptblocker_overwrite?a&&a():Q.has(Q.permContentSettings).done(function(d){H.asked?a&&a(d,!1):d?a(d,!1):H.askForPermission(function(b){a&&a(b,!0);b&&!H.runCheck&&(H.runCheck=!0,V.reset())});H.asked=!0})},remove:function(a){Q.remove(Q.permContentSettings).done(a)}},V={run:function(a,d){var b=1,e=function(){0==--b&&(d&&d(),
window.location.reload())};if("config"==a){var g=n.listValues(),f;for(f in g){var c=g[f];-1!=c.search(l.CONSTANTS.PREFIX.SCRIPT)&&-1!=c.search(l.CONSTANTS.PREFIX.COND)&&-1!=c.search(l.CONSTANTS.PREFIX.STORE)&&-1!=c.search(l.CONSTANTS.PREFIX.META)&&(b++,n.deleteValue(c).always(e))}}else"factory"==a&&(H.hasPermission&&(b++,H.remove(e)),b++,I.remove_permission().done(e),b++,n.factoryReset().always(e));e()},reset:function(a){V.run(null,a)},factoryReset:function(a){V.run("factory",a)},configReset:function(a){V.run("config",
a)}},T=function(){var a=function(){rea.runtime.lastError&&void 0},d={init:function(){d.setIcon();var a=g.values.appearance_badge_color||"#ee3131";"#"!==a[0]&&(a="#"+a);rea.browserAction.setBadgeBackgroundColor({color:a})},setIcon:function(b){var d,k;k=null;var f=d=!1;void 0===b||A.get.empty(b)||(d=A.get.blocker(b),f=A.get.forbidden(b));f?(d="images/icon_forbidden.png",k=e.getMessage("At_least_one_part_of_this_page_is_listed_at_the_forbidden_pages_setting_")):d?(d="images/icon_blocker.png",k=e.getMessage("Some_scripts_might_be_blocked_by_the_javascript_settings_for_this_page_or_a_script_blocker_")):
d=g.values.enabled&&void 0!==b?"images/icon.png":"images/icon_grey.png";D&&console.log("badge: set icon "+d);d={path:rea.extension.getURL(d)};k={title:k?k:rea.extension.manifest.name};null!=b&&(d.tabId=b,k.tabId=b);try{rea.browserAction.setIcon(d,a),rea.browserAction.setTitle(k)}catch(c){console.warn("bg: ERROR while setIcon! "+c.message)}},setBadge:function(a){var d=0;"off"==g.values.appearance_badges?d=0:"running"==g.values.appearance_badges?a&&!A.get.empty(a)&&(d=A.get.stats(a).running):"running_unique"==
g.values.appearance_badges?a&&!A.get.empty(a)&&(d=A.get.stats(a,!0).unique):"disabled"==g.values.appearance_badges&&a&&!A.get.empty(a)&&(d=A.get.stats(a).disabled);D&&console.log("badge: set "+d);d?rea.browserAction.setBadgeText({text:d.toString(),tabId:a}):rea.browserAction.setBadgeText({text:"",tabId:a})}};return d}(),ca=function(){var a=null,d={init:function(){a=n.getValue(l.CONSTANTS.STORAGE.BEGGING,null);if(!a){a={};var b=(new Date).getTime(),e=b;v.each(w.determineScriptsToRun(null),function(a){a.lastUpdated&&
a.lastUpdated<e&&(e=a.lastUpdated)});e!==b?(D&&console.log("beg: first action found at "+(new Date(e)).toISOString()),a.first_run={type:"from_script",ts:e}):a.first_run={type:"from_init",ts:b};d.save()}},save:function(){n.setValue(l.CONSTANTS.STORAGE.BEGGING,a)},needed:function(){var b=(new Date).getTime(),d=a.first_run?a.first_run.ts+12096E5<b:!0,e=!a.hide,f=!a.contributed,b=a.later?a.later.ts+12096E5<b:!0;return!l.RUNTIME.DOLPHIN&&d&&e&&f&&b},clicked:function(a,d,e){},dialog:{shown:function(b){var e=
(new Date).getTime();a.dialog={ts:e,extra:b};d.save()}},button:function(){var b={};["contributed","later","hide"].forEach(function(e){b[e]=function(b){var f=(new Date).getTime();a[e]={ts:f,extra:b};d.save()}});return b}()};return d}(),ma=function(){var a=function(a,b){console.log(a,b);if(b&&a.menuItemId){var c=a.menuItemId,d=y.getByUid(c);d&&d.script?wa.bundle({url:a.frameUrl||a.pageUrl||"<unknown>"},d.script,!0).then(function(c){var d=k();c.method="executeScript";a.frameUrl?c.url=B.woHash(a.frameUrl):
c.topframe=!0;rea.tabs.sendMessage(b.id,c,d.resolve);return d.promise()}).then(function(){rea.contextMenus.remove(c)}):D&&console.warn("ctxm: unable to find script "+a.menuItemId,a,b)}},d=[],b=null,e=!1,g=function(a){var c=[];v.each(a,function(a){var e=k();rea.contextMenus.create({id:a.uuid,contexts:["all"],parentId:b,title:a.name,type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},function(){e.resolve()});d.push(a.uuid);c.push(e.promise())});return k.when(c)},f=function(){var a=
k();rea.contextMenus.removeAll(function(){b=null;a.resolve()});return a.promise()},c=function(){var a=k();f().then(function(){b=rea.contextMenus.create({contexts:["all"],title:"Ace Script",type:"normal",documentUrlPatterns:["http://*/*","https://*/*"]},function(){a.resolve()})});return a.promise()},m=function(){var a=ea.getContexters(0,null);return a.length?(b?k.Pledge():c()).then(function(){return g(a)}):f().then(l.clean)},l={init:function(){rea.contextMenus.supported&&(l.clean().then(m).then(function(){e=
!0}),rea.contextMenus.onClicked.addListener(a))},clean:function(){var a=k();d.forEach(function(a){rea.contextMenus.remove(a)});d=[];a.resolve();return a.promise()},onScriptsChanged:function(){if(rea.contextMenus.supported&&e)return l.clean().then(m)},getContexterCount:function(){return d.length}};return l}(),z={infoChanged:[],redirects:{},addInfoChangedListener:function(a){z.infoChanged.push(a)},runInfoChangedListener:function(){for(var a=0;a<z.infoChanged.length;a++)z.infoChanged[a](L)},detectRedirectToCache:function(a){F.registerLateCallback(function(){z.detectRedirect(a)})},
detectRedirect:function(a){var d=a.responseHeaders||[],b=a.requestId,e=!1,k=!1,f=!1,c="xmlhttprequest"==a.type,m="main_frame"==a.type||"sub_frame"==a.type;if(!c&&!m&&"no"==g.values.webrequest_fixCSP)return{};c&&z.redirects[b]&&(e=!0);for(var l={},n=0;n<d.length;n++){var q=d[n];if(q.name){var p=q.name.toLowerCase();if("location"==p)if(m)k=!0;else{if(c){e&&window.clearTimeout(z.redirects[b].to);if(n=q.value||window.encodeURI(M.arrbuf2str(q.binaryValue)))q=n,B.parse(q).protocol||(n=B.parse(a.url),q=
B.parse(q),q=B.woHash(B.rel2abs(n,q))),z.redirects[b]={url:q,to:window.setTimeout(function(){delete z.redirects[b]},1E4)};break}}else if(m&&"yes"==g.values.webrequest_fixCSP&&q.value&&("x-webkit-csp"==p||"x-content-security-policy"==p||"content-security-policy"==p)){var E=!1,p=q.value.split(";").map(function(a){var b=a.trim();if(0==b.search(/^script-src /)){var c=-1!=b.search(/'unsafe-eval'/),d=-1!=b.search(/'none'/);if(!c||d)return E=!0,b.replace(/script-src /,"script-src 'unsafe-eval' ").replace(/ 'none'/,
"")}return a.trim()}),p=E?p.join(";"):q.value;l[n]={name:q.name,value:p}}}}if(m&&!k){if(A.events.response(a.tabId,a.frameId,a.url)){var f=!0,v;for(v in l)D&&console.log("csp: replace ",d[v],"with",l[v]),d[v]=l[v]}}else c&&e&&(d.push({name:"TM-finalURL"+rea.runtime.short_id,value:z.redirects[b].url}),f=!0);return f?{responseHeaders:d}:{}},headerFix:function(a){var d=H.runCheck,b="main_frame"==a.type||"sub_frame"==a.type;b&&d&&(d=B.parse(a.url).origin+"/*",rea.contentSettings.javascript.set({primaryPattern:d,
setting:"allow"}));var e=b&&A.get.user_agent(a.tabId,a.frameId),g=L.headers&&"xmlhttprequest"==a.type;if(!e&&!g)return{};var d=!1,b={},f=[],c=RegExp("^"+L.prefix),k;e&&(k=A.get.user_agent(a.tabId,a.frameId));for(var l=a.requestHeaders||[],n=0;n<l.length;n++)a=l[n],a.name&&(g&&0==a.name.search(c)?f.push(a):e&&"user-agent"==a.name.toLowerCase()?(d=!0,b[a.name]=k):b[a.name]=a.value);if(g)for(k=0;k<f.length;k++)a=f[k],d=!0,b[a.name.replace(c,"")]=a.value;if(d){k=[];for(var q in b)b.hasOwnProperty(q)&&
""!=q&&k.push({name:q,value:b[q]});return{requestHeaders:k}}return{}},sucRequest:function(a){0<a.tabId&&console.log("bg: "+a.requestId+" print "+a.type+" request of tabId "+a.tabId+" to "+a.url)},checkRequestForUserscript:function(a){var d="main_frame"==a.type;if(d&&0<a.tabId&&"POST"!=a.method&&"auto"==g.values.scriptUrlDetection&&qa.isScriptUrl(a.url))return w.installFromUrl(a.url,{},{silent_fail:!0}).fail(function(){rea.tabs.update(a.tabId,{url:a.url+"#bypass=true"},function(){})}),{redirectUrl:"javascript:history.back()"};
d&&A.events.reset(a.tabId,!0);A.events.request(a.tabId,a.frameId,a.url);return{}},removeWebRequestListeners:function(){if(L.use)try{z.preCleanup(),rea.webRequest.onBeforeRequest.removeListener(z.checkRequestForUserscript),rea.webRequest.onBeforeSendHeaders.removeListener(z.headerFix),rea.webRequest.onHeadersReceived.removeListener(z.detectRedirect)}catch(a){}L.headers=!1;z.runInfoChangedListener()},preInit:function(){L.use&&(z.tmp_cache=!0,rea.webRequest.onHeadersReceived.addListener(z.detectRedirectToCache,
{urls:["http://*/*","https://*/*"]},["responseHeaders","blocking"]),rea.webRequest.handlerBehaviorChanged())},preCleanup:function(){if(L.use&&z.tmp_cache)try{rea.webRequest.onHeadersReceived.removeListener(z.detectRedirectToCache),delete z.tmp_cache}catch(a){D&&console.log("bg: error cleaning pre-initialized webRequest listener",a)}},init:function(a){if(L.use)try{z.preCleanup(),rea.webRequest.onBeforeRequest.addListener(z.checkRequestForUserscript,{urls:["http://*/*","https://*/*","file://*/*"],types:["main_frame",
"sub_frame"]},["blocking"]),rea.webRequest.onBeforeSendHeaders.addListener(z.headerFix,{urls:["http://*/*","https://*/*","file://*/*"]},["requestHeaders","blocking"]),rea.webRequest.onHeadersReceived.addListener(z.detectRedirect,{urls:["http://*/*","https://*/*"]},["responseHeaders","blocking"]),rea.webRequest.handlerBehaviorChanged(),L.headers=a&&rea.webRequest.headerModificationSupported,L.id=v.createUUID(),L.testprefix=L.prefix+v.createUUID(),L.prefix=z.prefix+L.id+"_",z.runInfoChangedListener()}catch(d){D&&
console.error("bg: error initializing webRequests "+d.message),z.removeWebRequestListeners()}},finalize:function(){z.removeWebRequestListeners()}},Ca={onCommittedListener:function(a){A.events.commited(a.tabId,a.frameId,a.url)},init:function(){rea.webNavigation.supported&&rea.webNavigation.onCommitted.addListener(Ca.onCommittedListener)}},F={late:!1,callbacks:[],init:function(){},registerLateCallback:function(a){D&&console.log("toea: register callback");F.callbacks.push(a)},setReady:function(){D&&
console.debug("toea: run "+F.callbacks.length+" callbacks");F.late=!0;for(var a=0;a<F.callbacks.length;a++)F.callbacks[a]();F.callbacks=[]}},Oa=function(){var a=!1,d=null,b=function(){a||(D&&console.debug("Unloader.onbeforeunload()"),d&&d(),a=!0)};return{init:function(a){d=a;window.addEventListener("beforeunload",b,!1)}}}(),Ia=function(){var a=rea.extension.manifest.version,d=null,b=!1,h=!1,t=function(){if(1!=pa("mode")&&b)if(F.late){var c="version="+a+"&ext="+rea.runtime.short_id+"&updated=true",
f;b?(f="http://awe.acestream.me/welcome?"+c,h=!0):(c+="&old="+d,f="http://awe.acestream.me/welcome?"+c);"off"!=g.values.notification_showUpdate&&("notification"==g.values.notification_showUpdate?P.showUpdate(e.getMessage("Updated_to__0version0",a),e.getMessage("Click_here_to_see_the_recent_changes"),rea.extension.getURL("images/icon128.png"),function(a){a.clicked&&rea.tabs.create({url:f},function(){})}):"changelog"==g.values.notification_showUpdate&&(h||(f+="&intr=true"),h=!0,rea.tabs.create({url:f,
active:h},function(){})))}else F.registerLateCallback(t)},f=function(){var a=null,b,c=k(),d=function(d){b&&(d||null!==a)&&(d||window.clearTimeout(b),b=null,c.resolve(!!a))};rea.idle.queryState(l.MISC.IDLE_TIMEOUT,function(b){a="active"==b;d()});b=window.setTimeout(function(){d(!0)},300);return c.promise()},c=function(a){"install"==a.reason&&(F.late?(D&&console.log("upd: onInstalled",a),a||(a={reason:"mandatory_argument_is_not_set"}),"chrome_update"==a.reason?void 0:"install"!=a.reason&&"update"!=
a.reason||p.scheduleNotification(a.previousVersion,"install"==a.reason)):F.registerLateCallback(function(){c(a)}))},m=function(){var a=k(),b=function(){var b=(new Date).getTime(),c=n.getValue(l.CONSTANTS.STORAGE.LAST_START,0),b=Math.round((b-c)/1E3),c=b<=l.MISC.DISTURBANCE_ALLOWED;D&&console.log("upd: restart?",c,"(",b,"seconds ago)");a.resolve(c)};F.late?b():F.registerLateCallback(b);return a.promise()}(),r=function(){var a=!1,b=!1;f().then(function(a){b=a;return m}).then(function(b){a=b}).always(function(){h=
!b||a;t();q=!0})},u=null,q=!1,p={scheduleNotification:function(a,c){q||(d=a,b|=c,u&&window.clearTimeout(u),u=window.setTimeout(r,1E3))}};rea.runtime.onInstalled.addListener(c);rea.runtime.onUpdateAvailable.addListener(function(a){console.log("An update to version",a.version,"is available");window.setTimeout(function(){P.show(e.getMessage("Update"),e.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",rea.extension.manifest.name,a.version),rea.extension.getURL("images/icon128.png"),
6E4)},864E5)});(function(){F.registerLateCallback(function(){n.setValue(l.CONSTANTS.STORAGE.LAST_START,(new Date).getTime())})})();return p}(),Pa=function(a){"toggle-enable"==a&&(g.values.enabled=!g.values.enabled)},Da=function(a,d,b){F.late?("auto"==g.values.scriptUrlDetection&&qa.isScriptUrl(b.url)&&w.installFromUrl(b.url),"loading"==d.status?A.events.loading(b.id,0,b.url):"complete"==d.status&&A.events.complete(b.id,0,b.url)):window.setTimeout(function(){Da(a,d,b)},100)},Qa=function(a,d){Ea(d,
{});T.setIcon(a);T.setBadge(a)},Ea=function(a,d){Y[a]&&(Y[a].onClose(),delete Y[a]);A.events.remove(a)},ya=function(){var a="temporary"==g.values.incognito_mode&&rea.extension.inIncognitoContext;n.setTemporary(a);a&&(g.values.native_import=!1,g.values.sync_enabled=!1,g.values.scriptUpdateCheckPeriod=0,g.values.sync_type=0)},Ra=function(){ua(g.values.logLevel);e.setLocale(g.values.i18n||l.LOCALE.DEFAULT);N.setPath(g.values.native_import_path);H.init();A.listeners.add.onReset(function(a,b){ba.clearByTabId(a);
y.removeStorageListeners({tabid:a},!1);b||T.setIcon(a)});var a=function(a){T.setIcon(a);T.setBadge(a)};A.listeners.add.onCommited(a);A.listeners.add.onCompleted(a);J.init().done(function(a){a&&J.sync()});aa.init();y.init();a=function(){I.set_mode(g.values.downloads_mode);I.set_whitelist(g.values.downloads_extension_whitelist)};a();I.config_changed_listener=a;Ca.init();z.addInfoChangedListener(function(a){na&&na.setWebRequest(a)});z.init("no"!=g.values.webrequest_modHeaders);ma.init();ca.init()},B=
Registry.get("uri"),I=Registry.get("downloads");uris=B;down=I;var M,fa,na,ka,x,K,e,ga;init=function(){F.init();z.preInit();rea.tabs.onUpdated.addListener(Da);rea.tabs.onReplaced.addListener(Qa);rea.tabs.onRemoved.addListener(Ea);rea.extension.onMessage.addListener(ha.handler);rea.extension.onConnect.addListener(Ba);rea.extension.onConnectExternal.addListener(function(a){a.disconnect()});rea.commands.supported&&rea.commands.onCommand.addListener(Pa);Oa.init(function(){z.finalize();J.finalize()});M=
Registry.get("convert");e=Registry.get("i18n");na=Registry.get("xmlhttprequest");fa=na.run;ka=Registry.get("compat",l);x=Registry.get("parser");K=Registry.get("syncinfo");ga=Registry.get("test");rea.browserAction.setIcon({path:rea.extension.getURL("images/icon_grey.png")});rea.browserAction.setPopup({popup:"action.html"});rea.browserAction.setTitle({title:"Ace Script"});n.init().then(function(){return Ja()}).then(function(){return g.init()}).then(function(){cfgo=g;ya();Ra();La();T.init();window.setTimeout(la.check,
1E4);D&&console.debug("Listeners registered!");window.setTimeout(F.setReady,1);if(ga&&Registry.isDevVersion("test")){var a=ga.framework.prepare(w.doSave,l.RUNTIME.BROWSER);a&&console.error(a)}});chrome.notifications.onClosed.addListener(function(a){console.log("notification:onClosed: id="+a);R[a]&&delete R[a]});chrome.notifications.onClicked.addListener(function(a){console.log("notification:onClicked: id="+a);R[a]&&R[a].onClicked&&R[a].onClicked.call(null)});chrome.notifications.onButtonClicked.addListener(function(a,
d){console.log("notification:onButtonClicked: id="+a+" button="+d);R[a]&&R[a].onButtonClicked&&R[a].onButtonClicked.call(null,d)})};init()}});
