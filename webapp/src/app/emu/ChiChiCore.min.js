Bridge.assembly("ChiChiCore",function(){"use strict";Bridge.define("ChiChiNES.AddressingModes",{$kind:"enum",statics:{fields:{Bullshit:0,Implicit:1,Accumulator:2,Immediate:3,ZeroPage:4,ZeroPageX:5,ZeroPageY:6,Relative:7,Absolute:8,AbsoluteX:9,AbsoluteY:10,Indirect:11,IndexedIndirect:12,IndirectIndexed:13,IndirectZeroPage:14,IndirectAbsoluteX:15}}});Bridge.define("ChiChiNES.IClockedMemoryMappedIOElement",{$kind:"interface"});Bridge.define("ChiChiNES.BeepsBoops.Blip",{statics:{fields:{bass_shift:0,end_frame_extra:0,time_bits:0,half_width:0,phase_bits:0,delta_bits:0,buf_extra:0,phase_count:0,time_unit:0,bl_step:null},ctors:{init:function(){this.bass_shift=8;this.end_frame_extra=2;this.time_bits=21;this.half_width=8;this.phase_bits=5;this.delta_bits=15;this.bl_step=System.Array.create(0,[[43,-115,350,-488,1136,-914,5861,21022],[44,-118,348,-473,1076,-799,5274,21001],[45,-121,344,-454,1011,-677,4706,20936],[46,-122,336,-431,942,-549,4156,20829],[47,-123,327,-404,868,-418,3629,20679],[47,-122,316,-375,792,-285,3124,20488],[47,-120,303,-344,714,-151,2644,20256],[46,-117,289,-310,634,-17,2188,19985],[46,-114,273,-275,553,117,1758,19675],[44,-108,255,-237,471,247,1356,19327],[43,-103,237,-199,390,373,981,18944],[42,-98,218,-160,310,495,633,18527],[40,-91,198,-121,231,611,314,18078],[38,-84,178,-81,153,722,22,17599],[36,-76,157,-43,80,824,-241,17092],[34,-68,135,-3,8,919,-476,16558],[32,-61,115,34,-60,1006,-683,16001],[29,-52,94,70,-123,1083,-862,15422],[27,-44,73,106,-184,1152,-1015,14824],[25,-36,53,139,-239,1211,-1142,14210],[22,-27,34,170,-290,1261,-1244,13582],[20,-20,16,199,-335,1301,-1322,12942],[18,-12,-3,226,-375,1331,-1376,12293],[15,-4,-19,250,-410,1351,-1408,11638],[13,3,-35,272,-439,1361,-1419,10979],[11,9,-49,292,-464,1362,-1410,10319],[9,16,-63,309,-483,1354,-1383,9660],[7,22,-75,322,-496,1337,-1339,9005],[6,26,-85,333,-504,1312,-1280,8355],[4,31,-94,341,-507,1278,-1205,7713],[3,35,-102,347,-506,1238,-1119,7082],[1,40,-110,350,-499,1190,-1021,6464],[0,43,-115,350,-488,1136,-914,5861]],System.Int32,33,8)},ctor:function(){ChiChiNES.BeepsBoops.Blip.time_unit=2097152;ChiChiNES.BeepsBoops.Blip.buf_extra=18;ChiChiNES.BeepsBoops.Blip.phase_count=32}}},fields:{_blipBuffer:null},props:{BlipBuffer:{get:function(){return this._blipBuffer},set:function(value){this._blipBuffer=value}},blip_samples_avail:{get:function(){return this._blipBuffer.avail}}},ctors:{ctor:function(size){this.$initialize();this.blip_new(size)}},methods:{blip_new:function(size){this._blipBuffer=new ChiChiNES.BeepsBoops.Blip.blip_buffer_t(size);this._blipBuffer.size=size;this._blipBuffer.factor=0;this.blip_clear()},blip_set_rates:function(clock_rate,sample_rate){this._blipBuffer.factor=Bridge.Int.clip32(ChiChiNES.BeepsBoops.Blip.time_unit/clock_rate*sample_rate+.9999847412109375);System.Diagnostics.Debug.assert(this._blipBuffer.factor>0)},blip_clear:function(){this._blipBuffer.offset=0;this._blipBuffer.avail=0;this._blipBuffer.integrator=0;this._blipBuffer.samples=System.Array.init(this._blipBuffer.size+ChiChiNES.BeepsBoops.Blip.buf_extra|0,0,System.Int32)},blip_clocks_needed:function(samples){var needed=(Bridge.Int.mul(samples,ChiChiNES.BeepsBoops.Blip.time_unit)-this._blipBuffer.offset|0)>>>0;return System.Int64.clip32(System.Int64(needed).add(System.Int64(this._blipBuffer.factor)).sub(System.Int64(1)).div(System.Int64(this._blipBuffer.factor)))},blip_end_frame:function(t){var off=Bridge.Int.mul(t,this._blipBuffer.factor)+this._blipBuffer.offset|0;this._blipBuffer.avail=this._blipBuffer.avail+(off>>ChiChiNES.BeepsBoops.Blip.time_bits)|0;this._blipBuffer.offset=off&(ChiChiNES.BeepsBoops.Blip.time_unit-1|0)},remove_samples:function(count){var remain=(this._blipBuffer.avail+ChiChiNES.BeepsBoops.Blip.buf_extra|0)-count|0;this._blipBuffer.avail=this._blipBuffer.avail-count|0;System.Array.copy(this._blipBuffer.samples,count,this._blipBuffer.samples,0,remain);System.Array.fill(this._blipBuffer.samples,0,remain,count);this._blipBuffer.arrayLength=count},ReadBytes:function(outbuf,count){var $t,st;if(count>this._blipBuffer.avail&&(count=this._blipBuffer.avail),count!==0){var inPtr=0,outPtr=0,endPtr=inPtr+count|0,sum=this._blipBuffer.integrator;do st=sum>>ChiChiNES.BeepsBoops.Blip.delta_bits,sum=sum+($t=this._blipBuffer.samples)[inPtr]|0,inPtr=inPtr+1|0,Bridge.Int.sxs(st&65535)!==st&&(st=st>>31^32767),outbuf[outPtr]=st&255,outbuf[outPtr+1|0]=st>>8&255,outPtr=outPtr+2|0,sum=sum-(st<<7)|0;while(inPtr!==endPtr);this._blipBuffer.integrator=sum;this.remove_samples(count)}return count},blip_add_delta:function(time,delta){var $t,$t1,$t2,$t3,$t4,$t5,i;if(delta!==0){var fixedTime=System.Int64(Bridge.Int.mul(time,this._blipBuffer.factor)+this._blipBuffer.offset|0),outPtr=System.Int64.clip32(System.Int64(this._blipBuffer.avail).add(fixedTime.shr(ChiChiNES.BeepsBoops.Blip.time_bits))),phase_shift=16,phase=System.Int64.clip32(fixedTime.shr(phase_shift).and(System.Int64(ChiChiNES.BeepsBoops.Blip.phase_count-1|0))),inStep=phase,rev=ChiChiNES.BeepsBoops.Blip.phase_count-phase|0,interp_bits=15,interp=System.Int64.clip32(fixedTime.shr(phase_shift-interp_bits|0).and(System.Int64((1<<interp_bits)-1|0))),delta2=Bridge.Int.mul(delta,interp)>>interp_bits;for(delta=delta-delta2|0,i=0;i<8;i=i+1|0)($t=this._blipBuffer.samples)[$t1=outPtr+i|0]=($t2=this._blipBuffer.samples)[$t1]+(Bridge.Int.mul(ChiChiNES.BeepsBoops.Blip.bl_step.get([inStep,i]),delta)+Bridge.Int.mul(ChiChiNES.BeepsBoops.Blip.bl_step.get([inStep+1|0,i]),delta2)|0)|0,($t3=this._blipBuffer.samples)[$t4=outPtr+(15-i|0)|0]=($t5=this._blipBuffer.samples)[$t4]+(Bridge.Int.mul(ChiChiNES.BeepsBoops.Blip.bl_step.get([rev,i]),delta)+Bridge.Int.mul(ChiChiNES.BeepsBoops.Blip.bl_step.get([rev-1|0,i]),delta2)|0)|0}},blip_add_delta_fast:function(time,delta){var $t,$t1,$t2,$t3,$t4,$t5,fixedTime=Bridge.Int.mul(time,this._blipBuffer.factor)+this._blipBuffer.offset|0,outPtr=this._blipBuffer.avail+(fixedTime>>ChiChiNES.BeepsBoops.Blip.time_bits)|0,delta_unit=32768,phase=fixedTime>>6&(delta_unit-1|0),delta2=Bridge.Int.mul(delta,phase);($t=this._blipBuffer.samples)[$t1=outPtr+8|0]=($t2=this._blipBuffer.samples)[$t1]+(Bridge.Int.mul(delta,delta_unit)-delta2|0)|0;($t3=this._blipBuffer.samples)[$t4=outPtr+9|0]=($t5=this._blipBuffer.samples)[$t4]+delta2|0}}});Bridge.define("ChiChiNES.BeepsBoops.Blip.blip_buffer_t",{fields:{factor:0,offset:0,avail:0,size:0,integrator:0,arrayLength:0,samples:null},ctors:{ctor:function(size){this.$initialize();this.samples=System.Array.init(size,0,System.Int32);this.arrayLength=size}}});Bridge.define("ChiChiNES.BeepsBoops.IAPU",{$kind:"interface"});Bridge.define("ChiChiNES.BeepsBoops.DMCChannel",{fields:{_chan:0,_bleeper:null,LengthCounts:null,_dutyCycle:0,_length:0,_timer:0,_rawTimer:0,_volume:0,_time:0,_envelope:0,_looping:!1,_enabled:!1,_amplitude:0,doodies:null,_sweepShift:0,_sweepCounter:0,_sweepDivider:0,_sweepNegateFlag:!1,_sweepEnabled:!1,_startSweep:!1,_sweepInvalid:!1,_irqEnabled:!1,rate:0,dCounter:0,sampleAddress:0,_phase:0,_gain:0,_envTimer:0,_envStart:!1,_envConstantVolume:!1,_envVolume:0,_sweepComplement:!1},props:{Length:{get:function(){return this._length},set:function(value){this._length=value}},DutyCycle:{get:function(){return this._dutyCycle},set:function(value){this._dutyCycle=value}},Period:{get:function(){return this._timer},set:function(value){this._timer=value}},Volume:{get:function(){return this._volume},set:function(value){this._volume=value}},Time:{get:function(){return this._time},set:function(value){this._time=value}},Envelope:{get:function(){return this._envelope},set:function(value){this._envelope=value}},Looping:{get:function(){return this._looping},set:function(value){this._looping=value}},Enabled:{get:function(){return this._enabled},set:function(value){this._enabled=value}},Gain:{get:function(){return this._gain},set:function(value){this._gain=value}},SweepComplement:{get:function(){return this._sweepComplement},set:function(value){this._sweepComplement=value}}},ctors:{init:function(){this.LengthCounts=System.Array.init([10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],System.Byte);this._enabled=!0;this.doodies=System.Array.init([2,6,30,249],System.Byte);this._sweepDivider=1;this._irqEnabled=!1;this._envTimer=15},ctor:function(bleeper,chan){this.$initialize();this._bleeper=bleeper;this._chan=chan}},methods:{WriteRegister:function(register,data){switch(register){case 0:this._irqEnabled=(data&128)==128;this._looping=(data&64)==64;this.rate=data&15;break;case 1:this.dCounter=data&127;break;case 2:this.sampleAddress=data<<6|49152;break;case 3:this._timer=data&255;this._timer<<=4;this._timer&=1}},Run:function(end_time){for(;this._time<end_time;this._time++)this.UpdateAmplitude(this._dutyCycle>>(this._phase&7)&1);this._phase&=7},UpdateAmplitude:function(new_amp){var delta=new_amp*this._gain-this._amplitude;this._amplitude+=delta;this._bleeper.blip_add_delta(this._time,delta)},EndFrame:function(time){this.Run(time);this._time=0},FrameClock:function(time,step){this.Run(time);this._envStart?(this._envStart=!1,this._envTimer=this._volume+1,this._envVolume=15):(this._envTimer--,this._envTimer===0&&(this._envTimer=this._volume+1,this._envVolume>0?this._envVolume--:this._envVolume=this._looping?15:0));switch(step){case 1:case 3:if(--this._sweepCounter,this._sweepCounter===0&&(this._sweepCounter=this._sweepDivider+1,this._sweepEnabled&&this._sweepShift>0)){var sweep=this._timer>>this._sweepShift;this._timer+=this._sweepComplement?this._sweepNegateFlag?~sweep:sweep:this._sweepNegateFlag?~sweep+1:sweep;this._sweepInvalid=this._rawTimer<8||(this._timer&2048)==2048}this._startSweep&&(this._startSweep=!1,this._sweepCounter=this._sweepDivider+1);!this._looping&&this._length>0&&this._length--}}}});Bridge.define("ChiChiNES.BeepsBoops.IWavReader",{$kind:"interface"});Bridge.define("ChiChiNES.BeepsBoops.IWavWriter",{inherits:[System.IDisposable],$kind:"interface"});Bridge.define("ChiChiNES.BeepsBoops.NoiseChannel",{fields:{_bleeper:null,_chan:0,NoisePeriods:null,LengthCounts:null,_length:0,_period:0,_volume:0,_time:0,_envConstantVolume:!1,_envVolume:0,_looping:!1,_enabled:!1,amplitude:0,_phase:0,gain:0,_envTimer:0,_envStart:!1},props:{Length:{get:function(){return this._length},set:function(value){this._length=value}},Period:{get:function(){return this._period},set:function(value){this._period=value}},Volume:{get:function(){return this._volume},set:function(value){this._volume=value}},Time:{get:function(){return this._time},set:function(value){this._time=value}},Looping:{get:function(){return this._looping},set:function(value){this._looping=value}},Enabled:{get:function(){return this._enabled},set:function(value){this._enabled=value}},Gain:{get:function(){return this.gain},set:function(value){this.gain=value}}},ctors:{init:function(){this.NoisePeriods=System.Array.init([4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],System.Int32);this.LengthCounts=System.Array.init([10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],System.Byte);this._enabled=!0;this._phase=1;this._envTimer=15},ctor:function(bleeper,chan){this.$initialize();this._bleeper=bleeper;this._chan=chan}},methods:{WriteRegister:function(register,data){switch(register){case 0:this._envConstantVolume=(data&16)==16;this._volume=data&15;this._looping=(data&128)==128;break;case 2:this._period=this.NoisePeriods[data&15];break;case 3:this._enabled&&(this._length=this.LengthCounts[data>>3&31]);this._envStart=!0;break;case 4:this._enabled=data!==0;this._enabled||(this._length=0)}},Run:function(end_time){var volume=this._envConstantVolume?this._volume:this._envVolume,new15;if(this._length===0&&(volume=0),this._period===0){this._time=end_time;this.UpdateAmplitude(0);return}for(this._phase===0&&(this._phase=1);this._time<end_time;this._time+=this._period)new15=this._looping?this._phase&1^this._phase>>6&1:this._phase&1^this._phase>>1&1,this.UpdateAmplitude(this._phase&1*volume),this._phase=(this._phase>>1|new15<<14)&65535},UpdateAmplitude:function(amp){var delta=amp*this.gain-this.amplitude;this.amplitude+=delta;this._bleeper.blip_add_delta(this._time,delta)},EndFrame:function(time){this.Run(time);this._time=0},FrameClock:function(time,step){this.Run(time);this._envStart?(this._envStart=!1,this._envTimer=this._volume+1,this._envVolume=15):(this._envTimer--,this._envTimer===0&&(this._envTimer=this._volume+1,this._envVolume>0?this._envVolume--:this._envVolume=this._looping?15:0));switch(step){case 1:case 2:!(!this._looping&this._length>0)||this._length--}}}});Bridge.define("ChiChiNES.BeepsBoops.SoundStatusChangeEventArgs",{fields:{muted:!1},props:{Muted:{get:function(){return this.muted},set:function(value){this.muted=value}}}});Bridge.define("ChiChiNES.BeepsBoops.SquareChannel",{fields:{_chan:0,_bleeper:null,LengthCounts:null,_dutyCycle:0,_length:0,_timer:0,_rawTimer:0,_volume:0,_time:0,_envelope:0,_looping:!1,_enabled:!1,_amplitude:0,doodies:null,_sweepShift:0,_sweepCounter:0,_sweepDivider:0,_sweepNegateFlag:!1,_sweepEnabled:!1,_startSweep:!1,_sweepInvalid:!1,_phase:0,_gain:0,_envTimer:0,_envStart:!1,_envConstantVolume:!1,_envVolume:0,_sweepComplement:!1},props:{Length:{get:function(){return this._length},set:function(value){this._length=value}},DutyCycle:{get:function(){return this._dutyCycle},set:function(value){this._dutyCycle=value}},Period:{get:function(){return this._timer},set:function(value){this._timer=value}},Volume:{get:function(){return this._volume},set:function(value){this._volume=value}},Time:{get:function(){return this._time},set:function(value){this._time=value}},Envelope:{get:function(){return this._envelope},set:function(value){this._envelope=value}},Looping:{get:function(){return this._looping},set:function(value){this._looping=value}},Enabled:{get:function(){return this._enabled},set:function(value){this._enabled=value}},Gain:{get:function(){return this._gain},set:function(value){this._gain=value}},SweepComplement:{get:function(){return this._sweepComplement},set:function(value){this._sweepComplement=value}}},ctors:{init:function(){this.LengthCounts=System.Array.init([10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],System.Byte);this._enabled=!0;this.doodies=System.Array.init([2,6,30,249],System.Byte);this._sweepDivider=1;this._envTimer=15},ctor:function(bleeper,chan){this.$initialize();this._bleeper=bleeper;this._chan=chan}},methods:{WriteRegister:function(register,data){switch(register){case 0:this._envConstantVolume=(data&16)==16;this._volume=data&15;this._dutyCycle=this.doodies[data>>6&3];this._looping=(data&32)==32;this._sweepInvalid=!1;break;case 1:this._sweepShift=data&7;this._sweepNegateFlag=(data&8)==8;this._sweepDivider=data>>4&7;this._sweepEnabled=(data&128)==128;this._startSweep=!0;this._sweepInvalid=!1;break;case 2:this._timer&=1792;this._timer|=data;this._rawTimer=this._timer;break;case 3:this._timer&=255;this._timer|=(data&7)<<8;this._rawTimer=this._timer;this._phase=0;this._enabled&&(this._length=this.LengthCounts[data>>3&31]);this._envStart=!0;break;case 4:this._enabled=data!==0;this._enabled||(this._length=0)}},Run:function(end_time){var period=this._sweepEnabled?(this._timer+1&2047)<<1:(this._rawTimer+1&2047)<<1,volume;if(period===0){this._time=end_time;this.UpdateAmplitude(0);return}if(volume=this._envConstantVolume?this._volume:this._envVolume,this._length===0||volume===0||this._sweepInvalid){this._phase+=(end_time-this._time)/period&7;this._time=end_time;this.UpdateAmplitude(0);return}for(;this._time<end_time;this._time+=period,this._phase++)this.UpdateAmplitude((this._dutyCycle>>(this._phase&7)&1)*volume);this._phase&=7},UpdateAmplitude:function(new_amp){var delta=new_amp*this._gain-this._amplitude;this._amplitude+=delta;this._bleeper.blip_add_delta(this._time,delta)},EndFrame:function(time){this.Run(time);this._time=0},FrameClock:function(time,step){this.Run(time);this._envStart?(this._envStart=!1,this._envTimer=this._volume+1,this._envVolume=15):(this._envTimer--,this._envTimer===0&&(this._envTimer=this._volume+1,this._envVolume>0?this._envVolume--:this._envVolume=this._looping?15:0));switch(step){case 1:case 3:if(--this._sweepCounter,this._sweepCounter===0&&(this._sweepCounter=this._sweepDivider+1,this._sweepEnabled&&this._sweepShift>0)){var sweep=this._timer>>this._sweepShift;this._timer+=this._sweepComplement?this._sweepNegateFlag?~sweep:sweep:this._sweepNegateFlag?~sweep+1:sweep;this._sweepInvalid=this._rawTimer<8||(this._timer&2048)==2048}this._startSweep&&(this._startSweep=!1,this._sweepCounter=this._sweepDivider+1);!this._looping&&this._length>0&&this._length--}}}});Bridge.define("ChiChiNES.BeepsBoops.TriangleChannel",{fields:{_bleeper:null,_chan:0,LengthCounts:null,_length:0,_period:0,_time:0,_envelope:0,_looping:!1,_enabled:!1,_amplitude:0,_gain:0,_linCtr:0,_phase:0,_linVal:0,_linStart:!1},props:{Length:{get:function(){return this._length},set:function(value){this._length=value}},Period:{get:function(){return this._period},set:function(value){this._period=value}},Time:{get:function(){return this._time},set:function(value){this._time=value}},Envelope:{get:function(){return this._envelope},set:function(value){this._envelope=value}},Looping:{get:function(){return this._looping},set:function(value){this._looping=value}},Enabled:{get:function(){return this._enabled},set:function(value){this._enabled=value}},Amplitude:{get:function(){return this._amplitude},set:function(value){this._amplitude=value}},Gain:{get:function(){return this._gain},set:function(value){this._gain=value}}},ctors:{init:function(){this.LengthCounts=System.Array.init([10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],System.Int32);this._enabled=!0},ctor:function(bleeper,chan){this.$initialize();this._bleeper=bleeper;this._chan=chan}},methods:{WriteRegister:function(register,data){switch(register){case 0:this._looping=(data&128)==128;this._linVal=data&127;break;case 2:this._period&=1792;this._period|=data;break;case 3:this._period&=255;this._period|=(data&7)<<8;this._enabled&&(this._length=this.LengthCounts[data>>3&31]);this._linStart=!0;break;case 4:this._enabled=data!==0;this._enabled||(this._length=0)}},Run:function(end_time){var period=this._period+1;if(this._linCtr===0||this._length===0||this._period<4){this._time=end_time;return}for(;this._time<end_time;this._time+=period,this._phase=(this._phase+1)%32)this.UpdateAmplitude(this._phase<16?this._phase:31-this._phase)},UpdateAmplitude:function(new_amp){var delta=new_amp*this._gain-this._amplitude;this._amplitude+=delta;this._bleeper.blip_add_delta(this._time,delta)},EndFrame:function(time){this.Run(time);this._time=0},FrameClock:function(time,step){this.Run(time);this._linStart?this._linCtr=this._linVal:this._linCtr>0&&this._linCtr--;this._looping||(this._linStart=!1);switch(step){case 1:case 3:this._length>0&&!this._looping&&this._length--}}}});Bridge.define("ChiChiNES.CartDebugEvent",{fields:{clock:0,eventType:null},props:{Clock:{get:function(){return this.clock},set:function(value){this.clock=value}},EventType:{get:function(){return this.eventType},set:function(value){this.eventType=value}}},methods:{toString:function(){return System.String.format("{0}: {1}",this.clock,this.eventType)}}});Bridge.define("ChiChiNES.ClockedRequestEventArgs",{props:{Clock:0}});Bridge.define("ChiChiNES.ControlByteEventArgs",{fields:{nextValue:0},props:{NextValue:{get:function(){return this.nextValue},set:function(value){this.nextValue=value}}},ctors:{ctor:function(value){this.$initialize();this.nextValue=value}}});Bridge.define("ChiChiNES.CPU2A03",{statics:{fields:{cpuTiming:null},ctors:{init:function(){this.cpuTiming=System.Array.init([7,6,0,0,3,2,5,0,3,2,2,0,6,4,6,0,2,5,0,0,3,3,6,0,2,4,2,0,6,4,7,0,6,6,0,0,3,2,5,0,3,2,2,0,4,4,6,0,2,5,0,0,3,3,6,0,2,4,2,0,6,4,7,0,6,6,0,0,3,2,5,0,3,2,2,0,3,4,6,0,2,5,0,0,0,3,6,0,2,4,2,0,6,4,6,0,6,6,0,0,3,3,5,0,3,2,2,0,5,4,6,0,2,5,0,0,0,4,6,0,2,4,2,0,6,4,7,0,3,6,3,0,3,3,3,0,2,3,2,0,4,4,4,0,2,6,0,0,4,4,4,0,2,5,2,0,0,5,0,0,2,6,2,0,3,3,3,0,2,2,2,0,4,4,4,0,2,5,0,0,4,4,4,0,2,4,2,0,4,4,4,0,2,6,3,0,3,2,5,0,2,2,2,0,4,4,6,0,2,5,0,0,3,4,6,0,2,4,2,0,6,4,7,0,2,6,3,0,3,3,5,0,2,2,2,0,4,4,6,0,2,5,0,0,3,4,6,0,2,4,2,0,6,4,7,0],System.Int32)}}},fields:{_ticks:0,_operationCounter:0,_accumulator:0,_indexRegisterX:0,_indexRegisterY:0,_programCounter:0,_statusRegister:0,_addressBus:0,_reset:!1,_currentInstruction_AddressingMode:0,_currentInstruction_Address:0,_currentInstruction_OpCode:0,_currentInstruction_Parameters0:0,_currentInstruction_Parameters1:0,_currentInstruction_ExtraTiming:0,clock:0,systemClock:System.UInt64(0),_handleNMI:!1,_handleIRQ:!1,nextEvent:0,runningHard:!1,clockcount:null,instruction:null,addressmode:null,memoryPatches:null,genieCodes:null,_cheating:!1,lowByte:0,highByte:0,Rams:null,_pixelWhizzler:null,_cart:null,_padOne:null,_padTwo:null,soundBopper:null,nmiHandler:null,irqUpdater:null,_stackPointer:0,instructionUsage:null,_debugging:!1,instructionHistoryPointer:0,_instructionHistory:null},events:{DebugEvent:null},props:{Accumulator:{get:function(){return this._accumulator},set:function(value){this._accumulator=value}},IndexRegisterY:{get:function(){return this._indexRegisterY},set:function(value){this._indexRegisterY=value}},IndexRegisterX:{get:function(){return this._indexRegisterX},set:function(value){this._indexRegisterX=value}},ProgramCounter:{get:function(){return this._programCounter},set:function(value){this._programCounter=value}},StatusRegister:{get:function(){return this._statusRegister},set:function(value){this._statusRegister=value}},AddressCodePage:{get:function(){return this.AddressBus>>8}},AddressLowByte:{get:function(){return this.AddressBus&255}},AddressBus:{get:function(){return this._addressBus},set:function(value){this._addressBus=value}},DataBus:0,MemoryLock:!1,ReadWrite:!1,Ready:!1,Reset:{get:function(){return this._reset},set:function(value){this._reset=value;this._reset&&this.ResetCPU()}},CurrentInstruction:{get:function(){return new ChiChiNES.CPU2A03.Instruction.ctor}},OperationCounter:{get:function(){return this._operationCounter}},Clock:{get:function(){return this.clock},set:function(value){value===0&&(this.systemClock=this.systemClock.add(Bridge.Int.clipu64(this.clock)),this.clock=value)}},RunningHard:{get:function(){return this.runningHard},set:function(value){this.runningHard=value}},Ticks:{get:function(){return this._ticks},set:function(value){this._ticks=value===2147483647?0:value}},MemoryPatches:{get:function(){return this.memoryPatches},set:function(value){this.memoryPatches=value}},GenieCodes:{get:function(){return this.genieCodes},set:function(value){this.genieCodes=value}},Cheating:{get:function(){return this._cheating},set:function(value){this._cheating=value}},SoundBopper:{get:function(){return this.soundBopper},set:function(value){this.soundBopper=value;this.soundBopper.ChiChiNES$IClockedMemoryMappedIOElement$NMIHandler=this.irqUpdater}},PadOne:{get:function(){return this._padOne},set:function(value){this._padOne=value}},PadTwo:{get:function(){return this._padTwo},set:function(value){this._padTwo=value}},Cart:{get:function(){return this._cart},set:function(value){this._cart=value;this._cart.ChiChiNES$IClockedMemoryMappedIOElement$NMIHandler=this.irqUpdater}},PixelWhizzler:{get:function(){return this._pixelWhizzler},set:function(value){this._pixelWhizzler=value;this._pixelWhizzler.ChiChiNES$IPPU$NMIHandler=this.nmiHandler}},StackPointer:{get:function(){return this._stackPointer}},Debugging:{get:function(){return this._debugging},set:function(value){this._debugging=value}},InstructionUsage:{get:function(){return this.instructionUsage}},InstructionHistoryPointer:{get:function(){return this.instructionHistoryPointer}},InstructionHistory:{get:function(){return this._instructionHistory}}},ctors:{init:function(){this._ticks=0;this._operationCounter=0;this._accumulator=0;this._indexRegisterX=0;this._indexRegisterY=0;this._reset=!1;this._currentInstruction_AddressingMode=ChiChiNES.AddressingModes.Bullshit;this._currentInstruction_Address=0;this._currentInstruction_OpCode=0;this._currentInstruction_Parameters0=0;this._currentInstruction_Parameters1=0;this._currentInstruction_ExtraTiming=0;this.systemClock=System.UInt64(0);this.nextEvent=-1;this.clockcount=System.Array.init(256,0,System.Int32);this.instruction=System.Array.init(256,0,System.Int32);this.addressmode=System.Array.init(256,0,ChiChiNES.AddressingModes);this.memoryPatches=new(System.Collections.Generic.Dictionary$2(System.Int32,ChiChiNES.Hacking.IMemoryPatch));this.genieCodes=new(System.Collections.Generic.Dictionary$2(System.Int32,System.Int32));this._cheating=!1;this.Rams=System.Array.init(8192,0,System.Byte);this._stackPointer=255;this.instructionUsage=System.Array.init(256,0,System.Int32);this._debugging=!1;this.instructionHistoryPointer=255;this._instructionHistory=System.Array.init(256,null,ChiChiNES.CPU2A03.Instruction)},ctor:function(whizzler,bopper){this.$initialize();this._padOne=new ChiChiNES.InputHandler.ctor;this._padTwo=new ChiChiNES.InputHandler.ctor;this._pixelWhizzler=whizzler;this.SoundBopper=bopper;this.nmiHandler=Bridge.fn.cacheBind(this,this.NMIHandler);this.irqUpdater=Bridge.fn.cacheBind(this,this.IRQUpdater);bopper.NMIHandler=Bridge.fn.cacheBind(this,this.IRQUpdater);this._pixelWhizzler.ChiChiNES$IPPU$NMIHandler=this.nmiHandler}},methods:{getSRMask:function(flag){switch(flag){case ChiChiNES.CPUStatusBits.Carry:return 1;case ChiChiNES.CPUStatusBits.ZeroResult:return 2;case ChiChiNES.CPUStatusBits.InterruptDisable:return 4;case ChiChiNES.CPUStatusBits.DecimalMode:return 8;case ChiChiNES.CPUStatusBits.BreakCommand:return 16;case ChiChiNES.CPUStatusBits.Expansion:return 32;case ChiChiNES.CPUStatusBits.Overflow:return 64;case ChiChiNES.CPUStatusBits.NegativeResult:return 128}return 0},SetFlag:function(Flag,value){this._statusRegister=value?this._statusRegister|Flag:this._statusRegister&~Flag;this._statusRegister=this._statusRegister|ChiChiNES.CPUStatusMasks.ExpansionMask},GetFlag:function(Flag){var flag=Flag;return(this._statusRegister&flag)===flag},InterruptRequest:function(){if(!this.GetFlag(ChiChiNES.CPUStatusMasks.InterruptDisableMask)){this.SetFlag(ChiChiNES.CPUStatusMasks.InterruptDisableMask,!0);var newStatusReg=this._statusRegister&-17|32;this.PushStack(Bridge.Int.div(this.ProgramCounter,256)|0);this.PushStack(this.ProgramCounter);this.PushStack(this.StatusRegister);this.ProgramCounter=this.GetByte$1(65534)+(this.GetByte$1(65535)<<8)|0}},NonMaskableInterrupt:function(){var newStatusReg=this._statusRegister&-17|32;this.SetFlag(ChiChiNES.CPUStatusMasks.InterruptDisableMask,!0);this.PushStack(this._programCounter>>8);this.PushStack(this._programCounter&255);this.PushStack(newStatusReg);var lowByte=this.GetByte$1(65530)&255,highByte=this.GetByte$1(65531)&255,jumpTo=lowByte|highByte<<8;this.ProgramCounter=jumpTo},CheckEvent:function(){this.nextEvent===-1&&this.FindNextEvent()},RunFast:function(){while(this.clock<29780)this.Step()},Step:function(){var newStatusReg,newStatusReg1;if(this._currentInstruction_ExtraTiming=0,this.nextEvent<=this.clock&&this.HandleNextEvent(),this._handleNMI){this._handleNMI=!1;this.clock=this.clock+7|0;newStatusReg=this._statusRegister&-17|32;this.SetFlag(ChiChiNES.CPUStatusMasks.InterruptDisableMask,!0);this.PushStack(this._programCounter>>8);this.PushStack(this._programCounter&255);this.PushStack(newStatusReg);var lowByte=this.GetByte$1(65530)&255,highByte=this.GetByte$1(65531)&255,jumpTo=lowByte|highByte<<8;this.ProgramCounter=jumpTo}else if(this._handleIRQ){if(this._handleIRQ=!1,this.clock=this.clock+7|0,this.GetFlag(ChiChiNES.CPUStatusMasks.InterruptDisableMask))return;this.SetFlag(ChiChiNES.CPUStatusMasks.InterruptDisableMask,!0);newStatusReg1=this._statusRegister&-17|32;this.PushStack(Bridge.Int.div(this.ProgramCounter,256)|0);this.PushStack(this.ProgramCounter);this.PushStack(this.StatusRegister);this.ProgramCounter=this.GetByte$1(65534)+(this.GetByte$1(65535)<<8)|0}this._currentInstruction_Address=this._programCounter;this._currentInstruction_OpCode=this.GetByte$1(Bridge.identity(this._programCounter,this._programCounter=this._programCounter+1|0));this._currentInstruction_AddressingMode=this.addressmode[this._currentInstruction_OpCode];switch(this._currentInstruction_AddressingMode){case ChiChiNES.AddressingModes.Absolute:case ChiChiNES.AddressingModes.AbsoluteX:case ChiChiNES.AddressingModes.AbsoluteY:case ChiChiNES.AddressingModes.Indirect:this._currentInstruction_Parameters0=this.GetByte$1(Bridge.identity(this._programCounter,this._programCounter=this._programCounter+1|0));this._currentInstruction_Parameters1=this.GetByte$1(Bridge.identity(this._programCounter,this._programCounter=this._programCounter+1|0));break;case ChiChiNES.AddressingModes.ZeroPage:case ChiChiNES.AddressingModes.ZeroPageX:case ChiChiNES.AddressingModes.ZeroPageY:case ChiChiNES.AddressingModes.Relative:case ChiChiNES.AddressingModes.IndexedIndirect:case ChiChiNES.AddressingModes.IndirectIndexed:case ChiChiNES.AddressingModes.IndirectZeroPage:case ChiChiNES.AddressingModes.Immediate:this._currentInstruction_Parameters0=this.GetByte$1(Bridge.identity(this._programCounter,this._programCounter=this._programCounter+1|0))}this.Execute();this._debugging&&(this.WriteInstructionHistoryAndUsage(),this._operationCounter=this._operationCounter+1|0);this.clock=this.clock+(ChiChiNES.CPU2A03.cpuTiming[this._currentInstruction_OpCode]+this._currentInstruction_ExtraTiming|0)|0},RunCycles:function(count){for(var startCycles=this._ticks;(this._ticks-startCycles|0)<count;)this.Step()},setupticks:function(){this.clockcount[0]=7;this.addressmode[0]=ChiChiNES.AddressingModes.Implicit;this.clockcount[1]=6;this.addressmode[1]=ChiChiNES.AddressingModes.IndexedIndirect;this.clockcount[2]=2;this.addressmode[2]=ChiChiNES.AddressingModes.Implicit;this.clockcount[3]=2;this.addressmode[3]=ChiChiNES.AddressingModes.Bullshit;this.clockcount[4]=3;this.addressmode[4]=ChiChiNES.AddressingModes.Bullshit;this.clockcount[5]=3;this.addressmode[5]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[6]=5;this.addressmode[6]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[7]=2;this.addressmode[7]=ChiChiNES.AddressingModes.Bullshit;this.clockcount[8]=3;this.addressmode[8]=ChiChiNES.AddressingModes.Implicit;this.clockcount[9]=3;this.addressmode[9]=ChiChiNES.AddressingModes.Immediate;this.clockcount[10]=2;this.addressmode[10]=ChiChiNES.AddressingModes.Accumulator;this.clockcount[11]=2;this.addressmode[11]=ChiChiNES.AddressingModes.Immediate;this.clockcount[12]=4;this.addressmode[12]=ChiChiNES.AddressingModes.Absolute;this.clockcount[13]=4;this.addressmode[13]=ChiChiNES.AddressingModes.Absolute;this.clockcount[14]=6;this.addressmode[14]=ChiChiNES.AddressingModes.Absolute;this.clockcount[15]=2;this.addressmode[15]=ChiChiNES.AddressingModes.Implicit;this.clockcount[16]=2;this.addressmode[16]=ChiChiNES.AddressingModes.Relative;this.clockcount[17]=5;this.addressmode[17]=ChiChiNES.AddressingModes.IndirectIndexed;this.clockcount[18]=3;this.addressmode[18]=ChiChiNES.AddressingModes.IndirectZeroPage;this.clockcount[19]=2;this.addressmode[19]=ChiChiNES.AddressingModes.Implicit;this.clockcount[20]=3;this.addressmode[20]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[21]=4;this.addressmode[21]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[22]=6;this.addressmode[22]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[23]=2;this.addressmode[23]=ChiChiNES.AddressingModes.Implicit;this.clockcount[24]=2;this.addressmode[24]=ChiChiNES.AddressingModes.Implicit;this.clockcount[25]=4;this.addressmode[25]=ChiChiNES.AddressingModes.AbsoluteY;this.clockcount[26]=2;this.addressmode[26]=ChiChiNES.AddressingModes.Implicit;this.clockcount[27]=2;this.addressmode[27]=ChiChiNES.AddressingModes.Implicit;this.clockcount[28]=4;this.addressmode[28]=ChiChiNES.AddressingModes.Absolute;this.clockcount[29]=4;this.addressmode[29]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[30]=7;this.addressmode[30]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[31]=2;this.addressmode[31]=ChiChiNES.AddressingModes.Implicit;this.clockcount[32]=6;this.addressmode[32]=ChiChiNES.AddressingModes.Absolute;this.clockcount[33]=6;this.addressmode[33]=ChiChiNES.AddressingModes.IndexedIndirect;this.clockcount[34]=2;this.addressmode[34]=ChiChiNES.AddressingModes.Implicit;this.clockcount[35]=2;this.addressmode[35]=ChiChiNES.AddressingModes.Implicit;this.clockcount[36]=3;this.addressmode[36]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[37]=3;this.addressmode[37]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[38]=5;this.addressmode[38]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[39]=2;this.addressmode[39]=ChiChiNES.AddressingModes.Implicit;this.clockcount[40]=4;this.addressmode[40]=ChiChiNES.AddressingModes.Implicit;this.clockcount[41]=3;this.addressmode[41]=ChiChiNES.AddressingModes.Immediate;this.clockcount[42]=2;this.addressmode[42]=ChiChiNES.AddressingModes.Accumulator;this.clockcount[43]=2;this.addressmode[43]=ChiChiNES.AddressingModes.Immediate;this.clockcount[44]=4;this.addressmode[44]=ChiChiNES.AddressingModes.Absolute;this.clockcount[45]=4;this.addressmode[45]=ChiChiNES.AddressingModes.Absolute;this.clockcount[46]=6;this.addressmode[46]=ChiChiNES.AddressingModes.Absolute;this.clockcount[47]=2;this.addressmode[47]=ChiChiNES.AddressingModes.Implicit;this.clockcount[48]=2;this.addressmode[48]=ChiChiNES.AddressingModes.Relative;this.clockcount[49]=5;this.addressmode[49]=ChiChiNES.AddressingModes.IndirectIndexed;this.clockcount[50]=3;this.addressmode[50]=ChiChiNES.AddressingModes.IndirectZeroPage;this.clockcount[51]=2;this.addressmode[51]=ChiChiNES.AddressingModes.Implicit;this.clockcount[52]=4;this.addressmode[52]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[53]=4;this.addressmode[53]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[54]=6;this.addressmode[54]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[55]=2;this.addressmode[55]=ChiChiNES.AddressingModes.Implicit;this.clockcount[56]=2;this.addressmode[56]=ChiChiNES.AddressingModes.Implicit;this.clockcount[57]=4;this.addressmode[57]=ChiChiNES.AddressingModes.AbsoluteY;this.clockcount[58]=2;this.addressmode[58]=ChiChiNES.AddressingModes.Implicit;this.clockcount[59]=2;this.addressmode[59]=ChiChiNES.AddressingModes.Implicit;this.clockcount[60]=4;this.addressmode[60]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[61]=4;this.addressmode[61]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[62]=7;this.addressmode[62]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[63]=2;this.addressmode[63]=ChiChiNES.AddressingModes.Implicit;this.clockcount[64]=6;this.addressmode[64]=ChiChiNES.AddressingModes.Implicit;this.clockcount[65]=6;this.addressmode[65]=ChiChiNES.AddressingModes.IndexedIndirect;this.clockcount[66]=2;this.addressmode[66]=ChiChiNES.AddressingModes.Implicit;this.clockcount[67]=2;this.addressmode[67]=ChiChiNES.AddressingModes.Implicit;this.clockcount[68]=2;this.addressmode[68]=ChiChiNES.AddressingModes.Implicit;this.clockcount[69]=3;this.addressmode[69]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[70]=5;this.addressmode[70]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[71]=2;this.addressmode[71]=ChiChiNES.AddressingModes.Implicit;this.clockcount[72]=3;this.addressmode[72]=ChiChiNES.AddressingModes.Implicit;this.clockcount[73]=3;this.addressmode[73]=ChiChiNES.AddressingModes.Immediate;this.clockcount[74]=2;this.addressmode[74]=ChiChiNES.AddressingModes.Accumulator;this.clockcount[75]=2;this.addressmode[75]=ChiChiNES.AddressingModes.Immediate;this.clockcount[76]=3;this.addressmode[76]=ChiChiNES.AddressingModes.Absolute;this.clockcount[77]=4;this.addressmode[77]=ChiChiNES.AddressingModes.Absolute;this.clockcount[78]=6;this.addressmode[78]=ChiChiNES.AddressingModes.Absolute;this.clockcount[79]=2;this.addressmode[79]=ChiChiNES.AddressingModes.Implicit;this.clockcount[80]=2;this.addressmode[80]=ChiChiNES.AddressingModes.Relative;this.clockcount[81]=5;this.addressmode[81]=ChiChiNES.AddressingModes.IndirectIndexed;this.clockcount[82]=3;this.addressmode[82]=ChiChiNES.AddressingModes.IndirectZeroPage;this.clockcount[83]=2;this.addressmode[83]=ChiChiNES.AddressingModes.Implicit;this.clockcount[84]=2;this.addressmode[84]=ChiChiNES.AddressingModes.Implicit;this.clockcount[85]=4;this.addressmode[85]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[86]=6;this.addressmode[86]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[87]=2;this.addressmode[87]=ChiChiNES.AddressingModes.Implicit;this.clockcount[88]=2;this.addressmode[88]=ChiChiNES.AddressingModes.Implicit;this.clockcount[89]=4;this.addressmode[89]=ChiChiNES.AddressingModes.AbsoluteY;this.clockcount[90]=3;this.addressmode[90]=ChiChiNES.AddressingModes.Implicit;this.clockcount[91]=2;this.addressmode[91]=ChiChiNES.AddressingModes.Implicit;this.clockcount[92]=2;this.addressmode[92]=ChiChiNES.AddressingModes.Implicit;this.clockcount[93]=4;this.addressmode[93]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[94]=7;this.addressmode[94]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[95]=2;this.addressmode[95]=ChiChiNES.AddressingModes.Implicit;this.clockcount[96]=6;this.addressmode[96]=ChiChiNES.AddressingModes.Implicit;this.clockcount[97]=6;this.addressmode[97]=ChiChiNES.AddressingModes.IndexedIndirect;this.clockcount[98]=2;this.addressmode[98]=ChiChiNES.AddressingModes.Implicit;this.clockcount[99]=2;this.addressmode[99]=ChiChiNES.AddressingModes.Implicit;this.clockcount[100]=3;this.addressmode[100]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[101]=3;this.addressmode[101]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[102]=5;this.addressmode[102]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[103]=2;this.addressmode[103]=ChiChiNES.AddressingModes.Implicit;this.clockcount[104]=4;this.addressmode[104]=ChiChiNES.AddressingModes.Implicit;this.clockcount[105]=3;this.addressmode[105]=ChiChiNES.AddressingModes.Immediate;this.clockcount[106]=2;this.addressmode[106]=ChiChiNES.AddressingModes.Accumulator;this.clockcount[107]=2;this.addressmode[107]=ChiChiNES.AddressingModes.Immediate;this.clockcount[108]=5;this.addressmode[108]=ChiChiNES.AddressingModes.Indirect;this.clockcount[109]=4;this.addressmode[109]=ChiChiNES.AddressingModes.Absolute;this.clockcount[110]=6;this.addressmode[110]=ChiChiNES.AddressingModes.Absolute;this.clockcount[111]=2;this.addressmode[111]=ChiChiNES.AddressingModes.Implicit;this.clockcount[112]=2;this.addressmode[112]=ChiChiNES.AddressingModes.Relative;this.clockcount[113]=5;this.addressmode[113]=ChiChiNES.AddressingModes.IndirectIndexed;this.clockcount[114]=3;this.addressmode[114]=ChiChiNES.AddressingModes.IndirectZeroPage;this.clockcount[115]=2;this.addressmode[115]=ChiChiNES.AddressingModes.Implicit;this.clockcount[116]=4;this.addressmode[116]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[117]=4;this.addressmode[117]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[118]=6;this.addressmode[118]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[119]=2;this.addressmode[119]=ChiChiNES.AddressingModes.Implicit;this.clockcount[120]=2;this.addressmode[120]=ChiChiNES.AddressingModes.Implicit;this.clockcount[121]=4;this.addressmode[121]=ChiChiNES.AddressingModes.AbsoluteY;this.clockcount[122]=4;this.addressmode[122]=ChiChiNES.AddressingModes.Implicit;this.clockcount[123]=2;this.addressmode[123]=ChiChiNES.AddressingModes.Implicit;this.clockcount[124]=6;this.addressmode[124]=ChiChiNES.AddressingModes.IndirectAbsoluteX;this.clockcount[125]=4;this.addressmode[125]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[126]=7;this.addressmode[126]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[127]=2;this.addressmode[127]=ChiChiNES.AddressingModes.Implicit;this.clockcount[128]=2;this.addressmode[128]=ChiChiNES.AddressingModes.Relative;this.clockcount[129]=6;this.addressmode[129]=ChiChiNES.AddressingModes.IndexedIndirect;this.clockcount[130]=2;this.addressmode[130]=ChiChiNES.AddressingModes.Immediate;this.clockcount[131]=2;this.addressmode[131]=ChiChiNES.AddressingModes.Implicit;this.clockcount[132]=2;this.addressmode[132]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[133]=2;this.addressmode[133]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[134]=2;this.addressmode[134]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[135]=2;this.addressmode[135]=ChiChiNES.AddressingModes.Implicit;this.clockcount[136]=2;this.addressmode[136]=ChiChiNES.AddressingModes.Implicit;this.clockcount[137]=2;this.addressmode[137]=ChiChiNES.AddressingModes.Immediate;this.clockcount[138]=2;this.addressmode[138]=ChiChiNES.AddressingModes.Implicit;this.clockcount[139]=2;this.addressmode[139]=ChiChiNES.AddressingModes.Implicit;this.clockcount[140]=4;this.addressmode[140]=ChiChiNES.AddressingModes.Absolute;this.clockcount[141]=4;this.addressmode[141]=ChiChiNES.AddressingModes.Absolute;this.clockcount[142]=4;this.addressmode[142]=ChiChiNES.AddressingModes.Absolute;this.clockcount[143]=2;this.addressmode[143]=ChiChiNES.AddressingModes.Implicit;this.clockcount[144]=2;this.addressmode[144]=ChiChiNES.AddressingModes.Relative;this.clockcount[145]=6;this.addressmode[145]=ChiChiNES.AddressingModes.IndirectIndexed;this.clockcount[146]=3;this.addressmode[146]=ChiChiNES.AddressingModes.IndirectZeroPage;this.clockcount[147]=2;this.addressmode[147]=ChiChiNES.AddressingModes.Implicit;this.clockcount[148]=4;this.addressmode[148]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[149]=4;this.addressmode[149]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[150]=4;this.addressmode[150]=ChiChiNES.AddressingModes.ZeroPageY;this.clockcount[151]=2;this.addressmode[151]=ChiChiNES.AddressingModes.Implicit;this.clockcount[152]=2;this.addressmode[152]=ChiChiNES.AddressingModes.Implicit;this.clockcount[153]=5;this.addressmode[153]=ChiChiNES.AddressingModes.AbsoluteY;this.clockcount[154]=2;this.addressmode[154]=ChiChiNES.AddressingModes.Implicit;this.clockcount[155]=2;this.addressmode[155]=ChiChiNES.AddressingModes.Implicit;this.clockcount[156]=4;this.addressmode[156]=ChiChiNES.AddressingModes.Absolute;this.clockcount[157]=5;this.addressmode[157]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[158]=5;this.addressmode[158]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[159]=2;this.addressmode[159]=ChiChiNES.AddressingModes.Implicit;this.clockcount[160]=3;this.addressmode[160]=ChiChiNES.AddressingModes.Immediate;this.clockcount[161]=6;this.addressmode[161]=ChiChiNES.AddressingModes.IndexedIndirect;this.clockcount[162]=3;this.addressmode[162]=ChiChiNES.AddressingModes.Immediate;this.clockcount[163]=2;this.addressmode[163]=ChiChiNES.AddressingModes.Implicit;this.clockcount[164]=3;this.addressmode[164]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[165]=3;this.addressmode[165]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[166]=3;this.addressmode[166]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[167]=2;this.addressmode[167]=ChiChiNES.AddressingModes.Implicit;this.clockcount[168]=2;this.addressmode[168]=ChiChiNES.AddressingModes.Implicit;this.clockcount[169]=3;this.addressmode[169]=ChiChiNES.AddressingModes.Immediate;this.clockcount[170]=2;this.addressmode[170]=ChiChiNES.AddressingModes.Implicit;this.clockcount[171]=2;this.addressmode[171]=ChiChiNES.AddressingModes.Immediate;this.clockcount[172]=4;this.addressmode[172]=ChiChiNES.AddressingModes.Absolute;this.clockcount[173]=4;this.addressmode[173]=ChiChiNES.AddressingModes.Absolute;this.clockcount[174]=4;this.addressmode[174]=ChiChiNES.AddressingModes.Absolute;this.clockcount[175]=2;this.addressmode[175]=ChiChiNES.AddressingModes.Implicit;this.clockcount[176]=2;this.addressmode[176]=ChiChiNES.AddressingModes.Relative;this.clockcount[177]=5;this.addressmode[177]=ChiChiNES.AddressingModes.IndirectIndexed;this.clockcount[178]=3;this.addressmode[178]=ChiChiNES.AddressingModes.IndirectZeroPage;this.clockcount[179]=2;this.addressmode[179]=ChiChiNES.AddressingModes.Implicit;this.clockcount[180]=4;this.addressmode[180]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[181]=4;this.addressmode[181]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[182]=4;this.addressmode[182]=ChiChiNES.AddressingModes.ZeroPageY;this.clockcount[183]=2;this.addressmode[183]=ChiChiNES.AddressingModes.Implicit;this.clockcount[184]=2;this.addressmode[184]=ChiChiNES.AddressingModes.Implicit;this.clockcount[185]=4;this.addressmode[185]=ChiChiNES.AddressingModes.AbsoluteY;this.clockcount[186]=2;this.addressmode[186]=ChiChiNES.AddressingModes.Implicit;this.clockcount[187]=2;this.addressmode[187]=ChiChiNES.AddressingModes.Implicit;this.clockcount[188]=4;this.addressmode[188]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[189]=4;this.addressmode[189]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[190]=4;this.addressmode[190]=ChiChiNES.AddressingModes.AbsoluteY;this.clockcount[191]=2;this.addressmode[191]=ChiChiNES.AddressingModes.Implicit;this.clockcount[192]=3;this.addressmode[192]=ChiChiNES.AddressingModes.Immediate;this.clockcount[193]=6;this.addressmode[193]=ChiChiNES.AddressingModes.IndexedIndirect;this.clockcount[194]=2;this.addressmode[194]=ChiChiNES.AddressingModes.Immediate;this.clockcount[195]=2;this.addressmode[195]=ChiChiNES.AddressingModes.Implicit;this.clockcount[196]=3;this.addressmode[196]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[197]=3;this.addressmode[197]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[198]=5;this.addressmode[198]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[199]=2;this.addressmode[199]=ChiChiNES.AddressingModes.Implicit;this.clockcount[200]=2;this.addressmode[200]=ChiChiNES.AddressingModes.Implicit;this.clockcount[201]=3;this.addressmode[201]=ChiChiNES.AddressingModes.Immediate;this.clockcount[202]=2;this.addressmode[202]=ChiChiNES.AddressingModes.Implicit;this.clockcount[203]=2;this.addressmode[203]=ChiChiNES.AddressingModes.Immediate;this.clockcount[204]=4;this.addressmode[204]=ChiChiNES.AddressingModes.Absolute;this.clockcount[205]=4;this.addressmode[205]=ChiChiNES.AddressingModes.Absolute;this.clockcount[206]=6;this.addressmode[206]=ChiChiNES.AddressingModes.Absolute;this.clockcount[207]=2;this.addressmode[207]=ChiChiNES.AddressingModes.Implicit;this.clockcount[208]=2;this.addressmode[208]=ChiChiNES.AddressingModes.Relative;this.clockcount[209]=5;this.addressmode[209]=ChiChiNES.AddressingModes.IndirectIndexed;this.clockcount[210]=3;this.addressmode[210]=ChiChiNES.AddressingModes.IndirectZeroPage;this.clockcount[211]=2;this.addressmode[211]=ChiChiNES.AddressingModes.Implicit;this.clockcount[212]=2;this.addressmode[212]=ChiChiNES.AddressingModes.Implicit;this.clockcount[213]=4;this.addressmode[213]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[214]=6;this.addressmode[214]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[215]=2;this.addressmode[215]=ChiChiNES.AddressingModes.Implicit;this.clockcount[216]=2;this.addressmode[216]=ChiChiNES.AddressingModes.Implicit;this.clockcount[217]=4;this.addressmode[217]=ChiChiNES.AddressingModes.AbsoluteY;this.clockcount[218]=3;this.addressmode[218]=ChiChiNES.AddressingModes.Implicit;this.clockcount[219]=2;this.addressmode[219]=ChiChiNES.AddressingModes.Implicit;this.clockcount[220]=2;this.addressmode[220]=ChiChiNES.AddressingModes.Implicit;this.clockcount[221]=4;this.addressmode[221]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[222]=7;this.addressmode[222]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[223]=2;this.addressmode[223]=ChiChiNES.AddressingModes.Implicit;this.clockcount[224]=3;this.addressmode[224]=ChiChiNES.AddressingModes.Immediate;this.clockcount[225]=6;this.addressmode[225]=ChiChiNES.AddressingModes.IndexedIndirect;this.clockcount[226]=2;this.addressmode[226]=ChiChiNES.AddressingModes.Immediate;this.clockcount[227]=2;this.addressmode[227]=ChiChiNES.AddressingModes.Implicit;this.clockcount[228]=3;this.addressmode[228]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[229]=3;this.addressmode[229]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[230]=5;this.addressmode[230]=ChiChiNES.AddressingModes.ZeroPage;this.clockcount[231]=2;this.addressmode[231]=ChiChiNES.AddressingModes.Implicit;this.clockcount[232]=2;this.addressmode[232]=ChiChiNES.AddressingModes.Implicit;this.clockcount[233]=3;this.addressmode[233]=ChiChiNES.AddressingModes.Immediate;this.clockcount[234]=2;this.addressmode[234]=ChiChiNES.AddressingModes.Implicit;this.clockcount[235]=2;this.addressmode[235]=ChiChiNES.AddressingModes.Immediate;this.clockcount[236]=4;this.addressmode[236]=ChiChiNES.AddressingModes.Absolute;this.clockcount[237]=4;this.addressmode[237]=ChiChiNES.AddressingModes.Absolute;this.clockcount[238]=6;this.addressmode[238]=ChiChiNES.AddressingModes.Absolute;this.clockcount[239]=2;this.addressmode[239]=ChiChiNES.AddressingModes.Implicit;this.clockcount[240]=2;this.addressmode[240]=ChiChiNES.AddressingModes.Relative;this.clockcount[241]=5;this.addressmode[241]=ChiChiNES.AddressingModes.IndirectIndexed;this.clockcount[242]=3;this.addressmode[242]=ChiChiNES.AddressingModes.IndirectZeroPage;this.clockcount[243]=2;this.addressmode[243]=ChiChiNES.AddressingModes.Implicit;this.clockcount[244]=2;this.addressmode[244]=ChiChiNES.AddressingModes.Implicit;this.clockcount[245]=4;this.addressmode[245]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[246]=6;this.addressmode[246]=ChiChiNES.AddressingModes.ZeroPageX;this.clockcount[247]=2;this.addressmode[247]=ChiChiNES.AddressingModes.Implicit;this.clockcount[248]=2;this.addressmode[248]=ChiChiNES.AddressingModes.Implicit;this.clockcount[249]=4;this.addressmode[249]=ChiChiNES.AddressingModes.AbsoluteY;this.clockcount[250]=4;this.addressmode[250]=ChiChiNES.AddressingModes.Implicit;this.clockcount[251]=2;this.addressmode[251]=ChiChiNES.AddressingModes.Implicit;this.clockcount[252]=2;this.addressmode[252]=ChiChiNES.AddressingModes.Implicit;this.clockcount[253]=4;this.addressmode[253]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[254]=7;this.addressmode[254]=ChiChiNES.AddressingModes.AbsoluteX;this.clockcount[255]=2;this.addressmode[255]=ChiChiNES.AddressingModes.Implicit},ResetCPU:function(){this._statusRegister=52;this._operationCounter=0;this._stackPointer=253;this.setupticks();this.Ticks=4;this.ProgramCounter=this.GetByte$1(65532)+Bridge.Int.mul(this.GetByte$1(65533),256)|0},PowerOn:function(){this._statusRegister=52;this._stackPointer=253;this._operationCounter=0;this.setupticks();this.Ticks=4;for(var i=0;i<2048;i=i+1|0)this.Rams[i]=255;this.Rams[8]=247;this.Rams[9]=239;this.Rams[10]=223;this.Rams[15]=191;this.ProgramCounter=this.GetByte$1(65532)+Bridge.Int.mul(this.GetByte$1(65533),256)|0},GetState:function(outStream){outStream.enqueue(this._programCounter);outStream.enqueue(this._accumulator);outStream.enqueue(this._indexRegisterX);outStream.enqueue(this._indexRegisterY);outStream.enqueue(this._statusRegister);outStream.enqueue(this._stackPointer);for(var i=0;i<2048;i=i+4|0)outStream.enqueue(this.Rams[i]<<24|this.Rams[i+1|0]<<16|this.Rams[i+2|0]<<8|this.Rams[i+3|0])},SetState:function(inStream){var packedByte,i;for(this._programCounter=inStream.dequeue(),this._accumulator=inStream.dequeue(),this._indexRegisterX=inStream.dequeue(),this._indexRegisterY=inStream.dequeue(),this._statusRegister=inStream.dequeue(),this._stackPointer=inStream.dequeue(),packedByte=0,i=0;i<2048;i=i+4|0)packedByte=inStream.dequeue(),this.Rams[i]=packedByte>>24&255,this.Rams[i+1|0]=packedByte>>16&255,this.Rams[i+2|0]=packedByte>>8&255,this.Rams[i+3|0]=packedByte&255},DecodeAddress:function(){var result,indAddr,indirectAddr,addr;this._currentInstruction_ExtraTiming=0;result=0;switch(this._currentInstruction_AddressingMode){case ChiChiNES.AddressingModes.Absolute:result=this._currentInstruction_Parameters1<<8|this._currentInstruction_Parameters0;break;case ChiChiNES.AddressingModes.AbsoluteX:result=(this._currentInstruction_Parameters1<<8|this._currentInstruction_Parameters0)+this._indexRegisterX|0;(result&255)<this._indexRegisterX&&(this._currentInstruction_ExtraTiming=1);break;case ChiChiNES.AddressingModes.AbsoluteY:result=(this._currentInstruction_Parameters1<<8|this._currentInstruction_Parameters0)+this._indexRegisterY|0;(result&255)<this._indexRegisterY&&(this._currentInstruction_ExtraTiming=1);break;case ChiChiNES.AddressingModes.ZeroPage:result=this._currentInstruction_Parameters0&255;break;case ChiChiNES.AddressingModes.ZeroPageX:result=(this._currentInstruction_Parameters0+this._indexRegisterX|0)&255;break;case ChiChiNES.AddressingModes.ZeroPageY:result=((this._currentInstruction_Parameters0&255)+(this._indexRegisterY&255)|0)&255;break;case ChiChiNES.AddressingModes.Indirect:this.lowByte=this._currentInstruction_Parameters0;this.highByte=this._currentInstruction_Parameters1<<8;indAddr=(this.highByte|this.lowByte)&65535;indirectAddr=this.GetByte$1(indAddr);this.lowByte=(this.lowByte+1|0)&255;indAddr=(this.highByte|this.lowByte)&65535;indirectAddr=indirectAddr|this.GetByte$1(indAddr)<<8;result=indirectAddr;break;case ChiChiNES.AddressingModes.IndexedIndirect:addr=(this._currentInstruction_Parameters0+this._indexRegisterX|0)&255;this.lowByte=this.GetByte$1(addr);addr=addr+1|0;this.highByte=this.GetByte$1(addr&255);this.highByte=this.highByte<<8;result=this.highByte|this.lowByte;break;case ChiChiNES.AddressingModes.IndirectIndexed:this.lowByte=this.GetByte$1(this._currentInstruction_Parameters0&255);this.highByte=this.GetByte$1((this._currentInstruction_Parameters0+1|0)&255)<<8;addr=this.lowByte|this.highByte;result=addr+this._indexRegisterY|0;(result&255)>this._indexRegisterY&&(this._currentInstruction_ExtraTiming=1);break;case ChiChiNES.AddressingModes.Relative:result=this._programCounter+this._currentInstruction_Parameters0|0;break;default:this.HandleBadOperation()}return result&65535},HandleBadOperation:function(){throw new System.NotImplementedException("Executors.DecodeAddress() recieved an invalid addressmode");},DecodeOperand:function(){switch(this._currentInstruction_AddressingMode){case ChiChiNES.AddressingModes.Immediate:return this.DataBus=this._currentInstruction_Parameters0,this._currentInstruction_Parameters0;case ChiChiNES.AddressingModes.Accumulator:return this._accumulator;default:return this.DataBus=this.GetByte$1(this.DecodeAddress()),this.DataBus}},StoreOperand:function(){},Execute:function(){switch(this._currentInstruction_OpCode){case 128:case 130:case 194:case 226:case 4:case 20:case 52:case 68:case 84:case 100:case 116:case 212:case 244:case 12:case 28:case 60:case 92:case 124:case 220:case 252:this.DecodeAddress();break;case 105:case 101:case 117:case 109:case 125:case 121:case 97:case 113:this.ADC();break;case 41:case 37:case 53:case 45:case 61:case 57:case 33:case 49:this.AND();break;case 10:case 6:case 22:case 14:case 30:this.ASL();break;case 144:this.BCC();break;case 176:this.BCS();break;case 240:this.BEQ();break;case 36:case 44:this.BIT();break;case 48:this.BMI();break;case 208:this.BNE();break;case 16:this.BPL();break;case 0:this.BRK();break;case 80:this.BVC();break;case 112:this.BVS();break;case 24:this.CLC();break;case 216:this.CLD();break;case 88:this.CLI();break;case 184:this.CLV();break;case 201:case 197:case 213:case 205:case 221:case 217:case 193:case 209:this.CMP();break;case 224:case 228:case 236:this.CPX();break;case 192:case 196:case 204:this.CPY();break;case 198:case 214:case 206:case 222:this.DEC();break;case 202:this.DEX();break;case 136:this.DEY();break;case 73:case 69:case 85:case 77:case 93:case 89:case 65:case 81:this.EOR();break;case 230:case 246:case 238:case 254:this.INC();break;case 232:this.INX();break;case 200:this.INY();break;case 76:case 108:this.JMP();break;case 32:this.JSR();break;case 169:case 165:case 181:case 173:case 189:case 185:case 161:case 177:this.LDA();break;case 162:case 166:case 182:case 174:case 190:this.LDX();break;case 160:case 164:case 180:case 172:case 188:this.LDY();break;case 74:case 70:case 86:case 78:case 94:this.LSR();break;case 234:case 26:case 58:case 90:case 122:case 218:case 250:case 137:this.NOP();break;case 9:case 5:case 21:case 13:case 29:case 25:case 1:case 17:this.ORA();break;case 72:this.PHA();break;case 8:this.PHP();break;case 104:this.PLA();break;case 40:this.PLP();break;case 42:case 38:case 54:case 46:case 62:this.ROL();break;case 106:case 102:case 118:case 110:case 126:this.ROR();break;case 64:this.RTI();break;case 96:this.RTS();break;case 235:case 233:case 229:case 245:case 237:case 253:case 249:case 225:case 241:this.SBC();break;case 56:this.SEC();break;case 248:this.SED();break;case 120:this.SEI();break;case 133:case 149:case 141:case 157:case 153:case 129:case 145:this.STA();break;case 134:case 150:case 142:this.STX();break;case 132:case 148:case 140:this.STY();break;case 170:this.TAX();break;case 168:this.TAY();break;case 186:this.TSX();break;case 138:this.TXA();break;case 154:this.TXS();break;case 152:this.TYA();break;case 11:case 43:this.AAC();break;case 75:this.ASR();break;case 107:this.ARR();break;case 171:this.ATX()}},SetZNFlags:function(data){this._statusRegister=(data&255)==0?this._statusRegister|2:this._statusRegister&-3;this._statusRegister=(data&128)==128?this._statusRegister|128:this._statusRegister&-129},LDA:function(){this._accumulator=this.DecodeOperand();this.SetZNFlags(this._accumulator)},LDX:function(){this._indexRegisterX=this.DecodeOperand();this.SetZNFlags(this._indexRegisterX)},LDY:function(){this._indexRegisterY=this.DecodeOperand();this.SetZNFlags(this._indexRegisterY)},STA:function(){this.SetByte$1(this.DecodeAddress(),this._accumulator)},STX:function(){this.SetByte$1(this.DecodeAddress(),this._indexRegisterX)},STY:function(){this.SetByte$1(this.DecodeAddress(),this._indexRegisterY)},SED:function(){this.SetFlag(ChiChiNES.CPUStatusMasks.DecimalModeMask,!0)},CLD:function(){this.SetFlag(ChiChiNES.CPUStatusMasks.DecimalModeMask,!1)},JMP:function(){this._programCounter=this._currentInstruction_AddressingMode===ChiChiNES.AddressingModes.Indirect&&this._currentInstruction_Parameters0===255?255|this._currentInstruction_Parameters1<<8:this.DecodeAddress()},DEC:function(){var val=this.DecodeOperand()&255;val=val-1&255;this.SetByte$1(this.DecodeAddress(),val);this.SetZNFlags(val)},INC:function(){var val=this.DecodeOperand()&255;val=val+1&255;this.SetByte$1(this.DecodeAddress(),val);this.SetZNFlags(val)},ADC:function(){var data=this.DecodeOperand(),carryFlag=this._statusRegister&1,result=(this._accumulator+data|0)+carryFlag|0;this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,result>255);this.SetFlag(ChiChiNES.CPUStatusMasks.OverflowMask,((this._accumulator^data)&128)!=128&&((this._accumulator^result)&128)==128);this._accumulator=result&255;this.SetZNFlags(this._accumulator)},LSR:function(){var rst=this.DecodeOperand();this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,(rst&1)==1);rst=rst>>1&255;this.SetZNFlags(rst);this._currentInstruction_AddressingMode===ChiChiNES.AddressingModes.Accumulator?this._accumulator=rst:this.SetByte$1(this.DecodeAddress(),rst)},SKB:function(){},SBC:function(){var data=this.DecodeOperand()>>>0,carryFlag=(this._statusRegister^1)&1,result=System.Int64.clipu32(System.Int64(this._accumulator).sub(System.Int64(data)).sub(System.Int64(carryFlag)));this.SetFlag(ChiChiNES.CPUStatusMasks.OverflowMask,System.Int64(this._accumulator).xor(System.Int64(result)).and(System.Int64(128)).equals(System.Int64(128))&&System.Int64(this._accumulator).xor(System.Int64(data)).and(System.Int64(128)).equals(System.Int64(128)));this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,result<256);this._accumulator=result|0;this.SetZNFlags(this._accumulator)},AND:function(){this._accumulator=this._accumulator&this.DecodeOperand();this.SetZNFlags(this._accumulator)},ORA:function(){this._accumulator=this._accumulator|this.DecodeOperand();this.SetZNFlags(this._accumulator)},EOR:function(){this._accumulator=this._accumulator^this.DecodeOperand();this.SetZNFlags(this.Accumulator)},ASL:function(){var data=this.DecodeOperand();this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,(data&128)==128);data=data<<1&254;this._currentInstruction_AddressingMode===ChiChiNES.AddressingModes.Accumulator?this._accumulator=data:this.SetByte$1(this.DecodeAddress(),data);this.SetZNFlags(data)},BIT:function(){var operand=this.DecodeOperand();this.SetFlag(ChiChiNES.CPUStatusMasks.OverflowMask,(operand&64)==64);this._statusRegister=(operand&128)==128?this._statusRegister|128:this._statusRegister&127;this._statusRegister=(operand&this.Accumulator)==0?this._statusRegister|2:this._statusRegister&253},SEC:function(){this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,!0)},CLC:function(){this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,!1)},SEI:function(){this.SetFlag(ChiChiNES.CPUStatusMasks.InterruptDisableMask,!0)},CLI:function(){this.SetFlag(ChiChiNES.CPUStatusMasks.InterruptDisableMask,!1)},CLV:function(){this.SetFlag(ChiChiNES.CPUStatusMasks.OverflowMask,!1)},Compare:function(data){this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,data>255);this.SetZNFlags(data&255)},CMP:function(){var data=(this.Accumulator+256|0)-this.DecodeOperand()|0;this.Compare(data)},CPX:function(){var data=(this._indexRegisterX+256|0)-this.DecodeOperand()|0;this.Compare(data)},CPY:function(){var data=(this._indexRegisterY+256|0)-this.DecodeOperand()|0;this.Compare(data)},NOP:function(){this._currentInstruction_AddressingMode===ChiChiNES.AddressingModes.AbsoluteX&&this.DecodeAddress()},Branch:function(){System.Diagnostics.Debug.assert(ChiChiNES.CPU2A03.cpuTiming[this._currentInstruction_OpCode]===2);this._currentInstruction_ExtraTiming=1;var addr=this._currentInstruction_Parameters0&255;(addr&128)==128?(addr=addr-256|0,this._programCounter=this._programCounter+addr|0):this._programCounter=this._programCounter+addr|0;(this._programCounter&255)<addr&&(this._currentInstruction_ExtraTiming=2)},BCC:function(){(this._statusRegister&1)!=1&&this.Branch()},BCS:function(){(this._statusRegister&1)==1&&this.Branch()},BPL:function(){(this._statusRegister&128)!=128&&this.Branch()},BMI:function(){(this._statusRegister&128)==128&&this.Branch()},BVC:function(){(this._statusRegister&64)!=64&&this.Branch()},BVS:function(){(this._statusRegister&64)==64&&this.Branch()},BNE:function(){(this._statusRegister&2)!=2&&this.Branch()},BEQ:function(){(this._statusRegister&2)==2&&this.Branch()},DEX:function(){this._indexRegisterX=this._indexRegisterX-1|0;this._indexRegisterX=this._indexRegisterX&255;this.SetZNFlags(this._indexRegisterX)},DEY:function(){this._indexRegisterY=this._indexRegisterY-1|0;this._indexRegisterY=this._indexRegisterY&255;this.SetZNFlags(this._indexRegisterY)},INX:function(){this._indexRegisterX=this._indexRegisterX+1|0;this._indexRegisterX=this._indexRegisterX&255;this.SetZNFlags(this._indexRegisterX)},INY:function(){this._indexRegisterY=this._indexRegisterY+1|0;this._indexRegisterY=this._indexRegisterY&255;this.SetZNFlags(this._indexRegisterY)},TAX:function(){this._indexRegisterX=this._accumulator;this.SetZNFlags(this._indexRegisterX)},TXA:function(){this._accumulator=this._indexRegisterX;this.SetZNFlags(this._accumulator)},TAY:function(){this._indexRegisterY=this._accumulator;this.SetZNFlags(this._indexRegisterY)},TYA:function(){this._accumulator=this._indexRegisterY;this.SetZNFlags(this._accumulator)},TXS:function(){this._stackPointer=this._indexRegisterX},TSX:function(){this._indexRegisterX=this._stackPointer;this.SetZNFlags(this._indexRegisterX)},PHA:function(){this.PushStack(this._accumulator)},PLA:function(){this._accumulator=this.PopStack();this.SetZNFlags(this._accumulator)},PHP:function(){var newStatus=this._statusRegister|48;this.PushStack(newStatus)},PLP:function(){this._statusRegister=this.PopStack()},JSR:function(){this.PushStack(this._programCounter>>8&255);this.PushStack((this._programCounter-1|0)&255);this._programCounter=this.DecodeAddress()},ROR:function(){var data=this.DecodeOperand(),oldbit=0;this.GetFlag(ChiChiNES.CPUStatusMasks.CarryMask)&&(oldbit=128);this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,(data&1)==1);data=data>>1|oldbit;this.SetZNFlags(data);this._currentInstruction_AddressingMode===ChiChiNES.AddressingModes.Accumulator?this._accumulator=data:this.SetByte$1(this.DecodeAddress(),data)},ROL:function(){var data=this.DecodeOperand(),oldbit=0;this.GetFlag(ChiChiNES.CPUStatusMasks.CarryMask)&&(oldbit=1);this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,(data&128)==128);data=data<<1;data=data&255;data=data|oldbit;this.SetZNFlags(data);this._currentInstruction_AddressingMode===ChiChiNES.AddressingModes.Accumulator?this._accumulator=data:this.SetByte$1(this.DecodeAddress(),data)},RTS:function(){var high,low;low=(this.PopStack()+1|0)&255;high=this.PopStack();this._programCounter=high<<8|low},RTI:function(){this._statusRegister=this.PopStack();var low=this.PopStack(),high=this.PopStack();this._programCounter=Bridge.Int.mul(256,high)+low|0},BRK:function(){var newStatus,lowByte,highByte;this._programCounter=this._programCounter+1|0;this.PushStack(this._programCounter>>8&255);this.PushStack(this._programCounter&255);newStatus=this._statusRegister|48;this.PushStack(newStatus);this._statusRegister=this._statusRegister|20;this.AddressBus=65534;lowByte=this.GetByte();this.AddressBus=65535;highByte=this.GetByte();this._programCounter=lowByte+Bridge.Int.mul(highByte,256)|0},AAC:function(){this._accumulator=this.DecodeOperand()&this._accumulator&255;this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,(this._accumulator&128)==128);this.SetZNFlags(this._accumulator)},ASR:function(){this._accumulator=this.DecodeOperand()&this._accumulator;this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,(this._accumulator&1)==1);this._accumulator=this._accumulator>>1;this.SetZNFlags(this._accumulator)},ARR:function(){this._accumulator=this.DecodeOperand()&this._accumulator;this._accumulator=(this._statusRegister&1)==1?this._accumulator>>1|128:this._accumulator>>1;this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,(this._accumulator&1)==1);switch(this._accumulator&48){case 48:this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,!0);this.SetFlag(ChiChiNES.CPUStatusMasks.InterruptDisableMask,!1);break;case 0:this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,!1);this.SetFlag(ChiChiNES.CPUStatusMasks.InterruptDisableMask,!1);break;case 16:this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,!1);this.SetFlag(ChiChiNES.CPUStatusMasks.InterruptDisableMask,!0);break;case 32:this.SetFlag(ChiChiNES.CPUStatusMasks.CarryMask,!0);this.SetFlag(ChiChiNES.CPUStatusMasks.InterruptDisableMask,!0)}},ATX:function(){this._indexRegisterX=this._accumulator=this.DecodeOperand()&this._accumulator;this.SetZNFlags(this._indexRegisterX)},NMIHandler:function(){this._handleNMI=!0},IRQUpdater:function(){this._handleIRQ=!!(this.soundBopper.ChiChiNES$IClockedMemoryMappedIOElement$IRQAsserted|this._cart.ChiChiNES$IClockedMemoryMappedIOElement$IRQAsserted)},LoadBytes:function(offset,bytes){System.Array.copy(bytes,0,this.Rams,offset,bytes.length)},LoadBytes$1:function(offset,bytes,length){System.Array.copy(bytes,0,this.Rams,offset,length)},PushStack:function(data){this.Rams[this._stackPointer+256|0]=data&255;this._stackPointer=this._stackPointer-1|0;this._stackPointer<0&&(this._stackPointer=255)},PopStack:function(){return this._stackPointer=this._stackPointer+1|0,this._stackPointer>255&&(this._stackPointer=0),this.Rams[this._stackPointer+256|0]&255},GetByte:function(){return this.DataBus=this.GetByte$1(this.AddressBus),this.DataBus},GetByte$1:function(address){var result=0;switch(address&61440){case 0:case 4096:result=address<2048?this.Rams[address]:address>>8;break;case 8192:case 12288:result=this._pixelWhizzler.ChiChiNES$IPPU$GetByte(this.clock,address);break;case 16384:switch(address){case 16406:result=this._padOne.GetByte(this.clock,address);break;case 16407:break;case 16405:result=this.soundBopper.ChiChiNES$IClockedMemoryMappedIOElement$GetByte(this.clock,address);break;default:result=address>>8}break;case 20480:result=address>>8;break;case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:result=this._cart.ChiChiNES$IClockedMemoryMappedIOElement$GetByte(this.clock,address);break;default:throw new System.Exception("Bullshit!");}return this._cheating&&this.memoryPatches.containsKey(address)?this.memoryPatches.get(address).ChiChiNES$Hacking$IMemoryPatch$Activated?this.memoryPatches.get(address).ChiChiNES$Hacking$IMemoryPatch$GetData(result)&255:result&255:result&255},PeekByte:function(address){var result=0;switch(address&61440){case 0:case 4096:result=address<2048?this.Rams[address]:address>>8;break;case 8192:case 12288:result=this._pixelWhizzler.ChiChiNES$IPPU$GetByte(this.clock,address);break;case 16384:switch(address){case 16406:result=0;break;case 16407:break;case 16405:result=0;break;default:result=address>>8}break;case 20480:result=address>>8;break;case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:result=this._cart.ChiChiNES$IClockedMemoryMappedIOElement$GetByte(this.clock,address);break;default:throw new System.Exception("Bullshit!");}return this._cheating&&this.memoryPatches.containsKey(address)?this.memoryPatches.get(address).ChiChiNES$Hacking$IMemoryPatch$Activated?this.memoryPatches.get(address).ChiChiNES$Hacking$IMemoryPatch$GetData(result)&255:result&255:result&255},PeekBytes:function(start,finish){for(var array=System.Array.init(finish-start|0,0,System.Int32),i=0;i<(finish-start|0);i=i+1|0)array[i]=this.PeekByte(start+i|0);return array},SetByte:function(){this.SetByte$1(this.AddressBus,this.DataBus&255)},SetByte$1:function(address,data){if(address<2048){this.Rams[address&2047]=data&255;return}switch(address&61440){case 0:case 4096:this.Rams[address&2047]=data&255;break;case 20480:this.Cart.ChiChiNES$IClockedMemoryMappedIOElement$SetByte(this.clock,address,data);break;case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:this.Cart.ChiChiNES$IClockedMemoryMappedIOElement$SetByte(this.clock,address,data);break;case 8192:case 12288:this._pixelWhizzler.ChiChiNES$IPPU$SetByte(this.clock,address,data);break;case 16384:switch(address){case 16384:case 16385:case 16386:case 16387:case 16388:case 16389:case 16390:case 16391:case 16392:case 16393:case 16394:case 16395:case 16396:case 16397:case 16398:case 16399:case 16405:case 16407:this.soundBopper.ChiChiNES$IClockedMemoryMappedIOElement$SetByte(this.clock,address,data);break;case 16404:this._pixelWhizzler.ChiChiNES$IPPU$CopySprites(Bridge.ref(this,"Rams"),Bridge.Int.mul(data,256));this._currentInstruction_ExtraTiming=this._currentInstruction_ExtraTiming+512|0;break;case 16406:this._padOne.SetByte(this.clock,address,data&1)}}},FindNextEvent:function(){this.nextEvent=this.clock+this._pixelWhizzler.ChiChiNES$IPPU$NextEventAt|0},HandleNextEvent:function(){this._pixelWhizzler.ChiChiNES$IPPU$HandleEvent(this.Clock);this.FindNextEvent()},ResetInstructionHistory:function(){this.instructionHistoryPointer=255},WriteInstructionHistoryAndUsage:function(){var $t;this._instructionHistory[Bridge.identity(this.instructionHistoryPointer,this.instructionHistoryPointer=this.instructionHistoryPointer-1|0)&255]=($t=new ChiChiNES.CPU2A03.Instruction.ctor,$t.time=this.systemClock,$t.A=this._accumulator,$t.X=this._indexRegisterX,$t.Y=this._indexRegisterY,$t.SR=this._statusRegister,$t.SP=this._stackPointer,$t.frame=this.clock,$t.OpCode=this._currentInstruction_OpCode,$t.Parameters0=this._currentInstruction_Parameters0,$t.Parameters1=this._currentInstruction_Parameters1,$t.Address=this._currentInstruction_Address,$t.AddressingMode=this._currentInstruction_AddressingMode,$t.ExtraTiming=this._currentInstruction_ExtraTiming,$t);this.instructionUsage[this._currentInstruction_OpCode]=this.instructionUsage[this._currentInstruction_OpCode]+1|0;(this.instructionHistoryPointer&255)==255&&this.FireDebugEvent("instructionHistoryFull")},FireDebugEvent:function(){Bridge.staticEquals(this.DebugEvent,null)?null:this.DebugEvent(this,{})},PeekInstruction:function(){return new ChiChiNES.CPU2A03.Instruction.ctor}}});Bridge.define("ChiChiNES.CPU2A03.Instruction",{fields:{AddressingMode:0,frame:0,time:System.UInt64(0),A:0,X:0,Y:0,SR:0,SP:0,Address:0,OpCode:0,Parameters0:0,Parameters1:0,ExtraTiming:0,Length:0},ctors:{ctor:function(){this.$initialize()},$ctor1:function(inst){this.$initialize();this.AddressingMode=inst.AddressingMode;this.Address=inst.Address;this.OpCode=inst.OpCode;this.Parameters0=inst.Parameters0;this.Parameters1=inst.Parameters1;this.ExtraTiming=inst.ExtraTiming;this.Length=inst.Length}}});Bridge.define("ChiChiNES.CPUStatusBits",{$kind:"enum",statics:{fields:{Carry:0,ZeroResult:1,InterruptDisable:2,DecimalMode:3,BreakCommand:4,Expansion:5,Overflow:6,NegativeResult:7}}});Bridge.define("ChiChiNES.CPUStatusMasks",{$kind:"enum",statics:{fields:{CarryMask:1,ZeroResultMask:2,InterruptDisableMask:4,DecimalModeMask:8,BreakCommandMask:16,ExpansionMask:32,OverflowMask:64,NegativeResultMask:128}}});Bridge.define("ChiChiNES.Hacking.IMemoryPatch",{$kind:"interface"});Bridge.define("ChiChiNES.IControlPad",{inherits:[System.IDisposable],$kind:"interface"});Bridge.define("ChiChiNES.IMemoryMappedIOElement",{$kind:"interface"});Bridge.define("ChiChiNES.Interaction.CallbackType",{$kind:"enum",statics:{fields:{None:0,NoArgs:1,Array:2,IntPtr:3}}});Bridge.define("ChiChiNES.Interaction.IDisplayContext",{$kind:"interface"});Bridge.define("ChiChiNES.Interaction.InvalidDisplayContextException",{inherits:[System.Exception],ctors:{ctor:function(s){this.$initialize();System.Exception.ctor.call(this,s)},$ctor1:function(s,innerException){this.$initialize();System.Exception.ctor.call(this,s,innerException)}}});Bridge.define("ChiChiNES.Interaction.NESDisplayPluginAttribute",{inherits:[System.Attribute]});Bridge.define("ChiChiNES.Interaction.NESPixelFormats",{$kind:"enum",statics:{fields:{RGB:0,BGR:1,Indexed:2}}});Bridge.define("ChiChiNES.IPixelAwareDevice",{$kind:"interface"});Bridge.define("ChiChiNES.IPPU",{$kind:"interface"});Bridge.define("ChiChiNES.Machine.ControlPanel.RunningStatuses",{$kind:"enum",statics:{fields:{Unloaded:0,Off:1,Running:2,Frozen:3,Paused:4}}});Bridge.define("ChiChiNES.NameTableMirroring",{$kind:"enum",statics:{fields:{OneScreen:0,Vertical:1,Horizontal:2,FourScreen:3}}});Bridge.define("ChiChiNES.NESMachine",{inherits:[System.IDisposable],fields:{_currCartName:null,runState:0,lastSaveState:null,currentSaveSlot:0,_cpu:null,_ppu:null,_cart:null,_sharedWave:null,soundBopper:null,_enableSound:!1,breakpointHit:!1,tiler:null,soundThreader:null,doDraw:!1,isDebugging:!1,_totalCPUClocks:0,frameCount:0,frameOn:!1,frameJustEnded:!1},events:{SoundStatusChanged:null,Drawscreen:null},props:{CurrentCartName:{get:function(){return this._currCartName}},RunState:{get:function(){return this.runState},set:function(value){this.runState!==value&&(this.runState=value)}},CurrentSaveSlot:{get:function(){return this.currentSaveSlot},set:function(value){value>=0&&value<=10&&(this.currentSaveSlot=value)}},Cpu:{get:function(){return this._cpu},set:function(value){this._cpu=value}},Cart:{get:function(){return this._cart}},SoundBopper:{get:function(){return this.soundBopper},set:function(value){this.soundBopper=value}},WaveForms:{get:function(){return this._sharedWave}},EnableSound:{get:function(){return this._enableSound},set:function(value){var $t;this._enableSound!==value&&(Bridge.staticEquals(this.SoundStatusChanged,null)||this.SoundStatusChanged(this,($t=new ChiChiNES.BeepsBoops.SoundStatusChangeEventArgs,$t.Muted=!value,$t)),this.soundBopper.Muted=!value,this._enableSound=value)}},Tiler:{get:function(){return this.tiler}},FrameCount:{get:function(){return this.frameCount},set:function(value){this.frameCount=value}},IsRunning:{get:function(){return!0}},PPU:{get:function(){return this._ppu}},PadOne:{get:function(){return this._cpu.PadOne.ControlPad},set:function(value){this._cpu.PadOne.ControlPad=value}},PadTwo:{get:function(){return this._cpu.PadTwo.ControlPad},set:function(value){this._cpu.PadTwo.ControlPad=value;this.PPU.ChiChiNES$IPPU$PixelAwareDevice=Bridge.as(value,ChiChiNES.IPixelAwareDevice)}},SRAMReader:null,SRAMWriter:null},alias:["dispose","System$IDisposable$dispose"],ctors:{init:function(){this._currCartName="";this.runState=ChiChiNES.Machine.ControlPanel.RunningStatuses.Unloaded;this.lastSaveState=System.Array.init(10,null,System.Array.type(System.Int32));this._enableSound=!0;this.breakpointHit=!1;this.doDraw=!1;this._totalCPUClocks=0;this.frameCount=0;this.frameOn=!0;this.frameJustEnded=!1},ctor:function(cpu,ppu,tiler,wavSharer,soundBopper,soundThread){this.$initialize();this._cpu=cpu;this._ppu=ppu;this._ppu.ChiChiNES$IPPU$FrameFinishHandler=Bridge.fn.cacheBind(this,this.FrameFinished);this.tiler=tiler;this._sharedWave=wavSharer;this.soundBopper=soundBopper;this._cpu.SoundBopper=soundBopper;this.soundThreader=soundThread;this.addSoundStatusChanged(Bridge.fn.cacheBind(this.soundThreader,this.soundThreader.OnSoundStatusChanged));this.Initialize()}},methods:{Initialize:function(){this._cpu.Clock=0;this.frameCount=0},Reset:function(){this._cpu!=null&&this._cart!=null&&(this.soundBopper.RebuildSound(),this._ppu.ChiChiNES$IPPU$Initialize(),this._cart.ChiChiNES$INESCart$InitializeCart(),this._cpu.ResetCPU(),this.ClearGenieCodes(),this._cpu.PowerOn(),this.RunState=ChiChiNES.Machine.ControlPanel.RunningStatuses.Running)},PowerOn:function(){this._cpu!=null&&this._cart!=null&&(this.soundBopper.RebuildSound(),this._ppu.ChiChiNES$IPPU$Initialize(),this._cart.ChiChiNES$INESCart$InitializeCart(),!Bridge.staticEquals(this.SRAMReader,null)&&this._cart.ChiChiNES$INESCart$UsesSRAM&&(this._cart.ChiChiNES$INESCart$SRAM=this.SRAMReader(this._cart.ChiChiNES$INESCart$CheckSum)),this._cpu.ResetCPU(),this.ClearGenieCodes(),this._cpu.PowerOn(),this.RunState=ChiChiNES.Machine.ControlPanel.RunningStatuses.Running)},PowerOff:function(){this._cart!=null&&!Bridge.staticEquals(this.SRAMWriter,null)&&this._cart.ChiChiNES$INESCart$UsesSRAM&&this.SRAMWriter(this._cart.ChiChiNES$INESCart$CheckSum,this._cart.ChiChiNES$INESCart$SRAM)},EjectCart:function(){this._cart!=null&&!Bridge.staticEquals(this.SRAMWriter,null)&&this._cart.ChiChiNES$INESCart$UsesSRAM&&this.SRAMWriter(this._cart.ChiChiNES$INESCart$CheckSum,this._cart.ChiChiNES$INESCart$SRAM);this._cart=null;this._currCartName=null;this.RunState=ChiChiNES.Machine.ControlPanel.RunningStatuses.Unloaded},LoadCart:function(rom){if(this.EjectCart(),this._currCartName="Streamed",this._cart=ChiChiNES.ROMLoader.iNESFileHandler.LoadROM(this._ppu,rom),this._cart!=null)this._cpu.Cart=Bridge.cast(this._cart,ChiChiNES.IClockedMemoryMappedIOElement),this._cpu.Cart.ChiChiNES$IClockedMemoryMappedIOElement$NMIHandler=Bridge.fn.cacheBind(this._cpu,this._cpu.InterruptRequest),this._ppu.ChiChiNES$IPPU$ChrRomHandler=this._cart;else throw new ChiChiNES.ROMLoader.CartLoadException.ctor("Unsupported ROM type - load failed.");},GoTendo_NoThread:function(){},GoTendo:function(){},HasState:function(index){return this.lastSaveState!=null&&this.lastSaveState[index]!=null},GetState:function(index){var state=new(System.Collections.Generic.Queue$1(System.Int32).ctor);state=new(System.Collections.Generic.Queue$1(System.Int32).ctor);this._cpu.GetState(state);this._ppu.ChiChiNES$IPPU$WriteState(state);this._cart.ChiChiNES$INESCart$WriteState(state);this.lastSaveState[index]=System.Array.init(state.Count,0,System.Int32);state.copyTo$1(this.lastSaveState[index],0)},SetState:function(index){if(this.lastSaveState!=null){var cloneState=new(System.Collections.Generic.Queue$1(System.Int32).$ctor1)(this.lastSaveState[index]);this._cpu.SetState(cloneState);this._ppu.ChiChiNES$IPPU$ReadState(cloneState);this._cart.ChiChiNES$INESCart$ReadState(cloneState)}},ClearGenieCodes:function(){this._cpu.GenieCodes.clear();this._cpu.Cheating=!1},AddGameGenieCode:function(code,patch){var $t,hexCode=System.Array.init(code.length,0,System.Byte),i=0,c,digit;$t=Bridge.getEnumerator(code.toUpperCase());try{while($t.moveNext()){c=$t.Current;digit=0;switch(c){case 65:digit=0;break;case 80:digit=1;break;case 90:digit=2;break;case 76:digit=3;break;case 71:digit=4;break;case 73:digit=5;break;case 84:digit=6;break;case 89:digit=7;break;case 69:digit=8;break;case 79:digit=9;break;case 88:digit=10;break;case 85:digit=11;break;case 75:digit=12;break;case 83:digit=13;break;case 86:digit=14;break;case 78:digit=15}hexCode[Bridge.identity(i,i=i+1|0)]=digit}}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$dispose()}var address=32768+((hexCode[3]&7)<<12)|0|(hexCode[5]&7)<<8|(hexCode[4]&8)<<8|(hexCode[2]&7)<<4|(hexCode[1]&8)<<4|hexCode[4]&7|hexCode[3]&8,data=0,compare=0;if(hexCode.length===6)data=(hexCode[1]&7)<<4|(hexCode[0]&8)<<4|hexCode[0]&7|hexCode[5]&8,patch.v=new ChiChiNES.Hacking.MemoryPatch(address,data);else if(hexCode.length===8)data=(hexCode[1]&7)<<4|(hexCode[0]&8)<<4|hexCode[0]&7|hexCode[7]&8,compare=(hexCode[7]&7)<<4|(hexCode[6]&8)<<4|hexCode[6]&7|hexCode[5]&8,patch.v=new ChiChiNES.Hacking.ComparedMemoryPatch(address,compare&255,data&255);else return patch.v=null,!1;try{patch.v.ChiChiNES$Hacking$IMemoryPatch$Activated=!0;this._cpu.MemoryPatches.add(address,patch.v);this._cpu.Cheating=!0}catch($e1){$e1=System.Exception.create($e1);this._cpu.Cheating=!1}return this._cpu.Cheating},WriteWAVToFile:function(writer){this._sharedWave.AppendFile(writer)},StopWritingWAV:function(){this._sharedWave.AppendFile(null)},SetupSound:function(){this._sharedWave=new ChiChiNES.BeepsBoops.WavSharer.ctor;this.soundBopper=new ChiChiNES.BeepsBoops.Bopper(this._sharedWave)},Runtendo:function(){this.isDebugging=!1;this.RunFrame()},dispose:function(){this._cart==null||this._cart.ChiChiNES$INESCart$CheckSum==null||Bridge.staticEquals(this.SRAMWriter,null)||this.SRAMWriter(this._cart.ChiChiNES$INESCart$CheckSum,this._cart.ChiChiNES$INESCart$SRAM);Bridge.sleep(100);this._sharedWave.Dispose();this.soundThreader.dispose()},Step:function(){this.frameJustEnded&&(this._cpu.FindNextEvent(),this.frameOn=!0,this.frameJustEnded=!1);this._cpu.Step();this.frameOn||(this._totalCPUClocks=this._cpu.Clock,this._totalCPUClocks=0,this._cpu.Clock=0,this._ppu.ChiChiNES$IPPU$LastcpuClock=0,this.frameJustEnded=!0)},RunFrame:function(){this.frameOn=!0;this.frameJustEnded=!1;this._cpu.FindNextEvent();do this._cpu.Step();while(this.frameOn);this._totalCPUClocks=this._cpu.Clock;this.PadOne!=null&&this.PadOne.ChiChiNES$IControlPad$refresh();this._totalCPUClocks=0;this._cpu.Clock=0;this._ppu.ChiChiNES$IPPU$LastcpuClock=0},FrameFinished:function(){this.frameJustEnded=!0;this.frameOn=!1;this.Drawscreen(this,{})}}});Bridge.define("ChiChiNES.NESSprite",{$kind:"struct",statics:{methods:{getDefaultValue:function(){return new ChiChiNES.NESSprite}}},fields:{YPosition:0,XPosition:0,SpriteNumber:0,Foreground:!1,IsVisible:!1,TileIndex:0,AttributeByte:0,FlipX:!1,FlipY:!1,Changed:!1},ctors:{ctor:function(){this.$initialize()}},methods:{getHashCode:function(){return Bridge.addHash([3351033891,this.YPosition,this.XPosition,this.SpriteNumber,this.Foreground,this.IsVisible,this.TileIndex,this.AttributeByte,this.FlipX,this.FlipY,this.Changed])},equals:function(o){return Bridge.is(o,ChiChiNES.NESSprite)?Bridge.equals(this.YPosition,o.YPosition)&&Bridge.equals(this.XPosition,o.XPosition)&&Bridge.equals(this.SpriteNumber,o.SpriteNumber)&&Bridge.equals(this.Foreground,o.Foreground)&&Bridge.equals(this.IsVisible,o.IsVisible)&&Bridge.equals(this.TileIndex,o.TileIndex)&&Bridge.equals(this.AttributeByte,o.AttributeByte)&&Bridge.equals(this.FlipX,o.FlipX)&&Bridge.equals(this.FlipY,o.FlipY)&&Bridge.equals(this.Changed,o.Changed):!1},$clone:function(to){var s=to||new ChiChiNES.NESSprite;return s.YPosition=this.YPosition,s.XPosition=this.XPosition,s.SpriteNumber=this.SpriteNumber,s.Foreground=this.Foreground,s.IsVisible=this.IsVisible,s.TileIndex=this.TileIndex,s.AttributeByte=this.AttributeByte,s.FlipX=this.FlipX,s.FlipY=this.FlipY,s.Changed=this.Changed,s}}});Bridge.define("ChiChiNES.PortQueueing.PortWriteEntry",{fields:{time:0,address:0,data:0},ctors:{ctor:function(time,address,data){this.$initialize();this.time=time;this.address=address;this.data=data}}});Bridge.define("ChiChiNES.PPUWriteEvent",{inherits:[System.ComponentModel.INotifyPropertyChanged],fields:{isWrite:!1,scanlineNum:0,scanlinePos:0,frameClock:0,registerAffected:0,dataWritten:0},events:{PropertyChanged:null},props:{IsWrite:{get:function(){return this.isWrite},set:function(value){this.isWrite=value}},ScanlineNum:{get:function(){return this.scanlineNum},set:function(value){this.scanlineNum=value}},ScanlinePos:{get:function(){return this.scanlinePos},set:function(value){this.scanlinePos=value}},FrameClock:{get:function(){return this.frameClock},set:function(value){this.frameClock=value}},RegisterAffected:{get:function(){return this.registerAffected},set:function(value){this.registerAffected=value}},DataWritten:{get:function(){return this.dataWritten},set:function(value){this.dataWritten=value}},Text:{get:function(){return this.toString()}}},alias:["addPropertyChanged","System$ComponentModel$INotifyPropertyChanged$addPropertyChanged","removePropertyChanged","System$ComponentModel$INotifyPropertyChanged$removePropertyChanged"],methods:{toString:function(){return System.String.format(" {0:x2} written to {1:x4} at {2}, {3}",this.registerAffected,this.dataWritten,this.scanlineNum,this.scanlinePos)}}});Bridge.define("ChiChiNES.ROMLoader.CartLoadException",{inherits:[System.Exception],ctors:{$ctor1:function(message,innerException){this.$initialize();System.Exception.ctor.call(this,message,innerException)},ctor:function(message){this.$initialize();System.Exception.ctor.call(this,message)}}});Bridge.define("ChiChiNES.ROMLoader.iNESFileHandler",{statics:{methods:{LoadROM:function(ppu,thefile){var _cart=null,iNesHeader=System.Array.init(16,0,System.Byte),mapperId,len;System.Array.copy(thefile,0,iNesHeader,0,16);mapperId=iNesHeader[6]&240;mapperId=Bridge.Int.div(mapperId,16)|0;mapperId=mapperId+iNesHeader[7]|0;var prgRomCount=iNesHeader[4],chrRomCount=iNesHeader[5],theRom=System.Array.init(Bridge.Int.mul(prgRomCount,16384),0,System.Byte),chrRom=System.Array.init(Bridge.Int.mul(chrRomCount,16384),0,System.Byte),chrOffset=0;System.Array.copy(thefile,16,theRom,0,theRom.length);chrOffset=16+theRom.length|0;len=chrRom.length;(chrOffset+chrRom.length|0)>thefile.length&&(len=thefile.length-chrOffset|0);System.Array.copy(thefile,chrOffset,chrRom,0,len);switch(mapperId){case 0:case 2:case 3:case 7:_cart=new ChiChiNES.CPU.NESCart;break;case 1:_cart=new ChiChiNES.NesCartMMC1;break;case 4:_cart=new ChiChiNES.NesCartMMC3}return _cart!=null&&(_cart.ChiChiNES$INESCart$Whizzler=ppu,ppu.ChiChiNES$IPPU$ChrRomHandler=_cart,_cart.ChiChiNES$INESCart$ROMHashFunction=null,_cart.ChiChiNES$INESCart$LoadiNESCart(iNesHeader,prgRomCount,chrRomCount,theRom,chrRom,chrOffset)),_cart}}}});Bridge.define("ChiChiNES.Sound.IWavStreamer",{inherits:[System.IDisposable],$kind:"interface"});Bridge.define("ChiChiNES.Sound.SoundThreader",{inherits:[System.IDisposable],fields:{_wavePlayer:null},props:{WavePlayer:{get:function(){return this._wavePlayer},set:function(value){this._wavePlayer=value}}},alias:["dispose","System$IDisposable$dispose"],ctors:{ctor:function(streamer){this.$initialize();this._wavePlayer=streamer}},methods:{OnSoundStatusChanged:function(sender,e){this._wavePlayer.ChiChiNES$Sound$IWavStreamer$Muted=e.Muted},PlaySound:function(){this._wavePlayer.ChiChiNES$Sound$IWavStreamer$playPCM()},dispose:function(){this._wavePlayer.System$IDisposable$dispose()}}});Bridge.define("ChiChiNES.TileDoodler",{fields:{_ppu:null,currentNameTableEntries:null,currentPatternTableEntries:null},props:{XOffset:0,YOffset:0},ctors:{init:function(){this.currentNameTableEntries=System.Array.init(32,null,System.Array.type(System.Array.type(System.Int32)));this.currentPatternTableEntries=System.Array.init(2,null,System.Array.type(System.Array.type(System.Array.type(System.Int32))))},ctor:function(ppu){var $t,$t1,$t2,$t3,pt,x,y,i,j;for(this.$initialize(),this._ppu=ppu,this.currentPatternTableEntries=System.Array.init(2,null,System.Array.type(System.Array.type(System.Array.type(System.Int32)))),pt=0;pt<2;pt=pt+1|0)for(this.currentPatternTableEntries[pt]=System.Array.init(32,null,System.Array.type(System.Array.type(System.Int32))),x=0;x<32;x=x+1|0)for(($t=this.currentPatternTableEntries[pt])[x]=System.Array.init(30,null,System.Array.type(System.Int32)),y=0;y<30;y=y+1|0)($t1=($t2=this.currentPatternTableEntries[pt])[x])[y]=System.Array.init(8,0,System.Int32);for(this.currentNameTableEntries=System.Array.init(32,null,System.Array.type(System.Array.type(System.Int32))),i=0;i<32;i=i+1|0)for(this.currentNameTableEntries[i]=System.Array.init(30,null,System.Array.type(System.Int32)),j=0;j<30;j=j+1|0)($t3=this.currentNameTableEntries[i])[j]=System.Array.init(8,0,System.Int32)}},methods:{GetPatternTableEntry:function(PatternTable,TileIndex,attributeByte,actualAddress){var $t,$t1,$t2,result=System.Array.init(64,0,System.Int32),i,patternEntry,patternEntryBit2,bit;for(actualAddress.v=System.Array.init(8,0,System.Int32),i=0;i<8;i=i+1|0)for(patternEntry=this._ppu.ChiChiNES$IPPU$ChrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,(PatternTable+Bridge.Int.mul(TileIndex,16)|0)+i|0),actualAddress.v[i]=this._ppu.ChiChiNES$IPPU$ChrRomHandler.ChiChiNES$INESCart$ActualChrRomOffset((PatternTable+Bridge.Int.mul(TileIndex,16)|0)+i|0),patternEntryBit2=this._ppu.ChiChiNES$IPPU$ChrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,((PatternTable+Bridge.Int.mul(TileIndex,16)|0)+i|0)+8|0),bit=0;bit<8;bit=bit+1|0)(patternEntry&($t=ChiChiNES.PixelWhizzler.PowersOfTwo)[bit])!=0&&(result[Bridge.Int.mul(i,8)+bit|0]=1|attributeByte),(patternEntryBit2&($t1=ChiChiNES.PixelWhizzler.PowersOfTwo)[bit])!=0&&(result[$t2=Bridge.Int.mul(i,8)+bit|0]=result[$t2]|2|attributeByte);return result},GetSprite:function(PatternTable,TileIndex,attributeByte,flipX,flipY){for(var patternEntry,patternEntryBit2,bit,bit1,$t,$t1,$t2,$t3,$t4,$t5,result=System.Array.init(64,0,System.Int32),yMultiplyer=8,i=0;i<8;i=i+1|0)if(flipY?(patternEntry=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte(((PatternTable+Bridge.Int.mul(TileIndex,16)|0)+7|0)-i|0),patternEntryBit2=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte((((PatternTable+Bridge.Int.mul(TileIndex,16)|0)+7|0)-i|0)+8|0)):(patternEntry=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte((PatternTable+Bridge.Int.mul(TileIndex,16)|0)+i|0),patternEntryBit2=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte(((PatternTable+Bridge.Int.mul(TileIndex,16)|0)+i|0)+8|0)),flipX)for(bit=7;bit>=0;bit=bit-1|0)(patternEntry&($t=ChiChiNES.PixelWhizzler.PowersOfTwo)[bit])!=0&&(result[(Bridge.Int.mul(i,yMultiplyer)+7|0)-bit|0]=1|attributeByte),(patternEntryBit2&($t1=ChiChiNES.PixelWhizzler.PowersOfTwo)[bit])!=0&&(result[$t2=(Bridge.Int.mul(i,yMultiplyer)+7|0)-bit|0]=result[$t2]|2|attributeByte);else for(bit1=0;bit1<8;bit1=bit1+1|0)(patternEntry&($t3=ChiChiNES.PixelWhizzler.PowersOfTwo)[bit1])!=0&&(result[Bridge.Int.mul(i,8)+bit1|0]=1|attributeByte),(patternEntryBit2&($t4=ChiChiNES.PixelWhizzler.PowersOfTwo)[bit1])!=0&&(result[$t5=Bridge.Int.mul(i,8)+bit1|0]=result[$t5]|2|attributeByte);return result},TryGetSprite:function(result,PatternTable,TileIndex,attributeByte,flipX,flipY){for(var patternEntry,patternEntryBit2,bit,bit1,$t,$t1,$t2,$t3,$t4,$t5,yMultiplyer=8,hasData=!1,i=0;i<8;i=i+1|0)if(flipY?(patternEntry=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte(((PatternTable+Bridge.Int.mul(TileIndex,16)|0)+7|0)-i|0),patternEntryBit2=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte((((PatternTable+Bridge.Int.mul(TileIndex,16)|0)+7|0)-i|0)+8|0)):(patternEntry=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte((PatternTable+Bridge.Int.mul(TileIndex,16)|0)+i|0),patternEntryBit2=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte(((PatternTable+Bridge.Int.mul(TileIndex,16)|0)+i|0)+8|0)),flipX)for(bit=7;bit>=0;bit=bit-1|0)result[(Bridge.Int.mul(i,yMultiplyer)+7|0)-bit|0]=0,(patternEntry&($t=ChiChiNES.PixelWhizzler.PowersOfTwo)[bit])!=0&&(result[(Bridge.Int.mul(i,yMultiplyer)+7|0)-bit|0]=1|attributeByte,hasData=!0),(patternEntryBit2&($t1=ChiChiNES.PixelWhizzler.PowersOfTwo)[bit])!=0&&(result[$t2=(Bridge.Int.mul(i,yMultiplyer)+7|0)-bit|0]=result[$t2]|2|attributeByte,hasData=!0);else for(bit1=0;bit1<8;bit1=bit1+1|0)result[Bridge.Int.mul(i,8)+bit1|0]=0,(patternEntry&($t3=ChiChiNES.PixelWhizzler.PowersOfTwo)[bit1])!=0&&(result[Bridge.Int.mul(i,8)+bit1|0]=1|attributeByte,hasData=!0),(patternEntryBit2&($t4=ChiChiNES.PixelWhizzler.PowersOfTwo)[bit1])!=0&&(result[$t5=Bridge.Int.mul(i,8)+bit1|0]=result[$t5]|2|attributeByte,hasData=!0);return hasData},GetPatternTableLine:function(result,startPosition,LineNumber,PatternTable,TileIndex,attributeByte){for(var $t,$t1,$t2,patternEntry=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte((PatternTable+Bridge.Int.mul(TileIndex,16)|0)+LineNumber|0),patternEntryBit2=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte(((PatternTable+Bridge.Int.mul(TileIndex,16)|0)+LineNumber|0)+8|0),bit=0;bit<8;bit=bit+1|0)(patternEntry&($t=ChiChiNES.PixelWhizzler.PowersOfTwo)[bit])!=0&&(result.v[Bridge.Int.mul(LineNumber,8)+bit|0]=1|attributeByte),(patternEntryBit2&($t1=ChiChiNES.PixelWhizzler.PowersOfTwo)[bit])!=0&&(result.v[$t2=Bridge.Int.mul(LineNumber,8)+bit|0]=result.v[$t2]|2|attributeByte)},DrawRect:function(newData,width,height,xPos,yPos){for(var i,xPosition,yPosition,$t,j=0;j<height;j=j+1|0)for(i=0;i<width;i=i+1|0){if(xPosition=(xPos+8|0)-i|0,yPosition=yPos+j|0,xPosition>=256||yPosition>=240)return;($t=this._ppu.ChiChiNES$IPPU$CurrentFrame)[Bridge.Int.mul(yPosition,256)+xPosition|0]=newData[Bridge.Int.mul(j,width)+i|0]&255}},MergeRect:function(newData,width,height,xPos,yPos,inFront){var $t,j,i,xPosition,yPosition;if(inFront){this.MergeRectBehind(newData,width,height,xPos,yPos);return}for(j=0;j<height;j=j+1|0)for(i=0;i<width;i=i+1|0){if(xPosition=(xPos+8|0)-i|0,yPosition=yPos+j|0,xPosition>=256||yPosition>=240)return;newData[Bridge.Int.mul(j,width)+i|0]!==0&&(($t=this._ppu.ChiChiNES$IPPU$CurrentFrame)[Bridge.Int.mul(yPosition,256)+xPosition|0]=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte(newData[Bridge.Int.mul(j,width)+i|0]+16128|0)&255)}},MergeRectBehind:function(newData,width,height,xPos,yPos){for(var i,xPosition,yPosition,$t,$t1,j=0;j<height;j=j+1|0)for(i=0;i<width;i=i+1|0){if(xPosition=(xPos+8|0)-i|0,yPosition=yPos+j|0,xPosition>=256||yPosition>=240)return;($t=this._ppu.ChiChiNES$IPPU$CurrentFrame)[Bridge.Int.mul(yPosition,256)+xPosition|0]===this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte(16128)&&(($t1=this._ppu.ChiChiNES$IPPU$CurrentFrame)[Bridge.Int.mul(yPosition,256)+xPosition|0]=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte(newData[Bridge.Int.mul(j,width)+i|0]+16128|0)&255)}},DrawAllTiles:function(){var $t,NameTable,nt2,i,j,TileIndex,addToCol;for(this.YOffset>256&&(this.YOffset=this.YOffset&255),this.XOffset>256&&(this.XOffset=this.XOffset&255),NameTable=8192+Bridge.Int.mul(1024,this._ppu.ChiChiNES$IPPU$PPUControlByte0&3)|0,nt2=Bridge.Int.div(NameTable&3072,1024)|0,i=0;i<32;i=i+1|0)for(j=0;j<30;j=j+1|0)TileIndex=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte(((8192+this._ppu.ChiChiNES$IPPU$NameTableMemoryStart|0)+i|0)+Bridge.Int.mul(j,32)|0)&255,addToCol=this.GetAttributeTableEntry(this._ppu.ChiChiNES$IPPU$NameTableMemoryStart,i,j),this.DrawRect(this.GetPatternTableEntry(this._ppu.ChiChiNES$IPPU$PatternTableIndex,TileIndex,addToCol,Bridge.ref($t=this.currentNameTableEntries[i],j)),8,8,Bridge.Int.mul(i,8)+this.XOffset|0,Bridge.Int.mul(j,8)+this.YOffset|0)},GetAttributeTableEntry:function(ppuNameTableMemoryStart,i,j){var LookUp=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte((((8192+ppuNameTableMemoryStart|0)+960|0)+(Bridge.Int.div(i,4)|0)|0)+Bridge.Int.mul(Bridge.Int.div(j,4)|0,8)|0),AttribByte=0;switch(i&2|Bridge.Int.mul(j&2,2)){case 0:AttribByte=LookUp<<2&12;break;case 2:AttribByte=LookUp&12;break;case 4:AttribByte=LookUp>>2&12;break;case 6:AttribByte=LookUp>>4&12}return AttribByte},GetNameTablePixel:function(xPosition,yPosition){var ppuNameTableMemoryStart=this._ppu.ChiChiNES$IPPU$NameTableMemoryStart,xTilePosition,patternTableEntryIndex;xPosition=xPosition+this._ppu.ChiChiNES$IPPU$HScroll|0;xPosition>255&&(xPosition=xPosition-256|0,ppuNameTableMemoryStart=ppuNameTableMemoryStart^1024);xTilePosition=Bridge.Int.div(xPosition,8)|0;patternTableEntryIndex=7-(xPosition&7)|0;yPosition=yPosition+this._ppu.ChiChiNES$IPPU$VScroll|0;yPosition>240&&(yPosition=yPosition-241|0,ppuNameTableMemoryStart=ppuNameTableMemoryStart^2048);var yTilePosition=Bridge.Int.div(yPosition,8)|0,patternTableYOffset=yPosition&7,TileIndex=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte(((8192+ppuNameTableMemoryStart|0)+xTilePosition|0)+Bridge.Int.mul(yTilePosition,32)|0)&255,patternEntry=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte((this._ppu.ChiChiNES$IPPU$PatternTableIndex+Bridge.Int.mul(TileIndex,16)|0)+patternTableYOffset|0),patternEntryByte2=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte(((this._ppu.ChiChiNES$IPPU$PatternTableIndex+Bridge.Int.mul(TileIndex,16)|0)+8|0)+patternTableYOffset|0),attributeByte=this.GetAttributeTableEntry(ppuNameTableMemoryStart,xTilePosition,yTilePosition);return(patternEntry>>patternTableEntryIndex&1|Bridge.Int.mul(patternEntryByte2>>patternTableEntryIndex&1,2)|attributeByte)&255},SpriteZeroHit:function(xPosition,yPosition){var $t,$t1,$t2,$t3,y=($t=this._ppu.ChiChiNES$IPPU$SpriteRam)[0],yLine=yPosition%8,xPos=xPosition%8;if(yPosition>y&&yPosition<=(y+9|0)){var tileIndex=($t1=this._ppu.ChiChiNES$IPPU$SpriteRam)[1],patternEntry=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte(((this._ppu.ChiChiNES$IPPU$PatternTableIndex+Bridge.Int.mul(tileIndex,16)|0)+7|0)-yLine|0),patternEntryBit2=this._ppu.ChiChiNES$IPPU$VidRAM_GetNTByte((((this._ppu.ChiChiNES$IPPU$PatternTableIndex+Bridge.Int.mul(tileIndex,16)|0)+7|0)-yLine|0)+8|0);if((patternEntry&($t2=ChiChiNES.PixelWhizzler.PowersOfTwo)[xPos])!=0||(patternEntryBit2&($t3=ChiChiNES.PixelWhizzler.PowersOfTwo)[xPos])!=0)return!0}return!1},DrawSprite:function(spriteNum){var $t,$t1,$t2,$t3,spriteAddress=Bridge.Int.mul(4,spriteNum),y=($t=this._ppu.ChiChiNES$IPPU$SpriteRam)[spriteAddress],attributeByte=($t1=this._ppu.ChiChiNES$IPPU$SpriteRam)[spriteAddress+2|0],x=($t2=this._ppu.ChiChiNES$IPPU$SpriteRam)[spriteAddress+3|0],tileIndex=($t3=this._ppu.ChiChiNES$IPPU$SpriteRam)[spriteAddress+1|0],attrColor=(attributeByte&3)<<2|16,isInFront=(attributeByte&32)==32,flipX=(attributeByte&64)==64,flipY=(attributeByte&128)==128,spritePatternTable=0,getPatternTableEntry,getPatternTableEntryBottom,getPatternTableEntry1;(this._ppu.ChiChiNES$IPPU$PPUControlByte0&32)==32?((tileIndex&1)==1&&(spritePatternTable=4096),getPatternTableEntry=this.GetSprite(spritePatternTable,tileIndex,attrColor,flipX,flipY),tileIndex=tileIndex+1|0,getPatternTableEntryBottom=this.GetSprite(spritePatternTable,tileIndex,attrColor,flipX,flipY),flipY?(this.MergeRect(getPatternTableEntryBottom,8,8,x-1|0,y+1|0,isInFront),this.MergeRect(getPatternTableEntry,8,8,x-1|0,y+9|0,isInFront)):(this.MergeRect(getPatternTableEntry,8,8,x-1|0,y+1|0,isInFront),this.MergeRect(getPatternTableEntryBottom,8,8,x-1|0,y+9|0,isInFront))):((this._ppu.ChiChiNES$IPPU$PPUControlByte0&8)==8&&(spritePatternTable=4096),getPatternTableEntry1=this.GetSprite(spritePatternTable,tileIndex,attrColor,flipX,flipY),this.MergeRect(getPatternTableEntry1,8,8,x-1|0,y+1|0,isInFront));return},DrawAllSprites:function(){for(var i=63;i>=0;i=i-1|0)this.DrawSprite(i)},DoodlePatternTable:function(PatternTable){var $t,$t1,patTable=0,patterns,tile,j,i;switch(PatternTable){case 4096:patTable=1;break;case 0:patTable=0}for(patterns={v:System.Array.init(16384,0,System.Int32)},j=0;j<16;j=j+1|0)for(i=0;i<16;i=i+1|0)tile=this.GetPatternTableEntry(PatternTable,i+Bridge.Int.mul(j,16)|0,0,Bridge.ref($t=($t1=this.currentPatternTableEntries[patTable])[i],j)),this.DrawTile(patterns,128,128,tile,Bridge.Int.mul(i,8),Bridge.Int.mul(j,8));return patterns.v},DoodleNameTable:function(NameTable){for(var j,$t,result={v:System.Array.init(61440,0,System.Int32)},i=0;i<32;i=i+1|0)for(j=0;j<30;j=j+1|0){var address=((8192+NameTable|0)+i|0)+Bridge.Int.mul(j,32)|0,TileIndex=this._ppu.ChiChiNES$IPPU$ChrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,address),addToCol=this.GetAttributeTableEntry(NameTable,i,j),tile=this.GetPatternTableEntry(this._ppu.ChiChiNES$IPPU$PatternTableIndex,TileIndex,addToCol,Bridge.ref($t=this.currentNameTableEntries[i],j));this.DrawTile(result,256,240,tile,Bridge.Int.mul(i,8),Bridge.Int.mul(j,8))}return result.v},DrawTile:function(destBuffer,width,height,tile,xPos,yPos){for(var i,xPosition,yPosition,j=0;j<8;j=j+1|0)for(i=0;i<8;i=i+1|0){if(xPosition=(xPos+8|0)-i|0,yPosition=Bridge.Int.mul(yPos+j|0,width),xPos>height)break;if((yPosition+xPosition|0)>=destBuffer.v.length)break;destBuffer.v[yPosition+xPosition|0]=tile[Bridge.Int.mul(j,8)+i|0]&255}},GetNameTableEntryLocation:function(x,y){var $t,$t1;return($t=($t1=this.currentNameTableEntries[Bridge.Int.div(x,32)|0])[Bridge.Int.div(y,30)|0])[y&7]},GetPatternEntryLocation:function(table,x,y){var $t,$t1,$t2;return($t=($t1=($t2=this.currentPatternTableEntries[table])[Bridge.Int.div(x,32)|0])[Bridge.Int.div(y,30)|0])[y&7]}}});Bridge.define("ChiChiNES.INESCart",{inherits:[ChiChiNES.IClockedMemoryMappedIOElement],$kind:"interface"});Bridge.define("ChiChiNES.BeepsBoops.Bopper",{inherits:[ChiChiNES.IClockedMemoryMappedIOElement,ChiChiNES.BeepsBoops.IAPU],statics:{fields:{master_vol:0,clock_rate:0},ctors:{init:function(){this.master_vol=4369;this.clock_rate=1789772.727}}},fields:{square0:null,square1:null,triangle:null,noise:null,writer:null,dmc:null,myBlipper:null,_throwingIRQs:!1,registers:null,_sampleRate:0,square0Gain:0,square1Gain:0,triangleGain:0,noiseGain:0,reg15:0,muted:!1,lastFrameHit:0,_writeBuffer:null,_interruptRaised:!1,lastClock:0},props:{SampleRate:{get:function(){return this._sampleRate},set:function(value){this._sampleRate=value;this.RebuildSound()}},Muted:{get:function(){return this.muted},set:function(value){this.muted=value}},WriteBuffer:{get:function(){return this._writeBuffer},set:function(value){this._writeBuffer=value}},InterruptRaised:{get:function(){return this._interruptRaised},set:function(value){this._interruptRaised=value}},EnableSquare0:{get:function(){return this.square0.Gain!==0},set:function(value){this.square0.Gain=value?this.square0Gain:0}},EnableSquare1:{get:function(){return this.square1.Gain!==0},set:function(value){this.square1.Gain=value?this.square1Gain:0}},EnableTriangle:{get:function(){return this.triangle.Gain!==0},set:function(value){this.triangle.Gain=value?this.triangleGain:0}},EnableNoise:{get:function(){return this.noise.Gain!==0},set:function(value){this.noise.Gain=value?this.noiseGain:0}},NMIHandler:{get:function(){return null},set:function(){}},IRQAsserted:{get:function(){return!1},set:function(){}},NextEventAt:{get:function(){return 7445*(this.lastFrameHit+1)-this.lastClock}}},alias:["GetByte","ChiChiNES$IClockedMemoryMappedIOElement$GetByte","SetByte","ChiChiNES$IClockedMemoryMappedIOElement$SetByte","Muted","ChiChiNES$BeepsBoops$IAPU$Muted","UpdateFrame","ChiChiNES$BeepsBoops$IAPU$UpdateFrame","EndFrame","ChiChiNES$BeepsBoops$IAPU$EndFrame","InterruptRaised","ChiChiNES$BeepsBoops$IAPU$InterruptRaised","EnableSquare0","ChiChiNES$BeepsBoops$IAPU$EnableSquare0","EnableSquare1","ChiChiNES$BeepsBoops$IAPU$EnableSquare1","EnableTriangle","ChiChiNES$BeepsBoops$IAPU$EnableTriangle","EnableNoise","ChiChiNES$BeepsBoops$IAPU$EnableNoise","NMIHandler","ChiChiNES$IClockedMemoryMappedIOElement$NMIHandler","IRQAsserted","ChiChiNES$IClockedMemoryMappedIOElement$IRQAsserted","NextEventAt","ChiChiNES$IClockedMemoryMappedIOElement$NextEventAt","HandleEvent","ChiChiNES$IClockedMemoryMappedIOElement$HandleEvent","ResetClock","ChiChiNES$IClockedMemoryMappedIOElement$ResetClock"],ctors:{init:function(){this.registers=new ChiChiNES.PortQueueing.QueuedPort;this._sampleRate=11025;this.square0Gain=873;this.square1Gain=873;this.triangleGain=1004;this.noiseGain=567;this.muted=!1;this.lastFrameHit=0;this._writeBuffer=System.Array.init(1024,0,System.Int16)},ctor:function(output){this.$initialize();this.writer=output;this._sampleRate=output.Frequency;this.RebuildSound()}},methods:{RebuildSound:function(){var $t;this.myBlipper=new ChiChiNES.BeepsBoops.Blip(this._sampleRate/5);this.myBlipper.blip_set_rates(ChiChiNES.BeepsBoops.Bopper.clock_rate,this._sampleRate);this.registers.clear();this._interruptRaised=!1;this.square0Gain=873;this.square1Gain=873;this.triangleGain=1004;this.noiseGain=567;this.square0=($t=new ChiChiNES.BeepsBoops.SquareChannel(this.myBlipper,0),$t.Gain=this.square0Gain,$t.Period=10,$t.SweepComplement=!0,$t);this.square1=($t=new ChiChiNES.BeepsBoops.SquareChannel(this.myBlipper,1),$t.Gain=this.square1Gain,$t.Period=10,$t.SweepComplement=!1,$t);this.triangle=($t=new ChiChiNES.BeepsBoops.TriangleChannel(this.myBlipper,2),$t.Gain=this.triangleGain,$t.Period=0,$t);this.noise=($t=new ChiChiNES.BeepsBoops.NoiseChannel(this.myBlipper,3),$t.Gain=this.noiseGain,$t.Period=0,$t);this.dmc=($t=new ChiChiNES.BeepsBoops.DMCChannel(this.myBlipper,4),$t.Gain=873,$t.Period=10,$t)},GetByte:function(Clock,address){return address===16384&&(this._interruptRaised=!1),address===16405?this.ReadStatus():66},ReadStatus:function(){return(this.square0.Length>0?1:0)|(this.square1.Length>0?2:0)|(this.triangle.Length>0?4:0)|(this.square0.Length>0?8:0)|(this._interruptRaised?64:0)},SetByte:function(Clock,address){address===16384&&(this._interruptRaised=!1)},DoSetByte:function(Clock,address,data){switch(address){case 16384:case 16385:case 16386:case 16387:this.square0.WriteRegister(address-16384,data,Clock);break;case 16388:case 16389:case 16390:case 16391:this.square1.WriteRegister(address-16388,data,Clock);break;case 16392:case 16393:case 16394:case 16395:this.triangle.WriteRegister(address-16392,data,Clock);break;case 16396:case 16397:case 16398:case 16399:this.noise.WriteRegister(address-16396,data,Clock);break;case 16405:this.reg15=data;this.square0.WriteRegister(4,data&1,Clock);this.square1.WriteRegister(4,data&2,Clock);this.triangle.WriteRegister(4,data&4,Clock);this.noise.WriteRegister(4,data&8,Clock);break;case 16407:this._throwingIRQs=(data&64)!=64;this.lastFrameHit=0}},UpdateFrame:function(time){this.muted||(this.RunFrameEvents(time,this.lastFrameHit),this.lastFrameHit===3?(this._throwingIRQs&&(this._interruptRaised=!0),this.lastFrameHit=0):this.lastFrameHit++)},RunFrameEvents:function(time,step){this.triangle.FrameClock(time,step);this.noise.FrameClock(time,step);this.square0.FrameClock(time,step);this.square1.FrameClock(time,step)},EndFrame:function(time){this.square0.EndFrame(time);this.square1.EndFrame(time);this.triangle.EndFrame(time);this.noise.EndFrame(time);this.muted||this.myBlipper.blip_end_frame(time);this.writer.Locker;var count=this.myBlipper.ReadBytes(this.writer.SharedBuffer,this.writer.SharedBuffer.length/2,0);this.writer.WavesWritten(count)},FlushFrame:function(){for(var currentClock=0,frameClocker=0,currentEntry,clockDelta;this.registers.Count>0;)currentEntry=this.registers.dequeue(),frameClocker>7445&&(frameClocker-=7445,this.UpdateFrame(7445)),this.DoSetByte(currentEntry.time,currentEntry.address,currentEntry.data),currentClock=currentEntry.time,frameClocker=currentEntry.time;for(clockDelta=currentClock%7445,this.lastFrameHit===0&&this.UpdateFrame(7445);this.lastFrameHit>0;)this.UpdateFrame(7445*(this.lastFrameHit+1))},HandleEvent:function(Clock){this.UpdateFrame(Clock);this.lastClock=Clock;Clock>29780&&(this.writer,this.EndFrame(Clock))},ResetClock:function(Clock){this.lastClock=Clock}}});Bridge.define("ChiChiNES.BeepsBoops.WavSharer",{inherits:[ChiChiNES.BeepsBoops.IWavReader],statics:{fields:{sample_size:0},ctors:{init:function(){this.sample_size=2}}},fields:{_NESTooFast:!1,Locker:null,frequency:0,_sharedBuffer:null,_sharedBufferLength:0,_bufferAvailable:!1,appendToFile:null,fileWriting:!1,bufferWasRead:!1,bytesWritten:null},props:{NESTooFast:{get:function(){return this._NESTooFast},set:function(value){this._NESTooFast=value}},Frequency:{get:function(){return this.frequency}},SharedBuffer:{get:function(){return this._sharedBuffer},set:function(value){this._sharedBuffer=value}},SharedBufferLength:{get:function(){return this._sharedBufferLength},set:function(value){this._sharedBufferLength=value}},BufferAvailable:{get:function(){return this._bufferAvailable}},BytesWritten:{get:function(){return this.bytesWritten},set:function(value){this.bytesWritten=value}}},alias:["Frequency","ChiChiNES$BeepsBoops$IWavReader$Frequency","SharedBuffer","ChiChiNES$BeepsBoops$IWavReader$SharedBuffer","SharedBufferLength","ChiChiNES$BeepsBoops$IWavReader$SharedBufferLength","BufferAvailable","ChiChiNES$BeepsBoops$IWavReader$BufferAvailable","StartReadWaves","ChiChiNES$BeepsBoops$IWavReader$StartReadWaves","ReadWaves","ChiChiNES$BeepsBoops$IWavReader$ReadWaves","BytesWritten","ChiChiNES$BeepsBoops$IWavReader$BytesWritten","SetSharedBuffer","ChiChiNES$BeepsBoops$IWavReader$SetSharedBuffer"],ctors:{init:function(){this.Locker={};this.frequency=22050},$ctor1:function(frequency){ChiChiNES.BeepsBoops.WavSharer.ctor.call(this);this.frequency=frequency},ctor:function(){this.$initialize();this._sharedBuffer=System.Array.init(8192,0,System.Byte)}},methods:{WavesWritten:function(remain){var n=Bridge.Int.div(this._sharedBuffer.length,ChiChiNES.BeepsBoops.WavSharer.sample_size)|0;n>remain&&(n=remain);this._sharedBufferLength=Bridge.Int.mul(n,2);this.bufferWasRead=!1;this._bufferAvailable=!0;this.WroteBytes()},AppendFile:function(writer){this.appendToFile=writer;this.fileWriting=this.appendToFile!=null},Dispose:function(){null!=this.appendToFile&&this.appendToFile.System$IDisposable$dispose()},StartReadWaves:function(){},ReadWaves:function(){this._bufferAvailable=!1;this._sharedBufferLength=0;this.bufferWasRead=!0},WroteBytes:function(){Bridge.staticEquals(this.bytesWritten,null)||this.bytesWritten(this,{})},SetSharedBuffer:function(values){this._sharedBuffer=values}}});Bridge.define("ChiChiNES.Hacking.ComparedMemoryPatch",{inherits:[ChiChiNES.Hacking.IMemoryPatch],fields:{_CompareData:0,_ReplaceData:0},props:{Activated:!1,Address:0},alias:["Activated","ChiChiNES$Hacking$IMemoryPatch$Activated","Address","ChiChiNES$Hacking$IMemoryPatch$Address","GetData","ChiChiNES$Hacking$IMemoryPatch$GetData"],ctors:{ctor:function(Address,CompareToData,ReplaceWithData){this.$initialize();this._CompareData=CompareToData;this._ReplaceData=ReplaceWithData;this.Address=Address}},methods:{GetData:function(data){return data===this._CompareData?this._ReplaceData:data},toString:function(){return System.String.format("{0} = {1} if {2} Activated: {3}",this.Address,this._ReplaceData,this._CompareData,this.Activated)}}});Bridge.define("ChiChiNES.Hacking.MemoryPatch",{inherits:[ChiChiNES.Hacking.IMemoryPatch],fields:{_data:0},props:{Activated:!1,Address:0},alias:["Activated","ChiChiNES$Hacking$IMemoryPatch$Activated","Address","ChiChiNES$Hacking$IMemoryPatch$Address","GetData","ChiChiNES$Hacking$IMemoryPatch$GetData"],ctors:{ctor:function(Address,Data){this.$initialize();this._data=Data;this.Address=Address}},methods:{GetData:function(){return this._data},toString:function(){return System.String.format("{0} = {1}  Activated: {2}",this.Address,this._data,this.Activated)}}});Bridge.define("ChiChiNES.InputHandler",{inherits:[ChiChiNES.IClockedMemoryMappedIOElement],fields:{currentByte:0,nextByte:0,controlPad:null,isZapper:!1,inputLock:null},props:{IsZapper:{get:function(){return this.isZapper},set:function(value){this.isZapper=value}},ControlPad:{get:function(){return this.controlPad},set:function(value){this.controlPad=value}},CurrentByte:{get:function(){return this.currentByte},set:function(value){this.currentByte=value}},NMIHandler:{get:function(){throw new System.NotImplementedException;},set:function(){throw new System.NotImplementedException;}},IRQAsserted:{get:function(){throw new System.NotImplementedException;},set:function(){throw new System.NotImplementedException;}},NextEventAt:{get:function(){throw new System.NotImplementedException;}}},alias:["GetByte","ChiChiNES$IClockedMemoryMappedIOElement$GetByte","SetByte","ChiChiNES$IClockedMemoryMappedIOElement$SetByte","NMIHandler","ChiChiNES$IClockedMemoryMappedIOElement$NMIHandler","IRQAsserted","ChiChiNES$IClockedMemoryMappedIOElement$IRQAsserted","NextEventAt","ChiChiNES$IClockedMemoryMappedIOElement$NextEventAt","HandleEvent","ChiChiNES$IClockedMemoryMappedIOElement$HandleEvent","ResetClock","ChiChiNES$IClockedMemoryMappedIOElement$ResetClock"],ctors:{init:function(){this.isZapper=!1;this.inputLock={}},ctor:function(){this.$initialize();this.controlPad=null},$ctor1:function(padOne){this.$initialize();this.ControlPad=padOne}},methods:{controlPad_NextControlByteSet:function(sender,e){this.SetNextControlByte(e.NextValue)},GetByte:function(clock){return this.controlPad.ChiChiNES$IControlPad$getByte(clock)},SetByte:function(clock,address,data){this.controlPad.ChiChiNES$IControlPad$setByte(clock,data)},SetNextControlByte:function(data){this.nextByte=data},HandleEvent:function(){throw new System.NotImplementedException;},ResetClock:function(){throw new System.NotImplementedException;}}});Bridge.define("ChiChiNES.NullControlPad",{inherits:[ChiChiNES.IControlPad],props:{CurrentByte:{get:function(){return 0},set:function(){}}},alias:["CurrentByte","ChiChiNES$IControlPad$CurrentByte","refresh","ChiChiNES$IControlPad$refresh","getByte","ChiChiNES$IControlPad$getByte","setByte","ChiChiNES$IControlPad$setByte","dispose","System$IDisposable$dispose"],methods:{refresh:function(){},getByte:function(){return 0},setByte:function(){},dispose:function(){}}});Bridge.define("ChiChiNES.PixelWhizzler",{inherits:[ChiChiNES.IPPU,ChiChiNES.IClockedMemoryMappedIOElement],statics:{fields:{ScanlinePreRenderDummyScanline:0,ScanlineRenderingStartsOn:0,ScanlineRenderingEndsOn:0,ScanlineLastRenderedPixel:0,ScanlineTotalLength:0,ScanlineEventPPUXIncremented:0,ScanlineEventPPUXReset:0,ScanlineEventPPUYIncremented:0,vBufferWidth:0,_powersOfTwo:null,pal:null,frameClockEnd:0},props:{PowersOfTwo:{get:function(){return ChiChiNES.PixelWhizzler._powersOfTwo}}},ctors:{init:function(){this.ScanlinePreRenderDummyScanline=20;this.ScanlineRenderingStartsOn=21;this.ScanlineRenderingEndsOn=260;this.ScanlineLastRenderedPixel=255;this.ScanlineTotalLength=340;this.ScanlineEventPPUXIncremented=3;this.ScanlineEventPPUXReset=257;this.ScanlineEventPPUYIncremented=251;this.vBufferWidth=256;this._powersOfTwo=System.Array.init(32,0,System.Int32);this.pal=System.Array.init([7961465,10626572,11407400,10554206,7733552,2753820,725017,271983,278855,284436,744967,3035906,7161605,0,131586,131586,12566719,14641430,15614283,14821245,12196292,6496468,2176980,875189,293472,465210,1597716,5906953,11090185,2961197,197379,197379,16316149,16298569,16588080,16415170,15560682,12219892,7115511,4563694,2277591,2151458,4513360,1957181,14604331,6579811,263172,263172,16447992,16441012,16634316,16500447,16236786,14926838,12831991,11393781,2287340,5500370,11858360,14283440,15921318,13158344,328965,328965,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],System.Int32);this.frameClockEnd=89342},ctor:function(){for(var i=0;i<32;i=i+1|0)ChiChiNES.PixelWhizzler._powersOfTwo[i]=Bridge.Int.clip32(Math.pow(2,i))}},methods:{GetPalRGBA:function(){for(var n=0;n<64;n=n+1|0)ChiChiNES.PixelWhizzler.pal[n+64|0]=ChiChiNES.PixelWhizzler.pal[n],ChiChiNES.PixelWhizzler.pal[n+128|0]=ChiChiNES.PixelWhizzler.pal[n],ChiChiNES.PixelWhizzler.pal[n+192|0]=ChiChiNES.PixelWhizzler.pal[n];return ChiChiNES.PixelWhizzler.pal}}},fields:{currentXPosition:0,currentYPosition:0,scanlineNum:0,scanlinePos:0,_isDebugging:!1,shouldRender:!1,vBuffer:null,nameTableIndex:0,_frames:0,hitSprite:!1,_PPUControlByte0:0,_PPUControlByte1:0,_spritesAreVisible:!1,_tilesAreVisible:!1,_PPUStatus:0,_PPUAddress:0,ppuReadBuffer:0,PPUAddressLatchIsHigh:!1,p32:null,_backgroundPatternTableIndex:0,needToDraw:!1,isRendering:!1,frameClock:0,FrameEnded:!1,frameOn:!1,framePalette:null,nameTableMemoryStart:0,lastcpuClock:0,rgb32OutBuffer:null,byteOutBuffer:null,outBuffer:null,vbufLocation:0,drawInfo:null,pixelDevices:null,_clipTiles:!1,_clipSprites:!1,nameTableBits:0,vidRamIsRam:!1,_palette:null,_openBus:0,currentPalette:0,nmiHandler:null,frameFinished:null,NMIHasBeenThrownThisFrame:!1,_hScroll:0,_vScroll:0,lockedHScroll:0,lockedVScroll:0,spriteChanges:!1,_spriteCopyHasHappened:!1,sprite0scanline:0,sprite0x:0,spriteZeroHit:!1,isForegroundPixel:!1,currentSprites:null,unpackedSprites:null,_maxSpritesPerScanline:0,spriteRAM:null,_spriteAddress:0,spritesOnThisScanline:0,spriteSize:0,spritesOnLine:null,patternEntry:0,patternEntryByte2:0,currentAttributeByte:0,currentTileIndex:0,xNTXor:0,yNTXor:0,fetchTile:!1,xPosition:0,yPosition:0,chrRomHandler:null,events:null},props:{CurrentYPosition:{get:function(){return this.currentYPosition}},CurrentXPosition:{get:function(){return this.currentXPosition}},ScanlinePos:{get:function(){return this.scanlinePos}},ScanlineNum:{get:function(){return this.scanlineNum}},IsDebugging:{get:function(){return this._isDebugging},set:function(value){this._isDebugging=value}},ShouldRender:{get:function(){return this.shouldRender},set:function(value){this.shouldRender=value}},Frames:{get:function(){return this._frames}},HandleVBlankIRQ:!1,VROM:null,PPUControlByte0:{get:function(){return this._PPUControlByte0},set:function(value){this._PPUControlByte0!==value&&(this._PPUControlByte0=value,this.UpdatePPUControlByte0())}},NMIIsThrown:{get:function(){return(this._PPUControlByte0&128)==128}},PPUControlByte1:{get:function(){return this._PPUControlByte1},set:function(value){this._PPUControlByte1=value}},BackgroundVisible:{get:function(){return this._tilesAreVisible}},SpritesAreVisible:{get:function(){return this._spritesAreVisible}},PPUStatus:{get:function(){return this._PPUStatus},set:function(value){this._PPUStatus=value}},PPUAddress:{get:function(){return this._PPUAddress},set:function(value){this._PPUAddress=value}},PatternTableIndex:{get:function(){return this._backgroundPatternTableIndex}},NeedToDraw:{get:function(){return this.needToDraw}},IsRendering:{get:function(){return this.isRendering}},FrameOn:{get:function(){return this.frameOn},set:function(value){this.frameOn=value}},NameTableMemoryStart:{get:function(){return this.nameTableMemoryStart},set:function(value){this.nameTableMemoryStart=value}},CurrentFrame:{get:function(){return this.vBuffer}},LastcpuClock:{get:function(){return this.lastcpuClock},set:function(value){this.lastcpuClock=value}},OutBuffer:{get:function(){return this.outBuffer}},VideoBuffer:{get:function(){return this.rgb32OutBuffer}},PixelAwareDevice:{get:function(){return this.pixelDevices},set:function(value){this.pixelDevices=value}},ByteOutBuffer:{get:function(){return this.byteOutBuffer},set:function(value){this.byteOutBuffer=value}},Palette:{get:function(){return this._palette},set:function(value){this._palette=value}},CurrentPalette:{get:function(){return this.currentPalette}},NMIHandler:{get:function(){return this.nmiHandler},set:function(value){this.nmiHandler=value}},IRQAsserted:{get:function(){throw new System.NotImplementedException;},set:function(){throw new System.NotImplementedException;}},NextEventAt:{get:function(){return this.frameClock<6820?Bridge.Int.div(6820-this.frameClock|0,3)|0:Bridge.Int.div(Bridge.Int.div(89345-this.frameClock|0,341)|0,3)|0}},FrameFinishHandler:{get:function(){return this.frameFinished},set:function(value){this.frameFinished=value}},NMIOccurred:{get:function(){return(this._PPUStatus&128)==128}},HScroll:{get:function(){return this.lockedHScroll}},VScroll:{get:function(){return this.lockedVScroll}},SpriteCopyHasHappened:{get:function(){return this._spriteCopyHasHappened},set:function(value){this._spriteCopyHasHappened=value}},MaxSpritesPerScanline:{get:function(){return this._maxSpritesPerScanline},set:function(value){this._maxSpritesPerScanline=value}},SpriteRam:{get:function(){return this.spriteRAM}},SpritesOnLine:{get:function(){return this.spritesOnLine}},ChrRomHandler:{get:function(){return this.chrRomHandler},set:function(value){this.chrRomHandler=value}},Events:{get:function(){return this.events}}},alias:["ScanlinePos","ChiChiNES$IPPU$ScanlinePos","ScanlineNum","ChiChiNES$IPPU$ScanlineNum","Initialize","ChiChiNES$IPPU$Initialize","WriteState","ChiChiNES$IPPU$WriteState","ReadState","ChiChiNES$IPPU$ReadState","VidRAM_GetNTByte","ChiChiNES$IPPU$VidRAM_GetNTByte","PPUControlByte0","ChiChiNES$IPPU$PPUControlByte0","PPUControlByte1","ChiChiNES$IPPU$PPUControlByte1","SpritesAreVisible","ChiChiNES$IPPU$SpritesAreVisible","SetupBufferForDisplay","ChiChiNES$IPPU$SetupBufferForDisplay","PatternTableIndex","ChiChiNES$IPPU$PatternTableIndex","NameTableMemoryStart","ChiChiNES$IPPU$NameTableMemoryStart","CurrentFrame","ChiChiNES$IPPU$CurrentFrame","RenderScanline","ChiChiNES$IPPU$RenderScanline","LastcpuClock","ChiChiNES$IPPU$LastcpuClock","DrawTo","ChiChiNES$IPPU$DrawTo","VideoBuffer","ChiChiNES$IPPU$VideoBuffer","SetVideoBuffer","ChiChiNES$IPPU$SetVideoBuffer","UpdatePixelInfo","ChiChiNES$IPPU$UpdatePixelInfo","PixelAwareDevice","ChiChiNES$IPPU$PixelAwareDevice","ByteOutBuffer","ChiChiNES$IPPU$ByteOutBuffer","Palette","ChiChiNES$IPPU$Palette","SetByte","ChiChiNES$IClockedMemoryMappedIOElement$SetByte","SetByte","ChiChiNES$IPPU$SetByte","GetByte","ChiChiNES$IClockedMemoryMappedIOElement$GetByte","GetByte","ChiChiNES$IPPU$GetByte","NMIHandler","ChiChiNES$IClockedMemoryMappedIOElement$NMIHandler","NMIHandler","ChiChiNES$IPPU$NMIHandler","IRQAsserted","ChiChiNES$IClockedMemoryMappedIOElement$IRQAsserted","NextEventAt","ChiChiNES$IClockedMemoryMappedIOElement$NextEventAt","NextEventAt","ChiChiNES$IPPU$NextEventAt","HandleEvent","ChiChiNES$IClockedMemoryMappedIOElement$HandleEvent","HandleEvent","ChiChiNES$IPPU$HandleEvent","ResetClock","ChiChiNES$IClockedMemoryMappedIOElement$ResetClock","ResetClock","ChiChiNES$IPPU$ResetClock","FrameFinishHandler","ChiChiNES$IPPU$FrameFinishHandler","SetupVINT","ChiChiNES$IPPU$SetupVINT","HScroll","ChiChiNES$IPPU$HScroll","VScroll","ChiChiNES$IPPU$VScroll","SpriteRam","ChiChiNES$IPPU$SpriteRam","CopySprites","ChiChiNES$IPPU$CopySprites","SpritesOnLine","ChiChiNES$IPPU$SpritesOnLine","PreloadSprites","ChiChiNES$IPPU$PreloadSprites","ChrRomHandler","ChiChiNES$IPPU$ChrRomHandler"],ctors:{init:function(){this.currentXPosition=0;this.currentYPosition=0;this.scanlineNum=0;this.scanlinePos=0;this.shouldRender=!1;this._frames=0;this.hitSprite=!1;this.PPUAddressLatchIsHigh=!0;this.p32=System.Array.init(256,0,System.Int32);this.needToDraw=!0;this.isRendering=!0;this.frameClock=0;this.FrameEnded=!1;this.frameOn=!1;this.framePalette=System.Array.init(256,0,System.Int32);this.rgb32OutBuffer=System.Array.init(65536,0,System.Int32);this.byteOutBuffer=System.Array.init(262144,0,System.Byte);this.outBuffer=System.Array.init(65536,0,System.Int32);this.drawInfo=System.Array.init(65536,0,System.Int32);this.nameTableBits=0;this.vidRamIsRam=!0;this._palette=System.Array.init(32,0,System.Byte);this._openBus=0;this.currentPalette=0;this.NMIHasBeenThrownThisFrame=!1;this._hScroll=0;this._vScroll=0;this.lockedHScroll=0;this.lockedVScroll=0;this.sprite0scanline=-1;this.sprite0x=-1;this._maxSpritesPerScanline=64;this.spriteRAM=System.Array.init(256,0,System.Byte);this.spritesOnLine=System.Array.init(512,0,System.Int32);this.patternEntry=0;this.patternEntryByte2=0;this.currentTileIndex=0;this.xNTXor=0;this.yNTXor=0;this.fetchTile=!0;this.events=new(System.Collections.Generic.Queue$1(ChiChiNES.PPUWriteEvent).ctor)},ctor:function(){this.$initialize();this.InitSprites();this.vBuffer=System.Array.init(61440,0,System.Byte);ChiChiNES.PixelWhizzler.GetPalRGBA()}},methods:{Initialize:function(){this._PPUAddress=0;this._PPUStatus=0;this._PPUControlByte0=0;this._PPUControlByte1=0;this._hScroll=0;this.scanlineNum=0;this.scanlinePos=0;this._spriteAddress=0},WriteState:function(writer){var i,i1,i2,i3;for(writer.enqueue(this._PPUStatus),writer.enqueue(this._PPUControlByte0),writer.enqueue(this._hScroll),writer.enqueue(this._vScroll),writer.enqueue(this.scanlineNum),writer.enqueue(this.scanlinePos),writer.enqueue(this.currentYPosition),writer.enqueue(this.currentXPosition),writer.enqueue(this.nameTableIndex),writer.enqueue(this._backgroundPatternTableIndex),writer.enqueue(this.patternEntry),writer.enqueue(this.patternEntryByte2),writer.enqueue(this.currentAttributeByte),writer.enqueue(this.xNTXor),writer.enqueue(this.yNTXor),writer.enqueue(this.fetchTile?0:1),writer.enqueue(this.xPosition),writer.enqueue(this.yPosition),writer.enqueue(this.lastcpuClock),writer.enqueue(this.vbufLocation),i=0;i<16384;i=i+4|0)writer.enqueue(this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,i)<<24|this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,i+1|0)<<16|this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,i+2|0)<<8|this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,i+3|0)<<0);for(writer.enqueue(this._spriteAddress),i1=0;i1<256;i1=i1+4|0)writer.enqueue(this.spriteRAM[i1]<<24|this.spriteRAM[i1+1|0]<<16|this.spriteRAM[i1+2|0]<<8|this.spriteRAM[i1+3|0]);for(i2=0;i2<ChiChiNES.PixelWhizzler.pal.length;i2=i2+4|0)writer.enqueue(ChiChiNES.PixelWhizzler.pal[i2]<<24|ChiChiNES.PixelWhizzler.pal[i2+1|0]<<16|ChiChiNES.PixelWhizzler.pal[i2+2|0]<<8|ChiChiNES.PixelWhizzler.pal[i2+3|0]);for(i3=0;i3<this._palette.length;i3=i3+4|0)writer.enqueue(this._palette[i3]<<24|this._palette[i3+1|0]<<16|this._palette[i3+2|0]<<8|this._palette[i3+3|0])},ReadState:function(state){var packedByte,i,i1,i2,i3;for(this._PPUStatus=state.dequeue(),this._PPUControlByte0=state.dequeue(),this._hScroll=state.dequeue(),this._vScroll=state.dequeue(),this.scanlineNum=state.dequeue(),this.scanlinePos=state.dequeue(),this.currentYPosition=state.dequeue(),this.currentXPosition=state.dequeue(),this.nameTableIndex=state.dequeue(),this._backgroundPatternTableIndex=state.dequeue(),this.patternEntry=state.dequeue(),this.patternEntryByte2=state.dequeue(),this.currentAttributeByte=state.dequeue(),this.xNTXor=state.dequeue(),this.yNTXor=state.dequeue(),this.fetchTile=state.dequeue()===1,this.xPosition=state.dequeue(),this.yPosition=state.dequeue(),this.lastcpuClock=state.dequeue(),this.vbufLocation=state.dequeue(),packedByte=0,i=0;i<16384;i=i+4|0)packedByte=state.dequeue(),this.chrRomHandler.ChiChiNES$IClockedMemoryMappedIOElement$SetByte(0,i,packedByte>>24&255),this.chrRomHandler.ChiChiNES$IClockedMemoryMappedIOElement$SetByte(0,i+1|0,packedByte>>16&255),this.chrRomHandler.ChiChiNES$IClockedMemoryMappedIOElement$SetByte(0,i+2|0,packedByte>>8&255),this.chrRomHandler.ChiChiNES$IClockedMemoryMappedIOElement$SetByte(0,i+3|0,packedByte&255);for(this._spriteAddress=state.dequeue(),i1=0;i1<256;i1=i1+4|0)packedByte=state.dequeue(),this.spriteRAM[i1]=packedByte>>24&255,this.spriteRAM[i1+1|0]=packedByte>>16&255,this.spriteRAM[i1+2|0]=packedByte>>8&255,this.spriteRAM[i1+3|0]=packedByte&255;for(i2=0;i2<ChiChiNES.PixelWhizzler.pal.length;i2=i2+4|0)packedByte=state.dequeue(),ChiChiNES.PixelWhizzler.pal[i2]=packedByte>>24&255,ChiChiNES.PixelWhizzler.pal[i2+1|0]=packedByte>>16&255,ChiChiNES.PixelWhizzler.pal[i2+2|0]=packedByte>>8&255,ChiChiNES.PixelWhizzler.pal[i2+3|0]=packedByte&255;for(i3=0;i3<this._palette.length;i3=i3+4|0)packedByte=state.dequeue(),this._palette[i3]=packedByte>>24&255,this._palette[i3+1|0]=packedByte>>16&255,this._palette[i3+2|0]=packedByte>>8&255,this._palette[i3+3|0]=packedByte&255;this.UnpackSprites();this.PreloadSprites(this.scanlineNum)},VidRAM_GetNTByte:function(address){return address>=8192&&address<12288?this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,address):this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,address)},UpdatePPUControlByte0:function(){this._backgroundPatternTableIndex=(this._PPUControlByte0&16)==16?4096:0},SetupBufferForDisplay:function(buffer){for(var i1,i=0;i<30;i=i+1|0)this.p32[i]=ChiChiNES.PixelWhizzler.pal[i];for(i1=0;i1<buffer.v.length;i1=i1+4|0)buffer.v[i1]=this.p32[buffer.v[i1]],buffer.v[i1+1|0]=this.p32[buffer.v[i1+1|0]&255],buffer.v[i1+2|0]=this.p32[buffer.v[i1+2|0]&255],buffer.v[i1+3|0]=this.p32[buffer.v[i1+3|0]&255]},RenderScanline:function(){throw new System.NotImplementedException;},DrawTo:function(cpuClockNum){var frClock=(cpuClockNum-this.lastcpuClock)*3,i;for(this.frameClock<6820&&(this.frameClock+frClock<6820?(this.frameClock+=frClock,frClock=0):(frClock+=this.frameClock-6820,this.frameClock=6820)),i=0;i<frClock;++i){switch(this.frameClock++){case 6820:this.ClearVINT();this.frameOn=!0;this.ClearNESPalette();this.chrRomHandler.ChiChiNES$INESCart$ResetBankStartCache();this.spriteChanges&&(this.UnpackSprites(),this.spriteChanges=!1);break;case 7161:this.vbufLocation=0;this.xNTXor=0;this.yNTXor=0;this.currentXPosition=0;this.currentYPosition=0;break;case ChiChiNES.PixelWhizzler.frameClockEnd:this.shouldRender=!0;this.frameFinished();this.SetupVINT();this.frameOn=!1;this.frameClock=0;this._isDebugging&&this.events.clear()}if(this.frameClock>=7161&&this.frameClock<=89342){if(this.currentXPosition<256&&this.vbufLocation<61440){if(this.xPosition=this.currentXPosition+this.lockedHScroll,(this.xPosition&7)==0){this.xNTXor=(this.xPosition&256)==256?1024:0;this.xPosition&=255;var ppuNameTableMemoryStart=this.nameTableMemoryStart^this.xNTXor^this.yNTXor,xTilePosition=this.xPosition>>3,TileIndex=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,8192+ppuNameTableMemoryStart+xTilePosition+((this.yPosition>>3)%30<<5)),patternTableYOffset=this.yPosition&7,patternID=this._backgroundPatternTableIndex+TileIndex*16+patternTableYOffset;this.patternEntry=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,patternID);this.patternEntryByte2=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,patternID+8);this.currentAttributeByte=this.GetAttributeTableEntry(ppuNameTableMemoryStart,xTilePosition,this.yPosition>>3)}var tilePixel=this._tilesAreVisible?this.GetNameTablePixel():0,foregroundPixel={v:!1},spritePixel=this._spritesAreVisible?this.GetSpritePixel(foregroundPixel):0;!this.hitSprite&&this.spriteZeroHit&&tilePixel!==0&&(this.hitSprite=!0,this._PPUStatus=this._PPUStatus|64);this.byteOutBuffer[this.vbufLocation*4]=this._palette[foregroundPixel.v||tilePixel===0&&spritePixel!==0?spritePixel:tilePixel];this.vbufLocation++}this.currentXPosition===256&&this.chrRomHandler.ChiChiNES$INESCart$UpdateScanlineCounter();this.currentXPosition++;this.currentXPosition>340&&(this.currentXPosition=0,this.currentYPosition++,this.PreloadSprites(this.currentYPosition),this.spritesOnThisScanline>=7&&(this._PPUStatus=this._PPUStatus|32),this.lockedHScroll=this._hScroll,this.UpdatePixelInfo(),this.RunNewScanlineEvents())}}this.lastcpuClock=cpuClockNum},BumpScanline:function(){},UpdateXPosition:function(){},FillBuffer:function(){},SetVideoBuffer:function(inBuffer){this.rgb32OutBuffer=inBuffer},DrawPixel:function(){},UpdatePixelInfo:function(){this.nameTableMemoryStart=Bridge.Int.mul(this.nameTableBits,1024)},ClippingTilePixels:function(){return this._clipTiles},ClippingSpritePixels:function(){return this._clipSprites},SetByte:function(Clock,address,data){var $t;this._isDebugging&&this.Events.enqueue(($t=new ChiChiNES.PPUWriteEvent,$t.IsWrite=!0,$t.DataWritten=data,$t.FrameClock=this.frameClock,$t.RegisterAffected=address,$t.ScanlineNum=Bridge.Int.div(this.frameClock,341)|0,$t.ScanlinePos=this.frameClock%341,$t));this.needToDraw=!0;switch(address&7){case 0:this.DrawTo(Clock);this._PPUControlByte0=data;this._openBus=data;this.nameTableBits=this._PPUControlByte0&3;this._backgroundPatternTableIndex=Bridge.Int.mul((this._PPUControlByte0&16)>>4,4096);this.nameTableMemoryStart=Bridge.Int.mul(this.nameTableBits,1024);break;case 1:this.DrawTo(Clock);this.isRendering=(data&24)!=0;this._PPUControlByte1=data;this._spritesAreVisible=(this._PPUControlByte1&16)==16;this._tilesAreVisible=(this._PPUControlByte1&8)==8;this._clipTiles=(this._PPUControlByte1&2)!=2;this._clipSprites=(this._PPUControlByte1&4)!=4;this.nameTableMemoryStart=Bridge.Int.mul(this.nameTableBits,1024);break;case 2:this.ppuReadBuffer=data;this._openBus=data;break;case 3:this._spriteAddress=data&255;this._openBus=this._spriteAddress;break;case 4:this.spriteRAM[this._spriteAddress]=data&255;this._spriteAddress=(this._spriteAddress+1|0)&255;this.unpackedSprites[Bridge.Int.div(this._spriteAddress,4)|0].Changed=!0;this.spriteChanges=!0;break;case 5:this.PPUAddressLatchIsHigh?(this.DrawTo(Clock),this._hScroll=data,this.lockedHScroll=this._hScroll&7,this.UpdatePixelInfo(),this.PPUAddressLatchIsHigh=!1):(this.DrawTo(Clock),this._vScroll=data,data>240&&(this._vScroll=data-256|0),this.frameOn&&(!this.frameOn||this.isRendering)||(this.lockedVScroll=this._vScroll),this.PPUAddressLatchIsHigh=!0,this.UpdatePixelInfo());break;case 6:this.PPUAddressLatchIsHigh?(this._PPUAddress=this._PPUAddress&255|(data&63)<<8,this.PPUAddressLatchIsHigh=!1):(this._PPUAddress=this._PPUAddress&32512|data&255,this.PPUAddressLatchIsHigh=!0,this.DrawTo(Clock),this._hScroll=(this._PPUAddress&31)<<3,this._vScroll=(this._PPUAddress>>5&31)<<3,this._vScroll=this._vScroll|this._PPUAddress>>12&3,this.nameTableBits=this._PPUAddress>>10&3,this.frameOn&&(this.lockedHScroll=this._hScroll,this.lockedVScroll=this._vScroll,this.lockedVScroll=this.lockedVScroll-this.currentYPosition|0),this.UpdatePixelInfo());break;case 7:(this._PPUAddress&65280)==16128?(this.DrawTo(Clock),this.WriteToNESPalette(this._PPUAddress,data&255),this.UpdatePixelInfo()):(this._PPUAddress&61440)==8192?this.chrRomHandler.ChiChiNES$INESCart$SetPPUByte(Clock,this._PPUAddress,data&255):this.vidRamIsRam&&this.chrRomHandler.ChiChiNES$INESCart$SetPPUByte(Clock,this._PPUAddress,data&255);this._PPUAddress=(this.PPUControlByte0&4)==4?this._PPUAddress+32|0:this._PPUAddress+1|0;this.PPUAddressLatchIsHigh=!0;this.PPUAddress=this.PPUAddress&16383}},GetByte:function(Clock,address){var $t,ret,tmp;this._isDebugging&&this.Events.enqueue(($t=new ChiChiNES.PPUWriteEvent,$t.IsWrite=!1,$t.DataWritten=0,$t.FrameClock=this.frameClock,$t.RegisterAffected=address,$t.ScanlineNum=Bridge.Int.div(this.frameClock,341)|0,$t.ScanlinePos=this.frameClock%341,$t));switch(address&7){case 3:case 0:case 1:case 5:case 6:return this._openBus;case 2:return this.PPUAddressLatchIsHigh=!0,ret=this.ppuReadBuffer&31|this._PPUStatus,this.DrawTo(Clock),(ret&128)==128&&(this._PPUStatus=this._PPUStatus&-129),this.UpdatePixelInfo(),this._openBus=ret,ret;case 4:return tmp=this.spriteRAM[this._spriteAddress],this._openBus=tmp,tmp;case 7:return(this.PPUAddress&65280)==16128?(tmp=this._palette[this.PPUAddress&31],this.ppuReadBuffer=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(Clock,this._PPUAddress-4096|0)):(tmp=this.ppuReadBuffer,this.ppuReadBuffer=(this._PPUAddress>=8192&this._PPUAddress<=12287)?this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(Clock,this._PPUAddress):this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(Clock,this._PPUAddress&16383)),this._PPUAddress=(this._PPUControlByte0&4)==4?this._PPUAddress+32|0:this._PPUAddress+1|0,this._PPUAddress=this._PPUAddress&16383,tmp}return 0},ClearNESPalette:function(){},WriteToNESPalette:function(address,data){var palAddress=address&31;this._palette[palAddress]=data;(this._PPUAddress&65519)==16128&&(this._palette[(palAddress^16)&31]=data)},HandleEvent:function(Clock){this.DrawTo(Clock)},ResetClock:function(Clock){this.lastcpuClock=Clock},SetupVINT:function(){this._PPUStatus=this._PPUStatus|128;this.NMIHasBeenThrownThisFrame=!1;this._frames=this._frames+1|0;this.needToDraw=!1;this.NMIIsThrown&&(this.nmiHandler(),this.HandleVBlankIRQ=!0,this.NMIHasBeenThrownThisFrame=!0)},ClearVINT:function(){this._PPUStatus=0;this.hitSprite=!1;this.spriteSize=(this._PPUControlByte0&32)==32?16:8;(this._PPUControlByte1&24)!=0&&(this.isRendering=!0)},RunEndOfScanlineRenderEvents:function(){},RunNewScanlineEvents:function(){this.yPosition=this.currentYPosition+this.lockedVScroll|0;this.yPosition<0&&(this.yPosition=this.yPosition+240|0);this.yPosition>=240?(this.yPosition=this.yPosition-240|0,this.yNTXor=2048):this.yNTXor=0},UpdateSprites:function(){},UpdateTiles:function(){},CopySprites:function(source,copyFrom){for(var spriteLocation,i=0;i<256;i=i+1|0)spriteLocation=(this._spriteAddress+i|0)&255,this.spriteRAM[spriteLocation]!==source.v[copyFrom+i|0]&&(this.spriteRAM[spriteLocation]=source.v[copyFrom+i|0],this.unpackedSprites[Bridge.Int.div(spriteLocation,4)|0].Changed=!0);this._spriteCopyHasHappened=!0;this.spriteChanges=!0},InitSprites:function(){var i,i1;for(this.currentSprites=System.Array.init(this._maxSpritesPerScanline,function(){return new ChiChiNES.NESSprite},ChiChiNES.NESSprite),i=0;i<this._maxSpritesPerScanline;i=i+1|0)this.currentSprites[i]=new ChiChiNES.NESSprite;for(this.unpackedSprites=System.Array.init(64,function(){return new ChiChiNES.NESSprite},ChiChiNES.NESSprite),i1=0;i1<64;i1=i1+1|0)this.unpackedSprites[i1]=new ChiChiNES.NESSprite},GetSpritePixel:function(isForegroundPixel){var i,currSprite,spritePatternTable,patternEntry,patternEntryBit2;isForegroundPixel.v=!1;this.spriteZeroHit=!1;var result=0,yLine=0,xPos=0,tileIndex=0;for(i=0;i<this.spritesOnThisScanline;i=i+1|0)if(currSprite=this.currentSprites[i].$clone(),currSprite.XPosition>0&&this.currentXPosition>=currSprite.XPosition&&this.currentXPosition<(currSprite.XPosition+8|0)&&(spritePatternTable=0,(this._PPUControlByte0&8)==8&&(spritePatternTable=4096),xPos=this.currentXPosition-currSprite.XPosition|0,yLine=(this.currentYPosition-currSprite.YPosition|0)-1|0,yLine=yLine&(this.spriteSize-1|0),tileIndex=currSprite.TileIndex,(this._PPUControlByte0&32)==32&&((tileIndex&1)==1?(spritePatternTable=4096,tileIndex=tileIndex^1):spritePatternTable=0),currSprite.FlipY&&(yLine=(this.spriteSize-yLine|0)-1|0),yLine>=8&&(yLine=yLine+8|0),patternEntry=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,(spritePatternTable+Bridge.Int.mul(tileIndex,16)|0)+yLine|0),patternEntryBit2=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,((spritePatternTable+Bridge.Int.mul(tileIndex,16)|0)+yLine|0)+8|0),result=(currSprite.FlipX?patternEntry>>xPos&1|patternEntryBit2>>xPos<<1&2:patternEntry>>(7-xPos|0)&1|patternEntryBit2>>(7-xPos|0)<<1&2)&255,result!==0))return currSprite.SpriteNumber===0&&(this.spriteZeroHit=!0),isForegroundPixel.v=currSprite.Foreground,(result|currSprite.AttributeByte)&255;return 0},WhissaSpritePixel:function(patternTableIndex,x,y,sprite,tileIndex){var patternEntry,patternEntryBit2;return sprite.v.FlipY&&(y=(this.spriteSize-y|0)-1|0),y>=8&&(y=y+8|0),patternEntry=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,(patternTableIndex+Bridge.Int.mul(tileIndex,16)|0)+y|0),patternEntryBit2=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,((patternTableIndex+Bridge.Int.mul(tileIndex,16)|0)+y|0)+8|0),(sprite.v.FlipX?patternEntry>>x&1|patternEntryBit2>>x<<1&2:patternEntry>>(7-x|0)&1|patternEntryBit2>>(7-x|0)<<1&2)&255},PreloadSprites:function(scanline){var $t,$t1,yLine,spriteNum,spriteID,y,spId;for(this.spritesOnThisScanline=0,this.sprite0scanline=-1,yLine=this.currentYPosition-1|0,this.outBuffer[64768+yLine|0]=0,this.outBuffer[65024+yLine|0]=0,spriteNum=0;spriteNum<256;spriteNum=spriteNum+4|0)if(spriteID=((spriteNum+this._spriteAddress|0)&255)>>2,y=this.unpackedSprites[spriteID].YPosition+1|0,scanline>=y&&scanline<(y+this.spriteSize|0)&&(spriteID===0&&(this.sprite0scanline=scanline,this.sprite0x=this.unpackedSprites[spriteID].XPosition),spId=Bridge.Int.div(spriteNum,4)|0,spId<32?this.outBuffer[$t=64768+yLine|0]=this.outBuffer[$t]|1<<spId:this.outBuffer[$t1=65024+yLine|0]=this.outBuffer[$t1]|1<<(spId-32|0),this.currentSprites[this.spritesOnThisScanline]=this.unpackedSprites[spriteID].$clone(),this.currentSprites[this.spritesOnThisScanline].IsVisible=!0,this.spritesOnThisScanline=this.spritesOnThisScanline+1|0,this.spritesOnThisScanline===this._maxSpritesPerScanline))break;this.spritesOnThisScanline>7&&(this._PPUStatus=this._PPUStatus|32)},UnpackSprites:function(){for(var currSprite,outBufferloc=65280,i=0;i<256;i=i+4|0)this.outBuffer[outBufferloc]=this.spriteRAM[i]<<24|this.spriteRAM[i+1|0]<<16|this.spriteRAM[i+2|0]<<8|this.spriteRAM[i+3|0]<<0,outBufferloc=outBufferloc+1|0;for(currSprite=0;currSprite<this.unpackedSprites.length;currSprite=currSprite+1|0)this.unpackedSprites[currSprite].Changed&&this.UnpackSprite(currSprite)},UnpackSprite:function(currSprite){var attrByte=this.spriteRAM[Bridge.Int.mul(currSprite,4)+2|0];this.unpackedSprites[currSprite].IsVisible=!0;this.unpackedSprites[currSprite].AttributeByte=(attrByte&3)<<2|16;this.unpackedSprites[currSprite].YPosition=this.spriteRAM[Bridge.Int.mul(currSprite,4)];this.unpackedSprites[currSprite].XPosition=this.spriteRAM[Bridge.Int.mul(currSprite,4)+3|0];this.unpackedSprites[currSprite].SpriteNumber=currSprite;this.unpackedSprites[currSprite].Foreground=(attrByte&32)!=32;this.unpackedSprites[currSprite].FlipX=(attrByte&64)==64;this.unpackedSprites[currSprite].FlipY=(attrByte&128)==128;this.unpackedSprites[currSprite].TileIndex=this.spriteRAM[Bridge.Int.mul(currSprite,4)+1|0];this.unpackedSprites[currSprite].Changed=!1},GetNameTablePixel:function(){var result=(this.patternEntry&128)>>7|(this.patternEntryByte2&128)>>6;return this.patternEntry=this.patternEntry<<1,this.patternEntryByte2=this.patternEntryByte2<<1,result>0&&(result=result|this.currentAttributeByte),result&255},FetchNextTile:function(){var ppuNameTableMemoryStart=this.nameTableMemoryStart^this.xNTXor^this.yNTXor,xTilePosition=this.xPosition>>3,tileRow=(this.yPosition>>3)%30<<5,tileNametablePosition=((8192+ppuNameTableMemoryStart|0)+xTilePosition|0)+tileRow|0,TileIndex=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,tileNametablePosition),patternTableYOffset=this.yPosition&7,patternID=(this._backgroundPatternTableIndex+Bridge.Int.mul(TileIndex,16)|0)+patternTableYOffset|0;this.patternEntry=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,patternID);this.patternEntryByte2=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,patternID+8|0);this.currentAttributeByte=this.GetAttributeTableEntry(ppuNameTableMemoryStart,xTilePosition,this.yPosition>>3)},GetNameTablePixelOld:function(){var xPosition=this.currentXPosition,yPosition=this.currentYPosition,ppuNameTableMemoryStart=this.nameTableMemoryStart,patternTableEntryIndex;xPosition=xPosition+this.lockedHScroll|0;xPosition>255&&(xPosition=xPosition-256|0,ppuNameTableMemoryStart=ppuNameTableMemoryStart^1024);patternTableEntryIndex=7-(xPosition&7)|0;yPosition=yPosition+this.lockedVScroll|0;yPosition<0&&(yPosition=yPosition+240|0);yPosition>=240&&(yPosition=yPosition-240|0,ppuNameTableMemoryStart=ppuNameTableMemoryStart^2048);var tileRow=(Bridge.Int.div(yPosition,8)|0)%30,tileNametablePosition=((8192+ppuNameTableMemoryStart|0)+(Bridge.Int.div(xPosition,8)|0)|0)+Bridge.Int.mul(tileRow,32)|0,TileIndex=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,tileNametablePosition),patternTableYOffset=yPosition&7,patternEntry=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,(this._backgroundPatternTableIndex+Bridge.Int.mul(TileIndex,16)|0)+patternTableYOffset|0),patternEntryByte2=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,((this._backgroundPatternTableIndex+Bridge.Int.mul(TileIndex,16)|0)+8|0)+patternTableYOffset|0),result=(patternEntry>>patternTableEntryIndex&1|Bridge.Int.mul(patternEntryByte2>>patternTableEntryIndex&1,2))&255;return result>0&&(result=(result|this.GetAttributeTableEntry(ppuNameTableMemoryStart,Bridge.Int.div(xPosition,8)|0,Bridge.Int.div(yPosition,8)|0)&255)&255),result},GetAttributeTableEntry:function(ppuNameTableMemoryStart,i,j){var LookUp=this.chrRomHandler.ChiChiNES$INESCart$GetPPUByte(0,(((8192+ppuNameTableMemoryStart|0)+960|0)+(Bridge.Int.div(i,4)|0)|0)+Bridge.Int.mul(Bridge.Int.div(j,4)|0,8)|0);switch(i&2|Bridge.Int.mul(j&2,2)){case 0:return LookUp<<2&12;case 2:return LookUp&12;case 4:return LookUp>>2&12;case 6:return LookUp>>4&12}return 0}}});Bridge.define("ChiChiNES.PortQueueing.QueuedPort",{inherits:[System.Collections.Generic.Queue$1(ChiChiNES.PortQueueing.PortWriteEntry)],ctors:{ctor:function(){this.$initialize();System.Collections.Generic.Queue$1(ChiChiNES.PortQueueing.PortWriteEntry).$ctor2.call(this,256)}}});Bridge.define("ChiChiNES.BaseCart",{inherits:[ChiChiNES.INESCart],fields:{pixelEffects:null,debugging:!1,debugEvents:null,iNesHeader:null,romControlBytes:null,nesCart:null,chrRom:null,current8:0,currentA:0,currentC:0,currentE:0,SRAMCanWrite:!1,SRAMEnabled:!1,SRAMCanSave:!1,prgRomCount:0,chrRomCount:0,mapperId:0,bank8start:0,bankAstart:0,bankCstart:0,bankEstart:0,prgRomBank6:null,_ROMHashfunction:null,chrRomOffset:0,chrRamStart:0,whizzler:null,irqRaised:!1,checkSum:null,mirroring:0,updateIRQ:null,ppuBankStarts:null,bankStartCache:null,currentBank:0,bankSwitchesChanged:!1,nullEffect:null,oneScreenOffset:0},props:{Debugging:{get:function(){return this.debugging},set:function(value){this.debugging=value}},DebugEvents:{get:function(){return this.debugEvents},set:function(value){this.debugEvents=value}},ChrRom:{get:function(){return this.chrRom},set:function(value){this.chrRom=value}},ChrRomCount:{get:function(){return this.chrRomCount}},PrgRomCount:{get:function(){return this.prgRomCount}},ROMHashFunction:{get:function(){return this._ROMHashfunction},set:function(value){this._ROMHashfunction=value}},Whizzler:{get:function(){return this.whizzler},set:function(value){this.whizzler=value}},IrqRaised:{get:function(){return this.irqRaised},set:function(value){this.irqRaised=value}},CheckSum:{get:function(){return this.checkSum}},CPU:{get:function(){throw new System.NotImplementedException;},set:function(){throw new System.NotImplementedException;}},SRAM:{get:function(){return this.prgRomBank6},set:function(value){value!=null&&value.length===this.prgRomBank6.length&&(this.prgRomBank6=value)}},CartName:null,NumberOfPrgRoms:{get:function(){return this.prgRomCount}},NumberOfChrRoms:{get:function(){return this.chrRomCount}},MapperID:{get:function(){return this.mapperId}},Mirroring:{get:function(){return this.mirroring}},NMIHandler:{get:function(){return this.updateIRQ},set:function(value){this.updateIRQ=value}},IRQAsserted:{get:function(){return!1},set:function(){}},NextEventAt:{get:function(){return-1}},PpuBankStarts:{get:function(){return this.ppuBankStarts},set:function(value){this.ppuBankStarts=value}},BankStartCache:{get:function(){return this.bankStartCache}},CurrentBank:{get:function(){return this.currentBank}},BankSwitchesChanged:{get:function(){return this.bankSwitchesChanged},set:function(value){this.bankSwitchesChanged=value}},OneScreenOffset:{get:function(){return this.oneScreenOffset},set:function(value){this.oneScreenOffset=value}},UsesSRAM:!1,ChrRamStart:{get:function(){return this.chrRamStart}},PPUBankStarts:{get:function(){return this.ppuBankStarts},set:function(){throw new System.NotImplementedException;}}},alias:["ChrRom","ChiChiNES$INESCart$ChrRom","ROMHashFunction","ChiChiNES$INESCart$ROMHashFunction","LoadiNESCart","ChiChiNES$INESCart$LoadiNESCart","Whizzler","ChiChiNES$INESCart$Whizzler","UpdateScanlineCounter","ChiChiNES$INESCart$UpdateScanlineCounter","GetByte","ChiChiNES$IClockedMemoryMappedIOElement$GetByte","CheckSum","ChiChiNES$INESCart$CheckSum","WriteState","ChiChiNES$INESCart$WriteState","ReadState","ChiChiNES$INESCart$ReadState","CPU","ChiChiNES$INESCart$CPU","SRAM","ChiChiNES$INESCart$SRAM","CartName","ChiChiNES$INESCart$CartName","NumberOfPrgRoms","ChiChiNES$INESCart$NumberOfPrgRoms","NumberOfChrRoms","ChiChiNES$INESCart$NumberOfChrRoms","MapperID","ChiChiNES$INESCart$MapperID","Mirroring","ChiChiNES$INESCart$Mirroring","NMIHandler","ChiChiNES$IClockedMemoryMappedIOElement$NMIHandler","IRQAsserted","ChiChiNES$IClockedMemoryMappedIOElement$IRQAsserted","NextEventAt","ChiChiNES$IClockedMemoryMappedIOElement$NextEventAt","HandleEvent","ChiChiNES$IClockedMemoryMappedIOElement$HandleEvent","ResetClock","ChiChiNES$IClockedMemoryMappedIOElement$ResetClock","BankStartCache","ChiChiNES$INESCart$BankStartCache","CurrentBank","ChiChiNES$INESCart$CurrentBank","ResetBankStartCache","ChiChiNES$INESCart$ResetBankStartCache","UpdateBankStartCache","ChiChiNES$INESCart$UpdateBankStartCache","BankSwitchesChanged","ChiChiNES$INESCart$BankSwitchesChanged","GetPPUByte","ChiChiNES$INESCart$GetPPUByte","ActualChrRomOffset","ChiChiNES$INESCart$ActualChrRomOffset","SetPPUByte","ChiChiNES$INESCart$SetPPUByte","FetchPixelEffect","ChiChiNES$INESCart$FetchPixelEffect","UsesSRAM","ChiChiNES$INESCart$UsesSRAM","ChrRamStart","ChiChiNES$INESCart$ChrRamStart","PPUBankStarts","ChiChiNES$INESCart$PPUBankStarts"],ctors:{init:function(){this.pixelEffects=new(System.Collections.Generic.Dictionary$2(System.Int32,System.Array.type(System.Byte)));this.debugging=!1;this.debugEvents=new(System.Collections.Generic.List$1(ChiChiNES.CartDebugEvent).ctor);this.iNesHeader=System.Array.init(16,0,System.Byte);this.romControlBytes=System.Array.init(2,0,System.Byte);this.current8=-1;this.currentA=-1;this.currentC=-1;this.currentE=-1;this.prgRomBank6=System.Array.init(8192,0,System.Byte);this.chrRomOffset=0;this.chrRamStart=0;this.mirroring=-1;this.ppuBankStarts=System.Array.init(16,0,System.Int32);this.bankStartCache=System.Array.init(4096,0,System.Int32);this.currentBank=0;this.bankSwitchesChanged=!1;this.nullEffect=System.Array.init([0,0,0,0,0,0,0,0],System.Byte)},ctor:function(){var effect,i,i1;for(this.$initialize(),effect=System.Array.init([1,1,1,1,1,1,1,1],System.Byte),this.pixelEffects.add(3408,effect),this.pixelEffects.add(0,effect),i=21264;i<21696;i=i+1|0)this.pixelEffects.add(i-16400|0,effect);for(i1=0;i1<16;i1=i1+1|0)this.ppuBankStarts[i1]=Bridge.Int.mul(i1,1024)}},methods:{ClearDebugEvents:function(){this.debugEvents.clear()},LoadiNESCart:function(header,prgRoms,chrRoms,prgRomData,chrRomData,chrRomOffset){this.romControlBytes[0]=header[6];this.romControlBytes[1]=header[7];this.mapperId=(this.romControlBytes[0]&240)>>4;this.mapperId=this.mapperId+(this.romControlBytes[1]&240)|0;this.chrRomOffset=chrRomOffset;System.Array.copy(header,0,this.iNesHeader,0,header.length);this.prgRomCount=prgRoms;this.chrRomCount=chrRoms;this.nesCart=System.Array.init(prgRomData.length,0,System.Byte);System.Array.copy(prgRomData,0,this.nesCart,0,prgRomData.length);this.chrRomCount===0&&(chrRomData=System.Array.init(32768,0,System.Byte));this.chrRom=System.Array.init(chrRomData.length+4096|0,0,System.Byte);this.chrRamStart=chrRomData.length;System.Array.copy(chrRomData,0,this.chrRom,0,chrRomData.length);this.prgRomCount=this.iNesHeader[4];this.chrRomCount=this.iNesHeader[5];this.romControlBytes[0]=this.iNesHeader[6];this.romControlBytes[1]=this.iNesHeader[7];this.SRAMCanSave=(this.romControlBytes[0]&2)==2;this.SRAMEnabled=!0;this.UsesSRAM=(this.romControlBytes[0]&2)==2;this.Mirror(0,0);(this.romControlBytes[0]&1)==1?this.Mirror(0,1):this.Mirror(0,2);(this.romControlBytes[0]&8)==8&&this.Mirror(0,3);this.checkSum="";this.InitializeCart()},UpdateScanlineCounter:function(){},GetByte:function(clock,address){var bank=0;switch(address&57344){case 24576:return this.prgRomBank6[address&8191];case 32768:bank=this.bank8start;break;case 40960:bank=this.bankAstart;break;case 49152:bank=this.bankCstart;break;case 57344:bank=this.bankEstart}if((bank+(address&8191)|0)>this.nesCart.length)throw new System.Exception("THis is broken!");return this.nesCart[bank+(address&8191)|0]},SetupBankStarts:function(reg8,regA,regC,regE){reg8=this.MaskBankAddress(reg8);regA=this.MaskBankAddress(regA);regC=this.MaskBankAddress(regC);regE=this.MaskBankAddress(regE);this.current8=reg8;this.currentA=regA;this.currentC=regC;this.currentE=regE;this.bank8start=Bridge.Int.mul(reg8,8192);this.bankAstart=Bridge.Int.mul(regA,8192);this.bankCstart=Bridge.Int.mul(regC,8192);this.bankEstart=Bridge.Int.mul(regE,8192)},MaskBankAddress:function(bank){if(bank>=Bridge.Int.mul(this.prgRomCount,2)){for(var i=255;(bank&i)>=Bridge.Int.mul(this.prgRomCount,2);)i=i>>1;return bank&i}return bank},WriteState:function(state){state.enqueue(this.SRAMCanWrite?1:0);state.enqueue(this.SRAMEnabled?1:0);state.enqueue(this.SRAMCanSave?1:0);state.enqueue(this.prgRomCount);state.enqueue(this.chrRomCount);state.enqueue(this.mapperId);state.enqueue(this.bank8start);state.enqueue(this.bankAstart);state.enqueue(this.bankCstart);state.enqueue(this.bankEstart);for(var i=0;i<8192;i=i+4|0)state.enqueue(this.prgRomBank6[i]<<24|this.prgRomBank6[i+1|0]<<16|this.prgRomBank6[i+2|0]<<8|this.prgRomBank6[i+3|0])},ReadState:function(state){var packedByte,i;for(this.SRAMCanWrite=state.dequeue()===1,this.SRAMEnabled=state.dequeue()===1,this.SRAMCanSave=state.dequeue()===1,this.prgRomCount=state.dequeue(),this.chrRomCount=state.dequeue(),this.mapperId=state.dequeue(),this.bank8start=state.dequeue(),this.bankAstart=state.dequeue(),this.bankCstart=state.dequeue(),this.bankEstart=state.dequeue(),packedByte=0,i=0;i<8192;i=i+4|0)packedByte=state.dequeue(),this.prgRomBank6[i]=packedByte>>24&255,this.prgRomBank6[i+1|0]=packedByte>>16&255,this.prgRomBank6[i+2|0]=packedByte>>8&255,this.prgRomBank6[i+3|0]=packedByte&255},HandleEvent:function(){},ResetClock:function(){},ResetBankStartCache:function(){this.currentBank=0;System.Array.copy(this.ppuBankStarts,0,this.bankStartCache,0,16)},UpdateBankStartCache:function(){return this.currentBank=this.currentBank+1|0,System.Array.copy(this.ppuBankStarts,0,this.bankStartCache,Bridge.Int.mul(this.currentBank,16),16),this.whizzler.ChiChiNES$IPPU$UpdatePixelInfo(),this.currentBank},GetPPUByte:function(clock,address){var bank=Bridge.Int.div(address,1024)|0,newAddress=this.ppuBankStarts[bank]+(address&1023)|0;return this.chrRom[newAddress]},ActualChrRomOffset:function(address){var bank=Bridge.Int.div(address,1024)|0;return this.bankStartCache[Bridge.Int.mul(this.currentBank,16)+bank|0]+(address&1023)|0},SetPPUByte:function(clock,address,data){var bank=Bridge.Int.div(address,1024)|0,newAddress=this.bankStartCache[Bridge.Int.mul(this.currentBank,16)+bank|0]+(address&1023)|0;this.chrRom[newAddress]=data},FetchPixelEffect:function(vramAddress){var bank=Bridge.Int.div(vramAddress,1024)|0,newAddress=this.ppuBankStarts[bank]+(vramAddress&1023)|0;return this.pixelEffects.containsKey(newAddress)?this.pixelEffects.get(newAddress):this.nullEffect},Mirror:function(clockNum,mirroring){var $t;this.debugging&&this.DebugEvents.add(($t=new ChiChiNES.CartDebugEvent,$t.Clock=clockNum,$t.EventType=System.String.format("Mirror set to {0}",mirroring),$t));this.mirroring=mirroring;clockNum>-1&&this.whizzler.ChiChiNES$IPPU$DrawTo(clockNum);switch(mirroring){case 0:this.ppuBankStarts[8]=(this.chrRamStart+0|0)+this.oneScreenOffset|0;this.ppuBankStarts[9]=(this.chrRamStart+0|0)+this.oneScreenOffset|0;this.ppuBankStarts[10]=(this.chrRamStart+0|0)+this.oneScreenOffset|0;this.ppuBankStarts[11]=(this.chrRamStart+0|0)+this.oneScreenOffset|0;break;case 1:this.ppuBankStarts[8]=this.chrRamStart+0|0;this.ppuBankStarts[9]=this.chrRamStart+1024|0;this.ppuBankStarts[10]=this.chrRamStart+0|0;this.ppuBankStarts[11]=this.chrRamStart+1024|0;break;case 2:this.ppuBankStarts[8]=this.chrRamStart+0|0;this.ppuBankStarts[9]=this.chrRamStart+0|0;this.ppuBankStarts[10]=this.chrRamStart+1024|0;this.ppuBankStarts[11]=this.chrRamStart+1024|0;break;case 3:this.ppuBankStarts[8]=this.chrRamStart+0|0;this.ppuBankStarts[9]=this.chrRamStart+1024|0;this.ppuBankStarts[10]=this.chrRamStart+2048|0;this.ppuBankStarts[11]=this.chrRamStart+3072|0}this.UpdateBankStartCache();this.whizzler.ChiChiNES$IPPU$UpdatePixelInfo()}}});Bridge.define("ChiChiNES.CPU.NESCart",{inherits:[ChiChiNES.BaseCart],fields:{prgRomBank6$1:null,prevBSSrc:null},alias:["InitializeCart","ChiChiNES$INESCart$InitializeCart","SetByte","ChiChiNES$IClockedMemoryMappedIOElement$SetByte"],ctors:{init:function(){this.prgRomBank6$1=System.Array.init(2048,0,System.Byte);this.prevBSSrc=System.Array.init(8,0,System.Int32)}},methods:{InitializeCart:function(){for(var i=0;i<8;i=i+1|0)this.prevBSSrc[i]=-1;switch(this.mapperId){case 0:case 1:case 2:case 3:this.ChrRomCount>0&&this.CopyBanks(0,0,0,1);this.SetupBankStarts(0,1,Bridge.Int.mul(this.PrgRomCount,2)-2|0,Bridge.Int.mul(this.PrgRomCount,2)-1|0);break;case 7:this.SetupBankStarts(0,1,2,3);this.Mirror(0,0);break;default:throw new System.NotImplementedException("Mapper "+(this.mapperId.toString()||"")+" not implemented.");}},CopyBanks:function(clock,dest,src,numberOf8kBanks){var oneKsrc,oneKdest,i;for(dest>=this.ChrRomCount&&(dest=this.ChrRomCount-1|0),oneKsrc=Bridge.Int.mul(src,8),oneKdest=Bridge.Int.mul(dest,8),i=0;i<Bridge.Int.mul(numberOf8kBanks,8);i=i+1|0)this.ppuBankStarts[oneKdest+i|0]=Bridge.Int.mul(oneKsrc+i|0,1024);this.UpdateBankStartCache()},SetByte:function(clock,address,val){var newbank8,newbank81;if(address>=24576&&address<=32767){this.SRAMEnabled&&(this.prgRomBank6$1[address&8191]=val&255);return}this.mapperId===7&&(newbank8=0,newbank8=Bridge.Int.mul(4,val&15),this.SetupBankStarts(newbank8,newbank8+1|0,newbank8+2|0,newbank8+3|0),this.OneScreenOffset=(val&16)==16?1024:0,this.Mirror(clock,0));this.mapperId===3&&address>=32768&&this.CopyBanks(clock,0,val,1);this.mapperId===2&&address>=32768&&(newbank81=0,newbank81=Bridge.Int.mul(val,2),this.SetupBankStarts(newbank81,newbank81+1|0,this.currentC,this.currentE))}}});Bridge.define("ChiChiNES.NesCartMMC1",{inherits:[ChiChiNES.BaseCart],fields:{sequence:0,accumulator:0,bank_select:0,_registers:null,lastwriteAddress:0,lastClock:0},alias:["InitializeCart","ChiChiNES$INESCart$InitializeCart","SetByte","ChiChiNES$IClockedMemoryMappedIOElement$SetByte"],ctors:{init:function(){this.sequence=0;this.accumulator=0;this.bank_select=0;this._registers=System.Array.init(4,0,System.Int32);this.lastwriteAddress=0}},methods:{InitializeCart:function(){this.ChrRomCount>0&&this.CopyBanks(0,0,4);this._registers[0]=12;this._registers[1]=0;this._registers[2]=0;this._registers[3]=0;this.SetupBankStarts(0,1,Bridge.Int.mul(this.PrgRomCount,2)-2|0,Bridge.Int.mul(this.PrgRomCount,2)-1|0);this.sequence=0;this.accumulator=0},MaskBankAddress$1:function(bank){if(bank>=Bridge.Int.mul(this.PrgRomCount,2)){for(var i=255;(bank&i)>=Bridge.Int.mul(this.PrgRomCount,2);)i=Bridge.Int.div(i,2)|0;return bank&i}return bank},CopyBanks:function(dest,src,numberOf4kBanks){var oneKdest,oneKsrc,i;if(this.ChrRomCount>0)for(oneKdest=Bridge.Int.mul(dest,4),oneKsrc=Bridge.Int.mul(src,4),i=0;i<Bridge.Int.mul(numberOf4kBanks,4);i=i+1|0)this.ppuBankStarts[oneKdest+i|0]=Bridge.Int.mul(oneKsrc+i|0,1024);this.UpdateBankStartCache()},SetByte:function(clock,address,val){this.lastClock=clock;switch(address&61440){case 24576:case 28672:this.prgRomBank6[address&8191]=val&255;break;default:if(this.lastwriteAddress=address,(val&128)==128?(this._registers[0]=this._registers[0]|12,this.accumulator=0,this.sequence=0):((val&1)==1&&(this.accumulator=this.accumulator|1<<this.sequence),this.sequence=this.sequence+1|0),this.sequence===5){var regnum=(address&32767)>>13;this._registers[(address&32767)>>13]=this.accumulator;this.sequence=0;this.accumulator=0;switch(regnum){case 0:this.SetMMC1Mirroring(clock);break;case 1:case 2:this.SetMMC1ChrBanking(clock);break;case 3:this.SetMMC1PrgBanking()}}}},SetMMC1ChrBanking:function(clock){this.whizzler.ChiChiNES$IPPU$DrawTo(clock);(this._registers[0]&16)==16?(this.CopyBanks(0,this._registers[1],1),this.CopyBanks(1,this._registers[2],1)):(this.CopyBanks(0,this._registers[1],1),this.CopyBanks(1,this._registers[1]+1|0,1));this.BankSwitchesChanged=!0;this.whizzler.ChiChiNES$IPPU$UpdatePixelInfo()},SetMMC1PrgBanking:function(){var reg;this.bank_select=this.PrgRomCount===32?(this._registers[1]&16)<<1:0;(this._registers[0]&8)==0?(reg=Bridge.Int.mul(4,this._registers[3]>>1&15)+this.bank_select|0,this.SetupBankStarts(reg,reg+1|0,reg+2|0,reg+3|0)):(reg=Bridge.Int.mul(2,this._registers[3])+this.bank_select|0,(this._registers[0]&4)==4?this.SetupBankStarts(reg,reg+1|0,Bridge.Int.mul(this.PrgRomCount,2)-2|0,Bridge.Int.mul(this.PrgRomCount,2)-1|0):this.SetupBankStarts(0,1,reg,reg+1|0))},SetMMC1Mirroring:function(clock){this.whizzler.ChiChiNES$IPPU$DrawTo(clock);switch(this._registers[0]&3){case 0:this.OneScreenOffset=0;this.Mirror(clock,0);break;case 1:this.OneScreenOffset=1024;this.Mirror(clock,0);break;case 2:this.Mirror(clock,1);break;case 3:this.Mirror(clock,2)}this.BankSwitchesChanged=!0;this.whizzler.ChiChiNES$IPPU$UpdatePixelInfo()}}});Bridge.define("ChiChiNES.NesCartMMC3",{inherits:[ChiChiNES.BaseCart],fields:{_registers:null,chr2kBank0:0,chr2kBank1:0,chr1kBank0:0,chr1kBank1:0,chr1kBank2:0,chr1kBank3:0,prgSwap:0,prgSwitch1:0,prgSwitch2:0,prevBSSrc:null,_mmc3Command:0,_mmc3ChrAddr:0,_mmc3IrqVal:0,_mmc3TmpVal:0,scanlineCounter:0,_mmc3IrcOn:!1,ppuBankSwap:!1,PPUBanks:null},props:{IRQAsserted:{get:function(){return this.irqRaised},set:function(value){this.irqRaised=value}}},alias:["InitializeCart","ChiChiNES$INESCart$InitializeCart","IRQAsserted","ChiChiNES$IClockedMemoryMappedIOElement$IRQAsserted","SetByte","ChiChiNES$IClockedMemoryMappedIOElement$SetByte","UpdateScanlineCounter","ChiChiNES$INESCart$UpdateScanlineCounter"],ctors:{init:function(){this._registers=System.Array.init(4,0,System.Int32);this.chr2kBank0=0;this.chr2kBank1=1;this.chr1kBank0=0;this.chr1kBank1=0;this.chr1kBank2=0;this.chr1kBank3=0;this.prgSwap=0;this.prgSwitch1=0;this.prgSwitch2=0;this.prevBSSrc=System.Array.init(8,0,System.Int32);this._mmc3Command=0;this._mmc3ChrAddr=0;this._mmc3IrqVal=0;this._mmc3TmpVal=0;this.scanlineCounter=0;this._mmc3IrcOn=!1;this.ppuBankSwap=!1;this.PPUBanks=System.Array.init(8,0,System.Int32)}},methods:{InitializeCart:function(){this.prgSwap=1;this.prgSwitch1=0;this.prgSwitch2=1;this.SwapPrgRomBanks();this._mmc3IrqVal=0;this._mmc3IrcOn=!1;this._mmc3TmpVal=0;this.chr2kBank0=0;this.chr2kBank1=0;this.chr1kBank0=0;this.chr1kBank1=0;this.chr1kBank2=0;this.chr1kBank3=0;this.ChrRomCount>0&&this.CopyBanks(0,0,8)},MaskBankAddress:function(bank){if(bank>=Bridge.Int.mul(this.PrgRomCount,2)){for(var i=255;(bank&i)>=Bridge.Int.mul(this.PrgRomCount,2);)i=i>>1;return bank&i}return bank},CopyBanks:function(dest,src,numberOf1kBanks){var $t,i;if(this.ChrRomCount>0){for(i=0;i<numberOf1kBanks;i=i+1|0)($t=this.PpuBankStarts)[dest+i|0]=Bridge.Int.mul(src+i|0,1024);this.BankSwitchesChanged=!0}},SetByte:function(clock,address,val){if(address>=24576&&address<32768){this.SRAMEnabled&&this.SRAMCanWrite&&(this.prgRomBank6[address&8191]=val&255);return}switch(address&57345){case 32768:this._mmc3Command=val&7;(val&128)==128?(this.ppuBankSwap=!0,this._mmc3ChrAddr=4096):(this.ppuBankSwap=!1,this._mmc3ChrAddr=0);this.prgSwap=(val&64)==64?1:0;this.SwapPrgRomBanks();break;case 32769:switch(this._mmc3Command){case 0:this.chr2kBank0=val;this.SwapChrBanks();break;case 1:this.chr2kBank1=val;this.SwapChrBanks();break;case 2:this.chr1kBank0=val;this.SwapChrBanks();break;case 3:this.chr1kBank1=val;this.SwapChrBanks();break;case 4:this.chr1kBank2=val;this.SwapChrBanks();break;case 5:this.chr1kBank3=val;this.SwapChrBanks();break;case 6:this.prgSwitch1=val;this.SwapPrgRomBanks();break;case 7:this.prgSwitch2=val;this.SwapPrgRomBanks()}break;case 40960:(val&1)==1?this.Mirror(clock,2):this.Mirror(clock,1);break;case 40961:this.SRAMCanWrite=(val&64)==0;this.SRAMEnabled=(val&128)==128;break;case 49152:this._mmc3IrqVal=val;val===0&&(this.scanlineCounter=0);break;case 49153:this._mmc3TmpVal=this._mmc3IrqVal;break;case 57344:this._mmc3IrcOn=!1;this._mmc3IrqVal=this._mmc3TmpVal;this.irqRaised=!1;Bridge.staticEquals(this.updateIRQ,null)||this.updateIRQ();break;case 57345:this._mmc3IrcOn=!0}},SwapChrBanks:function(){this.ppuBankSwap?(this.CopyBanks(0,this.chr1kBank0,1),this.CopyBanks(1,this.chr1kBank1,1),this.CopyBanks(2,this.chr1kBank2,1),this.CopyBanks(3,this.chr1kBank3,1),this.CopyBanks(4,this.chr2kBank0,2),this.CopyBanks(6,this.chr2kBank1,2)):(this.CopyBanks(4,this.chr1kBank0,1),this.CopyBanks(5,this.chr1kBank1,1),this.CopyBanks(6,this.chr1kBank2,1),this.CopyBanks(7,this.chr1kBank3,1),this.CopyBanks(0,this.chr2kBank0,2),this.CopyBanks(2,this.chr2kBank1,2))},SwapPrgRomBanks:function(){this.prgSwap===1?this.SetupBankStarts(Bridge.Int.mul(this.PrgRomCount,2)-2|0,this.prgSwitch2,this.prgSwitch1,Bridge.Int.mul(this.PrgRomCount,2)-1|0):this.SetupBankStarts(this.prgSwitch1,this.prgSwitch2,Bridge.Int.mul(this.PrgRomCount,2)-2|0,Bridge.Int.mul(this.PrgRomCount,2)-1|0)},UpdateScanlineCounter:function(){if(this.scanlineCounter===0&&(this.scanlineCounter=this._mmc3IrqVal,this._mmc3IrqVal===0)){this._mmc3IrcOn&&(this.irqRaised=!0,this.updateIRQ());this.scanlineCounter=-1;return}this._mmc3TmpVal!==0?(this.scanlineCounter=this._mmc3TmpVal,this._mmc3TmpVal=0):this.scanlineCounter=(this.scanlineCounter-1|0)&255;this.scanlineCounter===0&&(this._mmc3IrcOn&&(this.irqRaised=!0,Bridge.staticEquals(this.updateIRQ,null)||this.updateIRQ()),this._mmc3IrqVal>0&&(this.scanlineCounter=this._mmc3IrqVal))}}})});