!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["emulator.worker"]=e():t["emulator.worker"]=e()}(this,function(){return function(t){function e(i){if(s[i])return s[i].exports;var r=s[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var s={};return e.m=t,e.c=s,e.d=function(t,s,i){e.o(t,s)||Object.defineProperty(t,s,{configurable:!1,enumerable:!0,get:i})},e.n=function(t){var s=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(s,"a",s),s},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=0)}([function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=s(1),r=function(){return function(){this.bufferupdate=!1,this.stateupdate=!0,this.runStatus={},this.cartInfo={},this.sound={},this.Cpu={},this.Cart={},this.debug={currentCpuStatus:{PC:0,A:0,X:0,Y:0,SP:0,SR:0},currentPPUStatus:{}}}}(),n=function(){function t(){this.framesRendered=0,this.startTime=0,this.runTimeout=0,this.Debugging=!1,this.frameFinished=!1,this.ready=!1,this.framesPerSecond=0,this.iops=new Array(16),this.cartName="unk",this.sharedAudioBufferPos=0,this.machine=new i.ChiChiMachine}return t.prototype.createMachine=function(){var t=this;this.machine=new i.ChiChiMachine,this.machine.Drawscreen=function(){},this.ready=!0,this.machine.Cpu.FireDebugEvent=function(){var e=new r;e.debug={currentCpuStatus:t.machine.Cpu.GetStatus?t.machine.Cpu.GetStatus():{PC:0,A:0,X:0,Y:0,SP:0,SR:0},currentPPUStatus:t.machine.Cpu.GetPPUStatus?t.machine.Cpu.GetPPUStatus():{},InstructionHistory:{Buffer:t.machine.Cpu.InstructionHistory.slice(0),Index:t.machine.Cpu.InstructionHistoryPointer,Finish:!1}},postMessage(e)},this.machine.Cpu.Debugging=!1},t.prototype.updateBuffers=function(){this.machine;var t=new r;t.bufferupdate=!0,t.stateupdate=!1,this.machine&&this.machine.Cart&&(t.Cpu={Rams:this.machine.Cpu.Rams,spriteRAM:this.machine.Cpu.spriteRAM},t.Cart={chrRom:this.machine.Cart.chrRom,prgRomBank6:this.machine.Cart.prgRomBank6,ppuBankStarts:this.machine.Cart.ppuBankStarts,bankStartCache:this.machine.Cart.bankStartCache}),postMessage(t)},t.prototype.updateState=function(){var t=this.machine,e=new r;this.machine&&this.machine.Cart&&(e.Cpu={status:this.machine.Cpu.GetStatus(),ppuStatus:this.machine.Cpu.GetPPUStatus(),backgroundPatternTableIndex:this.machine.Cpu.backgroundPatternTableIndex,_PPUControlByte0:this.machine.Cpu._PPUControlByte0,_PPUControlByte1:this.machine.Cpu._PPUControlByte1},e.cartInfo={mapperId:this.machine.Cart.MapperID,name:this.cartName,prgRomCount:this.machine.Cart.NumberOfPrgRoms,chrRomCount:this.machine.Cart.NumberOfChrRoms},e.Cart={CurrentBank:this.machine.Cart.CurrentBank,current8:this.machine.Cart.current8,currentA:this.machine.Cart.currentA,currentC:this.machine.Cart.currentC,currentE:this.machine.Cart.currentE,bank8start:this.machine.Cart.bank8start,bankAstart:this.machine.Cart.bankAstart,bankCstart:this.machine.Cart.bankCstart,bankEstart:this.machine.Cart.bankEstart}),t&&(e.sound={soundEnabled:t.EnableSound,settings:t.SoundBopper.audioSettings},this.machine.Cpu.Debugging&&(e.debug={currentCpuStatus:this.machine.Cpu.GetStatus?this.machine.Cpu.GetStatus():{PC:0,A:0,X:0,Y:0,SP:0,SR:0},currentPPUStatus:this.machine.Cpu.GetPPUStatus?this.machine.Cpu.GetPPUStatus():{},InstructionHistory:{Buffer:this.machine.Cpu.InstructionHistory.slice(0),Index:this.machine.Cpu.InstructionHistoryPointer,Finish:!0}})),postMessage(e)},t.prototype.drawScreen=function(){},t.prototype.stop=function(){clearInterval(this.interval),this.machine.PowerOff(),this.runStatus=this.machine.RunState},t.prototype.flushAudio=function(){for(var t=this.machine.WaveForms.SharedBufferLength/2,e=0;e<t;++e){if(this.sharedAudioBufferPos+e>this.sharedAudioBuffer.length)return this.sharedAudioBufferPos=0,void(this.iops[0]=0);this.sharedAudioBuffer[this.sharedAudioBufferPos+e]=this.machine.WaveForms.SharedBuffer[e]}this.sharedAudioBufferPos+=t},t.prototype.runInnerLoop=function(){this.machine.RunFrame(),this.machine.PadOne.padOneState=255&this.iops[2],this.machine.PadTwo.padOneState=this.iops[2]>>8&255,this.framesPerSecond=0,this.flushAudio(),60==this.framesRendered++&&(this.updateState(),this.framesPerSecond=this.framesRendered/((new Date).getTime()-this.startTime)*1e3,this.framesRendered=0,this.startTime=(new Date).getTime(),this.iops[1]=this.framesPerSecond,this.framesPerSecond<60&&this.runTimeout>0?this.runTimeout--:this.runTimeout<50&&this.runTimeout++),0===this.iops[0]&&(this.runStatus=i.RunningStatuses.Paused)},t.prototype.run=function(t){var e=this,s=this.machine;t&&s.Reset(),s.Cpu.Debugging=!1,this.startTime=(new Date).getTime(),clearInterval(this.interval),this.interval=setInterval(function(){e.runInnerLoop()},16),this.runStatus=s.RunState},t.prototype.runFrame=function(){clearInterval(this.interval),this.frameFinished=!1;var t=this.machine;t.Cpu.Debugging=this.Debugging,t.RunFrame(),this.runStatus=this.machine.RunState,this.frameFinished=!0},t.prototype.reset=function(){var t=this.machine;t.Cpu.Debugging=this.Debugging,t.Reset(),this.runStatus=this.machine.RunState},t.prototype.step=function(){clearInterval(this.interval);var t=this.machine;t.Cpu.Debugging=this.Debugging,t.Step(),this.runStatus=this.machine.RunState},t.prototype.handleMessage=function(t){this.machine;switch(t.data.command){case"create":this.createMachine(),this.machine.Cpu.byteOutBuffer=t.data.vbuffer,this.sharedAudioBuffer=t.data.abuffer,this.sharedAudioBufferPos=0,this.iops=t.data.iops;break;case"loadrom":this.stop(),this.machine.EnableSound=!1,this.machine.LoadCart(t.data.rom),this.updateBuffers();break;case"loadnsf":this.stop(),this.updateBuffers();break;case"audiosettings":this.machine.SoundBopper.audioSettings=t.data.settings;break;case"mute":this.machine.EnableSound=!1;break;case"unmute":this.machine.EnableSound=!0;break;case"run":this.Debugging=!1,this.run(!0);break;case"runframe":this.Debugging=!0,this.runFrame();break;case"step":this.Debugging=!0,this.step();break;case"continue":this.run(!1);break;case"stop":this.machine.EnableSound=!1,this.stop();break;case"reset":this.reset();break;default:return}this.updateState()},t}();e.tendoWrapper=n},function(t,e){t.exports=function(t){function e(i){if(s[i])return s[i].exports;var r=s[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var s={};return e.m=t,e.c=s,e.d=function(t,s,i){e.o(t,s)||Object.defineProperty(t,s,{configurable:!1,enumerable:!0,get:i})},e.n=function(t){var s=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(s,"a",s),s},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=5)}([function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});!function(t){t[t.Unloaded=0]="Unloaded",t[t.Off=1]="Off",t[t.Running=2]="Running",t[t.Frozen=3]="Frozen",t[t.Paused=4]="Paused"}(e.RunningStatuses||(e.RunningStatuses={}));!function(t){t[t.Bullshit=0]="Bullshit",t[t.Implicit=1]="Implicit",t[t.Accumulator=2]="Accumulator",t[t.Immediate=3]="Immediate",t[t.ZeroPage=4]="ZeroPage",t[t.ZeroPageX=5]="ZeroPageX",t[t.ZeroPageY=6]="ZeroPageY",t[t.Relative=7]="Relative",t[t.Absolute=8]="Absolute",t[t.AbsoluteX=9]="AbsoluteX",t[t.AbsoluteY=10]="AbsoluteY",t[t.Indirect=11]="Indirect",t[t.IndexedIndirect=12]="IndexedIndirect",t[t.IndirectIndexed=13]="IndirectIndexed",t[t.IndirectZeroPage=14]="IndirectZeroPage",t[t.IndirectAbsoluteX=15]="IndirectAbsoluteX"}(e.ChiChiCPPU_AddressingModes||(e.ChiChiCPPU_AddressingModes={}));var i=function(){return function(){this.PC=0,this.A=0,this.X=0,this.Y=0,this.SP=0,this.SR=0}}();e.CpuStatus=i;var r=function(){return function(){this.status=0,this.controlByte0=0,this.controlByte1=0,this.nameTableStart=0,this.currentTile=0,this.lockedVScroll=0,this.lockedHScroll=0,this.X=0,this.Y=0}}();e.PpuStatus=r;var n=function(){return function(){this.AddressingMode=0,this.frame=0,this.time=0,this.A=0,this.X=0,this.Y=0,this.SR=0,this.SP=0,this.Address=0,this.OpCode=0,this.Parameters0=0,this.Parameters1=0,this.ExtraTiming=0,this.Length=0}}();e.ChiChiInstruction=n;var a=function(){return function(){this.YPosition=0,this.XPosition=0,this.SpriteNumber=0,this.Foreground=!1,this.IsVisible=!1,this.TileIndex=0,this.AttributeByte=0,this.FlipX=!1,this.FlipY=!1,this.Changed=!1}}();e.ChiChiSprite=a;var h=function(){return function(){this.sampleRate=44100,this.master_volume=0,this.enableSquare0=!0,this.enableSquare1=!0,this.enableTriangle=!0,this.enableNoise=!0,this.enablePCM=!0}}();e.AudioSettings=h},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=s(2),r=s(3),n=s(0),a=s(4),h=function(){function t(){}return t.LoadROM=function(t,e){var s=null,r=e.slice(0,16),n=240&r[6];n=(n>>=4)+r[7]|0;var a=r[4],h=r[5],o=16384*a,u=16384*h,c=new Uint8Array(o);c.fill(0);var p=new Uint8Array(u);p.fill(0);var l=0;i.BaseCart.arrayCopy(e,16,c,0,c.length),l=16+c.length|0;var d=p.length;switch((l+p.length|0)>e.length&&(d=e.length-l|0),i.BaseCart.arrayCopy(e,l,p,0,d),n){case 0:case 2:case 3:case 7:s=new i.NesCart;break;case 1:s=new i.MMC1Cart;break;case 4:s=new i.MMC3Cart}return null!=s&&(s.Whizzler=s.CPU=t,t.ChrRomHandler=s,s.ROMHashFunction=null,s.LoadiNESCart(r,a,h,c,p,l)),s},t.LoadNSF=function(t,e){var s=null,r=e.slice(0,128),n=240&r[6];n=(n>>=4)+r[7]|0;var a=e.length-128,h=new Array(a);h.fill(0);var o=new Array(0);o.fill(0);return i.BaseCart.arrayCopy(e,128,h,0,h.length),null!=(s=new i.NsfCart)&&(s.Whizzler=s.CPU=t,t.ChrRomHandler=s,s.ROMHashFunction=null,s.LoadNSFFile(r,1,0,h,o,0)),s},t}();e.iNESFileHandler=h;var o=function(){function t(t){var e=this;this.frameJustEnded=!0,this.frameOn=!1,this.totalCPUClocks=0,this._enableSound=!1;var s=new r.WavSharer;this.SoundBopper=new r.ChiChiBopper(s),this.WaveForms=s,this.Cpu=t||new u(this.SoundBopper),this.Cpu.frameFinished=function(){e.FrameFinished()}}return t.prototype.Drawscreen=function(){},Object.defineProperty(t.prototype,"Cart",{get:function(){return this.Cpu.Cart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"EnableSound",{get:function(){return this._enableSound},set:function(t){this.SoundBopper.Muted=!t,this._enableSound=t,this._enableSound&&this.SoundBopper.RebuildSound()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"PadOne",{get:function(){return this.Cpu.PadOne.ControlPad},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"PadTwo",{get:function(){return this.Cpu.PadTwo.ControlPad},enumerable:!0,configurable:!0}),t.prototype.Reset=function(){null!=this.Cpu&&null!=this.Cart&&(this.SoundBopper.RebuildSound(),this.Cpu.PPU_Initialize(),this.Cart.InitializeCart(),this.Cpu.ResetCPU(),this.Cpu.PowerOn(),this.RunState=n.RunningStatuses.Running)},t.prototype.PowerOn=function(){null!=this.Cpu&&null!=this.Cart&&(this.Cpu.PPU_Initialize(),this.Cart.InitializeCart(),this.Cpu.ResetCPU(),this.Cpu.PowerOn(),this.SoundBopper.RebuildSound(),this.RunState=n.RunningStatuses.Running)},t.prototype.PowerOff=function(){this.RunState=n.RunningStatuses.Off},t.prototype.Step=function(){this.frameJustEnded&&(this.Cpu.FindNextEvent(),this.frameOn=!0,this.frameJustEnded=!1),this.Cpu.Step(),this.frameOn||(this.totalCPUClocks=this.Cpu.Clock,this.totalCPUClocks=0,this.Cpu.Clock=0,this.Cpu.LastcpuClock=0,this.frameJustEnded=!0)},t.prototype.RunFrame=function(){this.frameOn=!0,this.frameJustEnded=!1,this.Cpu.FindNextEvent();do{this.Cpu.Step()}while(this.frameOn);this.totalCPUClocks=this.Cpu.Clock,this.SoundBopper.FlushFrame(this.totalCPUClocks),this.SoundBopper.EndFrame(this.totalCPUClocks),this.totalCPUClocks=0,this.Cpu.Clock=0,this.Cpu.LastcpuClock=0},t.prototype.EjectCart=function(){this.Cpu.Cart=null,this.Cpu.ChrRomHandler=null},t.prototype.LoadNSF=function(t){var e=this;this.EjectCart();var s=h.LoadNSF(this.Cpu,t);if(null==s)throw new Error("Unsupported ROM type - load failed.");this.Cpu.Cart=s,this.Cpu.Cart.NMIHandler=function(){e.Cpu.InterruptRequest()},this.Cpu.ChrRomHandler=this.Cart},t.prototype.LoadCart=function(t){var e=this;this.EjectCart();var s=h.LoadROM(this.Cpu,t);if(null==s)throw new Error("Unsupported ROM type - load failed.");this.Cpu.Cart=s,this.Cpu.Cart.NMIHandler=function(){e.Cpu.InterruptRequest()},this.Cpu.ChrRomHandler=this.Cart},t.prototype.HasState=function(t){throw new Error("Method not implemented.")},t.prototype.GetState=function(t){throw new Error("Method not implemented.")},t.prototype.SetState=function(t){throw new Error("Method not implemented.")},t.prototype.SetupSound=function(){throw new Error("Method not implemented.")},t.prototype.FrameFinished=function(){this.frameJustEnded=!0,this.frameOn=!1,this.Drawscreen()},t.prototype.dispose=function(){},t}();e.ChiChiMachine=o;var u=function(){function t(t){this.SRMasks_CarryMask=1,this.SRMasks_ZeroResultMask=2,this.SRMasks_InterruptDisableMask=4,this.SRMasks_DecimalModeMask=8,this.SRMasks_BreakCommandMask=16,this.SRMasks_ExpansionMask=32,this.SRMasks_OverflowMask=64,this.SRMasks_NegativeResultMask=128,this.vbufLocation=0,this.yPosition=0,this.xPosition=0,this.currentAttributeByte=0,this.spriteSize=0,this.spritesOnThisScanline=0,this.spriteZeroHit=!1,this.isForegroundPixel=!1,this._spriteCopyHasHappened=!1,this.LastcpuClock=0,this.spriteChanges=!1,this.ppuReadBuffer=0,this._clipSprites=!1,this._clipTiles=!1,this._tilesAreVisible=!1,this._spritesAreVisible=!1,this.nameTableMemoryStart=0,this._reset=!1,this.clock=0,this._ticks=0,this._statusRegister=0,this._programCounter=0,this._handleNMI=!1,this._handleIRQ=!1,this._addressBus=0,this._dataBus=0,this._operationCounter=0,this._accumulator=0,this._indexRegisterX=0,this._indexRegisterY=0,this._currentInstruction_AddressingMode=n.ChiChiCPPU_AddressingModes.Bullshit,this._currentInstruction_Address=0,this._currentInstruction_OpCode=0,this._currentInstruction_Parameters0=0,this._currentInstruction_Parameters1=0,this._currentInstruction_ExtraTiming=0,this.systemClock=0,this.nextEvent=-1,this._cheating=!1,this.__frameFinished=!0,this._ramsBuffer=new SharedArrayBuffer(8192*Uint8Array.BYTES_PER_ELEMENT),this.Rams=new Uint8Array(this._ramsBuffer),this._stackPointer=255,this.instructionUsage=new Uint32Array(256),this._debugging=!1,this.instructionHistoryPointer=255,this._instructionHistory=new Array(256),this.backgroundPatternTableIndex=0,this._PPUAddress=0,this._PPUStatus=0,this._PPUControlByte0=0,this._PPUControlByte1=0,this._spriteAddress=0,this.currentXPosition=0,this.currentYPosition=0,this._hScroll=0,this._vScroll=0,this.lockedHScroll=0,this.lockedVScroll=0,this.shouldRender=!1,this._frames=0,this.hitSprite=!1,this.PPUAddressLatchIsHigh=!0,this.p32=new Uint32Array(256),this.isRendering=!0,this.frameClock=0,this.FrameEnded=!1,this.frameOn=!1,this.nameTableBits=0,this.vidRamIsRam=!0,this._palette=new Uint8Array(32),this._openBus=0,this.sprite0scanline=0,this.sprite0x=0,this._maxSpritesPerScanline=64,this.xNTXor=0,this.yNTXor=0,this.spriteRAMBuffer=new SharedArrayBuffer(256*Uint8Array.BYTES_PER_ELEMENT),this.spriteRAM=new Uint8Array(this.spriteRAMBuffer),this.spritesOnLine=new Array(512),this.currentTileIndex=0,this.fetchTile=!0,this.patternEntry=0,this.patternEntryByte2=0,this.outBuffer=new Uint8Array(65536),this.byteOutBuffer=new Uint8Array(262144),this.SoundBopper=t,t.NMIHandler=this.IRQUpdater,this.PPU_InitSprites(),this._padOne=new a.ChiChiInputHandler,this._padTwo=new a.ChiChiInputHandler;for(var e=0;e<this._instructionHistory.length;++e)this._instructionHistory[e]=new n.ChiChiInstruction}return Object.defineProperty(t.prototype,"PatternTableIndex",{get:function(){return this.backgroundPatternTableIndex},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"SpritePatternTableIndex",{get:function(){var t=0;return 32==(32&this._PPUControlByte0)&&(t=4096),t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Debugging",{get:function(){return this._debugging},set:function(t){this._debugging=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"InstructionHistory",{get:function(){return this._instructionHistory},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"InstructionHistoryPointer",{get:function(){return this.instructionHistoryPointer},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"PadOne",{get:function(){return this._padOne},set:function(t){this._padOne=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"PadTwo",{get:function(){return this._padTwo},set:function(t){this._padTwo=t},enumerable:!0,configurable:!0}),t.prototype.addDebugEvent=function(t){},t.prototype.removeDebugEvent=function(t){},Object.defineProperty(t.prototype,"PPU_NameTableMemoryStart",{get:function(){return this.nameTableMemoryStart},set:function(t){this.nameTableMemoryStart=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Clock",{get:function(){return this.clock},set:function(t){this.clock=t,0===t&&(this.systemClock=this.systemClock+this.clock&0xffffffffff)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ChrRomHandler",{get:function(){return this.chrRomHandler},set:function(t){this.chrRomHandler=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"PPU_NextEventAt",{get:function(){return this.frameClock<6820?(6820-this.frameClock)/3:(89345-this.frameClock)/341/3},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"PPU_FrameFinishHandler",{get:function(){return this.frameFinished},set:function(t){this.frameFinished=t},enumerable:!0,configurable:!0}),t.prototype.SetFlag=function(t,e){this._statusRegister=e?this._statusRegister|t:this._statusRegister&~t,this._statusRegister|=32},t.prototype.GetFlag=function(t){return(this._statusRegister&t)===t},t.prototype.InterruptRequest=function(){if(!this.GetFlag(this.SRMasks_InterruptDisableMask)){this.SetFlag(this.SRMasks_InterruptDisableMask,!0);this._statusRegister;this.PushStack(this._programCounter>>8),this.PushStack(this._programCounter),this.PushStack(this._statusRegister),this._programCounter=this.GetByte(65534)+(this.GetByte(65535)<<8)}},t.prototype.NonMaskableInterrupt=function(){var t=-17&this._statusRegister|32;this.SetFlag(this.SRMasks_InterruptDisableMask,!0),this.PushStack(this._programCounter>>8),this.PushStack(255&this._programCounter),this.PushStack(t);var e=this.GetByte(65530)|this.GetByte(65531)<<8;this._programCounter=e},t.prototype.CheckEvent=function(){-1===this.nextEvent&&this.FindNextEvent()},t.prototype.RunFast=function(){for(;this.clock<29780;)this.Step()},t.prototype.Step=function(){if(this._currentInstruction_ExtraTiming=0,this.nextEvent<=this.clock&&this.HandleNextEvent(),this._handleNMI){this._handleNMI=!1,this.clock+=7;var e=-17&this._statusRegister|32;this.SetFlag(this.SRMasks_InterruptDisableMask,!0),this.PushStack(this._programCounter>>8),this.PushStack(255&this._programCounter),this.PushStack(e);var s=this.GetByte(65530)|this.GetByte(65531)<<8;this._programCounter=s}else if(this._handleIRQ&&(this._handleIRQ=!1,this.clock+=7,!this.GetFlag(this.SRMasks_InterruptDisableMask))){this.SetFlag(this.SRMasks_InterruptDisableMask,!0);this._statusRegister;this.PushStack(this._programCounter>>8),this.PushStack(this._programCounter),this.PushStack(this._statusRegister),this._programCounter=this.GetByte(65534)+(this.GetByte(65535)<<8)}switch(this._currentInstruction_Address=this._programCounter,this._currentInstruction_OpCode=this.GetByte(this._programCounter++),this._currentInstruction_AddressingMode=t.addressModes[this._currentInstruction_OpCode],this._currentInstruction_AddressingMode){case n.ChiChiCPPU_AddressingModes.Absolute:case n.ChiChiCPPU_AddressingModes.AbsoluteX:case n.ChiChiCPPU_AddressingModes.AbsoluteY:case n.ChiChiCPPU_AddressingModes.Indirect:this._currentInstruction_Parameters0=this.GetByte(this._programCounter++),this._currentInstruction_Parameters1=this.GetByte(this._programCounter++);break;case n.ChiChiCPPU_AddressingModes.ZeroPage:case n.ChiChiCPPU_AddressingModes.ZeroPageX:case n.ChiChiCPPU_AddressingModes.ZeroPageY:case n.ChiChiCPPU_AddressingModes.Relative:case n.ChiChiCPPU_AddressingModes.IndexedIndirect:case n.ChiChiCPPU_AddressingModes.IndirectIndexed:case n.ChiChiCPPU_AddressingModes.IndirectZeroPage:case n.ChiChiCPPU_AddressingModes.Immediate:this._currentInstruction_Parameters0=this.GetByte(this._programCounter++);break;case n.ChiChiCPPU_AddressingModes.Accumulator:case n.ChiChiCPPU_AddressingModes.Implicit:}this.Execute(),this._debugging&&(this.WriteInstructionHistoryAndUsage(),this._operationCounter++),this.clock+=t.cpuTiming[this._currentInstruction_OpCode]+this._currentInstruction_ExtraTiming},t.prototype.ResetCPU=function(){this._statusRegister=52,this._operationCounter=0,this._stackPointer=253,this._programCounter=this.GetByte(65532)|this.GetByte(65533)<<8,this._ticks=4},t.prototype.PowerOn=function(){this._statusRegister=52,this._stackPointer=253,this._operationCounter=0,this._ticks=4;for(var t=0;t<2048;++t)this.Rams[t]=255;this.Rams[8]=247,this.Rams[9]=239,this.Rams[10]=223,this.Rams[15]=191,this._programCounter=this.GetByte(65532)|this.GetByte(65533)<<8},t.prototype.GetState=function(t){},t.prototype.SetState=function(t){},t.prototype.RunFrame=function(){this.FindNextEvent();do{this.Step()}while(!this.__frameFinished)},t.prototype.DecodeAddress=function(){this._currentInstruction_ExtraTiming=0;var t=0,e=0,s=0;switch(this._currentInstruction_AddressingMode){case n.ChiChiCPPU_AddressingModes.Absolute:t=this._currentInstruction_Parameters1<<8|this._currentInstruction_Parameters0;break;case n.ChiChiCPPU_AddressingModes.AbsoluteX:(255&(t=(this._currentInstruction_Parameters1<<8|this._currentInstruction_Parameters0)+this._indexRegisterX|0))<this._indexRegisterX&&(this._currentInstruction_ExtraTiming=1);break;case n.ChiChiCPPU_AddressingModes.AbsoluteY:(255&(t=(this._currentInstruction_Parameters1<<8|this._currentInstruction_Parameters0)+this._indexRegisterY|0))<this._indexRegisterY&&(this._currentInstruction_ExtraTiming=1);break;case n.ChiChiCPPU_AddressingModes.ZeroPage:t=this._currentInstruction_Parameters0;break;case n.ChiChiCPPU_AddressingModes.ZeroPageX:t=255&(this._currentInstruction_Parameters0+this._indexRegisterX|0);break;case n.ChiChiCPPU_AddressingModes.ZeroPageY:t=255&((255&this._currentInstruction_Parameters0)+(255&this._indexRegisterY)|0);break;case n.ChiChiCPPU_AddressingModes.Indirect:e=this._currentInstruction_Parameters0;var i=65535&((s=this._currentInstruction_Parameters1<<8)|e),r=this.GetByte(i);i=65535&(s|(e=255&(e+1|0))),t=r|=this.GetByte(i)<<8;break;case n.ChiChiCPPU_AddressingModes.IndexedIndirect:var a=255&(this._currentInstruction_Parameters0+this._indexRegisterX|0);e=this.GetByte(a),a=a+1|0,s=this.GetByte(255&a),t=(s<<=8)|e;break;case n.ChiChiCPPU_AddressingModes.IndirectIndexed:(255&(t=(a=(e=this.GetByte(this._currentInstruction_Parameters0))|(s=this.GetByte(255&(this._currentInstruction_Parameters0+1|0))<<8))+this._indexRegisterY|0))>this._indexRegisterY&&(this._currentInstruction_ExtraTiming=1);break;case n.ChiChiCPPU_AddressingModes.Relative:t=this._programCounter+this._currentInstruction_Parameters0|0;break;default:this.HandleBadOperation()}return 65535&t},t.prototype.HandleBadOperation=function(){throw new Error("Method not implemented.")},t.prototype.DecodeOperand=function(){switch(this._currentInstruction_AddressingMode){case n.ChiChiCPPU_AddressingModes.Immediate:return this._dataBus=this._currentInstruction_Parameters0,this._currentInstruction_Parameters0;case n.ChiChiCPPU_AddressingModes.Accumulator:return this._accumulator;default:return this._dataBus=this.GetByte(this.DecodeAddress()),this._dataBus}},t.prototype.Execute=function(){var t=0,e=0,s=0,i=0,r=0,a=0;switch(this._currentInstruction_OpCode){case 128:case 130:case 194:case 226:case 4:case 20:case 52:case 68:case 84:case 100:case 116:case 212:case 244:case 12:case 28:case 60:case 92:case 124:case 220:case 252:this.DecodeAddress();break;case 105:case 101:case 117:case 109:case 125:case 121:case 97:case 113:t=this.DecodeOperand(),i=1&this._statusRegister,r=this._accumulator+t+i|0,this.SetFlag(this.SRMasks_CarryMask,r>255),this.SetFlag(this.SRMasks_OverflowMask,128!=(128&(this._accumulator^t))&&128==(128&(this._accumulator^r))),this._accumulator=255&r,this.SetZNFlags(this._accumulator);break;case 41:case 37:case 53:case 45:case 61:case 57:case 33:case 49:this._accumulator=this._accumulator&this.DecodeOperand(),this.SetZNFlags(this._accumulator);break;case 10:case 6:case 22:case 14:case 30:t=this.DecodeOperand(),this.SetFlag(this.SRMasks_CarryMask,128==(128&t)),t=t<<1&254,this._currentInstruction_AddressingMode===n.ChiChiCPPU_AddressingModes.Accumulator?this._accumulator=t:this.SetByte(this.DecodeAddress(),t),this.SetZNFlags(t);break;case 144:1!=(1&this._statusRegister)&&this.Branch();break;case 176:1==(1&this._statusRegister)&&this.Branch();break;case 240:2==(2&this._statusRegister)&&this.Branch();break;case 36:case 44:t=this.DecodeOperand(),this.SetFlag(this.SRMasks_OverflowMask,64==(64&t)),this._statusRegister=128==(128&t)?128|this._statusRegister:127&this._statusRegister,0==(t&this._accumulator)?this._statusRegister=2|this._statusRegister:this._statusRegister=253&this._statusRegister;break;case 48:128==(128&this._statusRegister)&&this.Branch();break;case 208:2!=(2&this._statusRegister)&&this.Branch();break;case 16:128!=(128&this._statusRegister)&&this.Branch();break;case 0:this._programCounter=this._programCounter+1,this.PushStack(this._programCounter>>8&255),this.PushStack(255&this._programCounter),t=48|this._statusRegister,this.PushStack(t),this._statusRegister=20|this._statusRegister,this._addressBus=65534,e=this.GetByte(this._addressBus),this._addressBus=65535,s=this.GetByte(this._addressBus),this._programCounter=e+256*s;break;case 80:64!=(64&this._statusRegister)&&this.Branch();break;case 112:64==(64&this._statusRegister)&&this.Branch();break;case 24:this.SetFlag(this.SRMasks_CarryMask,!1);break;case 216:this.SetFlag(this.SRMasks_DecimalModeMask,!1);break;case 88:this.SetFlag(this.SRMasks_InterruptDisableMask,!1);break;case 184:this.SetFlag(this.SRMasks_OverflowMask,!1);break;case 201:case 197:case 213:case 205:case 221:case 217:case 193:case 209:t=this._accumulator+256-this.DecodeOperand(),this.Compare(t);break;case 224:case 228:case 236:t=this._indexRegisterX+256-this.DecodeOperand(),this.Compare(t);break;case 192:case 196:case 204:t=this._indexRegisterY+256-this.DecodeOperand(),this.Compare(t);break;case 198:case 214:case 206:case 222:t=(t=this.DecodeOperand())-1&255,this.SetByte(this.DecodeAddress(),t),this.SetZNFlags(t);break;case 202:this._indexRegisterX=this._indexRegisterX-1,this._indexRegisterX=255&this._indexRegisterX,this.SetZNFlags(this._indexRegisterX);break;case 136:this._indexRegisterY=this._indexRegisterY-1,this._indexRegisterY=255&this._indexRegisterY,this.SetZNFlags(this._indexRegisterY);break;case 73:case 69:case 85:case 77:case 93:case 89:case 65:case 81:this._accumulator=this._accumulator^this.DecodeOperand(),this.SetZNFlags(this._accumulator);break;case 230:case 246:case 238:case 254:t=(t=this.DecodeOperand())+1&255,this.SetByte(this.DecodeAddress(),t),this.SetZNFlags(t);break;case 232:this._indexRegisterX=this._indexRegisterX+1,this._indexRegisterX=255&this._indexRegisterX,this.SetZNFlags(this._indexRegisterX);break;case 200:this._indexRegisterY=this._indexRegisterY+1,this._indexRegisterY=255&this._indexRegisterY,this.SetZNFlags(this._indexRegisterY);break;case 76:case 108:this._currentInstruction_AddressingMode===n.ChiChiCPPU_AddressingModes.Indirect&&255===this._currentInstruction_Parameters0?this._programCounter=255|this._currentInstruction_Parameters1<<8:this._programCounter=this.DecodeAddress();break;case 32:this.PushStack(this._programCounter>>8&255),this.PushStack(this._programCounter-1&255),this._programCounter=this.DecodeAddress();break;case 169:case 165:case 181:case 173:case 189:case 185:case 161:case 177:this._accumulator=this.DecodeOperand(),this.SetZNFlags(this._accumulator);break;case 162:case 166:case 182:case 174:case 190:this._indexRegisterX=this.DecodeOperand(),this.SetZNFlags(this._indexRegisterX);break;case 160:case 164:case 180:case 172:case 188:this._indexRegisterY=this.DecodeOperand(),this.SetZNFlags(this._indexRegisterY);break;case 74:case 70:case 86:case 78:case 94:t=this.DecodeOperand(),this.SetFlag(this.SRMasks_CarryMask,1==(1&t)),t=t>>1&255,this.SetZNFlags(t),this._currentInstruction_AddressingMode===n.ChiChiCPPU_AddressingModes.Accumulator?this._accumulator=t:this.SetByte(this.DecodeAddress(),t);break;case 234:case 26:case 58:case 90:case 122:case 218:case 250:case 137:this._currentInstruction_AddressingMode===n.ChiChiCPPU_AddressingModes.AbsoluteX&&this.DecodeAddress();break;case 9:case 5:case 21:case 13:case 29:case 25:case 1:case 17:this._accumulator=this._accumulator|this.DecodeOperand(),this.SetZNFlags(this._accumulator);break;case 72:this.PushStack(this._accumulator);break;case 8:t=48|this._statusRegister,this.PushStack(t);break;case 104:this._accumulator=this.PopStack(),this.SetZNFlags(this._accumulator);break;case 40:this._statusRegister=this.PopStack();break;case 42:case 38:case 54:case 46:case 62:t=this.DecodeOperand(),a=1==(1&this._statusRegister)?1:0,this.SetFlag(this.SRMasks_CarryMask,128==(128&t)),t=255&(t<<1|a),this.SetZNFlags(t),this._currentInstruction_AddressingMode===n.ChiChiCPPU_AddressingModes.Accumulator?this._accumulator=t:this.SetByte(this.DecodeAddress(),t);break;case 106:case 102:case 118:case 110:case 126:t=this.DecodeOperand(),a=1==(1&this._statusRegister)?128:0,this.SetFlag(this.SRMasks_CarryMask,1==(1&t)),t=t>>1|a,this.SetZNFlags(t),this._currentInstruction_AddressingMode===n.ChiChiCPPU_AddressingModes.Accumulator?this._accumulator=t:this.SetByte(this.DecodeAddress(),t);break;case 64:this._statusRegister=this.PopStack(),e=this.PopStack(),s=this.PopStack(),this._programCounter=s<<8|e;break;case 96:e=this.PopStack()+1&255,s=this.PopStack(),this._programCounter=s<<8|e;break;case 235:case 233:case 229:case 245:case 237:case 253:case 249:case 225:case 241:t=4095&this.DecodeOperand(),i=1&(1^this._statusRegister),r=(this._accumulator-t&4095)-i&4095,this.SetFlag(this.SRMasks_OverflowMask,128==(128&(this._accumulator^r))&&128==(128&(this._accumulator^t))),this.SetFlag(this.SRMasks_CarryMask,r<256),this._accumulator=255&r,this.SetZNFlags(this._accumulator);break;case 56:this.SetFlag(this.SRMasks_CarryMask,!0);break;case 248:this.SetFlag(this.SRMasks_DecimalModeMask,!0);break;case 120:this.SetFlag(this.SRMasks_InterruptDisableMask,!0);break;case 133:case 149:case 141:case 157:case 153:case 129:case 145:this.SetByte(this.DecodeAddress(),this._accumulator);break;case 134:case 150:case 142:this.SetByte(this.DecodeAddress(),this._indexRegisterX);break;case 132:case 148:case 140:this.SetByte(this.DecodeAddress(),this._indexRegisterY);break;case 170:this._indexRegisterX=this._accumulator,this.SetZNFlags(this._indexRegisterX);break;case 168:this._indexRegisterY=this._accumulator,this.SetZNFlags(this._indexRegisterY);break;case 186:this._indexRegisterX=this._stackPointer,this.SetZNFlags(this._indexRegisterX);break;case 138:this._accumulator=this._indexRegisterX,this.SetZNFlags(this._accumulator);break;case 154:this._stackPointer=this._indexRegisterX;break;case 152:this._accumulator=this._indexRegisterY,this.SetZNFlags(this._accumulator);break;case 11:case 43:this._accumulator=this.DecodeOperand()&this._accumulator&255,this.SetFlag(this.SRMasks_CarryMask,128==(128&this._accumulator)),this.SetZNFlags(this._accumulator);break;case 75:this._accumulator=this.DecodeOperand()&this._accumulator,this.SetFlag(this.SRMasks_CarryMask,1==(1&this._accumulator)),this._accumulator=this._accumulator>>1,this.SetZNFlags(this._accumulator);break;case 107:switch(this._accumulator=this.DecodeOperand()&this._accumulator,1==(1&this._statusRegister)?this._accumulator=this._accumulator>>1|128:this._accumulator=this._accumulator>>1,this.SetFlag(this.SRMasks_CarryMask,1==(1&this._accumulator)),48&this._accumulator){case 48:this.SetFlag(this.SRMasks_CarryMask,!0),this.SetFlag(this.SRMasks_InterruptDisableMask,!1);break;case 0:this.SetFlag(this.SRMasks_CarryMask,!1),this.SetFlag(this.SRMasks_InterruptDisableMask,!1);break;case 16:this.SetFlag(this.SRMasks_CarryMask,!1),this.SetFlag(this.SRMasks_InterruptDisableMask,!0);break;case 32:this.SetFlag(this.SRMasks_CarryMask,!0),this.SetFlag(this.SRMasks_InterruptDisableMask,!0)}break;case 171:this._indexRegisterX=this._accumulator=this.DecodeOperand()&this._accumulator,this.SetZNFlags(this._indexRegisterX)}},t.prototype.SetZNFlags=function(t){0==(255&t)?this._statusRegister|=2:this._statusRegister&=-3,128==(128&t)?this._statusRegister|=128:this._statusRegister&=-129},t.prototype.Compare=function(t){this.SetFlag(this.SRMasks_CarryMask,t>255),this.SetZNFlags(255&t)},t.prototype.Branch=function(){this._currentInstruction_ExtraTiming=1;var t=255&this._currentInstruction_Parameters0;128==(128&t)?(t-=256,this._programCounter+=t):this._programCounter+=t,(255&this._programCounter)<t&&(this._currentInstruction_ExtraTiming=2)},t.prototype.NMIHandler=function(){this._handleNMI=!0},t.prototype.IRQUpdater=function(){this._handleIRQ=this.SoundBopper.IRQAsserted||this.Cart.IRQAsserted},t.prototype.LoadBytes=function(t,e){throw new Error("Method not implemented.")},t.prototype.LoadBytes$1=function(t,e,s){throw new Error("Method not implemented.")},t.prototype.PushStack=function(t){this.Rams[this._stackPointer+256]=t,this._stackPointer--,this._stackPointer<0&&(this._stackPointer=255)},t.prototype.PopStack=function(){return this._stackPointer++,this._stackPointer>255&&(this._stackPointer=0),this.Rams[this._stackPointer+256]},t.prototype.GetByte=function(t){var e=0;switch(61440&t){case 0:case 4096:e=t<2048?this.Rams[t]:t>>8;break;case 8192:case 12288:e=this.PPU_GetByte(this.clock,t);break;case 16384:switch(t){case 16406:e=this._padOne.GetByte(this.clock,t);break;case 16407:e=this._padTwo.GetByte(this.clock,t);break;case 16405:e=this.SoundBopper.GetByte(this.clock,t);break;default:e=t>>8}break;case 20480:e=t>>8;break;case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:e=this.Cart.GetByte(this.clock,t);break;default:throw new Error("Bullshit!")}return 255&e},t.prototype.PeekByte=function(t){var e=0;switch(61440&t){case 0:case 4096:e=t<2048?this.Rams[t]:t>>8;break;case 8192:case 12288:e=0;break;case 16384:switch(t){case 16406:e=this._padOne.GetByte(this.clock,t);break;case 16407:e=this._padTwo.GetByte(this.clock,t);break;case 16405:e=this.SoundBopper.GetByte(this.clock,t);break;default:e=t>>8}break;case 20480:e=t>>8;break;case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:e=0;break;default:throw new Error("Bullshit!")}return 255&e},t.prototype.PeekBytes=function(t,e){for(var s=new Array,i=0;i<e;++i)i<this.Rams.length&&s.push(this.Rams[i]);return s},t.prototype.SetByte=function(t,e){if(t<2048)this.Rams[2047&t]=e;else switch(61440&t){case 0:case 4096:this.Rams[2047&t]=e;break;case 20480:this.Cart.SetByte(this.clock,t,e);break;case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:this.Cart.SetByte(this.clock,t,e);break;case 8192:case 12288:this.PPU_SetByte(this.clock,t,e);break;case 16384:switch(t){case 16384:case 16385:case 16386:case 16387:case 16388:case 16389:case 16390:case 16391:case 16392:case 16393:case 16394:case 16395:case 16396:case 16397:case 16398:case 16399:case 16405:case 16407:this.SoundBopper.SetByte(this.clock,t,e);break;case 16404:this.PPU_CopySprites(256*e),this._currentInstruction_ExtraTiming=this._currentInstruction_ExtraTiming+512;break;case 16406:this._padOne.SetByte(this.clock,t,1&e),this._padTwo.SetByte(this.clock,t,1&e)}}},t.prototype.FindNextEvent=function(){this.nextEvent=this.clock+this.PPU_NextEventAt},t.prototype.HandleNextEvent=function(){this.PPU_HandleEvent(this.clock),this.FindNextEvent()},t.prototype.ResetInstructionHistory=function(){this.instructionHistoryPointer=255},t.prototype.WriteInstructionHistoryAndUsage=function(){var t=new n.ChiChiInstruction;t.time=this.systemClock,t.A=this._accumulator,t.X=this._indexRegisterX,t.Y=this._indexRegisterY,t.SR=this._statusRegister,t.SP=this._stackPointer,t.frame=this.clock,t.OpCode=this._currentInstruction_OpCode,t.Parameters0=this._currentInstruction_Parameters0,t.Parameters1=this._currentInstruction_Parameters1,t.Address=this._currentInstruction_Address,t.AddressingMode=this._currentInstruction_AddressingMode,t.ExtraTiming=this._currentInstruction_ExtraTiming,this._instructionHistory[255&this.instructionHistoryPointer--]=t,this.instructionUsage[this._currentInstruction_OpCode]++,255==(255&this.instructionHistoryPointer)&&this.FireDebugEvent("instructionHistoryFull")},t.prototype.FireDebugEvent=function(t){throw new Error("Method not implemented.")},t.prototype.PeekInstruction=function(t){throw new Error("Method not implemented.")},t.prototype.PPU_Initialize=function(){this._PPUAddress=0,this._PPUStatus=0,this._PPUControlByte0=0,this._PPUControlByte1=0,this._hScroll=0,this._vScroll=0,this._spriteAddress=0},t.prototype.PPU_WriteState=function(t){throw new Error("Method not implemented.")},t.prototype.PPU_ReadState=function(t){throw new Error("Method not implemented.")},Object.defineProperty(t.prototype,"PPU_NMIIsThrown",{get:function(){return 128==(128&this._PPUControlByte0)},enumerable:!0,configurable:!0}),t.prototype.PPU_SetupVINT=function(){this._PPUStatus=128|this._PPUStatus,this._frames=this._frames+1,this.PPU_NMIIsThrown&&(this._handleNMI=!0)},t.prototype.PPU_VidRAM_GetNTByte=function(t){return this.chrRomHandler.GetPPUByte(0,t)},t.prototype.UpdatePPUControlByte0=function(){16&this._PPUControlByte0?this.backgroundPatternTableIndex=4096:this.backgroundPatternTableIndex=0},t.prototype.PPU_SetByte=function(t,e,s){switch(7&e){case 0:this.DrawTo(t),this._PPUControlByte0=s,this._openBus=s,this.nameTableBits=3&this._PPUControlByte0,this.backgroundPatternTableIndex=4096*((16&this._PPUControlByte0)>>4),this.nameTableMemoryStart=1024*this.nameTableBits;break;case 1:this.DrawTo(t),this.isRendering=0!=(24&s),this._PPUControlByte1=s,this._spritesAreVisible=16==(16&this._PPUControlByte1),this._tilesAreVisible=8==(8&this._PPUControlByte1),this._clipTiles=2!=(2&this._PPUControlByte1),this._clipSprites=4!=(4&this._PPUControlByte1),this.nameTableMemoryStart=1024*this.nameTableBits;break;case 2:this.ppuReadBuffer=s,this._openBus=s;break;case 3:this._spriteAddress=255&s,this._openBus=this._spriteAddress;break;case 4:this.spriteRAM[this._spriteAddress]=s,this._spriteAddress=this._spriteAddress+1&255,this.unpackedSprites[this._spriteAddress>>2].Changed=!0,this.spriteChanges=!0;break;case 5:this.PPUAddressLatchIsHigh?(this.DrawTo(t),this._hScroll=s,this.lockedHScroll=7&this._hScroll,this.UpdatePixelInfo(),this.PPUAddressLatchIsHigh=!1):(this.DrawTo(t),this._vScroll=s,s>240&&(this._vScroll=s-256),(!this.frameOn||this.frameOn&&!this.isRendering)&&(this.lockedVScroll=this._vScroll),this.PPUAddressLatchIsHigh=!0,this.UpdatePixelInfo());break;case 6:this.PPUAddressLatchIsHigh?(this._PPUAddress=255&this._PPUAddress|(63&s)<<8,this.PPUAddressLatchIsHigh=!1):(this._PPUAddress=32512&this._PPUAddress|255&s,this.PPUAddressLatchIsHigh=!0,this.DrawTo(t),this._hScroll=(31&this._PPUAddress)<<3,this._vScroll=(this._PPUAddress>>5&31)<<3,this._vScroll|=this._PPUAddress>>12&3,this.nameTableBits=this._PPUAddress>>10&3,this.frameOn&&(this.lockedHScroll=this._hScroll,this.lockedVScroll=this._vScroll,this.lockedVScroll=this.lockedVScroll-this.currentYPosition),this.UpdatePixelInfo());break;case 7:if(16128==(65280&this._PPUAddress)){this.DrawTo(t);var i=31&this._PPUAddress;this._palette[i]=s,16128==(65519&this._PPUAddress)&&(this._palette[31&(16^i)]=s),this.UpdatePixelInfo()}else 8192==(61440&this._PPUAddress)?this.chrRomHandler.SetPPUByte(t,this._PPUAddress,s):this.vidRamIsRam&&this.chrRomHandler.SetPPUByte(t,this._PPUAddress,s);4==(4&this._PPUControlByte0)?this._PPUAddress=this._PPUAddress+32:this._PPUAddress=this._PPUAddress+1,this.PPUAddressLatchIsHigh=!0,this._PPUAddress=16383&this._PPUAddress}},t.prototype.PPU_GetByte=function(t,e){switch(7&e){case 3:case 0:case 1:case 5:case 6:return this._openBus;case 2:var s=0;return this.PPUAddressLatchIsHigh=!0,s=31&this.ppuReadBuffer|this._PPUStatus,this.DrawTo(t),128==(128&s)&&(this._PPUStatus=-129&this._PPUStatus),this.UpdatePixelInfo(),s;case 4:var i=this.spriteRAM[this._spriteAddress];return i;case 7:return 16128==(65280&this._PPUAddress)?(i=this._palette[31&this._PPUAddress],this.ppuReadBuffer=this.chrRomHandler.GetPPUByte(t,this._PPUAddress-4096)):(i=this.ppuReadBuffer,this._PPUAddress>=8192&&this._PPUAddress<=12287?this.ppuReadBuffer=this.chrRomHandler.GetPPUByte(t,this._PPUAddress):this.ppuReadBuffer=this.chrRomHandler.GetPPUByte(t,16383&this._PPUAddress)),4==(4&this._PPUControlByte0)?this._PPUAddress=this._PPUAddress+32:this._PPUAddress=this._PPUAddress+1,this._PPUAddress=16383&this._PPUAddress,i}return 0},t.prototype.PPU_HandleEvent=function(t){this.DrawTo(t)},t.prototype.PPU_ResetClock=function(t){this.LastcpuClock=t},t.prototype.PPU_CopySprites=function(t){for(var e=0;e<256;++e){var s=this._spriteAddress+e&255;this.spriteRAM[s]!==this.Rams[t+e]&&(this.spriteRAM[s]=this.Rams[t+e],this.unpackedSprites[s>>2&255].Changed=!0)}this._spriteCopyHasHappened=!0,this.spriteChanges=!0},t.prototype.PPU_InitSprites=function(){this.currentSprites=new Array(this._maxSpritesPerScanline);for(t=0;t<this._maxSpritesPerScanline;++t)this.currentSprites[t]=new n.ChiChiSprite;this.unpackedSprites=new Array(64);for(var t=0;t<64;++t)this.unpackedSprites[t]=new n.ChiChiSprite},t.prototype.PPU_GetSpritePixel=function(){this.isForegroundPixel=!1,this.spriteZeroHit=!1;for(var t=0,e=0,s=0,i=0,r=0;r<this.spritesOnThisScanline;++r){var n=this.currentSprites[r];if(n.XPosition>0&&this.currentXPosition>=n.XPosition&&this.currentXPosition<n.XPosition+8){var a=0;8==(8&this._PPUControlByte0)&&(a=4096),s=this.currentXPosition-n.XPosition,e=this.currentYPosition-n.YPosition-1,e&=this.spriteSize-1,i=n.TileIndex,32==(32&this._PPUControlByte0)&&(1==(1&i)?(a=4096,i^=1):a=0);var h,o;if(n.FlipY&&(e=this.spriteSize-e-1),e>=8&&(e+=8),h=this.chrRomHandler.GetPPUByte(0,a+16*i+e),o=this.chrRomHandler.GetPPUByte(0,a+16*i+e+8),0!==(t=255&(n.FlipX?h>>s&1|o>>s<<1&2:h>>7-s&1|o>>7-s<<1&2)))return 0===n.SpriteNumber&&(this.spriteZeroHit=!0),this.isForegroundPixel=n.Foreground,t|n.AttributeByte}}return 0},t.prototype.PPU_WhissaSpritePixel=function(t,e,s,i,r){var n=0,a=0;return i.v.FlipY&&(s=this.spriteSize-s-1),s>=8&&(s+=8),n=this.chrRomHandler.GetPPUByte(0,t+16*r+s),a=this.chrRomHandler.GetPPUByte(0,t+16*r+s+8),i.v.FlipX?n>>e&1|a>>e<<1&2:n>>7-e&1|a>>7-e<<1&2},t.prototype.PPU_PreloadSprites=function(t){this.spritesOnThisScanline=0,this.sprite0scanline=-1;var e=this.currentYPosition-1;this.outBuffer[64768+e]=0,this.outBuffer[65024+e]=0;for(var s=0;s<256;s+=4){var i=(s+this._spriteAddress&255)>>2,r=this.unpackedSprites[i].YPosition+1;if(t>=r&&t<r+this.spriteSize){0===i&&(this.sprite0scanline=t,this.sprite0x=this.unpackedSprites[i].XPosition);var n=s>>2;if(n<32?this.outBuffer[64768+e]|=1<<n:this.outBuffer[65024+e]|=1<<n-32,this.currentSprites[this.spritesOnThisScanline]=this.unpackedSprites[i],this.currentSprites[this.spritesOnThisScanline].IsVisible=!0,this.spritesOnThisScanline++,this.spritesOnThisScanline===this._maxSpritesPerScanline)break}}this.spritesOnThisScanline>7&&(this._PPUStatus=32|this._PPUStatus)},t.prototype.PPU_UnpackSprites=function(){for(var t=0;t<this.unpackedSprites.length;++t)this.unpackedSprites[t].Changed&&this.UnpackSprite(t)},t.prototype.UnpackSprite=function(t){var e=this.spriteRAM[2+(t<<2)|0];this.unpackedSprites[t].IsVisible=!0,this.unpackedSprites[t].AttributeByte=(3&e)<<2|16,this.unpackedSprites[t].YPosition=this.spriteRAM[4*t],this.unpackedSprites[t].XPosition=this.spriteRAM[4*t+3],this.unpackedSprites[t].SpriteNumber=t,this.unpackedSprites[t].Foreground=32!=(32&e),this.unpackedSprites[t].FlipX=64==(64&e),this.unpackedSprites[t].FlipY=128==(128&e),this.unpackedSprites[t].TileIndex=this.spriteRAM[4*t+1],this.unpackedSprites[t].Changed=!1},t.prototype.PPU_GetNameTablePixel=function(){var t=(128&this.patternEntry)>>7|(128&this.patternEntryByte2)>>6;return this.patternEntry<<=1,this.patternEntryByte2<<=1,t>0&&(t|=this.currentAttributeByte),255&t},t.prototype.FetchNextTile=function(){var t=this.nameTableMemoryStart^this.xNTXor^this.yNTXor,e=this.xPosition>>3,s=8192+t+e+((this.yPosition>>3)%30<<5),i=this.chrRomHandler.GetPPUByte(0,s),r=7&this.yPosition,n=this.backgroundPatternTableIndex+16*i+r;this.patternEntry=this.chrRomHandler.GetPPUByte(0,n),this.patternEntryByte2=this.chrRomHandler.GetPPUByte(0,n+8),this.currentAttributeByte=this.GetAttributeTableEntry(t,e,this.yPosition>>3)},t.prototype.GetAttributeTableEntry=function(t,e,s){var i=this.chrRomHandler.GetPPUByte(0,8192+t+960+(e>>2)+8*(s>>2));switch(2&e|2*(2&s)){case 0:return i<<2&12;case 2:return 12&i;case 4:return i>>2&12;case 6:return i>>4&12}return 0},t.prototype.DrawTo=function(t){var e=3*(t-this.LastcpuClock);this.frameClock<6820&&(this.frameClock+e<6820?(this.frameClock+=e,e=0):(e+=this.frameClock-6820,this.frameClock=6820));for(var s=0;s<e;++s){switch(this.frameClock++){case 0:break;case 6820:this._PPUStatus=0,this.hitSprite=!1,this.spriteSize=32==(32&this._PPUControlByte0)?16:8,0!=(24&this._PPUControlByte1)&&(this.isRendering=!0),this.frameOn=!0,this.chrRomHandler.ResetBankStartCache(),this.spriteChanges&&(this.PPU_UnpackSprites(),this.spriteChanges=!1);break;case 7161:this.vbufLocation=0,this.xNTXor=0,this.yNTXor=0,this.currentXPosition=0,this.currentYPosition=0;break;case 89342:this.shouldRender=!0,this.frameFinished(),this.PPU_SetupVINT(),this.frameOn=!1,this.frameClock=0}if(this.frameClock>=7161&&this.frameClock<=89342){if(this.currentXPosition<256&&this.vbufLocation<61440){if(this.xPosition=this.currentXPosition+this.lockedHScroll,0==(7&this.xPosition)){this.xNTXor=256&this.xPosition?1024:0,this.xPosition&=255;var i=this.nameTableMemoryStart^this.xNTXor^this.yNTXor,r=this.xPosition>>3,n=8192+i+r+((this.yPosition>>3)%30<<5),a=this.chrRomHandler.GetPPUByte(0,n),h=7&this.yPosition,o=this.backgroundPatternTableIndex+16*a+h;this.patternEntry=this.chrRomHandler.GetPPUByte(0,o),this.patternEntryByte2=this.chrRomHandler.GetPPUByte(0,o+8),this.currentAttributeByte=this.GetAttributeTableEntry(i,r,this.yPosition>>3)}var u=this._tilesAreVisible?this.PPU_GetNameTablePixel():0,c=this._spritesAreVisible?this.PPU_GetSpritePixel():0;!this.hitSprite&&this.spriteZeroHit&&0!==u&&(this.hitSprite=!0,this._PPUStatus=64|this._PPUStatus),this.byteOutBuffer[4*this.vbufLocation]=this._palette[this.isForegroundPixel||0===u&&0!==c?c:u],this.vbufLocation++}324===this.currentXPosition&&this.chrRomHandler.UpdateScanlineCounter(),this.currentXPosition++,this.currentXPosition>340&&(this.currentXPosition=0,this.currentYPosition++,this.PPU_PreloadSprites(this.currentYPosition),this.spritesOnThisScanline>=7&&(this._PPUStatus=32|this._PPUStatus),this.lockedHScroll=this._hScroll,this.UpdatePixelInfo(),this.yPosition=this.currentYPosition+this.lockedVScroll,this.yPosition<0&&(this.yPosition+=240),this.yPosition>=240?(this.yPosition-=240,this.yNTXor=2048):this.yNTXor=0)}}this.LastcpuClock=t},t.prototype.UpdatePixelInfo=function(){this.nameTableMemoryStart=1024*this.nameTableBits},t.prototype.VidRAM_GetNTByte=function(t){return this.chrRomHandler.GetPPUByte(0,t)},t.prototype.GetStatus=function(){return{PC:this._programCounter,A:this._accumulator,X:this._indexRegisterX,Y:this._indexRegisterY,SP:this._stackPointer,SR:this._statusRegister}},t.prototype.GetPPUStatus=function(){return{status:this._PPUStatus,controlByte0:this._PPUControlByte0,controlByte1:this._PPUControlByte1,nameTableStart:this.nameTableMemoryStart,currentTile:this.currentTileIndex,lockedVScroll:this.lockedVScroll,lockedHScroll:this.lockedHScroll,X:this.currentXPosition,Y:this.currentYPosition}},t.cpuTiming=[7,6,0,0,3,2,5,0,3,2,2,0,6,4,6,0,2,5,0,0,3,3,6,0,2,4,2,0,6,4,7,0,6,6,0,0,3,2,5,0,3,2,2,0,4,4,6,0,2,5,0,0,3,3,6,0,2,4,2,0,6,4,7,0,6,6,0,0,3,2,5,0,3,2,2,0,3,4,6,0,2,5,0,0,0,3,6,0,2,4,2,0,6,4,6,0,6,6,0,0,3,3,5,0,3,2,2,0,5,4,6,0,2,5,0,0,0,4,6,0,2,4,2,0,6,4,7,0,3,6,3,0,3,3,3,0,2,3,2,0,4,4,4,0,2,6,0,0,4,4,4,0,2,5,2,0,0,5,0,0,2,6,2,0,3,3,3,0,2,2,2,0,4,4,4,0,2,5,0,0,4,4,4,0,2,4,2,0,4,4,4,0,2,6,3,0,3,2,5,0,2,2,2,0,4,4,6,0,2,5,0,0,3,4,6,0,2,4,2,0,6,4,7,0,2,6,3,0,3,3,5,0,2,2,2,0,4,4,6,0,2,5,0,0,3,4,6,0,2,4,2,0,6,4,7,0],t.pal=new Uint32Array([7961465,10626572,11407400,10554206,7733552,2753820,725017,271983,278855,284436,744967,3035906,7161605,0,131586,131586,12566719,14641430,15614283,14821245,12196292,6496468,2176980,875189,293472,465210,1597716,5906953,11090185,2961197,197379,197379,16316149,16298569,16588080,16415170,15560682,12219892,7115511,4563694,2277591,2151458,4513360,1957181,14604331,6579811,263172,263172,16447992,16441012,16634316,16500447,16236786,14926838,12831991,11393781,2287340,5500370,11858360,14283440,15921318,13158344,328965,328965,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),t.addressModes=[1,12,1,0,0,4,4,0,1,3,2,3,8,8,8,1,7,13,14,1,4,5,5,1,1,10,1,1,8,9,9,1,8,12,1,1,4,4,4,1,1,3,2,3,8,8,8,1,7,13,14,1,5,5,5,1,1,10,1,1,9,9,9,1,1,12,1,1,1,4,4,1,1,3,2,3,8,8,8,1,7,13,14,1,1,5,5,1,1,10,1,1,1,9,9,1,1,12,1,1,4,4,4,1,1,3,2,3,11,8,8,1,7,13,14,1,5,5,5,1,1,10,1,1,15,9,9,1,7,12,3,1,4,4,4,1,1,3,1,1,8,8,8,1,7,13,14,1,5,5,6,1,1,10,1,1,8,9,9,1,3,12,3,1,4,4,4,1,1,3,1,3,8,8,8,1,7,13,14,1,5,5,6,1,1,10,1,1,9,9,10,1,3,12,3,1,4,4,4,1,1,3,1,3,8,8,8,1,7,13,14,1,1,5,5,1,1,10,1,1,1,9,9,1,3,12,3,1,4,4,4,1,1,3,1,3,8,8,8,1,7,13,14,1,1,5,5,1,1,10,1,1,1,9,9,1],t}();e.ChiChiCPPU=u},function(t,e,s){"use strict";var i=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s])};return function(e,s){function i(){this.constructor=e}t(e,s),e.prototype=null===s?Object.create(s):(i.prototype=s.prototype,new i)}}();Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(){var t=this;this.prgRomBank6=new Uint8Array(new SharedArrayBuffer(8192*Uint8Array.BYTES_PER_ELEMENT)),this.ppuBankStarts=new Uint32Array(new SharedArrayBuffer(16*Uint32Array.BYTES_PER_ELEMENT)),this.bankStartCache=new Uint32Array(new SharedArrayBuffer(4096*Uint32Array.BYTES_PER_ELEMENT)),this.iNesHeader=new Uint8Array(16),this.romControlBytes=new Uint8Array(2),this.nesCart=null,this.chrRom=null,this.current8=-1,this.currentA=-1,this.currentC=-1,this.currentE=-1,this.SRAMCanWrite=!1,this.SRAMEnabled=!1,this.SRAMCanSave=!1,this.prgRomCount=0,this.chrRomOffset=0,this.chrRamStart=0,this.chrRomCount=0,this.mapperId=0,this.bank8start=0,this.bankAstart=0,this.bankCstart=0,this.bankEstart=0,this._ROMHashfunction=null,this.checkSum=null,this.mirroring=-1,this.updateIRQ=function(){t.NMIHandler()},this.bankSwitchesChanged=!1,this.oneScreenOffset=0,this.irqRaised=!1,this.DebugEvents=null,this.CurrentBank=0,this.UsesSRAM=!1,this.prgRomBank6.fill(0);for(var e=0;e<16;e=e+1|0)this.ppuBankStarts[e]=1024*e}return t.arrayCopy=function(t,e,s,i,r){if(!s)throw new Error("dest Value cannot be null");if(!t)throw new Error("src Value cannot be null");if(e<0||i<0||r<0)throw new Error("Number was less than the array's lower bound in the first dimension");if(r>t.length-e||r>s.length-i)throw new Error("Destination array was not long enough. Check destIndex and length, and the array's lower bounds");if(e<i&&t===s)for(;--r>=0;)s[i+r]=t[e+r];else for(var n=0;n<r;n++)s[i+n]=t[e+n]},Object.defineProperty(t.prototype,"NumberOfPrgRoms",{get:function(){return this.prgRomCount},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"NumberOfChrRoms",{get:function(){return this.chrRomCount},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"MapperID",{get:function(){return this.mapperId},enumerable:!0,configurable:!0}),t.prototype.ClearDebugEvents=function(){},t.prototype.LoadiNESCart=function(e,s,i,r,n,a){this.romControlBytes[0]=e[6],this.romControlBytes[1]=e[7],this.mapperId=(240&this.romControlBytes[0])>>4,this.mapperId=this.mapperId+(240&this.romControlBytes[1])|0,this.chrRomOffset=a,this.iNesHeader=new Uint8Array(e.slice(0,16)),this.prgRomCount=s,this.chrRomCount=i,this.nesCart=new Uint8Array(r.length),t.arrayCopy(r,0,this.nesCart,0,r.length),0===this.chrRomCount&&(n=new Array(32768)).fill(0);var h=new SharedArrayBuffer((n.length+4096)*Uint8Array.BYTES_PER_ELEMENT);this.chrRom=new Uint8Array(h),this.chrRamStart=n.length,t.arrayCopy(n,0,this.chrRom,0,n.length),this.prgRomCount=this.iNesHeader[4],this.chrRomCount=this.iNesHeader[5],this.romControlBytes[0]=this.iNesHeader[6],this.romControlBytes[1]=this.iNesHeader[7],this.SRAMCanSave=2==(2&this.romControlBytes[0]),this.SRAMEnabled=!0,this.UsesSRAM=2==(2&this.romControlBytes[0]),this.Mirror(0,0),1==(1&this.romControlBytes[0])?this.Mirror(0,1):this.Mirror(0,2),8==(8&this.romControlBytes[0])&&this.Mirror(0,3),this.checkSum="",this.InitializeCart()},t.prototype.GetByte=function(t,e){var s=0;switch(57344&e){case 24576:return this.prgRomBank6[8191&e];case 32768:s=this.bank8start;break;case 40960:s=this.bankAstart;break;case 49152:s=this.bankCstart;break;case 57344:s=this.bankEstart}if((s+(8191&e)|0)>this.nesCart.length)throw new Error("THis is broken!");return this.nesCart[s+(8191&e)|0]},t.prototype.SetByte=function(t,e,s){},t.prototype.GetPPUByte=function(t,e){var s=e>>10,i=this.ppuBankStarts[s]+(1023&e);return this.chrRom[i]},t.prototype.SetPPUByte=function(t,e,s){var i=e>>10,r=this.bankStartCache[(this.CurrentBank<<4)+i]+(1023&e);this.chrRom[r]=s},t.prototype.SetupBankStarts=function(t,e,s,i){t=this.MaskBankAddress(t),e=this.MaskBankAddress(e),s=this.MaskBankAddress(s),i=this.MaskBankAddress(i),this.current8=t,this.currentA=e,this.currentC=s,this.currentE=i,this.bank8start=8192*t,this.bankAstart=8192*e,this.bankCstart=8192*s,this.bankEstart=8192*i},t.prototype.MaskBankAddress=function(t){if(t>=2*this.prgRomCount){for(var e=255;(t&e)>=2*this.prgRomCount;)e>>=1;return t&e}return t},t.prototype.WriteState=function(t){},t.prototype.ReadState=function(t){},t.prototype.HandleEvent=function(t){},t.prototype.ResetClock=function(t){},t.prototype.ResetBankStartCache=function(){this.CurrentBank=0,this.bankStartCache.fill(0);for(var t=0;t<16;++t)this.bankStartCache[t]=this.ppuBankStarts[t]},t.prototype.UpdateBankStartCache=function(){this.CurrentBank=this.CurrentBank+1|0;for(var t=0;t<16;++t)this.bankStartCache[16*this.CurrentBank+t]=this.ppuBankStarts[t];return this.Whizzler.UpdatePixelInfo(),this.CurrentBank},t.prototype.ActualChrRomOffset=function(t){var e=t>>10|0;return this.bankStartCache[16*this.CurrentBank+e]+(1023&t)},t.prototype.Mirror=function(t,e){switch(this.mirroring=e,t>-1&&this.Whizzler.DrawTo(t),e){case 0:this.ppuBankStarts[8]=(this.chrRamStart+0|0)+this.oneScreenOffset|0,this.ppuBankStarts[9]=(this.chrRamStart+0|0)+this.oneScreenOffset|0,this.ppuBankStarts[10]=(this.chrRamStart+0|0)+this.oneScreenOffset|0,this.ppuBankStarts[11]=(this.chrRamStart+0|0)+this.oneScreenOffset|0;break;case 1:this.ppuBankStarts[8]=this.chrRamStart+0|0,this.ppuBankStarts[9]=this.chrRamStart+1024|0,this.ppuBankStarts[10]=this.chrRamStart+0|0,this.ppuBankStarts[11]=this.chrRamStart+1024|0;break;case 2:this.ppuBankStarts[8]=this.chrRamStart+0|0,this.ppuBankStarts[9]=this.chrRamStart+0|0,this.ppuBankStarts[10]=this.chrRamStart+1024|0,this.ppuBankStarts[11]=this.chrRamStart+1024|0;break;case 3:this.ppuBankStarts[8]=this.chrRamStart+0|0,this.ppuBankStarts[9]=this.chrRamStart+1024|0,this.ppuBankStarts[10]=this.chrRamStart+2048|0,this.ppuBankStarts[11]=this.chrRamStart+3072|0}this.UpdateBankStartCache(),this.Whizzler.UpdatePixelInfo()},t.prototype.InitializeCart=function(){},t.prototype.UpdateScanlineCounter=function(){},t}();e.BaseCart=r;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.InitializeCart=function(){switch(this.mapperId){case 0:case 1:case 2:case 3:this.chrRomCount>0&&this.CopyBanks(0,0,0,1),this.SetupBankStarts(0,1,2*this.prgRomCount-2,2*this.prgRomCount-1);break;case 7:this.SetupBankStarts(0,1,2,3),this.Mirror(0,0);break;default:throw new Error("Mapper "+(this.mapperId.toString()||"")+" not implemented.")}},e.prototype.CopyBanks=function(t,e,s,i){e>=this.chrRomCount&&(e=this.chrRomCount-1|0);for(var r=s<<3,n=e<<3,a=0;a<i<<3;a=a+1|0)this.ppuBankStarts[n+a|0]=1024*(r+a);this.UpdateBankStartCache()},e.prototype.SetByte=function(t,e,s){if(e>=24576&&e<=32767)this.SRAMEnabled&&(this.prgRomBank6[8191&e]=255&s);else{if(7===this.mapperId){var i=0;i=(15&s)<<2,this.SetupBankStarts(i,i+1|0,i+2|0,i+3|0),this.OneScreenOffset=16==(16&s)?1024:0,this.Mirror(t,0)}if(3===this.mapperId&&e>=32768&&this.CopyBanks(t,0,s,1),2===this.mapperId&&e>=32768){var r=0;r=2*s,this.SetupBankStarts(r,r+1|0,this.currentC,this.currentE)}}},e}(r);e.NesCart=n;var a=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.loadNsfAt=0,e.bank_select=0,e.rams=new Uint8Array(4294967295),e}return i(e,t),e.prototype.InitializeCart=function(){},e.prototype.GetPPUByte=function(t,e){return 0},e.prototype.GetByte=function(t,e){return this.rams[e]},e.prototype.__SetByte=function(t,e){this.rams[t]=e},e.prototype.LoadNSFFile=function(t,e,s,i,r,n){this.mapperId=-1,this.prgRomCount=e,this.chrRomCount=s,this.SetupBankStarts(0,1,3,4),this.songCount=t[6],this.firstSong=t[7],this.loadNsfAt=(t[9]<<8)+t[8],this.initNsfAt=(t[11]<<8)+t[10],this.runNsfAt=(t[13]<<8)+t[12],this.songName=t.slice(14,46).map(function(t){return String.fromCharCode(t)}).join("").trim(),this.artist=t.slice(46,46).map(function(t){return String.fromCharCode(t)}).join("").trim(),this.copyright=t.slice(78,46).map(function(t){return String.fromCharCode(t)}).join("").trim();for(var a=this.loadNsfAt,h=0;h<i.length-128;++h)this.__SetByte(a+h,i[128+h]);this.__SetByte(65532,t[10]),this.__SetByte(65533,t[11]),this.prgRomCount=i.length/1024,this.chrRomCount=0,this.SRAMEnabled=!0,this.checkSum="",this.InitializeCart()},e}(r);e.NsfCart=a;var h=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.lastClock=0,e.sequence=0,e.accumulator=0,e.bank_select=0,e._registers=new Array(4),e.lastwriteAddress=0,e}return i(e,t),e.prototype.InitializeCart=function(){this.chrRomCount>0&&this.CopyBanks(0,0,4),this._registers[0]=12,this._registers[1]=0,this._registers[2]=0,this._registers[3]=0,this.SetupBankStarts(0,1,2*this.prgRomCount-2|0,2*this.prgRomCount-1|0),this.sequence=0,this.accumulator=0},e.prototype.MaskBankAddress$1=function(t){if(t>=this.prgRomCount<<1){var e;for(e=255;(t&e)>=2*this.prgRomCount;)e=e>>1&255;return t&e}return t},e.prototype.CopyBanks=function(t,e,s){if(this.chrRomCount>0)for(var i=4*t,r=4*e,n=0;n<s<<2;n=n+1|0)this.ppuBankStarts[i+n|0]=(r+n|0)<<10;this.UpdateBankStartCache()},e.prototype.SetByte=function(t,e,s){switch(this.lastClock=t,61440&e){case 24576:case 28672:this.prgRomBank6[8191&e]=255&s;break;default:if(this.lastwriteAddress=e,128==(128&s)?(this._registers[0]=12|this._registers[0],this.accumulator=0,this.sequence=0):(1==(1&s)&&(this.accumulator=this.accumulator|1<<this.sequence),this.sequence=this.sequence+1|0),5===this.sequence){var i=(32767&e)>>13;switch(this._registers[(32767&e)>>13]=this.accumulator,this.sequence=0,this.accumulator=0,i){case 0:this.SetMMC1Mirroring(t);break;case 1:case 2:this.SetMMC1ChrBanking(t);break;case 3:this.SetMMC1PrgBanking()}}}},e.prototype.SetMMC1ChrBanking=function(t){this.CPU.DrawTo(t),16==(16&this._registers[0])?(this.CopyBanks(0,this._registers[1],1),this.CopyBanks(1,this._registers[2],1)):(this.CopyBanks(0,this._registers[1],1),this.CopyBanks(1,this._registers[1]+1|0,1)),this.bankSwitchesChanged=!0,this.CPU.UpdatePixelInfo()},e.prototype.SetMMC1PrgBanking=function(){var t=0;32===this.prgRomCount?this.bank_select=(16&this._registers[1])<<1:this.bank_select=0,0==(8&this._registers[0])?(t=4*(this._registers[3]>>1&15)+this.bank_select|0,this.SetupBankStarts(t,t+1|0,t+2|0,t+3|0)):(t=2*this._registers[3]+this.bank_select|0,4==(4&this._registers[0])?this.SetupBankStarts(t,t+1|0,(this.prgRomCount<<1)-2|0,(this.prgRomCount<<1)-1|0):this.SetupBankStarts(0,1,t,t+1|0))},e.prototype.SetMMC1Mirroring=function(t){switch(this.CPU.DrawTo(t),3&this._registers[0]){case 0:this.oneScreenOffset=0,this.Mirror(t,0);break;case 1:this.oneScreenOffset=1024,this.Mirror(t,0);break;case 2:this.Mirror(t,1);break;case 3:this.Mirror(t,2)}this.bankSwitchesChanged=!0,this.CPU.UpdatePixelInfo()},e}(r);e.MMC1Cart=h;var o=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._registers=new Uint8Array(4),e.chr2kBank0=0,e.chr2kBank1=1,e.chr1kBank0=0,e.chr1kBank1=0,e.chr1kBank2=0,e.chr1kBank3=0,e.prgSwap=0,e.prgSwitch1=0,e.prgSwitch2=0,e.prevBSSrc=new Uint8Array(8),e._mmc3Command=0,e._mmc3ChrAddr=0,e._mmc3IrqVal=0,e._mmc3TmpVal=0,e.scanlineCounter=0,e._mmc3IrcOn=!1,e.ppuBankSwap=!1,e.PPUBanks=new Uint32Array(8),e}return i(e,t),e.prototype.InitializeCart=function(){this._registers.fill(0),this.PPUBanks.fill(0),this.prevBSSrc.fill(0),this.prgSwap=1,this.prgSwitch1=0,this.prgSwitch2=1,this.SwapPrgRomBanks(),this._mmc3IrqVal=0,this._mmc3IrcOn=!1,this._mmc3TmpVal=0,this.chr2kBank0=0,this.chr2kBank1=0,this.chr1kBank0=0,this.chr1kBank1=0,this.chr1kBank2=0,this.chr1kBank3=0,this.chrRomCount>0&&this.CopyBanks(0,0,8)},e.prototype.MaskBankAddress=function(t){if(t>=2*this.prgRomCount){for(var e=255;(t&e)>=2*this.prgRomCount;)e>>=1;return t&e}return t},e.prototype.CopyBanks=function(t,e,s){if(this.chrRomCount>0){for(var i=0;i<s;i=i+1|0)this.ppuBankStarts[t+i|0]=1024*(e+i);this.bankSwitchesChanged=!0}},e.prototype.SetByte=function(t,e,s){if(e>=24576&&e<32768)this.SRAMEnabled&&this.SRAMCanWrite&&(this.prgRomBank6[8191&e]=255&s);else switch(57345&e){case 32768:this._mmc3Command=7&s,128==(128&s)?(this.ppuBankSwap=!0,this._mmc3ChrAddr=4096):(this.ppuBankSwap=!1,this._mmc3ChrAddr=0),this.prgSwap=64==(64&s)?1:0,this.SwapPrgRomBanks();break;case 32769:switch(this._mmc3Command){case 0:this.chr2kBank0=s,this.SwapChrBanks();break;case 1:this.chr2kBank1=s,this.SwapChrBanks();break;case 2:this.chr1kBank0=s,this.SwapChrBanks();break;case 3:this.chr1kBank1=s,this.SwapChrBanks();break;case 4:this.chr1kBank2=s,this.SwapChrBanks();break;case 5:this.chr1kBank3=s,this.SwapChrBanks();break;case 6:this.prgSwitch1=s,this.SwapPrgRomBanks();break;case 7:this.prgSwitch2=s,this.SwapPrgRomBanks()}break;case 40960:1==(1&s)?this.Mirror(t,2):this.Mirror(t,1);break;case 40961:this.SRAMCanWrite=0==(64&s),this.SRAMEnabled=128==(128&s);break;case 49152:this._mmc3IrqVal=s,0===s&&(this.scanlineCounter=0);break;case 49153:this._mmc3TmpVal=this._mmc3IrqVal;break;case 57344:this._mmc3IrcOn=!1,this._mmc3IrqVal=this._mmc3TmpVal,this.irqRaised=!1,this.updateIRQ&&this.updateIRQ();break;case 57345:this._mmc3IrcOn=!0}},e.prototype.SwapChrBanks=function(){this.ppuBankSwap?(this.CopyBanks(0,this.chr1kBank0,1),this.CopyBanks(1,this.chr1kBank1,1),this.CopyBanks(2,this.chr1kBank2,1),this.CopyBanks(3,this.chr1kBank3,1),this.CopyBanks(4,this.chr2kBank0,2),this.CopyBanks(6,this.chr2kBank1,2)):(this.CopyBanks(4,this.chr1kBank0,1),this.CopyBanks(5,this.chr1kBank1,1),this.CopyBanks(6,this.chr1kBank2,1),this.CopyBanks(7,this.chr1kBank3,1),this.CopyBanks(0,this.chr2kBank0,2),this.CopyBanks(2,this.chr2kBank1,2))},e.prototype.SwapPrgRomBanks=function(){1===this.prgSwap?this.SetupBankStarts(2*this.prgRomCount-2|0,this.prgSwitch2,this.prgSwitch1,2*this.prgRomCount-1|0):this.SetupBankStarts(this.prgSwitch1,this.prgSwitch2,2*this.prgRomCount-2|0,2*this.prgRomCount-1|0)},e.prototype.UpdateScanlineCounter=function(){if(0===this.scanlineCounter&&(this.scanlineCounter=this._mmc3IrqVal,0===this._mmc3IrqVal))return this._mmc3IrcOn&&(this.irqRaised=!0,this.updateIRQ()),void(this.scanlineCounter=-1);0!==this._mmc3TmpVal?(this.scanlineCounter=this._mmc3TmpVal,this._mmc3TmpVal=0):this.scanlineCounter=255&(this.scanlineCounter-1|0),0===this.scanlineCounter&&(this._mmc3IrcOn&&(this.irqRaised=!0,this.updateIRQ&&this.updateIRQ()),this._mmc3IrqVal>0&&(this.scanlineCounter=this._mmc3IrqVal))},e}(r);e.MMC3Cart=o},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=s(0),r=function(){function t(){this.Locker={},this.NESTooFast=!1,this.Frequency=44100,this.SharedBufferLength=8192,this.BufferAvailable=!0,this.SharedBuffer=new Float32Array(this.SharedBufferLength)}return t.prototype.WavesWritten=function(e){var s=this.SharedBuffer.length/t.sample_size|0;s>e&&(s=e),this.SharedBufferLength=2*s,this.bufferWasRead=!1,this.BufferAvailable=!0},t.prototype.ReadWaves=function(){this.BufferAvailable=!1,this.SharedBufferLength=0,this.bufferWasRead=!0},t.prototype.SetSharedBuffer=function(t){this.SharedBuffer=t},t.sample_size=1,t}();e.WavSharer=r;var n=function(){return function(t){this.size=t,this.factor=0,this.offset=0,this.avail=0,this.integrator=0,this.time_bits=0,this.arrayLength=0,this.samples=new Array(t),this.samples.fill(0)}}(),a=function(){function t(t){this.bass_shift=8,this.end_frame_extra=2,this.half_width=8,this.phase_bits=5,this.blip_new(t)}return t.prototype.blip_new=function(t){this.BlipBuffer=new n(t),this.BlipBuffer.size=t,this.BlipBuffer.factor=0,this.blip_clear()},t.prototype.blip_set_rates=function(e,s){this.BlipBuffer.factor=t.time_unit/e*s+.9999847412109375},t.prototype.blip_clear=function(){this.BlipBuffer.offset=0,this.BlipBuffer.avail=0,this.BlipBuffer.integrator=0,this.BlipBuffer.samples=new Array(this.BlipBuffer.size+t.buf_extra),this.BlipBuffer.samples.fill(0)},t.prototype.blip_clocks_needed=function(e){return(e*t.time_unit-this.BlipBuffer.offset+this.BlipBuffer.factor-1)/this.BlipBuffer.factor|0},t.prototype.blip_end_frame=function(e){var s=e*this.BlipBuffer.factor+this.BlipBuffer.offset;this.BlipBuffer.avail+=s>>t.time_bits,this.BlipBuffer.offset=s&t.time_unit-1},t.prototype.remove_samples=function(e){var s=this.BlipBuffer.avail+t.buf_extra-e;this.BlipBuffer.avail-=e,this.BlipBuffer.samples.copyWithin(0,e,e+s),this.BlipBuffer.samples.fill(0,s,s+e),this.BlipBuffer.arrayLength=e},t.prototype.ReadBytes=function(e,s,i){if(s>this.BlipBuffer.avail&&(s=this.BlipBuffer.avail),0!==s){var r=0,n=0,a=r+s,h=this.BlipBuffer.integrator;do{var o=h>>t.delta_bits;h+=this.BlipBuffer.samples[r],r++,o!==o&&(o=o>>31^32767);var u=o/65536;e[n]=u,n+=1,h-=o<<7}while(r!==a);this.BlipBuffer.integrator=h,this.remove_samples(s)}return s},t.prototype.blip_add_delta=function(e,s){if(0!==s){var i=e*this.BlipBuffer.factor+this.BlipBuffer.offset|0,r=this.BlipBuffer.avail+(i>>t.time_bits),n=(i>>16&t.phase_count-1)>>>0,a=n,h=t.phase_count-n,o=s*(i>>1&32767)>>15;s-=o;for(var u=0;u<8;++u)this.BlipBuffer.samples[r+u]+=t.bl_step[a][u]*s+t.bl_step[a][u]*o,this.BlipBuffer.samples[r+(15-u)]+=t.bl_step[h][u]*s+t.bl_step[h-1][u]*o}},t.prototype.blip_add_delta_fast=function(e,s){var i=e*this.BlipBuffer.factor+this.BlipBuffer.offset,r=this.BlipBuffer.avail+(i>>t.time_bits),n=1<<t.delta_bits,a=s*(i>>t.time_bits-t.delta_bits&n-1);this.BlipBuffer.samples[r+8]+=s*n-a,this.BlipBuffer.samples[r+9]+=a},t.time_unit=2097152,t.buf_extra=18,t.phase_count=32,t.time_bits=21,t.delta_bits=15,t.bl_step=[[43,-115,350,-488,1136,-914,5861,21022],[44,-118,348,-473,1076,-799,5274,21001],[45,-121,344,-454,1011,-677,4706,20936],[46,-122,336,-431,942,-549,4156,20829],[47,-123,327,-404,868,-418,3629,20679],[47,-122,316,-375,792,-285,3124,20488],[47,-120,303,-344,714,-151,2644,20256],[46,-117,289,-310,634,-17,2188,19985],[46,-114,273,-275,553,117,1758,19675],[44,-108,255,-237,471,247,1356,19327],[43,-103,237,-199,390,373,981,18944],[42,-98,218,-160,310,495,633,18527],[40,-91,198,-121,231,611,314,18078],[38,-84,178,-81,153,722,22,17599],[36,-76,157,-43,80,824,-241,17092],[34,-68,135,-3,8,919,-476,16558],[32,-61,115,34,-60,1006,-683,16001],[29,-52,94,70,-123,1083,-862,15422],[27,-44,73,106,-184,1152,-1015,14824],[25,-36,53,139,-239,1211,-1142,14210],[22,-27,34,170,-290,1261,-1244,13582],[20,-20,16,199,-335,1301,-1322,12942],[18,-12,-3,226,-375,1331,-1376,12293],[15,-4,-19,250,-410,1351,-1408,11638],[13,3,-35,272,-439,1361,-1419,10979],[11,9,-49,292,-464,1362,-1410,10319],[9,16,-63,309,-483,1354,-1383,9660],[7,22,-75,322,-496,1337,-1339,9005],[6,26,-85,333,-504,1312,-1280,8355],[4,31,-94,341,-507,1278,-1205,7713],[3,35,-102,347,-506,1238,-1119,7082],[1,40,-110,350,-499,1190,-1021,6464],[0,43,-115,350,-488,1136,-914,5861]],t}(),h=function(){return function(t,e,s){this.time=t,this.address=e,this.data=s}}(),o=function(){function t(){this.array=new Array}return Object.defineProperty(t.prototype,"Count",{get:function(){return this.array.length},enumerable:!0,configurable:!0}),t.prototype.clear=function(){this.array.length=0},t.prototype.enqueue=function(t){this.array.push(t)},t.prototype.dequeue=function(){return this.array.pop()},t}(),u=function(){function t(t,e){}return t.prototype.WriteRegister=function(t,e,s){},t.prototype.Run=function(t){},t.prototype.UpdateAmplitude=function(t){},t.prototype.EndFrame=function(t){},t.prototype.FrameClock=function(t,e){},t}(),c=function(){function t(t,e){this._bleeper=null,this._chan=0,this.NoisePeriods=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],this.LengthCounts=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],this._length=0,this._period=0,this._volume=0,this._time=0,this._envConstantVolume=!1,this._envVolume=0,this._looping=!1,this._enabled=!1,this.amplitude=0,this._phase=0,this.gain=0,this._envTimer=0,this._envStart=!1,this._bleeper=t,this._chan=e,this._enabled=!0,this._phase=1,this._envTimer=15}return Object.defineProperty(t.prototype,"Period",{get:function(){return this._period},set:function(t){this._period=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Volume",{get:function(){return this._volume},set:function(t){this._volume=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Time",{get:function(){return this._time},set:function(t){this._time=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Looping",{get:function(){return this._looping},set:function(t){this._looping=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Enabled",{get:function(){return this._enabled},set:function(t){this._enabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Gain",{get:function(){return this.gain},set:function(t){this.gain=t},enumerable:!0,configurable:!0}),t.prototype.WriteRegister=function(t,e,s){switch(t){case 0:this._envConstantVolume=16==(16&e),this._volume=15&e,this._looping=128==(128&e);break;case 1:break;case 2:this._period=this.NoisePeriods[15&e];break;case 3:this._enabled&&(this._length=this.LengthCounts[e>>3&31]),this._envStart=!0;break;case 4:this._enabled=0!==e,this._enabled||(this._length=0)}},t.prototype.Run=function(t){var e=this._envConstantVolume?this._volume:this._envVolume;if(0===this._length&&(e=0),0===this._period)return this._time=t,void this.UpdateAmplitude(0);for(0===this._phase&&(this._phase=1);this._time<t;this._time+=this._period){var s;s=this._looping?1&this._phase^this._phase>>6&1:1&this._phase^this._phase>>1&1,this.UpdateAmplitude(this._phase&1*e),this._phase=65535&(this._phase>>1|s<<14)}},t.prototype.UpdateAmplitude=function(t){var e=t*this.gain-this.amplitude;this.amplitude+=e,this._bleeper.blip_add_delta(this._time,e)},t.prototype.EndFrame=function(t){this.Run(t),this._time=0},t.prototype.FrameClock=function(t,e){switch(this.Run(t),this._envStart?(this._envStart=!1,this._envTimer=this._volume+1,this._envVolume=15):(this._envTimer--,0===this._envTimer&&(this._envTimer=this._volume+1,this._envVolume>0?this._envVolume--:this._envVolume=this._looping?15:0)),e){case 1:case 2:!this._looping&&this._length>0&&this._length--}},t}(),p=function(){function t(t,e){this._bleeper=null,this._chan=0,this.LengthCounts=new Uint8Array([10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30]),this._length=0,this._period=0,this._time=0,this._envelope=0,this._looping=!1,this._enabled=!1,this._amplitude=0,this._gain=0,this._linCtr=0,this._phase=0,this._linVal=0,this._linStart=!1,this._bleeper=t,this._chan=e,this._enabled=!0}return Object.defineProperty(t.prototype,"Period",{get:function(){return this._period},set:function(t){this._period=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Time",{get:function(){return this._time},set:function(t){this._time=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Envelope",{get:function(){return this._envelope},set:function(t){this._envelope=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Looping",{get:function(){return this._looping},set:function(t){this._looping=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Enabled",{get:function(){return this._enabled},set:function(t){this._enabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Gain",{get:function(){return this._gain},set:function(t){this._gain=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Amplitude",{get:function(){return this._amplitude},set:function(t){this._amplitude=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Length",{get:function(){return this._length},set:function(t){this._length=t},enumerable:!0,configurable:!0}),t.prototype.WriteRegister=function(t,e,s){switch(t){case 0:this._looping=128==(128&e),this._linVal=127&e;break;case 1:break;case 2:this._period&=1792,this._period|=e;break;case 3:this._period&=255,this._period|=(7&e)<<8,this._enabled&&(this._length=this.LengthCounts[e>>3&31]),this._linStart=!0;break;case 4:this._enabled=0!==e,this._enabled||(this._length=0)}},t.prototype.Run=function(t){var e=this._period+1;if(0===this._linCtr||0===this._length||this._period<4)this._time=t;else for(;this._time<t;this._time+=e,this._phase=(this._phase+1)%32)this.UpdateAmplitude(this._phase<16?this._phase:31-this._phase)},t.prototype.UpdateAmplitude=function(t){var e=t*this._gain-this._amplitude;this._amplitude+=e,this._bleeper.blip_add_delta(this._time,e)},t.prototype.EndFrame=function(t){this.Run(t),this._time=0},t.prototype.FrameClock=function(t,e){switch(this.Run(t),this._linStart?this._linCtr=this._linVal:this._linCtr>0&&this._linCtr--,this._looping||(this._linStart=!1),e){case 1:case 3:this._length>0&&!this._looping&&this._length--}},t}(),l=function(){function t(t,e){this._chan=0,this._bleeper=null,this.LengthCounts=new Uint8Array([10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30]),this._dutyCycle=0,this._length=0,this._timer=0,this._rawTimer=0,this._volume=0,this._time=0,this._envelope=0,this._looping=!1,this._enabled=!1,this._amplitude=0,this.doodies=[2,6,30,249],this._sweepShift=0,this._sweepCounter=0,this._sweepDivider=0,this._sweepNegateFlag=!1,this._sweepEnabled=!1,this._startSweep=!1,this._sweepInvalid=!1,this._phase=0,this._gain=0,this._envTimer=0,this._envStart=!1,this._envConstantVolume=!1,this._envVolume=0,this._sweepComplement=!1,this._bleeper=t,this._chan=e,this._enabled=!0,this._sweepDivider=1,this._envTimer=15}return Object.defineProperty(t.prototype,"DutyCycle",{get:function(){return this._dutyCycle},set:function(t){this._dutyCycle=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Period",{get:function(){return this._timer},set:function(t){this._timer=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Volume",{get:function(){return this._volume},set:function(t){this._volume=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Time",{get:function(){return this._time},set:function(t){this._time=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Envelope",{get:function(){return this._envelope},set:function(t){this._envelope=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Looping",{get:function(){return this._looping},set:function(t){this._looping=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Enabled",{get:function(){return this._enabled},set:function(t){this._enabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Gain",{get:function(){return this._gain},set:function(t){this._gain=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"SweepComplement",{get:function(){return this._sweepComplement},set:function(t){this._sweepComplement=t},enumerable:!0,configurable:!0}),t.prototype.WriteRegister=function(t,e,s){switch(t){case 0:this._envConstantVolume=16==(16&e),this._volume=15&e,this._dutyCycle=this.doodies[e>>6&3],this._looping=32==(32&e),this._sweepInvalid=!1;break;case 1:this._sweepShift=7&e,this._sweepNegateFlag=8==(8&e),this._sweepDivider=e>>4&7,this._sweepEnabled=128==(128&e),this._startSweep=!0,this._sweepInvalid=!1;break;case 2:this._timer&=1792,this._timer|=e,this._rawTimer=this._timer;break;case 3:this._timer&=255,this._timer|=(7&e)<<8,this._rawTimer=this._timer,this._phase=0,this._enabled&&(this._length=this.LengthCounts[e>>3&31]),this._envStart=!0;break;case 4:this._enabled=0!==e,this._enabled||(this._length=0)}},t.prototype.Run=function(t){var e=this._sweepEnabled?(this._timer+1&2047)<<1:(this._rawTimer+1&2047)<<1;if(0===e)return this._time=t,void this.UpdateAmplitude(0);var s=this._envConstantVolume?this._volume:this._envVolume;if(0===this._length||0===s||this._sweepInvalid)return this._phase+=(t-this._time)/e&7,this._time=t,void this.UpdateAmplitude(0);for(;this._time<t;this._time+=e,this._phase++)this.UpdateAmplitude((this._dutyCycle>>(7&this._phase)&1)*s);this._phase&=7},t.prototype.UpdateAmplitude=function(t){var e=t*this._gain-this._amplitude;this._amplitude+=e,this._bleeper.blip_add_delta(this._time,e)},t.prototype.EndFrame=function(t){this.Run(t),this._time=0},t.prototype.FrameClock=function(t,e){switch(this.Run(t),this._envStart?(this._envStart=!1,this._envTimer=this._volume+1,this._envVolume=15):(this._envTimer--,0===this._envTimer&&(this._envTimer=this._volume+1,this._envVolume>0?this._envVolume--:this._envVolume=this._looping?15:0)),e){case 1:case 3:if(--this._sweepCounter,0===this._sweepCounter&&(this._sweepCounter=this._sweepDivider+1,this._sweepEnabled&&this._sweepShift>0)){var s=this._timer>>this._sweepShift;this._sweepComplement?this._timer+=this._sweepNegateFlag?~s:s:this._timer+=this._sweepNegateFlag?1+~s:s,this._sweepInvalid=this._rawTimer<8||2048==(2048&this._timer)}this._startSweep&&(this._startSweep=!1,this._sweepCounter=this._sweepDivider+1),!this._looping&&this._length>0&&this._length--}},t}(),d=function(){function t(t){this.writer=t,this.throwingIRQs=!1,this.reg15=0,this.master_vol=4369,this.registers=new o,this._sampleRate=44100,this.square0Gain=873,this.square1Gain=873,this.triangleGain=1004,this.noiseGain=567,this.muted=!1,this.lastFrameHit=0,this.RebuildSound()}return Object.defineProperty(t.prototype,"audioSettings",{get:function(){var t=new i.AudioSettings;return t.sampleRate=this._sampleRate,t.enableNoise=this.EnableNoise,t.enableSquare0=this.EnableSquare0,t.enableSquare1=this.EnableSquare1,t.enableTriangle=this.enableTriangle,t},set:function(t){this.EnableNoise=t.enableNoise,this.EnableSquare0=t.enableSquare0,this.EnableSquare1=t.enableSquare1,this.enableTriangle=t.enableTriangle},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"SampleRate",{get:function(){return this._sampleRate},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sampleRate",{set:function(t){this._sampleRate=t,this.RebuildSound()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"EnableSquare0",{get:function(){return this.square0.Gain>0},set:function(t){this.square0.Gain=t?this.square0Gain:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"EnableSquare1",{get:function(){return this.square1.Gain>0},set:function(t){this.square1.Gain=t?this.square1Gain:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enableTriangle",{get:function(){return this.triangle.Gain>0},set:function(t){this.triangle.Gain=t?this.triangleGain:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"EnableNoise",{get:function(){return this.noise.Gain>0},set:function(t){this.noise.Gain=t?this.noiseGain:0},enumerable:!0,configurable:!0}),t.prototype.RebuildSound=function(){this.myBlipper=new a(this._sampleRate/5),this.myBlipper.blip_set_rates(t.clock_rate,this._sampleRate),this.writer.Frequency=this.sampleRate,this.registers.clear(),this.InterruptRaised=!1,this.square0Gain=873,this.square1Gain=873,this.triangleGain=1004,this.noiseGain=567,this.square0=new l(this.myBlipper,0),this.square0.Gain=this.square0Gain,this.square0.Period=10,this.square0.SweepComplement=!0,this.square1=new l(this.myBlipper,0),this.square1.Gain=this.square1Gain,this.square1.Period=10,this.square1.SweepComplement=!1,this.triangle=new p(this.myBlipper,2),this.triangle.Gain=this.triangleGain,this.triangle.Period=0,this.noise=new c(this.myBlipper,3),this.noise.Gain=this.noiseGain,this.noise.Period=0,this.dmc=new u(this.myBlipper,4),this.dmc.Gain=873,this.dmc.Period=10},t.prototype.GetByte=function(t,e){return 16384===e&&(this.InterruptRaised=!1),16405===e?this.ReadStatus():66},t.prototype.ReadStatus=function(){return(this.square0.Length>0?1:0)|(this.square1.Length>0?2:0)|(this.triangle.Length>0?4:0)|(this.square0.Length>0?8:0)|(this.InterruptRaised?64:0)},t.prototype.SetByte=function(t,e,s){16384===e&&(this.InterruptRaised=!1),this.DoSetByte(t,e,s),this.registers.enqueue(new h(t,e,s))},t.prototype.DoSetByte=function(t,e,s){switch(e){case 16384:case 16385:case 16386:case 16387:this.square0.WriteRegister(e-16384,s,t);break;case 16388:case 16389:case 16390:case 16391:this.square1.WriteRegister(e-16388,s,t);break;case 16392:case 16393:case 16394:case 16395:this.triangle.WriteRegister(e-16392,s,t);break;case 16396:case 16397:case 16398:case 16399:this.noise.WriteRegister(e-16396,s,t);break;case 16400:case 16401:case 16402:case 16403:break;case 16405:this.reg15=s,this.square0.WriteRegister(4,1&s,t),this.square1.WriteRegister(4,2&s,t),this.triangle.WriteRegister(4,4&s,t),this.noise.WriteRegister(4,8&s,t);break;case 16407:this.throwingIRQs=64!=(64&s),this.lastFrameHit=0}},t.prototype.UpdateFrame=function(t){this.muted||(this.RunFrameEvents(t,this.lastFrameHit),3===this.lastFrameHit?(this.throwingIRQs&&(this.InterruptRaised=!0),this.lastFrameHit=0):this.lastFrameHit++)},t.prototype.RunFrameEvents=function(t,e){this.triangle.FrameClock(t,e),this.noise.FrameClock(t,e),this.square0.FrameClock(t,e),this.square1.FrameClock(t,e)},t.prototype.EndFrame=function(t){this.square0.EndFrame(t),this.square1.EndFrame(t),this.triangle.EndFrame(t),this.noise.EndFrame(t),this.muted||this.myBlipper.blip_end_frame(t);var e=this.myBlipper.ReadBytes(this.writer.SharedBuffer,this.writer.SharedBuffer.length/2,0);this.writer.WavesWritten(e)},t.prototype.FlushFrame=function(t){for(var e,s=0;this.registers.Count>0;)e=this.registers.dequeue(),s>7445&&(s-=7445,this.UpdateFrame(7445)),this.DoSetByte(e.time,e.address,e.data),e.time,s=e.time;for(0===this.lastFrameHit&&this.UpdateFrame(7445);this.lastFrameHit>0;)this.UpdateFrame(7445*(this.lastFrameHit+1))},t.prototype.HandleEvent=function(t){this.UpdateFrame(t),this.lastClock=t,t>29780&&(this.writer,this.EndFrame(t))},t.prototype.ResetClock=function(t){this.lastClock=t},t.clock_rate=1789772.727,t}();e.ChiChiBopper=d},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(){this.ControlPad=new r}return t.prototype.controlPad_NextControlByteSet=function(t,e){},t.prototype.GetByte=function(t,e){return this.ControlPad.getByte(t)},t.prototype.SetByte=function(t,e,s){return this.ControlPad.setByte(t,s)},t.prototype.SetNextControlByte=function(t){},t.prototype.HandleEvent=function(t){},t.prototype.ResetClock=function(t){},t}();e.ChiChiInputHandler=i;var r=function(){function t(){this.currentByte=0,this.readNumber=0,this.padOneState=0,this.CurrentByte=0}return t.prototype.refresh=function(){},t.prototype.getByte=function(t){var e=this.currentByte>>this.readNumber&1;return this.readNumber=this.readNumber+1&7,255&(64|e)},t.prototype.setByte=function(t,e){1==(1&e)&&(this.currentByte=this.padOneState,16==(16&this.currentByte)&&(this.currentByte=-33&this.currentByte),64==(64&this.currentByte)&&(this.currentByte=-129&this.currentByte),this.readNumber=0)},t}()},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=s(1);e.ChiChiCPPU=i.ChiChiCPPU,e.ChiChiMachine=i.ChiChiMachine,e.iNESFileHandler=i.iNESFileHandler;var r=s(6);e.ChiChiNsfCPPU=r.ChiChiNsfCPPU,e.ChiChiNsfMachine=r.ChiChiNsfMachine;var n=s(2);e.BaseCart=n.BaseCart,e.NesCart=n.NesCart,e.NsfCart=n.NsfCart,e.MMC1Cart=n.MMC1Cart,e.MMC3Cart=n.MMC3Cart;var a=s(4);e.ChiChiInputHandler=a.ChiChiInputHandler;var h=s(3);e.WavSharer=h.WavSharer,e.ChiChiBopper=h.ChiChiBopper;var o=s(0);e.RunningStatuses=o.RunningStatuses,e.ChiChiCPPU_AddressingModes=o.ChiChiCPPU_AddressingModes,e.CpuStatus=o.CpuStatus,e.PpuStatus=o.PpuStatus,e.ChiChiInstruction=o.ChiChiInstruction,e.ChiChiSprite=o.ChiChiSprite,e.AudioSettings=o.AudioSettings},function(t,e,s){"use strict";var i=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s])};return function(e,s){function i(){this.constructor=e}t(e,s),e.prototype=null===s?Object.create(s):(i.prototype=s.prototype,new i)}}();Object.defineProperty(e,"__esModule",{value:!0});var r=s(1),n=function(t){function e(){var e=t.call(this)||this;return e.Cpu=new a(e.SoundBopper),e.Cpu.frameFinished=function(){e.FrameFinished()},e}return i(e,t),e.prototype.LoadNsf=function(t){this.Cpu.LoadNsf(t)},e}(r.ChiChiMachine);e.ChiChiNsfMachine=n;var a=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.runNsfAt=0,e.loadNsfAt=0,e.initNsfAt=0,e.firstSong=0,e.songCount=0,e}return i(e,t),e.prototype.__SetByte=function(t,e){this.Rams[t]=e},e.prototype.GetByte=function(t){return this.Rams[t]},e.prototype.LoadNsf=function(t){var e=t.slice(0,16),s=new SharedArrayBuffer(65536*Uint8Array.BYTES_PER_ELEMENT);this.Rams=new Uint8Array(s),this.Rams.fill(0),this.songCount=e[6],this.firstSong=e[7],this.loadNsfAt=(e[9]<<8)+e[8],this.initNsfAt=(e[11]<<8)+e[10],this.runNsfAt=(e[13]<<8)+e[12],this.songName=e.slice(14,46).map(function(t){return String.fromCharCode(t)}).join("").trim(),this.artist=e.slice(46,46).map(function(t){return String.fromCharCode(t)}).join("").trim(),this.copyright=e.slice(78,46).map(function(t){return String.fromCharCode(t)}).join("").trim();var i=this.loadNsfAt;t=t.slice(16,t.length);for(var r=0;r<t.length-128;++r)this.__SetByte(i+r,t[128+r]);this.InitNsf()},e.prototype.InitNsf=function(){for(this.SetByte(16407,64),this._accumulator=this.firstSong,this._indexRegisterX=0,this._programCounter=this.initNsfAt;this._programCounter!=this.runNsfAt;)this.Step();console.log("ready to play")},e}(r.ChiChiCPPU);e.ChiChiNsfCPPU=a}])}])});